# Posterrama Module Dependency Graph

**Version**: 2.8.8  
**Last Updated**: 2025-01-20  
**Refactoring Status**: 70.1% reduction complete (19,864 ‚Üí 5,941 lines in server.js)

---

## üìä Overview

This document maps the dependency relationships between Posterrama's 31 modules (server.js + 17 routes + 14 lib). Understanding these dependencies is crucial for:

- **Refactoring**: Identify tightly coupled modules
- **Testing**: Understand what mocks are needed
- **Debugging**: Trace data flow through the system
- **Optimization**: Find caching opportunities

---

## üó∫Ô∏è Complete Dependency Map

### Visual Dependency Graph

```mermaid
graph TB
    %% Core Server
    SERVER[server.js<br/>5,941 lines]

    %% Route Modules (17)
    R_CONFIG[routes/admin-config.js]
    R_LIB[routes/admin-libraries.js]
    R_OBSERVABLE[routes/admin-observable.js]
    R_AUTH[routes/auth.js]
    R_BACKUPS[routes/config-backups.js]
    R_CONFIG_PUB[routes/config-public.js]
    R_DEVICES[routes/devices.js]
    R_PAGES[routes/frontend-pages.js]
    R_GROUPS[routes/groups.js]
    R_HEALTH[routes/health.js]
    R_LOCAL[routes/local-directory.js]
    R_MEDIA[routes/media.js]
    R_METRICS[routes/metrics-testing.js]
    R_PHOTO[routes/profile-photo.js]
    R_PUBLIC[routes/public-api.js]
    R_QR[routes/qr.js]
    R_RATINGS[routes/quality-ratings.js]

    %% Lib Modules (14)
    L_AUTH[lib/auth-helpers.js]
    L_CACHE[lib/cache-utils.js]
    L_CONFIG[lib/config-helpers.js]
    L_INIT[lib/init.js]
    L_JELLYFIN[lib/jellyfin-helpers.js]
    L_LOCAL_INIT[lib/local-directory-init.js]
    L_AGGREGATOR[lib/media-aggregator.js]
    L_PLEX[lib/plex-helpers.js]
    L_PLAYLIST[lib/playlist-cache.js]
    L_PRESET[lib/preset-helpers.js]
    L_SERVER_TEST[lib/server-test-helpers.js]
    L_SOURCE_UTILS[lib/source-utils.js]
    L_UTILS[lib/utils-helpers.js]
    L_WEBSOCKET[lib/websocket-handlers.js]

    %% Middleware
    MW_ADMIN[middleware/adminAuth.js]
    MW_CACHE[middleware/cache.js]
    MW_ERROR[middleware/errorHandler.js]
    MW_INDEX[middleware/index.js]
    MW_METRICS[middleware/metrics.js]
    MW_RATE[middleware/rateLimiter.js]
    MW_VALIDATE[middleware/validate.js]

    %% Utils
    U_CACHE[utils/cache.js]
    U_CONFIG_BACKUP[utils/configBackup.js]
    U_DEVICE[utils/deviceStore.js]
    U_ERRORS[utils/errors.js]
    U_GROUPS[utils/groupsStore.js]
    U_LOGGER[utils/logger.js]
    U_METRICS[utils/metrics.js]
    U_PLEX_HTTP[utils/plex-http-client.js]
    U_JELLYFIN_HTTP[utils/jellyfin-http-client.js]
    U_WSHUB[utils/wsHub.js]

    %% Sources
    S_PLEX[sources/plex.js]
    S_JELLYFIN[sources/jellyfin.js]
    S_TMDB[sources/tmdb.js]
    S_LOCAL[sources/local.js]

    %% Server Dependencies
    SERVER --> R_CONFIG
    SERVER --> R_LIB
    SERVER --> R_OBSERVABLE
    SERVER --> R_AUTH
    SERVER --> R_BACKUPS
    SERVER --> R_CONFIG_PUB
    SERVER --> R_DEVICES
    SERVER --> R_PAGES
    SERVER --> R_GROUPS
    SERVER --> R_HEALTH
    SERVER --> R_LOCAL
    SERVER --> R_MEDIA
    SERVER --> R_METRICS
    SERVER --> R_PHOTO
    SERVER --> R_PUBLIC
    SERVER --> R_QR
    SERVER --> R_RATINGS
    SERVER --> MW_INDEX
    SERVER --> L_INIT
    SERVER --> U_LOGGER
    SERVER --> U_WSHUB

    %% Route -> Lib Dependencies
    R_CONFIG --> L_CONFIG
    R_CONFIG --> L_PRESET
    R_CONFIG --> U_CONFIG_BACKUP

    R_LIB --> L_PLEX
    R_LIB --> L_JELLYFIN
    R_LIB --> L_SERVER_TEST

    R_AUTH --> L_AUTH
    R_AUTH --> MW_RATE

    R_BACKUPS --> U_CONFIG_BACKUP

    R_DEVICES --> L_PRESET
    R_DEVICES --> L_WEBSOCKET
    R_DEVICES --> U_DEVICE
    R_DEVICES --> U_WSHUB

    R_PAGES --> L_INIT

    R_GROUPS --> U_GROUPS

    R_LOCAL --> L_LOCAL_INIT
    R_LOCAL --> L_PLEX
    R_LOCAL --> L_JELLYFIN
    R_LOCAL --> S_LOCAL

    R_MEDIA --> L_AGGREGATOR
    R_MEDIA --> L_PLAYLIST
    R_MEDIA --> L_CACHE

    R_PHOTO --> L_UTILS

    %% Lib -> Lib Dependencies
    L_AGGREGATOR --> L_PLEX
    L_AGGREGATOR --> L_JELLYFIN
    L_AGGREGATOR --> L_PLAYLIST
    L_AGGREGATOR --> L_SOURCE_UTILS

    L_PLAYLIST --> L_CACHE
    L_PLAYLIST --> L_AGGREGATOR

    L_PLEX --> L_CACHE
    L_PLEX --> U_PLEX_HTTP
    L_PLEX --> S_PLEX

    L_JELLYFIN --> L_CACHE
    L_JELLYFIN --> U_JELLYFIN_HTTP
    L_JELLYFIN --> S_JELLYFIN

    L_CONFIG --> U_CONFIG_BACKUP
    L_CONFIG --> U_LOGGER

    L_INIT --> U_LOGGER

    L_WEBSOCKET --> U_DEVICE
    L_WEBSOCKET --> U_WSHUB

    %% Lib -> Utils Dependencies
    L_CACHE --> U_CACHE

    %% Middleware Dependencies
    MW_INDEX --> MW_ADMIN
    MW_INDEX --> MW_CACHE
    MW_INDEX --> MW_ERROR
    MW_INDEX --> MW_METRICS
    MW_INDEX --> MW_RATE
    MW_INDEX --> MW_VALIDATE

    MW_CACHE --> U_CACHE
    MW_ERROR --> U_LOGGER
    MW_ERROR --> U_ERRORS
    MW_METRICS --> U_METRICS

    %% Sources Dependencies
    S_PLEX --> U_CACHE
    S_PLEX --> U_LOGGER
    S_JELLYFIN --> U_CACHE
    S_JELLYFIN --> U_LOGGER
    S_TMDB --> U_CACHE
    S_TMDB --> U_LOGGER
    S_LOCAL --> U_LOGGER

    %% Styling
    classDef serverClass fill:#4CAF50,stroke:#2E7D32,stroke-width:4px
    classDef routeClass fill:#2196F3,stroke:#1565C0,stroke-width:2px
    classDef libClass fill:#FF9800,stroke:#E65100,stroke-width:2px
    classDef utilClass fill:#9C27B0,stroke:#6A1B9A,stroke-width:2px
    classDef sourceClass fill:#F44336,stroke:#C62828,stroke-width:2px

    class SERVER serverClass
    class R_CONFIG,R_LIB,R_OBSERVABLE,R_AUTH,R_BACKUPS,R_CONFIG_PUB,R_DEVICES,R_PAGES,R_GROUPS,R_HEALTH,R_LOCAL,R_MEDIA,R_METRICS,R_PHOTO,R_PUBLIC,R_QR,R_RATINGS routeClass
    class L_AUTH,L_CACHE,L_CONFIG,L_INIT,L_JELLYFIN,L_LOCAL_INIT,L_AGGREGATOR,L_PLEX,L_PLAYLIST,L_PRESET,L_SERVER_TEST,L_SOURCE_UTILS,L_UTILS,L_WEBSOCKET libClass
    class U_CACHE,U_CONFIG_BACKUP,U_DEVICE,U_ERRORS,U_GROUPS,U_LOGGER,U_METRICS,U_PLEX_HTTP,U_JELLYFIN_HTTP,U_WSHUB,MW_ADMIN,MW_CACHE,MW_ERROR,MW_INDEX,MW_METRICS,MW_RATE,MW_VALIDATE utilClass
    class S_PLEX,S_JELLYFIN,S_TMDB,S_LOCAL sourceClass
```

---

## üìã Dependency Matrix

### Route Dependencies

| Route Module            | Depends On (Direct)                                                | Transitively Uses                                      |
| ----------------------- | ------------------------------------------------------------------ | ------------------------------------------------------ |
| **admin-config.js**     | config-helpers, preset-helpers, configBackup                       | cache, logger                                          |
| **admin-libraries.js**  | plex-helpers, jellyfin-helpers, server-test-helpers                | cache, plex-http-client, jellyfin-http-client, logger  |
| **admin-observable.js** | logger, metrics                                                    | -                                                      |
| **auth.js**             | auth-helpers, rateLimiter                                          | logger                                                 |
| **config-backups.js**   | configBackup                                                       | logger                                                 |
| **config-public.js**    | -                                                                  | logger                                                 |
| **devices.js**          | preset-helpers, websocket-handlers, deviceStore, wsHub             | cache, logger                                          |
| **frontend-pages.js**   | init (asset versioning)                                            | logger                                                 |
| **groups.js**           | groupsStore                                                        | logger                                                 |
| **health.js**           | -                                                                  | logger                                                 |
| **local-directory.js**  | local-directory-init, plex-helpers, jellyfin-helpers, local source | cache, logger                                          |
| **media.js**            | media-aggregator, playlist-cache, cache-utils                      | plex-helpers, jellyfin-helpers, sources, cache, logger |
| **metrics-testing.js**  | metrics                                                            | logger                                                 |
| **profile-photo.js**    | utils-helpers                                                      | logger                                                 |
| **public-api.js**       | -                                                                  | logger                                                 |
| **qr.js**               | -                                                                  | logger                                                 |
| **quality-ratings.js**  | -                                                                  | logger                                                 |

### Lib Module Dependencies

| Lib Module                  | Depends On (Direct)                                          | Transitively Uses      |
| --------------------------- | ------------------------------------------------------------ | ---------------------- |
| **auth-helpers.js**         | -                                                            | logger, bcrypt         |
| **cache-utils.js**          | cache                                                        | -                      |
| **config-helpers.js**       | configBackup, logger                                         | -                      |
| **init.js**                 | logger, fs                                                   | -                      |
| **jellyfin-helpers.js**     | cache-utils, jellyfin-http-client, jellyfin source           | cache, logger          |
| **local-directory-init.js** | local source                                                 | logger                 |
| **media-aggregator.js**     | plex-helpers, jellyfin-helpers, playlist-cache, source-utils | cache, sources, logger |
| **plex-helpers.js**         | cache-utils, plex-http-client, plex source                   | cache, logger          |
| **playlist-cache.js**       | cache-utils, media-aggregator                                | cache, logger          |
| **preset-helpers.js**       | -                                                            | fs, logger             |
| **server-test-helpers.js**  | -                                                            | axios, logger          |
| **source-utils.js**         | -                                                            | logger                 |
| **utils-helpers.js**        | -                                                            | -                      |
| **websocket-handlers.js**   | deviceStore, wsHub                                           | logger                 |

---

## üéØ Dependency Levels

Modules organized by dependency depth (0 = no dependencies, higher = more dependencies):

### Level 0: Foundation (No Dependencies)

- `utils/logger.js` - Winston logger
- `utils/errors.js` - Custom error classes
- `utils/cache.js` - Core caching engine
- `lib/utils-helpers.js` - Pure utility functions

### Level 1: Core Utilities (Depend only on Level 0)

- `utils/configBackup.js` ‚Üí logger
- `utils/deviceStore.js` ‚Üí logger
- `utils/groupsStore.js` ‚Üí logger
- `utils/metrics.js` ‚Üí logger
- `utils/plex-http-client.js` ‚Üí logger, cache
- `utils/jellyfin-http-client.js` ‚Üí logger, cache
- `lib/auth-helpers.js` ‚Üí logger
- `lib/init.js` ‚Üí logger
- `lib/preset-helpers.js` ‚Üí logger

### Level 2: Sources & HTTP Clients (Depend on Level 0-1)

- `sources/plex.js` ‚Üí logger, cache
- `sources/jellyfin.js` ‚Üí logger, cache
- `sources/tmdb.js` ‚Üí logger, cache
- `sources/local.js` ‚Üí logger
- `utils/wsHub.js` ‚Üí logger, deviceStore

### Level 3: Middleware (Depend on Level 0-2)

- `middleware/adminAuth.js` ‚Üí logger
- `middleware/cache.js` ‚Üí cache
- `middleware/errorHandler.js` ‚Üí logger, errors
- `middleware/metrics.js` ‚Üí metrics, logger
- `middleware/rateLimiter.js` ‚Üí logger
- `middleware/validate.js` ‚Üí logger
- `middleware/index.js` ‚Üí ALL middleware

### Level 4: Lib Helpers (Depend on Level 0-3)

- `lib/cache-utils.js` ‚Üí cache
- `lib/config-helpers.js` ‚Üí configBackup, logger
- `lib/local-directory-init.js` ‚Üí local source
- `lib/plex-helpers.js` ‚Üí cache-utils, plex-http-client, plex source
- `lib/jellyfin-helpers.js` ‚Üí cache-utils, jellyfin-http-client, jellyfin source
- `lib/server-test-helpers.js` ‚Üí logger
- `lib/source-utils.js` ‚Üí logger
- `lib/websocket-handlers.js` ‚Üí deviceStore, wsHub

### Level 5: Complex Business Logic (Depend on Level 0-4)

- `lib/media-aggregator.js` ‚Üí plex-helpers, jellyfin-helpers, source-utils, logger
- `lib/playlist-cache.js` ‚Üí cache-utils, media-aggregator

### Level 6: Routes (Depend on Level 0-5)

- All 17 route modules (see matrix above for specific dependencies)

### Level 7: Server (Depends on Everything)

- `server.js` ‚Üí routes, lib, middleware, utils, sources

---

## üîÑ Circular Dependencies

### Identified Circles

**‚ö†Ô∏è media-aggregator.js ‚Üî playlist-cache.js**

- `lib/media-aggregator.js` depends on `lib/playlist-cache.js`
- `lib/playlist-cache.js` depends on `lib/media-aggregator.js`

**Resolution Strategy**: These are tightly coupled by design. The cache uses the aggregator to fetch fresh data; the aggregator checks the cache before fetching. This is acceptable as they represent a cohesive unit.

**Alternative**: Extract a `media-fetch-coordinator.js` that both depend on.

---

## üìä Module Coupling Analysis

### Highly Coupled Modules (>5 direct dependents)

| Module                      | Direct Dependents | Risk Level | Recommendation                       |
| --------------------------- | ----------------- | ---------- | ------------------------------------ |
| **utils/logger.js**         | ~30 modules       | Low        | Foundation module, coupling expected |
| **utils/cache.js**          | 12 modules        | Low        | Core infrastructure, stable API      |
| **lib/cache-utils.js**      | 5 modules         | Medium     | Consider splitting if it grows       |
| **lib/plex-helpers.js**     | 4 modules         | Medium     | Well-encapsulated, OK                |
| **lib/jellyfin-helpers.js** | 4 modules         | Medium     | Well-encapsulated, OK                |

### Loosely Coupled Modules (<2 direct dependents)

| Module                         | Direct Dependents | Notes                |
| ------------------------------ | ----------------- | -------------------- |
| **routes/qr.js**               | 0 (server only)   | Independent endpoint |
| **routes/health.js**           | 0 (server only)   | Independent endpoint |
| **routes/config-public.js**    | 0 (server only)   | Read-only endpoint   |
| **lib/utils-helpers.js**       | 1                 | General utilities    |
| **lib/server-test-helpers.js** | 1                 | Specialized use case |

---

## üß© Dependency Clusters

Modules that work together as cohesive units:

### Cluster 1: Media Pipeline

```
lib/media-aggregator.js
  ‚îú‚îÄ> lib/plex-helpers.js
  ‚îú‚îÄ> lib/jellyfin-helpers.js
  ‚îú‚îÄ> lib/playlist-cache.js
  ‚îî‚îÄ> lib/source-utils.js
```

**Purpose**: Aggregate media from multiple sources  
**Routes Using**: `routes/media.js`, `routes/local-directory.js`

### Cluster 2: Configuration Management

```
lib/config-helpers.js
  ‚îú‚îÄ> utils/configBackup.js
  ‚îî‚îÄ> lib/preset-helpers.js
```

**Purpose**: Manage app and device configuration  
**Routes Using**: `routes/admin-config.js`, `routes/devices.js`

### Cluster 3: Media Server Adapters

```
lib/plex-helpers.js
  ‚îú‚îÄ> utils/plex-http-client.js
  ‚îî‚îÄ> sources/plex.js

lib/jellyfin-helpers.js
  ‚îú‚îÄ> utils/jellyfin-http-client.js
  ‚îî‚îÄ> sources/jellyfin.js
```

**Purpose**: Adapt external media servers to common interface  
**Routes Using**: `routes/admin-libraries.js`, `routes/media.js`, `routes/local-directory.js`

### Cluster 4: Device Management

```
lib/websocket-handlers.js
  ‚îú‚îÄ> utils/wsHub.js
  ‚îú‚îÄ> utils/deviceStore.js
  ‚îî‚îÄ> lib/preset-helpers.js
```

**Purpose**: Manage device connections and settings  
**Routes Using**: `routes/devices.js`, `routes/groups.js`

### Cluster 5: Middleware Pipeline

```
middleware/index.js
  ‚îú‚îÄ> middleware/adminAuth.js
  ‚îú‚îÄ> middleware/cache.js
  ‚îú‚îÄ> middleware/errorHandler.js
  ‚îú‚îÄ> middleware/metrics.js
  ‚îú‚îÄ> middleware/rateLimiter.js
  ‚îî‚îÄ> middleware/validate.js
```

**Purpose**: Request processing pipeline  
**Used By**: `server.js` (all requests flow through)

---

## üîç Import Analysis

### Most Imported Modules (Top 10)

1. **utils/logger.js** - 30+ imports
2. **utils/cache.js** - 12 imports
3. **lib/cache-utils.js** - 5 imports
4. **lib/plex-helpers.js** - 4 imports
5. **lib/jellyfin-helpers.js** - 4 imports
6. **utils/configBackup.js** - 3 imports
7. **lib/media-aggregator.js** - 3 imports
8. **utils/wsHub.js** - 3 imports
9. **utils/deviceStore.js** - 3 imports
10. **lib/playlist-cache.js** - 2 imports

### Least Imported Modules (Independent)

- `routes/qr.js` - Only server.js imports
- `routes/health.js` - Only server.js imports
- `routes/config-public.js` - Only server.js imports
- `routes/profile-photo.js` - Only server.js imports
- `lib/utils-helpers.js` - Only 1 route imports

---

## üé® Dependency Patterns

### Pattern 1: Route ‚Üí Lib ‚Üí Utils ‚Üí Source

**Example**: Media aggregation flow

```
routes/media.js
  ‚îî‚îÄ> lib/media-aggregator.js
       ‚îî‚îÄ> lib/plex-helpers.js
            ‚îî‚îÄ> utils/cache.js
                 ‚îî‚îÄ> sources/plex.js
```

**Rationale**: Clean separation of concerns

- Route handles HTTP
- Lib handles business logic
- Utils provide shared services
- Sources interface with external APIs

### Pattern 2: Lib Module with HTTP Client

**Example**: Plex adapter pattern

```
lib/plex-helpers.js
  ‚îú‚îÄ> utils/plex-http-client.js  (HTTP communication)
  ‚îú‚îÄ> sources/plex.js             (Data transformation)
  ‚îî‚îÄ> utils/cache.js              (Caching layer)
```

**Rationale**: Separation of concerns

- HTTP client: network requests
- Source: data parsing/transformation
- Helper: orchestration + business logic
- Cache: performance optimization

### Pattern 3: Factory Pattern with Dependencies

**Example**: All route modules

```javascript
module.exports = function createRouter({
    logger, // Level 0
    cache, // Level 0
    asyncHandler, // Level 3
    someHelper, // Level 4+
}) {
    // Router implementation
};
```

**Rationale**: Explicit dependency injection

- Easy to test (mock dependencies)
- Clear dependency graph
- No hidden globals

---

## üß™ Testing Implications

### Mocking Requirements by Route

| Route                  | Required Mocks                              | Complexity |
| ---------------------- | ------------------------------------------- | ---------- |
| **admin-config.js**    | config-helpers, preset-helpers              | Medium     |
| **admin-libraries.js** | plex-helpers, jellyfin-helpers, axios       | High       |
| **auth.js**            | auth-helpers, session store                 | Medium     |
| **devices.js**         | deviceStore, wsHub, preset-helpers          | High       |
| **media.js**           | media-aggregator (mocks 4+ sources)         | Very High  |
| **local-directory.js** | local-directory-init, plex/jellyfin-helpers | High       |
| **health.js**          | None                                        | Low        |
| **qr.js**              | None                                        | Low        |

### Test Isolation Strategy

**Unit Tests** (test single module):

- Mock ALL dependencies
- Example: Test `lib/plex-helpers.js` by mocking `utils/cache.js` and `sources/plex.js`

**Integration Tests** (test module cluster):

- Mock external boundaries only
- Example: Test `routes/media.js` with real `lib/media-aggregator.js` but mock `sources/*`

**E2E Tests** (test full stack):

- Mock external APIs only (Plex, Jellyfin, TMDB)
- Use real implementations of all internal modules

---

## üìà Refactoring Recommendations

### Short-term (Low Risk)

1. **Extract common route utilities** from routes that duplicate code
2. **Split utils/cache.js** if it exceeds 500 lines (currently 274)
3. **Document circular dependency** between media-aggregator and playlist-cache

### Medium-term (Moderate Risk)

1. **Create media-source-facade.js** to reduce direct source dependencies
2. **Extract WebSocket command handlers** from lib/websocket-handlers.js
3. **Consolidate HTTP clients** into a single `utils/http-client.js` with adapters

### Long-term (High Risk)

1. **Break circular dependency** media-aggregator ‚Üî playlist-cache
    - Option A: Extract shared coordinator
    - Option B: Make playlist-cache emit events instead of calling aggregator
2. **Create plugin system** for media sources (reduce hard-coded dependencies)
3. **Extract admin routes** to separate Express app instance

---

## üîß Development Guidelines

### Adding a New Module

1. **Determine dependency level**: Place module at appropriate level (0-7)
2. **Minimize dependencies**: Only depend on lower levels
3. **Use dependency injection**: Accept dependencies as function parameters
4. **Document dependencies**: Add to this file

### Refactoring Existing Module

1. **Check dependents**: Use matrix above to find what imports your module
2. **Plan backward compatibility**: Maintain existing exports during transition
3. **Update tests**: Ensure all dependents still work
4. **Update this document**: Reflect new dependency relationships

### Avoiding Circular Dependencies

1. **Check dependency level**: Never depend on same or higher level
2. **Extract shared code**: Move common logic to lower level
3. **Use events**: Consider event emitters instead of direct calls
4. **Create facades**: Introduce abstraction layer

---

## üìö Related Documentation

- [MODULE-ARCHITECTURE.md](./MODULE-ARCHITECTURE.md) - Module structure and design patterns
- [ARCHITECTURE-DIAGRAMS.md](./ARCHITECTURE-DIAGRAMS.md) - Visual system diagrams
- [DEVELOPMENT.md](./DEVELOPMENT.md) - Development setup and workflows
- [SERVER-REFACTORING-PLAN.md](./SERVER-REFACTORING-PLAN.md) - Refactoring history

---

## üéØ Maintenance Checklist

**Update this document when**:

- ‚úÖ Adding new route, lib, or util module
- ‚úÖ Changing module dependencies (new imports)
- ‚úÖ Removing or merging modules
- ‚úÖ Introducing circular dependencies (document and plan resolution)
- ‚úÖ Splitting large modules into smaller ones
- ‚úÖ Creating new utility or helper functions

**Review dependency health**:

- Monthly: Check for new circular dependencies
- Quarterly: Analyze coupling metrics
- Before major releases: Audit dependency levels

---

**Document Version**: 1.0.0  
**Last Review**: 2025-01-20  
**Next Review**: After next major refactoring phase
