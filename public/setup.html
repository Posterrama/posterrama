<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Setup - Admin posterrama</title>
        <link rel="icon" type="image/svg+xml" href="/icons/posterrama-icon.svg?v=3" />
        <link rel="icon" type="image/x-icon" href="/favicon.ico?v=3" />
        <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png?v=2" />
        <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png?v=2" />
        <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=2" />
        <link rel="stylesheet" href="/admin.css" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
    </head>
    <body>
        <div class="auth-container">
            <!-- Step 1: Admin Account -->
            <div id="step1" class="auth-box panel">
                <div class="panel-content">
                    <h1 class="auth-title">
                        <div class="auth-title-row">
                            <i class="fas fa-rocket" style="opacity:.9; color: var(--color-primary);"></i>
                            <span class="auth-title-text">Setup</span>
                        </div>
                        <span class="auth-title-brand">posterrama</span>
                    </h1>
                    <h2 style="text-align:center; font-size:1.05rem; font-weight:600; margin:0 0 .75rem; color: var(--color-text-primary);">Step 1: Create Admin Account</h2>
                    <p style="text-align:center; margin:0 0 1.25rem; font-size:.85rem; line-height:1.4; color: var(--color-text-secondary);">Create an administrator account to continue.</p>
                    <form id="admin-form" class="form-compact">
                        <div class="form-group">
                            <input type="text" id="username" name="username" required placeholder="Admin username" autocomplete="username" />
                        </div>
                        <div class="form-group">
                            <input type="password" id="password" name="password" required minlength="8" placeholder="Password (min 8 chars)" autocomplete="new-password" />
                        </div>
                        <div class="auth-actions">
                            <button type="submit" class="btn auth-btn-primary btn-sm" id="continueStep1">
                                <span class="spinner" aria-hidden="true"></span>
                                <i class="fas fa-arrow-right" aria-hidden="true"></i>
                                <span>Continue</span>
                            </button>
                        </div>
                        <div id="errorStep1" class="error-inline" role="alert" aria-live="assertive"></div>
                    </form>
                </div>
            </div>

            <!-- Step 2: 2FA Setup (Initially Hidden) -->
            <div id="step2" class="auth-box panel steps-hidden">
                <div class="panel-content">
                    <h1 class="auth-title">
                        <div class="auth-title-row">
                            <i class="fas fa-shield-alt" style="opacity:.9; color: var(--color-primary);"></i>
                            <span class="auth-title-text">Setup</span>
                        </div>
                        <span class="auth-title-brand">posterrama</span>
                    </h1>
                    <h2 style="text-align:center; font-size:1.05rem; font-weight:600; margin:0 0 .75rem; color: var(--color-text-primary);">Step 2: Two-Factor Authentication</h2>
                    <p style="text-align:center; margin:0 0 1.25rem; font-size:.85rem; line-height:1.4; color: var(--color-text-secondary);">Would you like to enable 2FA to secure your admin panel?</p>
                    <div class="setup-choice">
                        <div class="choice-compact">
                            <div class="choice-info">
                                <h3>üîí Two-Factor Authentication</h3>
                                <p>Adds an extra layer of security using an authenticator app. <strong>Recommended for production environments.</strong></p>
                            </div>
                            <div class="choice-buttons">
                                <button type="button" id="enable-2fa-btn" class="btn auth-btn-primary btn-sm"><i class="fas fa-shield-alt"></i><span>Enable 2FA</span></button>
                                <button type="button" id="skip-2fa-btn" class="btn auth-btn-secondary btn-sm"><i class="fas fa-forward"></i><span>Skip for now</span></button>
                            </div>
                        </div>
                    </div>
                    <div class="setup-note"><i class="fas fa-info-circle"></i> You can always enable 2FA later from the admin panel settings.</div>
                    <div id="errorStep2" class="error-inline" role="alert" aria-live="assertive"></div>
                </div>
            </div>

            <!-- Step 3: 2FA Configuration (Initially Hidden) -->
            <div id="step3" class="auth-box panel steps-hidden">
                <div class="panel-content">
                    <h1 class="auth-title">
                        <div class="auth-title-row">
                            <i class="fas fa-mobile-alt" style="opacity:.9; color: var(--color-primary);"></i>
                            <span class="auth-title-text">Setup</span>
                        </div>
                        <span class="auth-title-brand">posterrama</span>
                    </h1>
                    <h2 style="text-align:center; font-size:1.05rem; font-weight:600; margin:0 0 .75rem; color: var(--color-text-primary);">Step 3: Configure 2FA</h2>
                    <ol class="info-list">
                        <li>Install an authenticator app (Google Authenticator, Authy, Microsoft Authenticator, etc.)</li>
                        <li>Scan the QR code below with your authenticator app</li>
                        <li>Enter the 6-digit code from your app to complete setup</li>
                        <li><strong>Note:</strong> This verification also tests your first login with 2FA</li>
                    </ol>
                    <div id="qr-container" style="text-align:center; margin:1.25rem 0">
                        <!-- QR code will be inserted here -->
                    </div>
                    <form id="verify-2fa-form" onsubmit="event.preventDefault(); verify2FA(document.getElementById('token').value);" class="form-compact">
                        <div class="form-group">
                            <input type="text" id="token" name="token" maxlength="6" placeholder="6-digit code" required style="text-align:center; letter-spacing:.25rem;" />
                        </div>
                        <div class="step-actions">
                            <button type="button" id="back-to-choice" class="btn auth-btn-secondary btn-sm" onclick="goBackToStep2()"><i class="fas fa-arrow-left"></i><span>Back</span></button>
                            <button type="submit" class="btn auth-btn-primary btn-sm" style="flex:1"><i class="fas fa-check"></i><span>Verify & Complete</span></button>
                        </div>
                    </form>
                    <div id="errorStep3" class="error-inline" role="alert" aria-live="assertive"></div>
                </div>
            </div>
        </div>
        <!-- Setup complete message, only tonen als ?complete=1 in de URL staat -->
        <script>
            let adminCredentials = null;

            // Setup wizard functionality
            document.addEventListener('DOMContentLoaded', function () {
                const step1 = document.getElementById('step1');
                const step2 = document.getElementById('step2');
                const step3 = document.getElementById('step3');
                const adminForm = document.getElementById('admin-form');
                const enable2faBtn = document.getElementById('enable-2fa-btn');
                const skip2faBtn = document.getElementById('skip-2fa-btn');
                const verify2faForm = document.getElementById('verify-2fa-form');
                const backToChoiceBtn = document.getElementById('back-to-choice');

                // Step 1: Admin account creation
                adminForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const errorBox = document.getElementById('errorStep1');
                    if (errorBox) { errorBox.textContent=''; errorBox.classList.remove('show'); }

                    if (!username || !password) {
                        if (errorBox) { errorBox.textContent = 'Please fill in all fields'; errorBox.classList.add('show'); }
                        return;
                    }

                    if (password.length < 8) {
                        if (errorBox) { errorBox.textContent = 'Password must be at least 8 characters long'; errorBox.classList.add('show'); }
                        return;
                    }

                    // Store credentials for later use
                    adminCredentials = { username, password };

                    // Move to step 2
                    step1.style.display = 'none';
                    step2.style.display = 'block';
                });

                // Step 2: 2FA choice
                skip2faBtn.addEventListener('click', async function () {
                    // Complete setup without 2FA
                    await completeSetup(false);
                });

                enable2faBtn.addEventListener('click', async function () {
                    // Move to step 3 and setup 2FA
                    step2.style.display = 'none';
                    step3.style.display = 'block';
                    await initiate2FASetup();
                });

                // Step 3: 2FA verification
                verify2faForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const token = document.getElementById('token').value;
                    const err3 = document.getElementById('errorStep3');
                    if (err3) { err3.textContent=''; err3.classList.remove('show'); }
                    if (token.length !== 6) {
                        if (err3) { err3.textContent='Please enter a 6-digit code'; err3.classList.add('show'); }
                        return;
                    }
                    await verify2FA(token);
                });

                backToChoiceBtn.addEventListener('click', function () {
                    step3.style.display = 'none';
                    step2.style.display = 'block';
                });
            });

            async function completeSetup(with2FA = false) {
                try {

                    const response = await fetch('/admin/setup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            username: adminCredentials.username,
                            password: adminCredentials.password,
                            enable2fa: with2FA ? 'true' : 'false',
                        }),
                    });

                    if (response.ok) {
                        window.location.href = '/setup.html?complete=1';
                    } else {
                        const error = await response.text();
                        console.error('‚ùå Setup failed:', error);
                        const err2 = document.getElementById('errorStep2');
                        if (err2) { err2.textContent='Setup failed: ' + error; err2.classList.add('show'); }
                    }
                } catch (error) {
                    console.error('üí• Setup error:', error);
                    const err2 = document.getElementById('errorStep2');
                    if (err2) { err2.textContent='Setup failed: ' + error.message; err2.classList.add('show'); }
                }
            }

            async function initiate2FASetup() {
                try {

                    // Create admin account with 2FA enabled
                    const setupResponse = await fetch('/admin/setup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            username: adminCredentials.username,
                            password: adminCredentials.password,
                            enable2fa: 'true', // Create account with 2FA enabled
                        }),
                    });


                    if (!setupResponse.ok) {
                        const errorText = await setupResponse.text();
                        console.error('‚ùå Admin account creation failed:', errorText);
                        throw new Error('Failed to create admin account: ' + errorText);
                    }

                    const setupData = await setupResponse.json();

                    // If setup included QR code, show it
                    if (setupData.qrCodeDataUrl) {
                        document.getElementById('qr-container').innerHTML =
                            `<img src="${setupData.qrCodeDataUrl}" alt="QR Code">`;
                    } else {
                        console.warn('No QR code in setup response, requesting separate 2FA setup');

                        // Login first to get session
                        const loginResponse = await fetch('/admin/login', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: new URLSearchParams({
                                username: adminCredentials.username,
                                password: adminCredentials.password,
                            }),
                        });

                        if (!loginResponse.ok) {
                            throw new Error('Failed to login after account creation');
                        }

                        // Now request 2FA setup
                        const tfaResponse = await fetch('/api/admin/2fa/setup', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Cache-Control': 'no-cache' },
                        });

                        if (!tfaResponse.ok) {
                            const errorText = await tfaResponse.text();
                            throw new Error('Failed to setup 2FA: ' + errorText);
                        }

                        const tfaData = await tfaResponse.json();
                        document.getElementById('qr-container').innerHTML =
                            `<img src="${tfaData.qrCodeDataUrl}" alt="QR Code">`;
                    }
                } catch (error) {
                    console.error('üí• 2FA setup error:', error);
                    const err2 = document.getElementById('errorStep2');
                    if (err2) { err2.textContent='2FA setup failed: ' + error.message; err2.classList.add('show'); }
                    // Return to step 2 for user to choose again
                    document.getElementById('step3').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                }
            }

            function goBackToStep2() {
                document.getElementById('step3').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
            }

            async function verify2FA(token) {
                // Prevent double execution
                if (verify2FA.isRunning) {
                    return;
                }
                verify2FA.isRunning = true;

                try {

                    // First, we need to login to establish a session for 2FA verification
                    const loginResponse = await fetch('/admin/login', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            username: adminCredentials.username,
                            password: adminCredentials.password,
                            totp_code: token, // Include 2FA code in login
                        }),
                    });


                    if (!loginResponse.ok) {
                        const errorText = await loginResponse.text();
                        console.error('‚ùå Login with 2FA failed:', errorText);
                        const err3 = document.getElementById('errorStep3');
                        if (err3) { err3.textContent='Verification failed: Invalid code or login error'; err3.classList.add('show'); }
                        return;
                    }


                    // Login successful with 2FA, setup is complete
                    window.location.href = '/setup.html?complete=1';
                } catch (error) {
                    console.error('üí• 2FA verification error:', error);
                    const err3 = document.getElementById('errorStep3');
                    if (err3) { err3.textContent='Verification failed: ' + error.message; err3.classList.add('show'); }
                } finally {
                    verify2FA.isRunning = false;
                }
            }

            // Original setup complete handling
            if (window.location.search.includes('complete=1')) {
                const msg = document.createElement('div');
                msg.className = 'setup-complete-message';
                msg.innerHTML = `<i class='fas fa-rocket'></i> <strong>Setup complete with 2FA!<br>You can now log in.<br>Redirecting shortly...</strong>`;
                document.querySelector('.auth-container').prepend(msg);
                const style = document.createElement('style');
                style.textContent = `.setup-complete-message {\n  margin: 2rem auto 1rem auto;\n  padding: 2rem 1.5rem;\n  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);\n  border-left: 5px solid #6366f1;\n  color: #e0e7ff;\n  font-size: 1.15rem;\n  font-weight: 500;\n  box-shadow: 0 8px 32px rgba(99,102,241,0.18);\n  border-radius: 14px;\n  text-align: center;\n  letter-spacing: 0.01em;\n  max-width: 400px;\n}\n.setup-complete-message strong {\n  color: #a5b4fc;\n  font-weight: 600;\n  display: block;\n  margin-top: 0.5rem;\n}\n.setup-complete-message i.fa-rocket {\n  color: #6366f1;\n  margin-right: 0.8rem;\n  font-size: 1.5rem;\n  vertical-align: middle;\n}`;
                document.head.appendChild(style);
                setTimeout(function () {
                    window.location.href = '/admin/login';
                }, 5000);
            }
        </script>
    </body>
</html>
