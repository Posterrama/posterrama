<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Posterrama Admin — Dashboard</title>
  <meta name="description" content="Posterrama Admin Dashboard for configuring media sources, display modes, devices, operations and monitoring your self-hosted poster server." />
  <!-- PWA: basic meta + manifest so admin2 independently registers the Service Worker -->
  <meta name="theme-color" content="#1a1d29" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/svg+xml" href="/icons/posterrama-icon.svg?v=3" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=3" />
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png?v=2" />
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png?v=2" />
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=2" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link rel="stylesheet" href="/admin.css?v={{ASSET_VERSION}}" />
  <link rel="stylesheet" href="/css/admin-logs-viewer.css?v={{ASSET_VERSION}}" />
  <script>
    // Remove any dynamically injected _next/static links from old caches or extensions
    if (typeof MutationObserver !== 'undefined') {
      new MutationObserver(mutations => {
        mutations.forEach(m => {
          m.addedNodes.forEach(node => {
            // Block <link>, <script>, and any element with _next in href/src
            if (node.tagName === 'LINK' && node.href && node.href.includes('_next')) {
              try { node.remove(); } catch(_) {}
            }
            if (node.tagName === 'SCRIPT' && node.src && node.src.includes('_next')) {
              try { node.remove(); } catch(_) {}
            }
          });
        });
      }).observe(document.documentElement, { childList: true, subtree: true });
    }
    // Also scan and remove any existing _next elements on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      // Remove all link tags (stylesheet, preload, prefetch, dns-prefetch, etc.)
      document.querySelectorAll('link[href*="_next"]').forEach(link => {
        try { link.remove(); } catch(_) {}
      });
      // Remove all script tags with _next src
      document.querySelectorAll('script[src*="_next"]').forEach(script => {
        try { script.remove(); } catch(_) {}
      });
    });
  </script>
  <style id="multiselect-overrides">
    /* Multiselect dropdown visibility & layering fixes */
    .multiselect { position: relative; }
    .multiselect .ms-menu { 
      position: absolute; 
      top: 100%;
      left: 0; 
      right: auto;
      min-width: 280px;
      background: var(--color-bg-elevated, #1f2330);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      padding: 8px 0 6px; 
      margin-top: 4px; 
      box-shadow: 0 8px 24px -4px rgba(0,0,0,0.55), 0 4px 12px -2px rgba(0,0,0,0.4);
      z-index: 1600; /* above side panels & other widgets */
      max-height: 340px; 
      overflow-y: auto; 
      overscroll-behavior: contain;
    }
    /* Ensure ancestor containers don't clip */
    .form-grid, .form-group, .panel-content, .panel, .form-subsection { overflow: visible !important; }
    /* When open, raise the multiselect container to create a local stacking context */
    .multiselect.ms-open { z-index: 1599; }
    /* Option list styling tweak compatibility (if admin.css already styles .ms-option) */
    .multiselect .ms-options { position: relative; }
    /* Prevent accidental horizontal scrollbars */
    .multiselect .ms-menu::-webkit-scrollbar { width: 10px; }
    .multiselect .ms-menu::-webkit-scrollbar-track { background: transparent; }
    .multiselect .ms-menu::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.18); border-radius: 6px; }
    .multiselect .ms-menu::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.28); }
    /* Defensive: if a parent has transform (creates new stacking context), allow body-level escape hatch */
    @media (min-width:0) {
      body.has-ms-portal .multiselect .ms-menu[data-portal="true"] { position: fixed; }
    }
  </style>
  
  <!-- Global Error Handler -->
  <script type="module" src="/error-handler.js"></script>
  
</head>
<body>
  <!-- Top navbar -->
  <nav class="navbar">
    <div class="nav-brand">
      <button class="btn btn-icon mobile-only" id="mobile-nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
        <i class="fas fa-bars"></i>
      </button>
      <img src="/logo.png" alt="Posterrama Logo" class="nav-logo" id="nav-logo-img" style="cursor: pointer;" title="Go to Dashboard" />
      <span>posterrama</span>
  <span class="version" id="app-version" title="Click to check for updates" style="margin-left:8px; cursor: pointer;">—</span>
  <span class="nav-badge" id="update-available-pill" hidden title="" style="margin-left:6px;">Update available</span>
    </div>
    <div class="nav-actions">
      <!-- Documentation Search (inline) -->
      <div class="doc-search-inline" id="doc-search-inline">
        <input type="search" 
               id="doc-search-input" 
               class="doc-search-input" 
               placeholder="Search help..." 
               autocomplete="off"
               autocorrect="off"
               autocapitalize="off"
               spellcheck="false"
               data-form-type="other"
               data-lpignore="true"
               readonly
               onfocus="this.removeAttribute('readonly'); this.value='';">
        <div class="doc-search-icon-circle">
          <i class="fas fa-search"></i>
        </div>
        <div class="doc-search-dropdown" id="doc-search-results" hidden></div>
      </div>
      
      <div class="dropdown" id="notif-dropdown">
        <button class="btn btn-icon dropdown-toggle" id="notif-btn" title="Notifications" aria-haspopup="true" aria-expanded="false" aria-controls="notif-menu">
          <i class="fas fa-bell"></i>
          <span class="badge" id="notif-count" hidden>0</span>
        </button>
        <div class="dropdown-menu" id="notif-menu" role="menu" aria-hidden="true"></div>
      </div>
  <div class="dropdown" id="settings-dropdown">
  <button type="button" class="btn btn-icon dropdown-toggle" id="settings-btn" title="Settings" aria-haspopup="true" aria-expanded="false" aria-controls="settings-menu">
          <i class="fas fa-cog"></i>
        </button>
        <div class="dropdown-menu" id="settings-menu" role="menu" aria-hidden="true">
          <div class="dropdown-heading">Quick links</div>
          <a class="dropdown-item" href="/" target="_blank" rel="noopener" title="Open Posterrama in a new tab">
            <i class="fas fa-external-link-alt"></i>
            <span>View Posterrama</span>
          </a>
          
          <a class="dropdown-item" href="/api-docs" target="_blank" rel="noopener">
            <i class="fas fa-book"></i>
            <span>API Docs</span>
          </a>
          <a class="dropdown-item" href="https://github.com/Posterrama/posterrama" target="_blank" rel="noopener">
            <i class="fab fa-github"></i>
            <span>GitHub Repository</span>
          </a>
          <a class="dropdown-item" href="https://github.com/Posterrama/posterrama/issues/new/choose" target="_blank" rel="noopener">
            <i class="fas fa-bug"></i>
            <span>Report an Issue</span>
          </a>
          <div class="dropdown-divider"></div>
          <div class="dropdown-heading">Monitoring</div>
          <a class="dropdown-item" href="#" id="menu-performance" data-nav="performance">
            <i class="fas fa-chart-line"></i>
            <span>Performance</span>
          </a>
          <a class="dropdown-item" href="/logs" target="_blank" rel="noopener" id="menu-logs">
            <i class="fas fa-terminal"></i>
            <span>Logs</span>
          </a>
          <div class="dropdown-divider"></div>
          <div class="dropdown-heading">Server</div>
          <a class="dropdown-item" href="#" id="menu-restart">
            <i class="fas fa-rotate"></i>
            <span>Restart Posterrama</span>
          </a>
        </div>
      </div>
      <div class="dropdown nav-user" id="user-dropdown">
  <button type="button" class="btn btn-icon dropdown-toggle" id="user-btn" title="Account" aria-haspopup="true" aria-expanded="false" aria-controls="user-menu">
          <i class="fas fa-user-circle"></i>
          <span>Admin</span>
        </button>
        <div class="dropdown-menu dropdown-right" id="user-menu" role="menu" aria-hidden="true">
          <div class="dropdown-heading">Account</div>
          <a class="dropdown-item" href="#" id="user-change-password">
            <i class="fas fa-key"></i>
            <span>Change Password</span>
          </a>
          <a class="dropdown-item" href="#" id="user-two-fa">
            <i class="fas fa-user-lock"></i>
            <span>Two‑Factor</span>
          </a>
          <a class="dropdown-item" href="#" id="user-profile-photo">
            <i class="fas fa-image"></i>
            <span>Profile Photo</span>
          </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="/admin/logout" id="user-logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <aside class="sidebar">
    <nav class="sidebar-nav">
      <a href="#" class="nav-item active" data-nav="dashboard">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
      </a>
      <a href="#" class="nav-item" data-nav="display">
        <i class="fas fa-desktop"></i>
        <span>Display Settings</span>
      </a>
      <a href="#" class="nav-item" data-nav="media-sources">
        <i class="fas fa-server"></i>
        <span>Media Sources</span>
      </a>
      <a href="#" class="nav-item" data-nav="devices">
        <i class="fas fa-laptop"></i>
        <span>Device Management</span>
      </a>
      <a href="#" class="nav-item" data-nav="operations"><i class="fas fa-screwdriver-wrench"></i><span>Operations</span></a>
    </nav>
  <div class="sidebar-footer"></div>
  </aside>

  <div class="sidebar-overlay" id="sidebar-overlay" hidden></div>

  <!-- Main content -->
  <main class="main-content">
    <header class="page-header">
      <div class="page-title">
  
      </div>
      <div class="page-actions">
        <button id="btn-configure-cards" class="btn-icon" title="Configure Dashboard Cards" style="background: none; border: none; color: var(--color-text-secondary); cursor: pointer; padding: 8px; margin-right: 8px; transition: all 0.2s ease;">
          <i class="fas fa-sliders-h" style="font-size: 1.1rem;"></i>
        </button>
        <span class="header-pill" id="perf-activity" title="Overall system activity (CPU and memory)">
          <i class="fas fa-wave-square"></i>
          <span class="label">Activity</span>
          <span class="value">—</span>
        </span>
      </div>
    </header>

  <!-- Dashboard Section -->
  <section id="section-dashboard" class="app-section active">
  <!-- KPI cards -->
  <section class="card-grid" id="kpi-cards">
      <div class="status-card status-success" title="Devices that are Online or Live">
        <div class="card-icon"><i class="fas fa-check-circle"></i></div>
        <div class="card-content">
          <h3>Active Devices</h3>
          <span class="metric" id="metric-active-devices">—</span>
          <span class="trend" id="metric-active-trend"></span>
        </div>
      </div>
      <div class="status-card status-info" id="media-items-card" title="Total media items across connected sources">
        <div class="card-icon"><i class="fas fa-photo-film"></i></div>
        <div class="card-content">
          <h3>Media Items</h3>
          <div class="metric-row"><span class="metric" id="metric-media-items">—</span><sup class="sources-sup" id="metric-sources-info" title=""></sup></div>
          <span class="trend" id="metric-media-sub">from sources</span>
        </div>
      </div>
      <div class="status-card status-warning" id="mode-card" title="Current display mode and key settings">
        <div class="card-icon"><i id="metric-mode-icon" class="fas fa-image"></i></div>
        <div class="card-content">
          <h3>Active Mode</h3>
          <span class="metric" id="metric-mode">—</span>
          <span class="trend" id="metric-mode-sub"></span>
        </div>
      </div>
      <div class="status-card status-error" title="Devices currently Offline">
        <div class="card-icon"><i class="fas fa-times-circle"></i></div>
        <div class="card-content">
          <h3>Offline Devices</h3>
          <span class="metric" id="metric-offline-devices">—</span>
          <span class="trend negative" id="metric-offline-sub">needs attention</span>
        </div>
      </div>
    </section>

  <section class="content-grid" style="margin-top: var(--space-lg);">
      <!-- Unified System Performance Dashboard -->
      <section id="panel-perf-dashboard" style="display: flex; flex-direction: column; gap: var(--space-lg);">
        <div class="perf-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; display: flex; align-items: center;">
            <span style="display: inline-flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); color: var(--color-text-primary); padding: 6px 16px; border-radius: 20px; font-size: 0.95rem; font-weight: 500; letter-spacing: 0.3px;">
              <i class="fas fa-gauge-high" style="opacity: 0.8;"></i>
              System Performance
            </span>
          </h2>
          
          <!-- Status pills in header -->
          <div class="perf-pills" style="display: flex; gap: 16px; align-items: center;">
            <span class="header-pill status-success" id="perf-app-status" title="Application server status">
              <i class="fas fa-rocket"></i>
              <span class="label">Application</span>
              <span class="value">Running</span>
            </span>
            <span class="header-pill status-info" id="perf-db-status" title="Storage status">
              <i class="fas fa-hdd"></i>
              <span class="label">Storage</span>
              <span class="value">Healthy</span>
            </span>
            <span class="header-pill status-warning" id="perf-cache-status" title="Cache system status">
              <i class="fas fa-bolt"></i>
              <span class="label">Cache</span>
              <span class="value">Active</span>
            </span>
            <!-- Uptime moved here as a pill only -->
            <span class="header-pill" id="perf-uptime-pill" title="Server uptime">
              <i class="fas fa-clock"></i>
              <span class="label">Uptime</span>
              <span class="value" id="perf-uptime">—</span>
            </span>
          </div>
        </div>
        
        <!-- Resource usage cards -->
        <div class="dashboard-cards-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
            
            <!-- Resources card -->
            <div style="background: linear-gradient(135deg, var(--color-bg-card), var(--color-bg-tertiary)); border-radius: 12px; padding: 24px; box-shadow: var(--shadow-md);">
              <h3 style="margin: 0 0 20px 0; font-size: 1.1rem; font-weight: 600; color: var(--color-text-primary); display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-microchip" style="color: var(--color-info);"></i>
                System Resources
              </h3>
              
              <div style="display: grid; gap: 20px;">
                <!-- CPU -->
                <div>
                  <div class="resource-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="resource-label" style="font-size: 0.9rem; color: var(--color-text-secondary); font-weight: 500;">CPU Usage</span>
                    <span class="resource-value" style="font-size: 0.9rem; font-weight: 600; color: var(--color-text-primary);" id="perf-cpu">—</span>
                  </div>
                  <div style="width: 100%; height: 8px; background: var(--color-bg-secondary); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, var(--color-info), var(--color-info-dark)); border-radius: 4px; transition: width 0.6s ease; width: 0%;" id="meter-cpu"></div>
                  </div>
                </div>
                
                <!-- Memory -->
                <div>
                  <div class="resource-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="resource-label" style="font-size: 0.9rem; color: var(--color-text-secondary); font-weight: 500;">Memory Usage</span>
                    <span class="resource-value" style="font-size: 0.9rem; font-weight: 600; color: var(--color-text-primary);" id="perf-mem">—</span>
                  </div>
                  <div style="width: 100%; height: 8px; background: var(--color-bg-secondary); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, var(--color-success), var(--color-success-dark)); border-radius: 4px; transition: width 0.6s ease; width: 0%;" id="meter-mem"></div>
                  </div>
                </div>

                <!-- Disk Usage: full-width bar like CPU/Memory -->
                <div>
                  <div class="resource-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="resource-label" style="font-size: 0.9rem; color: var(--color-text-secondary); font-weight: 500;">Disk Usage</span>
                    <span class="resource-value" style="font-size: 0.9rem; font-weight: 600; color: var(--color-text-primary);" id="perf-disk">—</span>
                  </div>
                  <div style="width: 100%; height: 8px; background: var(--color-bg-secondary); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, var(--color-info), var(--color-info-dark)); border-radius: 4px; transition: width 0.6s ease; width: 0%;" id="meter-disk"></div>
                  </div>
                </div>

                <!-- Load Average under Disk Usage -->
                <div id="perf-loadavg-container" style="margin-top: 8px;">
                  <div class="load-average-row" style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 4px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--color-text-secondary);">
                      <i class="fas fa-chart-line" style="color: var(--color-info);"></i>
                      <span style="font-size: 0.9rem; font-weight: 500;">Load</span>
                    </div>
                    <div class="load-average-badges" style="display: flex; gap: 8px; align-items: center;">
                      <span class="load-badge" style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 4px 10px; border-radius: 9999px; font-size: 0.85rem; font-weight: 600; min-width: 48px; text-align: center; font-variant-numeric: tabular-nums;" id="perf-loadavg-1">—</span>
                      <span class="load-badge" style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 4px 10px; border-radius: 9999px; font-size: 0.85rem; font-weight: 600; min-width: 48px; text-align: center; font-variant-numeric: tabular-nums;" id="perf-loadavg-5">—</span>
                      <span class="load-badge" style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 4px 10px; border-radius: 9999px; font-size: 0.85rem; font-weight: 600; min-width: 48px; text-align: center; font-variant-numeric: tabular-nums;" id="perf-loadavg-15">—</span>
                    </div>
                  </div>
                  
                </div>
                
              </div>
            </div>

            <!-- Cache management card -->
            <div style="background: linear-gradient(135deg, var(--color-bg-card), var(--color-bg-tertiary)); border-radius: 12px; padding: 24px; box-shadow: var(--shadow-md);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--color-text-primary); display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-database" style="color: var(--color-warning);"></i>
                  Cache
                </h3>
                <button type="button" class="btn btn-icon btn-sm cache-edit-btn" id="btn-edit-cache-size" style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-secondary); padding: 8px; border-radius: 6px; font-size: 0.8rem; transition: all 0.2s ease;">
                  <i class="fas fa-pen"></i>
                </button>
              </div>
              
              <!-- Storage usage -->
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="font-size: 0.85rem; color: var(--color-text-secondary);">Storage</span>
                  <span style="font-size: 0.85rem; font-weight: 600; color: var(--color-text-primary);" id="cache-disk-usage">Loading…</span>
                </div>
                <div style="width: 100%; height: 6px; background: var(--color-bg-secondary); border-radius: 3px; overflow: hidden;">
                  <div style="height: 100%; background: linear-gradient(90deg, var(--color-warning), var(--color-warning-dark)); border-radius: 3px; transition: width 0.6s ease; width: 0%;" id="meter-image-cache"></div>
                </div>
              </div>
              
              <!-- Cache Performance -->
              <div style="margin-bottom: 24px;">
                <div style="font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 8px;">Cache Performance</div>
                <div style="display: flex; gap: 16px;">
                  <div style="flex: 1;">
                    <div style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-bottom: 4px;">Hit Ratio</div>
                    <div style="font-size: 1.1rem; font-weight: 600; color: var(--color-success);" id="cache-hit-ratio">—</div>
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-bottom: 4px;">Requests</div>
                    <div style="font-size: 1.1rem; font-weight: 600; color: var(--color-text-primary);" id="cache-total-requests">—</div>
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-bottom: 4px;">Items (RAM)</div>
                    <div style="font-size: 1.1rem; font-weight: 600; color: var(--color-text-primary);" id="cache-item-count">—</div>
                  </div>
                </div>
              </div>
              
              <!-- Actions -->
              <div style="display: flex !important; flex-direction: row !important; gap: 8px !important;">
                <button type="button" id="cleanup-cache-button" style="flex: 1; padding: 10px 16px; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 8px; font-size: 0.85rem; font-weight: 500; color: var(--color-text-primary); display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <i class="fas fa-compress-alt"></i>
                  <span>Run Cleanup</span>
                </button>
                <button type="button" id="clear-cache-button" style="flex: 1; padding: 10px 16px; background: var(--color-error); border: 1px solid var(--color-error); border-radius: 8px; font-size: 0.85rem; font-weight: 500; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <i class="fas fa-broom"></i>
                  <span>Clear Cache</span>
                </button>
              </div>
            </div>
          </div>
      </section>
    </section>
    </section> <!-- /section-dashboard -->


    <!-- Display Settings -->
    <section id="section-display" class="app-section" hidden>
      
      <!-- Profile Edit Mode Banner (hidden by default) -->
      <div id="profile-edit-banner" class="profile-edit-banner" style="display: none;">
        <div class="profile-edit-banner-content">
          <i class="fas fa-user-cog"></i>
          <span>Editing Profile: <strong id="profile-edit-name">—</strong></span>
          <span class="profile-edit-hint">Changes will be saved to this profile, not the global settings</span>
        </div>
        <div class="profile-edit-banner-actions">
          <button class="btn btn-sm btn-secondary" id="btn-profile-edit-cancel"><i class="fas fa-times"></i> Cancel</button>
          <button class="btn btn-sm btn-primary" id="btn-profile-edit-save"><i class="fas fa-save"></i> Save to Profile</button>
        </div>
      </div>
      
      <div class="panel" id="panel-display" style="border: none; background: transparent; box-shadow: none;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; display: flex; align-items: center;">
            <span style="display: inline-flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); color: var(--color-text-primary); padding: 6px 16px; border-radius: 20px; font-size: 0.95rem; font-weight: 500; letter-spacing: 0.3px;">
              <i class="fas fa-desktop" style="opacity: 0.8;"></i>
              Display Settings
            </span>
          </h2>
          <div class="section-header-actions" style="display: flex; gap: 12px; align-items: center;">
            <span class="status-pill status-info" id="display-mode-pill" title="Current display mode">Mode: —</span>
            <button class="btn btn-primary btn-sm" id="btn-save-display"><span class="spinner" style="display:none"></span><i class="fas fa-save"></i><span>Save Settings</span></button>
          </div>
        </div>
        <div class="panel-content" style="padding: 0;">
          
          <!-- Floating Live Preview (reuses /preview page) -->
          <div id="display-preview-container" class="pip-mode screensaver-mode">
            <div class="preview-shell">
              <div class="preview-drag-handle" title="Drag preview"></div>
              <div class="preview-tools">
                <button type="button" id="toggle-preview-zoom" class="pip-button" title="Zoom 1.4x">
                  <i class="fas fa-search-plus"></i>
                </button>
              </div>
              <iframe id="display-preview-frame" class="preview-frame" title="Display Settings Live Preview" src="/screensaver?preview=1"></iframe>
            </div>
          </div>
          <!-- Active mode selector -->
          <div class="mode-card" id="card-active-mode" style="margin-bottom: 16px;">
            <div class="card-title" style="margin-bottom:12px;"><i class="fas fa-layer-group"></i> Active Mode</div>
            <div class="form-row">
              <div class="segmented" role="tablist" aria-label="Display Mode">
                <label class="seg" id="seg-saver" role="tab" aria-controls="card-screensaver" aria-checked="false">
                  <input type="radio" name="display.mode" id="mode-screensaver" value="screensaver" />
                  <i class="fas fa-image"></i> Screensaver
                </label>
                <label class="seg" id="seg-wallart" role="tab" aria-controls="card-wallart" aria-checked="false">
                  <input type="radio" name="display.mode" id="mode-wallart" value="wallart" />
                  <i class="fas fa-images"></i> Wallart
                </label>
                <label class="seg" id="seg-cinema" role="tab" aria-controls="card-cinema" aria-checked="false">
                  <input type="radio" name="display.mode" id="mode-cinema" value="cinema" />
                  <i class="fas fa-tv" style="transform: rotate(90deg);"></i> Cinema
                </label>
              </div>

            </div>
          </div>

          <!-- Mode-specific settings placed directly under Active Mode for better hierarchy -->
          <div id="mode-cards-top">
            <!-- Screensaver settings (active when mode = screensaver) -->
            <div id="card-screensaver" hidden>
              <fieldset id="fs-screensaver">
                <div class="form-grid masonry" id="saver-cards" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
                  <!-- Presets + Summary card (first by default) -->
                  <div class="mode-card" id="saver-presets-card" data-card-key="presets" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-sliders-h"></i> Presets</div>
                    <div class="scaling-presets" style="display:flex; flex-wrap:wrap; gap:8px;">
                      <button type="button" class="btn btn-secondary btn-sm" id="saver-preset-chill" title="Ken Burns, slower cadence"><i class="fas fa-wind"></i> <span>Chill</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="saver-preset-standard" title="Fade, balanced cadence"><i class="fas fa-balance-scale"></i> <span>Standard</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="saver-preset-lively" title="Slide, faster cadence"><i class="fas fa-bolt"></i> <span>Lively</span></button>
                      <button type="button" class="btn btn-outline btn-sm" id="saver-preset-reset" title="Reset to sensible defaults"><i class="fas fa-undo"></i> <span>Reset</span></button>
                    </div>
                    <div class="card-title" style="font-size:.95rem; margin:10px 0 6px;"><i class="fas fa-info-circle"></i> Current Experience</div>
                    <div id="saver-summary" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                      <span class="status-pill" id="saver-summary-interval" title="Poster change interval">Every — s</span>
                      <span class="status-pill" id="saver-summary-effect" title="Visual transition">Effect: —</span>
                      <span class="status-pill" id="saver-summary-pause" title="Pause after transition">Pause: —</span>
                      <span class="status-pill" id="saver-summary-clock" title="Clock widget status">Clock: —</span>
                    </div>
                  </div>
                  
                  <!-- Orientation card -->
                  <div class="mode-card" data-card-key="screensaver-orientation" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-mobile-alt"></i> Screen Orientation</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <div class="select-wrap has-caret">
                          <select id="screensaverOrientation">
                            <option value="auto">Auto</option>
                            <option value="portrait">Portrait</option>
                            <option value="landscape">Landscape</option>
                            <option value="portrait-flipped">Portrait (flipped)</option>
                            <option value="landscape-flipped">Landscape (flipped)</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- MOVED: Shared sections now live inside Screensaver -->
                  <!-- Visual Elements -->
                  <div class="mode-card" id="sec-visual" data-card-key="visual">
                    <div class="card-title" style="margin-bottom:10px;"><i class="fas fa-eye"></i> Visual Elements</div>
                    <div class="checkbox-row">
                      <label class="checkbox" for="showPoster">
                        <input type="checkbox" id="showPoster" />
                        <span class="checkmark"></span>
                        <span>Poster</span>
                      </label>
                      <label class="checkbox" for="showMetadata">
                        <input type="checkbox" id="showMetadata" />
                        <span class="checkmark"></span>
                        <span>Metadata</span>
                      </label>
                      <label class="checkbox" for="showClearLogo">
                        <input type="checkbox" id="showClearLogo" />
                        <span class="checkmark"></span>
                        <span>Clearlogo</span>
                      </label>
                      <label class="checkbox" for="showRottenTomatoes">
                        <input type="checkbox" id="showRottenTomatoes" />
                        <span class="checkmark"></span>
                        <span>Rotten Tomatoes</span>
                      </label>
                    </div>
                    <div class="form-grid" style="margin-top:12px;">
                      <div class="form-row full-span"><label for="rottenTomatoesMinimumScore">Minimum RT Score (0–10)</label><div class="number-input-wrapper"><input type="number" min="0" max="10" step="0.5" id="rottenTomatoesMinimumScore" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div></div>
                    </div>
                  </div>

                  <!-- Clock Widget -->
                  <div class="mode-card" id="sec-clock" data-card-key="clock">
                    <div class="card-title" style="margin-bottom:10px;"><i class="fas fa-clock"></i> Clock Widget
                      <label class="header-toggle" for="clockWidget" style="margin-left:auto;">
                        <input type="checkbox" id="clockWidget" />
                        <span class="ht-switch" aria-hidden="true"></span>
                        <span class="ht-text">Show clock</span>
                      </label>
                    </div>
                    <div class="form-grid">
                      
                      <div class="form-row"><label for="clockTimezone">Timezone</label><div class="select-wrap has-caret"><select id="clockTimezone"><option value="auto">Auto (System Timezone)</option><optgroup label="Common Timezones"><option value="Europe/Amsterdam">Europe/Amsterdam (CET/CEST)</option><option value="Europe/London">Europe/London (GMT/BST)</option><option value="Europe/Berlin">Europe/Berlin (CET/CEST)</option><option value="Europe/Paris">Europe/Paris (CET/CEST)</option><option value="America/New_York">America/New_York (EST/EDT)</option><option value="America/Chicago">America/Chicago (CST/CDT)</option><option value="America/Denver">America/Denver (MST/MDT)</option><option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option><option value="Asia/Tokyo">Asia/Tokyo (JST)</option><option value="Asia/Shanghai">Asia/Shanghai (CST)</option><option value="Australia/Sydney">Australia/Sydney (AEST/AEDT)</option></optgroup><optgroup label="Additional Timezones"><option value="UTC">UTC (Coordinated Universal Time)</option><option value="Africa/Cairo">Africa/Cairo (EET)</option><option value="Africa/Johannesburg">Africa/Johannesburg (SAST)</option><option value="America/Argentina/Buenos_Aires">America/Argentina/Buenos_Aires (ART)</option><option value="America/Mexico_City">America/Mexico_City (CST/CDT)</option><option value="America/Sao_Paulo">America/Sao_Paulo (BRT/BRST)</option><option value="America/Toronto">America/Toronto (EST/EDT)</option><option value="America/Vancouver">America/Vancouver (PST/PDT)</option><option value="Asia/Bangkok">Asia/Bangkok (ICT)</option><option value="Asia/Dubai">Asia/Dubai (GST)</option><option value="Asia/Hong_Kong">Asia/Hong_Kong (HKT)</option><option value="Asia/Jakarta">Asia/Jakarta (WIB)</option><option value="Asia/Kolkata">Asia/Kolkata (IST)</option><option value="Asia/Seoul">Asia/Seoul (KST)</option><option value="Asia/Singapore">Asia/Singapore (SGT)</option><option value="Asia/Taipei">Asia/Taipei (CST)</option><option value="Australia/Brisbane">Australia/Brisbane (AEST)</option><option value="Australia/Melbourne">Australia/Melbourne (AEST/AEDT)</option><option value="Australia/Perth">Australia/Perth (AWST)</option><option value="Europe/Athens">Europe/Athens (EET/EEST)</option><option value="Europe/Istanbul">Europe/Istanbul (TRT)</option><option value="Europe/Moscow">Europe/Moscow (MSK)</option><option value="Europe/Rome">Europe/Rome (CET/CEST)</option><option value="Europe/Stockholm">Europe/Stockholm (CET/CEST)</option><option value="Europe/Zurich">Europe/Zurich (CET/CEST)</option><option value="Pacific/Auckland">Pacific/Auckland (NZST/NZDT)</option><option value="Pacific/Honolulu">Pacific/Honolulu (HST)</option></optgroup></select><span class="select-caret" aria-hidden="true">▾</span></div></div>
                      <div class="form-row"><label for="clockFormat">Format</label><div class="select-wrap has-caret"><select id="clockFormat"><option value="24h">24-hour</option><option value="12h">12-hour</option></select><span class="select-caret" aria-hidden="true">▾</span></div></div>
                    </div>
                  </div>

                  <!-- UI Element Scaling -->
                  <div class="mode-card" id="sec-scaling" data-card-key="scaling">
                    <div class="card-title" style="margin-bottom:10px;"><i class="fas fa-expand-arrows-alt"></i> UI Element Scaling</div>
                    <div class="form-grid">
                      <div class="form-row"><label for="uiScaling_content">Content</label><div class="modern-slider"><input type="range" id="uiScaling_content" min="50" max="200" step="5" value="100" /><div class="slider-percentage" data-target="uiScaling.content">100%</div></div></div>
                      <div class="form-row"><label for="uiScaling_clearlogo">Clearlogo</label><div class="modern-slider"><input type="range" id="uiScaling_clearlogo" min="50" max="200" step="5" value="100" /><div class="slider-percentage" data-target="uiScaling.clearlogo">100%</div></div></div>
                      <div class="form-row"><label for="uiScaling_clock">Clock</label><div class="modern-slider"><input type="range" id="uiScaling_clock" min="50" max="200" step="5" value="100" /><div class="slider-percentage" data-target="uiScaling.clock">100%</div></div></div>
                      <div class="form-row"><label for="uiScaling_global">Global</label><div class="modern-slider"><input type="range" id="uiScaling_global" min="50" max="200" step="5" value="100" /><div class="slider-percentage" data-target="uiScaling.global">100%</div></div></div>
                    </div>
                    <!-- Presets -->
                    <div class="form-row" style="margin-top:8px;">
                      <div class="scaling-presets" style="display:flex; flex-wrap:wrap; gap:8px;">
                        <button type="button" class="btn btn-secondary btn-sm" id="preset-4k-tv"><i class="fas fa-tv"></i> <span>4K TV</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" id="preset-full-hd"><i class="fas fa-desktop"></i> <span>Full HD</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" id="preset-ultrawide"><i class="fas fa-expand-arrows-alt"></i> <span>Ultrawide</span></button>
                        <button type="button" class="btn btn-outline btn-sm" id="reset-ui-scaling"><i class="fas fa-undo"></i> <span>Reset</span></button>
                      </div>
                    </div>
                  </div>

                  <!-- Effects & Transitions -->
                  <div class="mode-card" id="sec-effects" data-card-key="effects">
                    <div class="card-title" style="margin-bottom:10px;"><i class="fas fa-magic"></i> Effects & Transitions</div>
                    <div class="form-grid">
                      <div class="form-row"><label for="transitionEffect">Transition effect</label><div class="select-wrap has-caret"><select id="transitionEffect"><option value="kenburns">Ken Burns</option><option value="fade">Fade In/Out</option><option value="slide">Slide Transition</option></select><span class="select-caret" aria-hidden="true">▾</span></div></div>
                      <div class="form-row"><label for="effectPauseTime">Effect pause (seconds)</label><div class="number-input-wrapper"><input type="number" min="0" max="10" step="0.5" id="effectPauseTime" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div></div>
                    </div>
                  </div>

                  <!-- Playback Timing -->
                  <div class="mode-card" id="sec-playback" data-card-key="playback">
                    <div class="card-title" style="margin-bottom:10px;"><i class="fas fa-cogs"></i> Playback Timing</div>
                    <div class="form-grid">
                      <div class="form-row"><label for="transitionIntervalSeconds">Transition interval (seconds)</label><div class="number-input-wrapper"><input type="number" min="1" max="300" step="1" id="transitionIntervalSeconds" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div></div>
                    </div>
                  </div>

              </fieldset>
            </div>

            <!-- Wallart settings -->
            <div id="card-wallart" style="margin-top:12px;" hidden>
              <fieldset id="fs-wallart">
                <div class="form-grid masonry" id="wallart-cards" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
                  <!-- Presets + Summary card (mirrors Screensaver) -->
                  <div class="mode-card" id="wallart-presets-card" data-card-key="presets" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-sliders-h"></i> Presets</div>
                    <div class="scaling-presets" id="wallart-presets-general" style="display:flex; flex-wrap:wrap; gap:8px;">
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-gallery" title="Dense grid, smooth fade"><i class="fas fa-th"></i> <span>Gallery</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-hero" title="Hero left, medium grid cadence"><i class="fas fa-user-astronaut"></i> <span>Hero Focus</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-vibe" title="Ambient gradient, slow"> <i class="fas fa-water"></i> <span>Ambient Vibe</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-museum" title="Slow, calm rotation for museum-like atmosphere"><i class="fas fa-landmark"></i> <span>Museum</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-dynamic" title="Fast-paced with high variety"><i class="fas fa-bolt"></i> <span>Dynamic</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-lounge" title="Relaxed tempo with subtle UI"><i class="fas fa-couch"></i> <span>Lounge</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-focus" title="Minimal randomness, predictable"><i class="fas fa-crosshairs"></i> <span>Focus</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-showcase" title="Moderate speed with larger UI"><i class="fas fa-star"></i> <span>Showcase</span></button>
                      <button type="button" class="btn btn-outline btn-sm" id="wallart-preset-reset" title="Reset to sensible defaults"><i class="fas fa-undo"></i> <span>Reset</span></button>
                    </div>
                    <div class="scaling-presets" id="wallart-presets-music" style="display:none; flex-wrap:wrap; gap:8px;">
                      <button type="button" class="btn btn-secondary btn-sm" id="music-preset-vinyl" title="Classic vinyl spin with medium grid"><i class="fas fa-record-vinyl"></i> <span>Vinyl Lounge</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="music-preset-artist" title="Artist cards with full-screen photos"><i class="fas fa-user-music"></i> <span>Artist Focus</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="music-preset-disco" title="High density with flip animation"><i class="fas fa-compact-disc"></i> <span>Disco Wall</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="music-preset-minimal" title="Clean covers-only, low density"><i class="fas fa-border-none"></i> <span>Minimalist</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="music-preset-jazz" title="Slow crossfade with album info"><i class="fas fa-guitar"></i> <span>Jazz Club</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="music-preset-party" title="Fast, energetic with slide-fade"><i class="fas fa-music"></i> <span>Party Mode</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="music-preset-audiophile" title="Detailed metadata, medium pace"><i class="fas fa-headphones-alt"></i> <span>Audiophile</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="music-preset-gallery" title="High density grid showcase"><i class="fas fa-album-collection"></i> <span>Collection</span></button>
                      <button type="button" class="btn btn-outline btn-sm" id="music-preset-reset" title="Reset to music defaults"><i class="fas fa-undo"></i> <span>Reset</span></button>
                    </div>
                    <div class="card-title" style="font-size:.95rem; margin:10px 0 6px;"><i class="fas fa-info-circle"></i> Current Experience</div>
                    <div id="wallart-summary" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                      <span class="status-pill" id="wallart-summary-density" title="Poster density">Density: —</span>
                      <span class="status-pill" id="wallart-summary-layout" title="Layout variant">Layout: —</span>
                      <span class="status-pill" id="wallart-summary-anim" title="Animation type">Anim: —</span>
                      <span class="status-pill" id="wallart-summary-tempo" title="Refresh/Randomness">Tempo: —</span>
                    </div>
                  </div>
                  
                  <!-- Orientation card -->
                  <div class="mode-card" data-card-key="wallart-orientation" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-mobile-alt"></i> Screen Orientation</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <div class="select-wrap has-caret">
                          <select id="wallartOrientation">
                            <option value="auto">Auto</option>
                            <option value="portrait">Portrait</option>
                            <option value="landscape">Landscape</option>
                            <option value="portrait-flipped">Portrait (flipped)</option>
                            <option value="landscape-flipped">Landscape (flipped)</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Tempo card -->
                  <div class="mode-card" data-card-key="tempo" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-tachometer-alt"></i> Tempo</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="wallartMode_refreshRate">Poster Refresh Rate</label>
                        <div class="modern-slider">
                          <input type="range" min="1" max="10" step="1" id="wallartMode_refreshRate" value="5" />
                          <div class="slider-percentage" data-target="wallartMode.refreshRate">Medium</div>
                        </div>
                      </div>
                      <div class="form-row">
                        <label for="wallartMode_randomness">Timing Randomness</label>
                        <div class="modern-slider">
                          <input type="range" min="0" max="10" step="1" id="wallartMode_randomness" value="3" />
                          <div class="slider-percentage" data-target="wallartMode.randomness">Low</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Animation card -->
                  <div class="mode-card" data-card-key="animation" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-magic"></i> Animation</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_animationType">
                            <option value="random">Random — Uses all animations</option>
                            <option value="fade">Fade — Smooth opacity</option>
                            <option value="slideLeft">Slide Left — From right</option>
                            <option value="slideUp">Slide Up — From bottom</option>
                            <option value="zoom">Zoom — Scale in</option>
                            <option value="flip">Flip — 3D flip</option>
                            <option value="staggered">Staggered — Rows/columns</option>
                            <option value="ripple">Ripple — Wave from center</option>
                            <option value="scanline">Scanline — Horizontal sweep</option>
                            <option value="parallax">Parallax — Subtle depth</option>
                            <option value="parallaxDepth">Parallax Depth — Multi-layer scrolling</option>
                            <option value="neonPulse">Neon Pulse — Soft glow</option>
                            <option value="chromaticShift">Chromatic Shift — RGB split</option>
                            <option value="mosaicShatter">Mosaic Shatter — Tiles assemble</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Parallax Depth Settings card (conditional) -->
                  <div class="mode-card" id="wallart-parallax-depth-card" data-card-key="parallaxDepth" style="padding:12px;display:none;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;">
                      <i class="fas fa-layer-group"></i> Parallax Depth Settings
                    </div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="wallartMode_parallaxDepth_layerCount" title="Number of depth layers: more layers create a stronger 3D effect but use more resources">
                          Layer Count
                          <i class="fas fa-info-circle" style="font-size:0.85em; opacity:0.6; margin-left:4px;"></i>
                        </label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_parallaxDepth_layerCount" title="Number of depth layers: more layers create a stronger 3D effect but use more resources">
                            <option value="2">2 Layers — Background + Foreground</option>
                            <option value="3" selected>3 Layers — Background + Mid + Foreground</option>
                            <option value="4">4 Layers — Maximum depth</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                      <div class="form-row">
                        <label for="wallartMode_parallaxDepth_speed" title="Controls how fast the posters scroll: higher values = faster movement">
                          Parallax Intensity
                          <i class="fas fa-info-circle" style="font-size:0.85em; opacity:0.6; margin-left:4px;"></i>
                        </label>
                        <div class="slider-container">
                          <input type="range" id="wallartMode_parallaxDepth_speed" min="0.1" max="2.0" step="0.1" value="1.0" title="Controls how fast the posters scroll: higher values = faster movement" />
                          <span class="slider-value" id="wallartMode_parallaxDepth_speed_value">1.0x</span>
                        </div>
                      </div>
                      <div class="form-row">
                        <label for="wallartMode_parallaxDepth_depthScale" title="How much foreground posters scale up: higher values = more dramatic size difference between layers">
                          Depth Scale
                          <i class="fas fa-info-circle" style="font-size:0.85em; opacity:0.6; margin-left:4px;"></i>
                        </label>
                        <div class="slider-container">
                          <input type="range" id="wallartMode_parallaxDepth_depthScale" min="1.0" max="2.0" step="0.05" value="1.3" title="How much foreground posters scale up: higher values = more dramatic size difference between layers" />
                          <span class="slider-value" id="wallartMode_parallaxDepth_depthScale_value">1.3x</span>
                        </div>
                      </div>
                      <div class="form-row">
                        <label class="checkbox" for="wallartMode_parallaxDepth_smoothScroll" title="Enables ease-out interpolation for smoother, more cinematic scrolling motion">
                          <input type="checkbox" id="wallartMode_parallaxDepth_smoothScroll" checked />
                          <span class="checkmark"></span>
                          <span>
                            Smooth scroll interpolation
                            <i class="fas fa-info-circle" style="font-size:0.85em; opacity:0.6; margin-left:4px;"></i>
                          </span>
                        </label>
                      </div>
                      <div class="form-row">
                        <label for="wallartMode_parallaxDepth_perspective" title="CSS 3D perspective depth: lower values = more dramatic 3D effect, higher values = more subtle">
                          3D Perspective
                          <i class="fas fa-info-circle" style="font-size:0.85em; opacity:0.6; margin-left:4px;"></i>
                        </label>
                        <div class="slider-container">
                          <input type="range" id="wallartMode_parallaxDepth_perspective" min="500" max="2000" step="100" value="1000" title="CSS 3D perspective depth: lower values = more dramatic 3D effect, higher values = more subtle" />
                          <span class="slider-value" id="wallartMode_parallaxDepth_perspective_value">1000px</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Layout card -->
                  <div class="mode-card" data-card-key="layout" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-th-large"></i> Layout</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="wallartMode_density">Density</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_density">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="ludicrous">Ludicrous</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                      <div class="form-row">
                        <label for="wallartMode_layoutVariant">Variant</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_layoutVariant">
                            <option value="heroGrid">Hero Grid</option>
                            <option value="filmCards">Film Cards</option>
                            <option value="classic">Classic</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                      
                    </div>
                  </div>

                  <!-- Film Cards Settings card -->
                  <div class="mode-card" id="wallart-filmcards-card" data-card-key="filmcards" style="padding:12px; display:none;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;">
                      <i class="fas fa-film"></i> Film Cards Spotlight
                    </div>
                    <div class="form-grid">
                      <!-- Group By -->
                      <div class="form-row">
                        <label for="wallartMode_filmCards_groupBy">
                          Group By
                          <span class="help-text">Spotlight theme</span>
                        </label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_filmCards_groupBy">
                            <option value="director" selected>Director</option>
                            <option value="genre">Genre</option>
                            <option value="actor">Actor</option>
                            <option value="collection">Collection</option>
                            <option value="random">Random</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>

                      <!-- Card Rotation Interval -->
                      <div class="form-row">
                        <label for="wallartMode_filmCards_cardRotationSeconds">
                          Group Interval
                          <span class="help-text">seconds</span>
                        </label>
                        <div class="number-input-wrapper">
                          <input type="number" id="wallartMode_filmCards_cardRotationSeconds" min="10" max="300" value="60" step="10" />
                          <div class="number-controls" role="group">
                            <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                            <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                          </div>
                        </div>
                      </div>

                      <!-- Poster Rotation Interval -->
                      <div class="form-row">
                        <label for="wallartMode_filmCards_posterRotationSeconds">
                          Poster Interval
                          <span class="help-text">seconds</span>
                        </label>
                        <div class="number-input-wrapper">
                          <input type="number" id="wallartMode_filmCards_posterRotationSeconds" min="5" max="120" value="15" step="5" />
                          <div class="number-controls" role="group">
                            <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                            <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                          </div>
                        </div>
                      </div>

                      <!-- Minimum Group Size -->
                      <div class="form-row">
                        <label for="wallartMode_filmCards_minGroupSize">
                          Min Group Size
                          <span class="help-text">Films per group</span>
                        </label>
                        <div class="number-input-wrapper">
                          <input type="number" id="wallartMode_filmCards_minGroupSize" min="1" max="20" value="3" step="1" />
                          <div class="number-controls" role="group">
                            <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                            <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                          </div>
                        </div>
                      </div>

                      <!-- Accent Color - Component Container -->
                      <div id="filmcards-color-picker-container"></div>
                    </div>
                  </div>

                  <!-- Ambience card -->
                  <div class="mode-card" data-card-key="ambience" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-lightbulb"></i> Ambience
                      <label class="header-toggle" for="wallartMode_ambientGradient" style="margin-left:auto;">
                        <input type="checkbox" id="wallartMode_ambientGradient" />
                        <span class="ht-switch" aria-hidden="true"></span>
                        <span class="ht-text">Ambient gradient</span>
                      </label>
                    </div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label class="checkbox" for="wallartMode_biasAmbientToHero">
                          <input type="checkbox" id="wallartMode_biasAmbientToHero" />
                          <span class="checkmark"></span>
                          <span>Bias ambient to hero</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Games Mode card -->
                  <div class="mode-card" id="wallart-games-card" data-card-key="games" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;">
                      <i class="fas fa-gamepad"></i> Games Mode
                      <label class="header-toggle" for="wallartMode_gamesOnly" style="margin-left:auto;">
                        <input type="checkbox" id="wallartMode_gamesOnly" />
                        <span class="ht-switch" aria-hidden="true"></span>
                      </label>
                    </div>
                    <div class="form-grid" id="games-mode-settings">
                      <!-- Settings would go here if needed in the future -->
                    </div>
                    <small class="form-help" id="wallart-games-only-help">Exclusive mode: when enabled, only game covers from RomM will be displayed (no movies, series, or music)</small>
                  </div>

                  <!-- Music Mode card -->
                  <div class="mode-card" id="wallart-music-card" data-card-key="music" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;">
                      <i class="fas fa-music"></i> Music Mode
                      <label class="header-toggle" for="wallartMode_musicMode_enabled" style="margin-left:auto;">
                        <input type="checkbox" id="wallartMode_musicMode_enabled" />
                        <span class="ht-switch" aria-hidden="true"></span>
                      </label>
                    </div>
                    <div class="form-grid" id="music-mode-settings">
                      <!-- Display Style -->
                      <div class="form-row">
                        <label for="wallartMode_musicMode_displayStyle">Display Style</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_musicMode_displayStyle">
                            <option value="covers-only" selected>Album Covers Only</option>
                            <option value="album-info">Album + Artist Info</option>
                            <option value="artist-cards">Artist Cards</option>
                            <option value="grid">Grid</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>

                      <!-- Animation Type -->
                      <div class="form-row" id="musicMode_animationRow">
                        <label for="wallartMode_musicMode_animation">Animation</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_musicMode_animation">
                            <option value="vinyl-spin" selected>Vinyl Spin (Rotating)</option>
                            <option value="slide-fade">Slide & Fade</option>
                            <option value="crossfade">Crossfade</option>
                            <option value="flip">Flip</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>

                      <!-- Density -->
                      <div class="form-row" id="musicMode_densityRow">
                        <label for="wallartMode_musicMode_density">Density</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_musicMode_density">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="ludicrous">Ludicrous</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>

                      <!-- Display Options -->
                      <div class="form-row" id="musicMode_displayOptionsRow" style="display: flex; flex-wrap: wrap; gap: 16px 24px;">
                        <label class="checkbox" for="wallartMode_musicMode_showArtist">
                          <input type="checkbox" id="wallartMode_musicMode_showArtist" />
                          <span class="checkmark"></span>
                          <span>Show artist name</span>
                        </label>

                        <label class="checkbox" for="wallartMode_musicMode_showAlbumTitle">
                          <input type="checkbox" id="wallartMode_musicMode_showAlbumTitle" />
                          <span class="checkmark"></span>
                          <span>Show album title</span>
                        </label>

                        <label class="checkbox" for="wallartMode_musicMode_showYear">
                          <input type="checkbox" id="wallartMode_musicMode_showYear" />
                          <span class="checkmark"></span>
                          <span>Show release year</span>
                        </label>

                        <label class="checkbox" for="wallartMode_musicMode_showGenre">
                          <input type="checkbox" id="wallartMode_musicMode_showGenre" />
                          <span class="checkmark"></span>
                          <span>Show genre</span>
                        </label>
                      </div>

                      <!-- Artist Rotation Interval (only for artist-cards) -->
                      <div class="form-row" id="musicMode_artistRotationRow" style="display: none;">
                        <label for="wallartMode_musicMode_artistRotationSeconds">Artist Rotation (seconds)</label>
                        <div class="number-input-wrapper">
                          <input type="number" min="10" max="600" step="10" id="wallartMode_musicMode_artistRotationSeconds" />
                          <div class="number-controls" role="group">
                            <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                            <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                          </div>
                        </div>
                        <small class="form-help">How long each artist is displayed before rotating to the next one</small>
                      </div>

                      <!-- Album Rotation -->
                      <div class="form-row" id="musicMode_albumRotationRow" style="display: none;">
                        <label for="wallartMode_musicMode_albumRotationSeconds">Album Rotation (seconds)</label>
                        <div class="number-input-wrapper">
                          <input type="number" min="5" max="120" step="5" id="wallartMode_musicMode_albumRotationSeconds" />
                          <div class="number-controls" role="group">
                            <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                            <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                          </div>
                        </div>
                        <small class="form-help">How often album covers rotate within artist cards (artist-cards style only)</small>
                      </div>

                      <!-- Accent Color (only for artist-cards) - Component Container -->
                      <div class="form-row" id="musicMode_accentColorRow" style="display: none;">
                        <div id="artistcards-color-picker-container"></div>
                      </div>

                      <!-- Album Sorting Mode -->
                      <div class="form-row">
                        <label for="wallartMode_musicMode_sortMode">Album Sorting</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_musicMode_sortMode">
                            <option value="weighted-random">Smart Mix (Recommended)</option>
                            <option value="recent">Recently Added</option>
                            <option value="popular">Most Played</option>
                            <option value="alphabetical">Alphabetical (A-Z)</option>
                            <option value="random">Pure Random</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                        <small class="form-help">How albums are selected and ordered for display</small>
                      </div>

                      <!-- Smart Mix Weights (only for weighted-random) -->
                      <div id="musicMode_sortWeightsRow" style="display: none; margin-left: 1rem; padding: 1rem; background: var(--color-bg-subtle); border-radius: 8px; border-left: 3px solid var(--color-primary);">
                        <div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--color-text-primary);"><i class="fas fa-sliders"></i> Smart Mix Weights</div>
                        
                        <div class="form-row" style="margin-bottom: 0.75rem;">
                          <label for="wallartMode_musicMode_sortWeight_recent" style="font-size: 0.9rem;">Recent Albums</label>
                          <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="range" id="wallartMode_musicMode_sortWeight_recent" min="0" max="100" step="5" style="flex: 1;" />
                            <span id="wallartMode_musicMode_sortWeight_recent_value" style="min-width: 3rem; text-align: right; font-weight: 600; color: var(--color-primary);">20%</span>
                          </div>
                          <small class="form-help">Albums recently added to your library</small>
                        </div>

                        <div class="form-row" style="margin-bottom: 0.75rem;">
                          <label for="wallartMode_musicMode_sortWeight_popular" style="font-size: 0.9rem;">Popular Albums</label>
                          <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="range" id="wallartMode_musicMode_sortWeight_popular" min="0" max="100" step="5" style="flex: 1;" />
                            <span id="wallartMode_musicMode_sortWeight_popular_value" style="min-width: 3rem; text-align: right; font-weight: 600; color: var(--color-primary);">30%</span>
                          </div>
                          <small class="form-help">Highly rated albums</small>
                        </div>

                        <div class="form-row">
                          <label for="wallartMode_musicMode_sortWeight_random" style="font-size: 0.9rem;">Random Albums</label>
                          <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="range" id="wallartMode_musicMode_sortWeight_random" min="0" max="100" step="5" style="flex: 1;" />
                            <span id="wallartMode_musicMode_sortWeight_random_value" style="min-width: 3rem; text-align: right; font-weight: 600; color: var(--color-primary);">50%</span>
                          </div>
                          <small class="form-help">Random selection for variety and rediscovering albums</small>
                        </div>

                        <small class="form-help" style="display: block; margin-top: 0.75rem; font-style: italic; color: var(--color-text-secondary);">Adjust weights to balance between new, popular, and rediscovered albums. Total doesn't need to equal 100%.</small>
                      </div>
                    </div>
                    <small class="form-help" id="music-mode-help">Exclusive mode: when enabled, only album covers from your Plex music library will be displayed (no movies, series, or games). Configure music library, genres, and artists in the Plex media Source.</small>
                  </div>

                  <!-- Hero settings card (shown for Hero Grid) -->
                  <div class="mode-card" id="wallart-hero-card" data-card-key="hero" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-user-astronaut"></i> Hero Settings</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="wallartMode_heroSide">Hero side</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_heroSide">
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                      <div class="form-row">
                        <label for="wallartMode_heroRotationMinutes">Hero rotation (min)</label>
                        <div class="number-input-wrapper"><input type="number" min="1" max="60" id="wallartMode_heroRotationMinutes" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div>
                      </div>
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>

            <!-- Cinema settings -->
            <div id="card-cinema" style="margin-top:12px;" hidden>
              <fieldset id="fs-cinema">
                <div class="form-grid masonry" id="cinema-cards">
                  <!-- Presets: first card (top-left) -->
                  <div class="mode-card" id="cinema-presets-card" data-card-key="cinema-presets" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-palette"></i> Presets</div>
                    <div id="cinema-presets-mount">
                      <!-- System preset buttons (exact same style as before) -->
                      <div class="scaling-presets" style="display:flex; flex-wrap:wrap; gap:8px;">
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="classicCinema" title="Classic cinema experience"><i class="fas fa-film"></i> <span>Classic</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="noir" title="Film noir style"><i class="fas fa-moon"></i> <span>Noir</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="neonNights" title="Neon nights vibes"><i class="fas fa-bolt"></i> <span>Neon</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="vintageTheater" title="Vintage theater feel"><i class="fas fa-ticket-alt"></i> <span>Vintage</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="modernMinimal" title="Modern minimal look"><i class="fas fa-minus"></i> <span>Minimal</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="filmProjector" title="Film projector style"><i class="fas fa-video"></i> <span>Projector</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="blockbuster" title="Blockbuster premiere"><i class="fas fa-star"></i> <span>Blockbuster</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="artDeco" title="Art deco elegance"><i class="fas fa-gem"></i> <span>Art Deco</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="driveIn" title="Drive-in theater"><i class="fas fa-car"></i> <span>Drive-In</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="imaxPremium" title="IMAX premium experience"><i class="fas fa-expand"></i> <span>IMAX</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="indieFilm" title="Indie film aesthetic"><i class="fas fa-camera"></i> <span>Indie</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" data-cin-preset="homeTheater" title="Home theater comfort"><i class="fas fa-couch"></i> <span>Home</span></button>
                        <button type="button" class="btn btn-outline btn-sm" data-cin-preset="reset" title="Reset to defaults" style="color: var(--color-accent);"><i class="fas fa-undo"></i> <span>Reset</span></button>
                      </div>
                      <!-- Separator -->
                      <hr style="border: none; border-top: 1px solid var(--color-border); margin: 12px 0;">
                      <!-- Custom presets section -->
                      <div class="card-title" style="font-size:.85rem; margin-bottom:8px;"><i class="fas fa-user"></i> My Presets</div>
                      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        <div class="select-wrap has-caret" style="flex:0 0 auto;">
                          <select id="cinemaPresetSelect" style="min-width:200px; padding-right:24px;">
                            <option value="">No saved presets</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="cinemaPresetSave" title="Save current settings as preset">
                          <i class="fas fa-save"></i> <span>Save</span>
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="cinemaPresetDelete" title="Delete a saved preset">
                          <i class="fas fa-trash"></i> <span>Delete</span>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- Right: Orientation -->
                  <div class="mode-card" data-card-key="orientation" style="padding:12px; grid-column: 1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-mobile-alt"></i> Screen Orientation</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <div class="select-wrap has-caret">
                          <select id="cinemaOrientation">
                            <option value="auto">Auto</option>
                            <option value="portrait">Portrait</option>
                            <option value="portrait-flipped">Portrait (flipped)</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Rotation Interval -->
                  <div class="mode-card" data-card-key="cinema-rotation" style="padding:12px; grid-column: 1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-sync-alt"></i> Poster Rotation Interval</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="cinemaRotationInterval">
                          Minutes
                          <span class="help-text">0.5 = 30 sec, 0 = off</span>
                        </label>
                        <div class="number-input-wrapper"><input type="number" min="0" step="0.5" id="cinemaRotationInterval" placeholder="0=disabled" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div>
                      </div>
                    </div>
                  </div>
                  <!-- Now Playing Integration -->
                  <div class="mode-card" data-card-key="cinema-now-playing" id="cinema-now-playing-card" style="padding:12px; grid-column: 1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-play-circle"></i> Now Playing</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="cinemaNowPlayingPriority">
                          Session Priority
                          <span class="help-text">Multiple sessions</span>
                        </label>
                        <div class="select-wrap has-caret">
                          <select id="cinemaNowPlayingPriority">
                            <option value="first">First active session</option>
                            <option value="random">Random active session</option>
                            <option value="user">Specific user</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                      <div class="form-row" id="cinemaNowPlayingFilterUserRow" style="display:none;">
                        <label for="cinemaNowPlayingFilterUser">
                          Plex Username
                          <span class="help-text">Filter by user</span>
                        </label>
                        <div class="select-wrap has-caret">
                          <select id="cinemaNowPlayingFilterUser">
                            <option value="">Loading users...</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                      <div class="form-row">
                        <label for="cinemaNowPlayingInterval">
                          Update Interval
                        </label>
                        <div class="number-input-wrapper"><input type="number" min="5" max="300" step="5" id="cinemaNowPlayingInterval" placeholder="15" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div>
                      </div>
                      
                      <!-- Timeline Border Section -->
                      <div style="grid-column: 1 / -1; margin-top: 12px; margin-bottom: 4px; padding-top: 12px; border-top: 1px solid var(--color-border); color: var(--color-text-secondary); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-border-all" style="margin-right: 4px;"></i> Timeline Progress Border
                      </div>
                      
                      <div class="form-row">
                        <label class="checkbox" for="cinemaTimelineBorderEnabled">
                          <input type="checkbox" id="cinemaTimelineBorderEnabled">
                          <span class="checkmark"></span>
                          <span>Enable <span class="help-text" style="font-weight:normal;">(show playback progress)</span></span>
                        </label>
                      </div>
                      
                      <div class="form-row" id="timelineBorderThicknessRow">
                        <label for="cinemaTimelineBorderThickness">
                          Thickness
                          <span class="help-text">Border width (px)</span>
                        </label>
                        <div class="number-input-wrapper"><input type="number" min="1" max="10" step="1" id="cinemaTimelineBorderThickness" placeholder="3" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div>
                      </div>
                      
                      <div class="form-row" id="timelineBorderStyleRow">
                        <label for="cinemaTimelineBorderStyle">
                          Style
                          <span class="help-text">Border appearance</span>
                        </label>
                        <div class="select-wrap has-caret">
                          <select id="cinemaTimelineBorderStyle">
                            <option value="solid">Solid</option>
                            <option value="dashed">Dashed</option>
                            <option value="dotted">Dotted</option>
                            <option value="neon">Neon</option>
                          </select>
                        </div>
                      </div>
                      
                      <div class="form-row" id="timelineBorderColorModeRow">
                        <label for="cinemaTimelineBorderColorMode">
                          Color Mode
                          <span class="help-text">Manual or auto from poster</span>
                        </label>
                        <div class="select-wrap has-caret">
                          <select id="cinemaTimelineBorderColorMode">
                            <option value="custom">Custom Color</option>
                            <option value="auto">Auto (Ton-sur-Ton)</option>
                          </select>
                        </div>
                      </div>
                      
                      <div class="form-row" id="timelineBorderColorRow">
                        <div id="timeline-border-color-picker-container"></div>
                      </div>
                      
                      <div class="form-row" id="timelineBorderOpacityRow">
                        <label for="cinemaTimelineBorderOpacity">
                          Opacity
                          <span class="help-text">0-100%</span>
                        </label>
                        <div class="number-input-wrapper"><input type="number" min="10" max="100" step="10" id="cinemaTimelineBorderOpacity" placeholder="60" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div>
                      </div>
                      
                      <div class="form-row" id="timelineBorderGradientRow">
                        <label class="checkbox" for="cinemaTimelineBorderGradient">
                          <input type="checkbox" id="cinemaTimelineBorderGradient">
                          <span class="checkmark"></span>
                          <span>Gradient <span class="help-text" style="font-weight:normal;">(color shifts with progress)</span></span>
                        </label>
                      </div>
                      
                      <div class="form-row" id="timelineBorderGlowRow">
                        <label class="checkbox" for="cinemaTimelineBorderGlow">
                          <input type="checkbox" id="cinemaTimelineBorderGlow">
                          <span class="checkmark"></span>
                          <span>Glow Effect</span>
                        </label>
                      </div>
                      
                      <div class="form-row" id="timelineBorderPausedRow">
                        <label class="checkbox" for="cinemaTimelineBorderPaused">
                          <input type="checkbox" id="cinemaTimelineBorderPaused" checked>
                          <span class="checkmark"></span>
                          <span>Paused Indicator <span class="help-text" style="font-weight:normal;">(pulse when paused)</span></span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Global Effects Card -->
                  <div class="mode-card" data-card-key="cinema-global-effects" id="cinema-global-effects-card" style="padding:12px; grid-column: 1 / -1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-magic"></i> Global Effects</div>
                    <div id="cinema-global-effects-mount">
                      <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                        <!-- Typography Section Header -->
                        <div style="grid-column: 1 / -1; margin-bottom: 4px; color: var(--color-text-secondary); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Typography (syncs to Header & Footer)</div>
                        
                        <div class="form-row">
                          <label for="cinemaGlobalFont">Font Family</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaGlobalFont">
                              <option value="system">System (Default)</option>
                              <option value="cinematic">Cinematic (Bebas Neue)</option>
                              <option value="classic">Classic (Playfair)</option>
                              <option value="modern">Modern (Montserrat)</option>
                              <option value="elegant">Elegant (Cormorant)</option>
                              <option value="marquee">Marquee (Broadway)</option>
                              <option value="retro">Retro (Press Start)</option>
                              <option value="neon">Neon (Tilt Neon)</option>
                              <option value="scifi">Sci-Fi (Space Grotesk)</option>
                              <option value="poster">Poster (Oswald)</option>
                              <option value="epic">Epic (Cinzel)</option>
                              <option value="bold">Bold (Lilita One)</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <div class="form-row">
                          <label for="cinemaGlobalTextColorMode">Text Color Mode</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaGlobalTextColorMode">
                              <option value="custom">Custom Color</option>
                              <option value="tonSurTon">Ton-sur-ton (Auto)</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <div id="cinema-global-text-color-picker-container" class="cinema-conditional-row"></div>
                        <div class="form-row cinema-conditional-row" id="cinemaGlobalTstIntensityRow" style="display: none;">
                          <label for="cinemaGlobalTstIntensity">Color Intensity</label>
                          <div class="modern-slider">
                            <input type="range" id="cinemaGlobalTstIntensity" min="10" max="100" step="5" value="45" />
                            <div class="slider-bar"><div class="fill"></div></div>
                          </div>
                          <div class="slider-percentage" data-target="cinema.globalEffects.tonSurTonIntensity">45%</div>
                        </div>
                        <div class="form-row">
                          <label for="cinemaGlobalTextEffect">Text Effect</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaGlobalTextEffect">
                              <option value="none">None</option>
                              <option value="subtle">Subtle Shadow</option>
                              <option value="dramatic">Dramatic Shadow</option>
                              <option value="neon">Neon Glow</option>
                              <option value="glow">Soft Glow</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        
                        <!-- Visual Effects Section Header -->
                        <div style="grid-column: 1 / -1; margin-top: 12px; margin-bottom: 4px; color: var(--color-text-secondary); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Visual Effects</div>
                        
                        <div class="form-row">
                          <label for="cinemaColorFilter">Color Filter</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaColorFilter">
                              <option value="none">None</option>
                              <option value="sepia">Sepia</option>
                              <option value="cool">Cool (Blue)</option>
                              <option value="warm">Warm (Orange)</option>
                              <option value="tint">Custom Tint</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <div id="cinema-tint-color-picker-container" class="cinema-conditional-row" style="display:none;"></div>
                        <div class="form-row">
                          <label for="cinemaContrast">Contrast</label>
                          <div class="slider-with-reset">
                            <div class="modern-slider">
                              <input type="range" id="cinemaContrast" min="50" max="150" step="5" value="100" />
                              <div class="slider-bar"><div class="fill"></div></div>
                            </div>
                            <button type="button" class="reset-btn" data-reset-target="cinemaContrast" data-reset-value="100" title="Reset to 100%"><i class="fas fa-undo"></i></button>
                          </div>
                          <div class="slider-percentage" data-target="cinema.globalEffects.contrast">100%</div>
                        </div>
                        <div class="form-row">
                          <label for="cinemaBrightness">Brightness</label>
                          <div class="slider-with-reset">
                            <div class="modern-slider">
                              <input type="range" id="cinemaBrightness" min="50" max="150" step="5" value="100" />
                              <div class="slider-bar"><div class="fill"></div></div>
                            </div>
                            <button type="button" class="reset-btn" data-reset-target="cinemaBrightness" data-reset-value="100" title="Reset to 100%"><i class="fas fa-undo"></i></button>
                          </div>
                          <div class="slider-percentage" data-target="cinema.globalEffects.brightness">100%</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Next row: Header (left) and Footer (right) -->
                  <div class="mode-card" data-card-key="cinema-header" id="cinema-header-card" style="padding:12px; grid-column: 1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-heading"></i> Header</div>
                    <div id="cinema-header-mount"></div>
                  </div>
                  <div class="mode-card" data-card-key="cinema-footer" id="cinema-footer-card" style="padding:12px; break-before: column; -webkit-column-break-before: always;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-window-maximize"></i> Footer</div>
                    <div id="cinema-footer-mount"></div>
                  </div>

                  <!-- Background Settings (Issue #35) -->
                  <div class="mode-card" data-card-key="cinema-background" id="cinema-background-card" style="padding:12px; grid-column: 1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-fill-drip"></i> Background</div>
                    <div id="cinema-background-mount">
                      <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-row">
                          <label for="cinemaBackgroundMode">Mode</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaBackgroundMode">
                              <option value="solid">Solid Color</option>
                              <option value="blurred">Blurred Poster</option>
                              <option value="gradient">Dynamic Gradient</option>
                              <option value="ambient">Ambient Color</option>
                              <option value="spotlight">Spotlight</option>
                              <option value="starfield">Starfield</option>
                              <option value="curtain">Theater Curtain</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <div class="form-row">
                          <label for="cinemaVignette">Vignette</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaVignette">
                              <option value="none">None</option>
                              <option value="subtle">Subtle</option>
                              <option value="dramatic">Dramatic</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <!-- Background Color - Component Container -->
                        <div id="cinema-background-color-picker-container" class="cinema-conditional-row" style="grid-column: 1 / -1;"></div>
                        <div class="form-row cinema-conditional-row" id="cinemaBackgroundBlurRow" style="display:none; grid-column: 1 / -1;">
                          <label for="cinemaBackgroundBlur">Blur Amount</label>
                          <div class="modern-slider">
                            <input type="range" id="cinemaBackgroundBlur" min="5" max="50" step="1" value="20" />
                            <div class="slider-bar"><div class="fill"></div></div>
                          </div>
                          <div class="slider-percentage" data-target="cinema.background.blurAmount">20px</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Poster Style Settings (Issue #35) -->
                  <div class="mode-card" data-card-key="cinema-poster" id="cinema-poster-card" style="padding:12px; grid-column: 1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-image"></i> Poster Style</div>
                    <div id="cinema-poster-mount">
                      <div class="form-grid">
                        <div class="form-row">
                          <label for="cinemaPosterStyle">Display Style</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaPosterStyle">
                              <option value="fullBleed">Full Bleed (Edge to Edge)</option>
                              <option value="framed">Classic Frame</option>
                              <option value="floating">Floating (Shadow)</option>
                              <option value="polaroid">Polaroid</option>
                              <option value="shadowBox">Shadow Box (3D)</option>
                              <option value="neon">Neon Glow</option>
                              <option value="doubleBorder">Double Border</option>
                              <option value="ornate">Ornate Corners</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <div class="form-row">
                          <label for="cinemaPosterOverlay">Overlay Effect</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaPosterOverlay">
                              <option value="none">None</option>
                              <option value="grain">Film Grain</option>
                              <option value="paper">Fold Creases</option>
                              <option value="monochrome">Monochrome</option>
                              <option value="oldMovie">Old Movie</option>
                              <option value="scanlines">Scanlines</option>
                              <option value="vhs">VHS Retro</option>
                              <option value="vintage">Vintage B&W</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <!-- Frame Color Mode -->
                        <div class="form-row cinema-conditional-row" id="cinemaFrameColorModeRow" style="display:none;">
                          <label for="cinemaFrameColorMode">Frame Color</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaFrameColorMode">
                              <option value="custom">Custom Color</option>
                              <option value="tonSurTonLight">Ton-sur-ton (Light)</option>
                              <option value="tonSurTonDark">Ton-sur-ton (Dark)</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <!-- Frame Color - Component Container -->
                        <div id="cinema-frame-color-picker-container" class="cinema-conditional-row" style="display:none;"></div>
                        <div class="form-row cinema-conditional-row" id="cinemaFrameWidthRow" style="display:none;">
                          <label for="cinemaFrameWidth">Frame Width</label>
                          <div class="modern-slider">
                            <input type="range" id="cinemaFrameWidth" min="2" max="20" step="1" value="8" />
                            <div class="slider-bar"><div class="fill"></div></div>
                          </div>
                          <div class="slider-percentage" data-target="cinema.poster.frameWidth">8px</div>
                        </div>
                        <div class="cinema-section-header">Cinematic Transitions</div>
                        <div class="form-row">
                          <label for="cinemaTransitionMode">Selection Mode</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaTransitionMode">
                              <option value="random">Random</option>
                              <option value="sequential">Sequential</option>
                              <option value="smart">Smart (Genre-based)</option>
                              <option value="single">Single</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <div class="form-row" id="singleTransitionRow" style="display:none;">
                          <label for="cinemaSingleTransition">Single Transition</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaSingleTransition">
                              <option value="fade">Fade</option>
                              <option value="zoomIn">Zoom In</option>
                              <option value="slideUp">Slide Up</option>
                              <option value="cinematic">Cinematic Reveal</option>
                              <option value="lightFlare">Light Flare</option>
                              <option value="shatter">Shatter</option>
                              <option value="spotlight">Spotlight</option>
                              <option value="unfold">Unfold</option>
                              <option value="swing">Swing</option>
                              <option value="ripple">Ripple</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <div class="form-row transitions-row" id="enabledTransitionsRow">
                          <label>Enabled Transitions</label>
                          <div class="transitions-checklist" id="enabledTransitionsGrid">
                            <label class="toggle-row"><input type="checkbox" value="fade" checked><span>Fade</span></label>
                            <label class="toggle-row"><input type="checkbox" value="zoomIn" checked><span>Zoom In</span></label>
                            <label class="toggle-row"><input type="checkbox" value="slideUp" checked><span>Slide Up</span></label>
                            <label class="toggle-row"><input type="checkbox" value="cinematic" checked><span>Cinematic Reveal</span></label>
                            <label class="toggle-row"><input type="checkbox" value="lightFlare" checked><span>Light Flare</span></label>
                            <label class="toggle-row"><input type="checkbox" value="shatter" checked><span>Shatter</span></label>
                            <label class="toggle-row"><input type="checkbox" value="spotlight" checked><span>Spotlight</span></label>
                            <label class="toggle-row"><input type="checkbox" value="unfold" checked><span>Unfold</span></label>
                            <label class="toggle-row"><input type="checkbox" value="swing" checked><span>Swing</span></label>
                            <label class="toggle-row"><input type="checkbox" value="ripple" checked><span>Ripple</span></label>
                          </div>
                        </div>
                        <div class="form-row">
                          <label for="cinemaPosterTransition">Transition Duration</label>
                          <div class="modern-slider">
                            <input type="range" id="cinemaPosterTransition" min="0.5" max="5" step="0.5" value="1.5" />
                            <div class="slider-bar"><div class="fill"></div></div>
                          </div>
                          <div class="slider-percentage" data-target="cinema.poster.transitionDuration">1.5s</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Metadata Display Settings (Issue #35) -->
                  <div class="mode-card" data-card-key="cinema-metadata" id="cinema-metadata-card" style="padding:12px; grid-column: 1; display:none;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-info-circle"></i> Metadata Display</div>
                    <div id="cinema-metadata-mount">
                      <div class="form-grid">
                        <div class="form-row">
                          <label for="cinemaMetadataLayout">Layout</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaMetadataLayout">
                              <option value="compact">Compact</option>
                              <option value="comfortable" selected>Comfortable</option>
                              <option value="spacious">Spacious</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <div class="form-row">
                          <label for="cinemaMetadataOpacity">Opacity</label>
                          <div class="modern-slider">
                            <input type="range" id="cinemaMetadataOpacity" min="0" max="100" step="5" value="80" />
                            <div class="slider-bar"><div class="fill"></div></div>
                          </div>
                          <div class="slider-percentage">80%</div>
                        </div>
                        
                        <div class="cinema-section-header">Movie Info</div>
                        <div class="checkbox-group" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;">
                          <label class="checkbox" for="cinemaShowYear"><input type="checkbox" id="cinemaShowYear" checked /><span class="checkmark"></span><span>Year</span></label>
                          <label class="checkbox" for="cinemaShowRuntime"><input type="checkbox" id="cinemaShowRuntime" checked /><span class="checkmark"></span><span>Runtime</span></label>
                          <label class="checkbox" for="cinemaShowRating"><input type="checkbox" id="cinemaShowRating" checked /><span class="checkmark"></span><span>Rating</span></label>
                          <label class="checkbox" for="cinemaShowCertification"><input type="checkbox" id="cinemaShowCertification" /><span class="checkmark"></span><span>Certification</span></label>
                          <label class="checkbox" for="cinemaShowGenre"><input type="checkbox" id="cinemaShowGenre" /><span class="checkmark"></span><span>Genre</span></label>
                          <label class="checkbox" for="cinemaShowDirector"><input type="checkbox" id="cinemaShowDirector" /><span class="checkmark"></span><span>Director</span></label>
                          <label class="checkbox" for="cinemaShowStudioLogo"><input type="checkbox" id="cinemaShowStudioLogo" /><span class="checkmark"></span><span>Studio</span></label>
                        </div>
                        
                        <div class="cinema-section-header">Technical Specs</div>
                        <div class="checkbox-group" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;">
                          <label class="checkbox" for="cinemaShowResolution"><input type="checkbox" id="cinemaShowResolution" checked /><span class="checkmark"></span><span>Resolution</span></label>
                          <label class="checkbox" for="cinemaShowAudio"><input type="checkbox" id="cinemaShowAudio" checked /><span class="checkmark"></span><span>Audio</span></label>
                          <label class="checkbox" for="cinemaShowHDR"><input type="checkbox" id="cinemaShowHDR" checked /><span class="checkmark"></span><span>HDR</span></label>
                          <label class="checkbox" for="cinemaShowAspectRatio"><input type="checkbox" id="cinemaShowAspectRatio" /><span class="checkmark"></span><span>Aspect Ratio</span></label>
                        </div>
                        <div class="form-row" style="margin-top: 12px; grid-column: 1 / -1;">
                          <label for="cinemaSpecsStyle">Specs Display Style</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaSpecsStyle">
                              <option value="dark-glass">Dark Glass (Text Only)</option>
                              <option value="glass">Glass (Text Only)</option>
                              <option value="icons-only">Icons Only</option>
                              <option value="icons-text">Icons & Text</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                        <div class="form-row cinema-conditional-row" id="cinemaSpecsIconSetRow" style="display:none;">
                          <label for="cinemaSpecsIconSet">Icon Set</label>
                          <div class="select-wrap has-caret">
                            <select id="cinemaSpecsIconSet">
                              <option value="tabler">Tabler Icons</option>
                              <option value="material">Material Symbols</option>
                            </select>
                            <span class="select-caret" aria-hidden="true">▾</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Promotional Features (Issue #35) -->
                  <div class="mode-card" data-card-key="cinema-promotional" id="cinema-promotional-card" style="padding:12px; grid-column: 1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-bullhorn"></i> Promotional</div>
                    <div id="cinema-promotional-mount">
                      <!-- Main toggles row -->
                      <div class="promo-toggles-grid">
                        <div class="promo-toggle-item">
                          <label class="checkbox" for="cinemaRatingBadge"><input type="checkbox" id="cinemaRatingBadge" /><span class="checkmark"></span><span>Rating Badge</span></label>
                        </div>
                        <div class="promo-toggle-item">
                          <label class="checkbox" for="cinemaWatchProviders"><input type="checkbox" id="cinemaWatchProviders" /><span class="checkmark"></span><span>Watch Providers</span></label>
                        </div>
                        <div class="promo-toggle-item">
                          <label class="checkbox" for="cinemaAwardsBadge"><input type="checkbox" id="cinemaAwardsBadge" /><span class="checkmark"></span><span>Awards Badge</span></label>
                        </div>
                        <div class="promo-toggle-item">
                          <label class="checkbox" for="cinemaTrailerEnabled"><input type="checkbox" id="cinemaTrailerEnabled" /><span class="checkmark"></span><span>Trailer</span></label>
                        </div>
                        <div class="promo-toggle-item">
                          <label class="checkbox" for="cinemaQREnabled"><input type="checkbox" id="cinemaQREnabled" /><span class="checkmark"></span><span>QR Code</span></label>
                        </div>
                      </div>
                      
                      <!-- Nested Settings Panels -->
                      <div class="promo-settings-panels">
                        <!-- Rating Badge Settings -->
                        <div class="cinema-nested-settings promo-settings-panel" id="cinemaRatingSettings" style="display:none;">
                          <div class="promo-panel-title"><i class="fas fa-star"></i> Rating Badge</div>
                          <div class="promo-settings-grid">
                            <div class="form-row">
                              <label for="cinemaRatingSource">Source</label>
                              <div class="select-wrap has-caret">
                                <select id="cinemaRatingSource">
                                  <option value="auto">Auto (Best Available)</option>
                                  <option value="imdb">IMDB</option>
                                  <option value="tmdb">TMDB</option>
                                  <option value="rotten">Rotten Tomatoes</option>
                                </select>
                                <span class="select-caret" aria-hidden="true">▾</span>
                              </div>
                            </div>
                            <div class="form-row">
                              <label for="cinemaRatingPosition">Position</label>
                              <div class="select-wrap has-caret">
                                <select id="cinemaRatingPosition">
                                  <option value="topLeft">Top Left</option>
                                  <option value="topRight">Top Right</option>
                                  <option value="bottomLeft">Bottom Left</option>
                                  <option value="bottomRight">Bottom Right</option>
                                </select>
                                <span class="select-caret" aria-hidden="true">▾</span>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Watch Providers Settings -->
                        <div class="cinema-nested-settings promo-settings-panel" id="cinemaWatchProviderSettings" style="display:none;">
                          <div class="promo-panel-title"><i class="fas fa-tv"></i> Watch Providers</div>
                          <div class="promo-settings-grid">
                            <div class="form-row">
                              <label for="cinemaWatchProviderPosition">Position</label>
                              <div class="select-wrap has-caret">
                                <select id="cinemaWatchProviderPosition">
                                  <option value="topRight">Top Right</option>
                                  <option value="topLeft">Top Left</option>
                                  <option value="bottomRight">Bottom Right</option>
                                  <option value="bottomLeft">Bottom Left</option>
                                </select>
                                <span class="select-caret" aria-hidden="true">▾</span>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Trailer Settings -->
                        <div class="cinema-nested-settings promo-settings-panel" id="cinemaTrailerSettings" style="display:none;">
                          <div class="promo-panel-title"><i class="fas fa-film"></i> Trailer</div>
                          <div class="promo-settings-grid">
                            <div class="form-row">
                              <label for="cinemaTrailerDelay">Delay</label>
                              <div class="slider-with-value">
                                <div class="modern-slider">
                                  <input type="range" id="cinemaTrailerDelay" min="0" max="30" step="1" value="5" />
                                  <div class="slider-bar"><div class="fill"></div></div>
                                </div>
                                <div class="slider-percentage" data-target="cinema.promotional.trailer.delay">5s</div>
                              </div>
                            </div>
                            <div class="form-row">
                              <label>Options</label>
                              <div class="checkbox-row">
                                <label class="checkbox" for="cinemaTrailerMuted"><input type="checkbox" id="cinemaTrailerMuted" checked /><span class="checkmark"></span><span>Muted</span></label>
                                <label class="checkbox" for="cinemaTrailerLoop"><input type="checkbox" id="cinemaTrailerLoop" checked /><span class="checkmark"></span><span>Loop</span></label>
                              </div>
                            </div>
                            <div class="form-row trailer-sound-warning" id="trailerSoundWarning" style="display:none; grid-column: 1 / -1;">
                              <div class="warning-box">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Sound requires browser settings. Set <code>chrome://flags/#autoplay-policy</code> to <strong>"No user gesture is required"</strong></span>
                              </div>
                            </div>
                            <div class="form-row">
                              <label for="cinemaTrailerQuality">Quality</label>
                              <div class="select-wrap has-caret">
                                <select id="cinemaTrailerQuality">
                                  <option value="default">Auto</option>
                                  <option value="hd1080">1080p (Full HD)</option>
                                  <option value="hd720">720p (HD)</option>
                                  <option value="large">480p</option>
                                  <option value="medium">360p</option>
                                </select>
                                <span class="select-caret" aria-hidden="true">▾</span>
                              </div>
                            </div>
                            <div class="form-row">
                              <label for="cinemaTrailerAutohide">Autohide after</label>
                              <div class="select-wrap has-caret">
                                <select id="cinemaTrailerAutohide">
                                  <option value="never">Never</option>
                                  <option value="1loop">1 loop</option>
                                  <option value="2loops">2 loops</option>
                                  <option value="3loops">3 loops</option>
                                  <option value="1min">1 minute</option>
                                  <option value="2min">2 minutes</option>
                                  <option value="5min">5 minutes</option>
                                </select>
                                <span class="select-caret" aria-hidden="true">▾</span>
                              </div>
                            </div>
                            <div class="form-row" id="cinemaTrailerReshowRow" style="display:none;">
                              <label for="cinemaTrailerReshow">Re-show after</label>
                              <div class="select-wrap has-caret">
                                <select id="cinemaTrailerReshow">
                                  <option value="never">Never</option>
                                  <option value="nextposter">Next poster</option>
                                  <option value="1min">1 minute</option>
                                  <option value="2min">2 minutes</option>
                                  <option value="5min">5 minutes</option>
                                  <option value="10min">10 minutes</option>
                                </select>
                                <span class="select-caret" aria-hidden="true">▾</span>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- QR Code Settings -->
                        <div class="cinema-nested-settings promo-settings-panel" id="cinemaQRSettings" style="display:none;">
                          <div class="promo-panel-title"><i class="fas fa-qrcode"></i> QR Code</div>
                          <div class="promo-settings-grid">
                            <div class="form-row">
                              <label for="cinemaQRUrlType">Link Type</label>
                              <div class="select-wrap has-caret">
                                <select id="cinemaQRUrlType">
                                  <option value="trailer">Trailer URL (YouTube)</option>
                                  <option value="imdb">IMDb URL</option>
                                  <option value="tmdb">TMDB URL</option>
                                  <option value="custom">Custom URL</option>
                                </select>
                                <span class="select-caret" aria-hidden="true">▾</span>
                              </div>
                            </div>
                            <div class="form-row" id="cinemaQRCustomUrlRow" style="display:none;">
                              <label for="cinemaQRUrl">Custom URL</label>
                              <input type="url" id="cinemaQRUrl" class="input-url" placeholder="https://example.com/tickets" />
                              <span class="help-text error-text" id="cinemaQRUrlError" style="display:none; color:#ef5350;">Please enter a valid URL</span>
                            </div>
                            <div class="form-row">
                              <label for="cinemaQRPosition">Position</label>
                              <div class="select-wrap has-caret">
                                <select id="cinemaQRPosition">
                                  <option value="bottomRight">Bottom Right</option>
                                  <option value="bottomLeft">Bottom Left</option>
                                  <option value="topRight">Top Right</option>
                                  <option value="topLeft">Top Left</option>
                                </select>
                                <span class="select-caret" aria-hidden="true">▾</span>
                              </div>
                            </div>
                            <div class="form-row">
                              <label for="cinemaQRSize">Size</label>
                              <div class="slider-with-value">
                                <div class="modern-slider">
                                  <input type="range" id="cinemaQRSize" min="60" max="200" step="10" value="100" />
                                  <div class="slider-bar"><div class="fill"></div></div>
                                </div>
                                <div class="slider-percentage" data-target="cinema.promotional.qrCode.size">100%</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                </div>
              </fieldset>
            </div>
          </div>

        </div>
      </div>

    </section>

    <!-- Media Sources Section (top-level sibling, not nested under dashboard) -->
    <section id="section-media-sources" class="app-section" hidden>
      <div class="panel" id="panel-media-sources" style="border: none; background: transparent; box-shadow: none;">
        <div class="section-header panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0; border: none; background: transparent;">
          <h2 style="margin: 0; display: flex; align-items: center;">
            <span style="display: inline-flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); color: var(--color-text-primary); padding: 6px 16px; border-radius: 20px; font-size: 0.95rem; font-weight: 500; letter-spacing: 0.3px;">
              <i class="fas fa-server" style="opacity: 0.8;"></i>
              Media Sources
            </span>
          </h2>
          <div class="section-header-actions panel-actions" style="display: flex; gap: 12px; align-items: center;"></div>
        </div>
        <div class="panel-content" style="padding: 0;">
      <!-- Sources tabs with expandable dropdowns -->
      <div class="form-section" id="sources-tabs">
        <div class="section-title"><i class="fas fa-layer-group"></i> Source</div>
        <div class="form-row">
          <div class="segmented" role="tablist" aria-label="Source">
            
            <!-- Media Servers (expandable) -->
            <label class="seg has-dropdown" id="seg-media" role="tab" aria-controls="panel-plex" aria-checked="false" data-default-source="plex">
              <input type="radio" name="sources.active" id="src-media" value="media" />
              <i class="fas fa-server"></i> <span class="seg-text">Media<span class="seg-source-name"></span></span>
              <i class="fas fa-chevron-down dropdown-chevron" title="Show media sources"></i>
              <div class="seg-dropdown">
                <div class="seg-dropdown-item" data-source="plex" data-panel="panel-plex">
                  <i class="fas fa-film"></i> Plex
                </div>
                <div class="seg-dropdown-item" data-source="jellyfin" data-panel="panel-jellyfin">
                  <i class="fas fa-play"></i> Jellyfin
                </div>
                <div class="seg-dropdown-item coming-soon" title="Coming soon">
                  <i class="fas fa-cloud"></i> Emby
                  <span class="badge badge-info">Soon</span>
                </div>
              </div>
            </label>

            <!-- Game Servers (expandable) -->
            <label class="seg has-dropdown" id="seg-game" role="tab" aria-controls="panel-romm" aria-checked="false" data-default-source="romm">
              <input type="radio" name="sources.active" id="src-game" value="game" />
              <i class="fas fa-gamepad"></i> <span class="seg-text">Game<span class="seg-source-name"></span></span>
              <i class="fas fa-chevron-down dropdown-chevron" title="Show game sources"></i>
              <div class="seg-dropdown">
                <div class="seg-dropdown-item" data-source="romm" data-panel="panel-romm">
                  <i class="fas fa-dice"></i> RomM
                </div>
                <div class="seg-dropdown-item coming-soon" title="Coming soon">
                  <i class="fas fa-trophy"></i> GameVault
                  <span class="badge badge-info">Soon</span>
                </div>
              </div>
            </label>

            <!-- Content APIs (expandable) -->
            <label class="seg has-dropdown" id="seg-content" role="tab" aria-controls="panel-local" aria-checked="false" data-default-source="local">
              <input type="radio" name="sources.active" id="src-content" value="content" />
              <i class="fas fa-database"></i> <span class="seg-text">Content<span class="seg-source-name"></span></span>
              <i class="fas fa-chevron-down dropdown-chevron" title="Show content sources"></i>
              <div class="seg-dropdown">
                <div class="seg-dropdown-item" data-source="local" data-panel="panel-local">
                  <i class="fas fa-folder"></i> Local Directory
                </div>
                <div class="seg-dropdown-item" data-source="tmdb" data-panel="panel-tmdb">
                  <i class="fas fa-clapperboard"></i> TMDB
                </div>
              </div>
            </label>

            <!-- Art Servers (expandable, disabled for now) -->
            <label class="seg has-dropdown disabled" id="seg-art" role="tab" aria-checked="false" title="Coming soon">
              <input type="radio" name="sources.active" id="src-art" value="art" disabled />
              <i class="fas fa-palette"></i> <span class="seg-text">Art</span>
              <i class="fas fa-chevron-down dropdown-chevron"></i>
              <div class="seg-dropdown">
                <div class="seg-dropdown-empty">
                  <i class="fas fa-info-circle"></i> No sources configured yet
                </div>
              </div>
            </label>

          </div>
          <div class="source-actions-right"></div>
        </div>
      </div>
      <section class="panel" id="panel-sources-overview" hidden></section>

      <!-- Plex Panel -->
      <section class="panel" id="panel-plex">
        <div class="actions-home" id="plex-actions-home" hidden>
          <span class="status-pill" id="plex-status-pill-header" title="Plex configuration status">Not configured</span>
          <span class="status-pill" id="plex-count-pill" title="Change ratings/genres/quality chips or year fields → the “Items: N” pill updates immediately using the cached playlist">Items: —</span>
          <button class="btn btn-icon btn-sm" id="btn-plex-test" title="Test connection"><i class="fas fa-vial"></i></button>
          <button class="btn btn-icon btn-sm" id="btn-plex-libraries" title="Fetch libraries"><i class="fas fa-list"></i></button>
          <label class="header-toggle" for="plex.enabled" title="Enable Plex source">
            <input type="checkbox" id="plex.enabled" />
            <span class="ht-switch" aria-hidden="true"></span>
            <span class="ht-text">Enabled</span>
          </label>
          <button class="btn btn-primary btn-sm" id="btn-save-plex" title="Save Plex settings"><i class="fas fa-save"></i><span>Save Settings</span></button>
        </div>
        <div class="panel-content">
          <div class="loading-overlay" aria-hidden="true">
            <div class="glass"></div>
            <div class="loader"><span class="spinner"></span></div>
          </div>
          <!-- Connection -->
          <div class="form-section">
            <div class="section-title"><i class="fas fa-server"></i> Server
              <div class="section-actions"></div>
            </div>
          </div>
          <div class="form-grid plex-dense" id="plex-server-grid">
            <div class="form-group">
              <label for="plex_hostname">Hostname</label>
              <input type="text" id="plex_hostname" placeholder="e.g. 192.168.1.10" autocomplete="off" autocapitalize="off" spellcheck="false">
            </div>
            <div class="form-group">
              <label for="plex_port">Port</label>
              <div class="number-input-wrapper niw-compact">
                <input type="number" id="plex_port" min="1" max="65535" placeholder="32400" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
                <div class="number-controls" role="group">
                  <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                  <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="plex_token">API Token</label>
              <input type="password" id="plex_token" placeholder="X-Plex-Token" autocomplete="new-password">
              
            </div>
          </div>

          <!-- Libraries -->
          <div class="form-section">
            <div class="section-title"><i class="fas fa-list"></i> Libraries</div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="plex.movies">Movie Libraries</label>
              <select id="plex.movies" multiple style="display:none"></select>
              <div class="multiselect" id="plex-ms-movies">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-movies-chips"></div>
                  <button class="ms-clear" id="plex-ms-movies-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-movies-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-movies-search" type="text" placeholder="Search libraries…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-movies-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-movies-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-movies-options"></div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="plex.music">Music Libraries</label>
              <select id="plex.shows" multiple style="display:none"></select>
              <div class="multiselect" id="plex-ms-shows">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-shows-chips"></div>
                  <button class="ms-clear" id="plex-ms-shows-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-shows-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-shows-search" type="text" placeholder="Search libraries…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-shows-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-shows-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-shows-options"></div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="plex.music">Music Libraries</label>
              <select id="plex.music" multiple style="display:none"></select>
              <div class="multiselect" id="plex-ms-music">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-music-chips"></div>
                  <button class="ms-clear" id="plex-ms-music-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-music-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-music-search" type="text" placeholder="Search libraries…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-music-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-music-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-music-options"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Years -->
          <div class="form-section">
            <div class="section-title"><i class="fas fa-filter"></i> Filters</div>
          </div>
          <!-- Compact filters grid: place all filters in one dense grid -->
          <div class="form-grid plex-dense" id="plex-filters-grid">
            <div class="form-group">
              <label for="plex.yearFilter">Release Years</label>
              <input type="text" id="plex.yearFilter" inputmode="numeric" placeholder="e.g. 1995, 1998, 2015-2025">
            </div>
            <div class="form-group">
              <label for="plex.ratingFilter">Ratings</label>
              <input type="hidden" id="plex.ratingFilter-hidden" value="">
              <div class="multiselect" id="plex-ms-ratings">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-ratings-chips"></div>
                  <button class="ms-clear" id="plex-ms-ratings-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-ratings-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-ratings-search" type="text" placeholder="Search ratings…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-ratings-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-ratings-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-ratings-options"></div>
                </div>
              </div>
              
            </div>
            <div class="form-group">
              <label for="plex.genreFilter">Genres</label>
              <input type="hidden" id="plex.genreFilter-hidden" value="">
              <div class="multiselect" id="plex-ms-genres">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-genres-chips"></div>
                  <button class="ms-clear" id="plex-ms-genres-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-genres-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-genres-search" type="text" placeholder="Search genres…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-genres-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-genres-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-genres-options"></div>
                </div>
              </div>
              
            </div>
            <div class="form-group">
              <label for="plex.qualityFilter">Qualities</label>
              <input type="hidden" id="plex.qualityFilter-hidden" value="">
              <div class="multiselect" id="plex-ms-qualities">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-qualities-chips"></div>
                  <button class="ms-clear" id="plex-ms-qualities-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-qualities-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-qualities-search" type="text" placeholder="Search qualities…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-qualities-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-qualities-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-qualities-options"></div>
                </div>
              </div>
              
            </div>
            <div class="form-group">
              <label for="plex.musicGenres">Music Genres</label>
              <select id="plex.musicGenres" multiple style="display:none"></select>
              <input type="hidden" id="plex.musicGenres-hidden" value="">
              <div class="multiselect" id="plex-ms-music-genres">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-music-genres-chips"></div>
                  <button class="ms-clear" id="plex-ms-music-genres-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-music-genres-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-music-genres-search" type="text" placeholder="Search genres…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-music-genres-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-music-genres-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-music-genres-options"></div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="plex.musicArtists">Music Artists</label>
              <select id="plex.musicArtists" multiple style="display:none"></select>
              <input type="hidden" id="plex.musicArtists-hidden" value="">
              <div class="multiselect" id="plex-ms-music-artists">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-music-artists-chips"></div>
                  <button class="ms-clear" id="plex-ms-music-artists-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-music-artists-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-music-artists-search" type="text" placeholder="Search artists…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-music-artists-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-music-artists-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-music-artists-options"></div>
                </div>
              </div>
            </div>
            <!-- Recently added days - toggle enables/disables the filter -->
            <div class="form-group recent-filter-group">
              <div class="recent-filter-header">
                <label><i class="fas fa-clock"></i> Recently added</label>
                <label class="header-toggle" for="plex.recentOnlyHeader">
                  <input type="checkbox" id="plex.recentOnlyHeader" />
                  <span class="ht-switch" aria-hidden="true"></span>
                </label>
              </div>
              <div class="recent-filter-input">
                <div class="number-input-wrapper niw-compact">
                  <input type="number" id="plex.recentDays" min="1" max="365" placeholder="30">
                  <div class="number-controls" role="group">
                    <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                    <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                  </div>
                </div>
                <span class="recent-filter-unit">days</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Jellyfin Panel -->
      <section class="panel" id="panel-jellyfin" hidden>
        <div class="actions-home" id="jellyfin-actions-home" hidden>
          <span class="status-pill" id="jf-status-pill-header" title="Jellyfin configuration status">Not configured</span>
          <span class="status-pill" id="jf-count-pill" title="Change ratings/genres/quality chips or year fields → the “Items: N” pill updates immediately using the cached playlist">Items: —</span>
          <span class="status-pill" id="jf-restart-pill" title="Jellyfin server status" hidden><i class="fas fa-check-circle"></i> <span id="jf-restart-text">OK</span></span>
          <button class="btn btn-icon btn-sm" id="btn-jf-test" title="Test connection"><i class="fas fa-vial"></i></button>
          <button class="btn btn-icon btn-sm" id="btn-jf-libraries" title="Fetch libraries"><i class="fas fa-list"></i></button>
          <label class="header-toggle" for="jf.enabled" title="Enable Jellyfin source">
            <input type="checkbox" id="jf.enabled" />
            <span class="ht-switch" aria-hidden="true"></span>
            <span class="ht-text">Enabled</span>
          </label>
          <button class="btn btn-primary btn-sm" id="btn-save-jellyfin" title="Save Jellyfin settings"><i class="fas fa-save"></i><span>Save Settings</span></button>
        </div>
        <div class="panel-content">
          <div class="loading-overlay" aria-hidden="true">
            <div class="glass"></div>
            <div class="loader"><span class="spinner"></span></div>
          </div>
          <div class="form-section">
            <div class="section-title"><i class="fas fa-server"></i> Server
              <div class="section-actions">
                <span class="ht-text" id="jf-insecure-note">Allow self‑signed certificates</span>
                <label class="header-toggle" for="jf.insecureHttpsHeader" title="Allow self‑signed/invalid HTTPS (Jellyfin)">
                  <input type="checkbox" id="jf.insecureHttpsHeader" />
                  <span class="ht-switch" aria-hidden="true"></span>
                </label>
              </div>
            </div>
          </div>
          <div class="form-grid plex-dense" id="jf-server-grid">
            <div class="form-group">
              <label for="jf.hostname">Hostname</label>
              <input type="text" id="jf.hostname" placeholder="e.g. 192.168.1.20" autocomplete="off" autocapitalize="off" spellcheck="false">
            </div>
            <div class="form-group">
              <label for="jf.port">Port</label>
              <div class="number-input-wrapper niw-compact niw-sized-sm">
                <input type="number" id="jf.port" min="1" max="65535" placeholder="8096" autocomplete="off">
                <div class="number-controls" role="group">
                  <button type="button" class="number-btn number-inc" title="Increase" aria-label="Increase"><i class="fas fa-chevron-up"></i></button>
                  <button type="button" class="number-btn number-dec" title="Decrease" aria-label="Decrease"><i class="fas fa-chevron-down"></i></button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="jf.apikey">API Key</label>
              <input type="password" id="jf.apikey" placeholder="Jellyfin API Key" autocomplete="new-password">
              
            </div>
            <div class="form-group" hidden>
              <input type="checkbox" id="jf.insecureHttps" />
            </div>
          </div>
          <div class="form-section">
            <div class="section-title"><i class="fas fa-list"></i> Libraries</div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="jf.movies">Movie Libraries</label>
              <select id="jf.movies" multiple style="display:none"></select>
              <div class="multiselect" id="jf-ms-movies">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="jf-ms-movies-chips"></div>
                  <button class="ms-clear" id="jf-ms-movies-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="jf-ms-movies-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="jf-ms-movies-search" type="text" placeholder="Search libraries…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="jf-ms-movies-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="jf-ms-movies-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="jf-ms-movies-options"></div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="jf.shows">Show Libraries</label>
              <select id="jf.shows" multiple style="display:none"></select>
              <div class="multiselect" id="jf-ms-shows">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="jf-ms-shows-chips"></div>
                  <button class="ms-clear" id="jf-ms-shows-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="jf-ms-shows-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="jf-ms-shows-search" type="text" placeholder="Search libraries…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="jf-ms-shows-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="jf-ms-shows-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="jf-ms-shows-options"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <div class="section-title"><i class="fas fa-filter"></i> Filters</div>
          </div>
          <!-- Dense filters grid for Jellyfin (no qualities) -->
          <div class="form-grid plex-dense" id="jf-filters-grid">
            <div class="form-group">
              <label for="jf.yearFilter">Release Years</label>
              <input type="text" id="jf.yearFilter" inputmode="numeric" placeholder="e.g. 1995, 1998, 2015-2025">
            </div>
            <div class="form-group">
              <label for="jf.ratingFilter">Ratings</label>
              <input type="hidden" id="jf.ratingFilter-hidden" value="">
              <div class="multiselect" id="jf-ms-ratings">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="jf-ms-ratings-chips"></div>
                  <button class="ms-clear" id="jf-ms-ratings-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="jf-ms-ratings-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="jf-ms-ratings-search" type="text" placeholder="Search ratings…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="jf-ms-ratings-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="jf-ms-ratings-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="jf-ms-ratings-options"></div>
                </div>
              </div>
              
            </div>
            <div class="form-group">
              <label for="jf.genreFilter">Genres</label>
              <input type="hidden" id="jf.genreFilter-hidden" value="">
              <div class="multiselect" id="jf-ms-genres">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="jf-ms-genres-chips"></div>
                  <button class="ms-clear" id="jf-ms-genres-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="jf-ms-genres-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="jf-ms-genres-search" type="text" placeholder="Search genres…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="jf-ms-genres-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="jf-ms-genres-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="jf-ms-genres-options"></div>
                </div>
              </div>
              
            </div>
            <!-- Recently added days - toggle enables/disables the filter -->
            <div class="form-group recent-filter-group">
              <div class="recent-filter-header">
                <label><i class="fas fa-clock"></i> Recently added</label>
                <label class="header-toggle" for="jf.recentOnlyHeader">
                  <input type="checkbox" id="jf.recentOnlyHeader" />
                  <span class="ht-switch" aria-hidden="true"></span>
                </label>
              </div>
              <div class="recent-filter-input">
                <div class="number-input-wrapper niw-compact">
                  <input type="number" id="jf.recentDays" min="1" max="365" placeholder="30">
                  <div class="number-controls" role="group">
                    <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                    <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                  </div>
                </div>
                <span class="recent-filter-unit">days</span>
              </div>
            </div>
          </div>
          <!-- Jellyfin Qualities hidden (disabled feature) -->
          <div class="form-grid" style="display:none">
            <div class="form-group">
              <label for="jf.qualityFilter">Qualities</label>
              <input type="hidden" id="jf.qualityFilter-hidden" value="">
              <div class="multiselect" id="jf-ms-qualities"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- RomM Panel -->
      <section class="panel" id="panel-romm" hidden>
        <div class="actions-home" id="romm-actions-home" hidden>
          <span class="status-pill" id="romm-status-pill-header" title="RomM configuration status">Not configured</span>
          <span class="status-pill" id="romm-count-pill" title="Number of games in playlist">Games: —</span>
          <button class="btn btn-icon btn-sm" id="btn-romm-test" title="Test connection"><i class="fas fa-vial"></i></button>
          <button class="btn btn-icon btn-sm" id="btn-romm-platforms" title="Fetch platforms"><i class="fas fa-list"></i></button>
          <label class="header-toggle" for="romm.enabled" title="Enable RomM source">
            <input type="checkbox" id="romm.enabled" />
            <span class="ht-switch" aria-hidden="true"></span>
            <span class="ht-text">Enabled</span>
          </label>
          <button class="btn btn-primary btn-sm" id="btn-save-romm" title="Save RomM settings" data-restart-required="false"><i class="fas fa-save"></i><span>Save Settings</span></button>
        </div>
        <div class="panel-content">
          <div class="loading-overlay" aria-hidden="true">
            <div class="glass"></div>
            <div class="loader"><span class="spinner"></span></div>
          </div>
          <div class="form-section">
            <div class="section-title"><i class="fas fa-server"></i> Server
              <div class="section-actions">
                <span class="ht-text" id="romm-insecure-note">Allow self‑signed certificates</span>
                <label class="header-toggle" for="romm.insecureHttpsHeader" title="Allow self‑signed/invalid HTTPS (RomM)">
                  <input type="checkbox" id="romm.insecureHttpsHeader" />
                  <span class="ht-switch" aria-hidden="true"></span>
                </label>
              </div>
            </div>
          </div>
          <div class="form-grid plex-dense" id="romm-server-grid">
            <div class="form-group">
              <label for="romm.url">Server URL</label>
              <input type="text" id="romm.url" placeholder="http://romm-server:8080" autocomplete="off" autocapitalize="off" spellcheck="false">
            </div>
            <div class="form-group">
              <label for="romm.username">Username</label>
              <input type="text" id="romm.username" placeholder="admin" autocomplete="off" autocapitalize="off" spellcheck="false">
            </div>
            <div class="form-group">
              <label for="romm.password">Password</label>
              <input type="password" id="romm.password" placeholder="Password" autocomplete="new-password">
            </div>
          </div>
          <!-- Hidden sync checkbox for insecureHttps (actual toggle is in section header) -->
          <div hidden>
            <input type="checkbox" id="romm.insecureHttps" />
          </div>
          
          <div class="form-section">
            <div class="section-title"><i class="fas fa-gamepad"></i> Platforms</div>
          </div>
          <div class="form-grid">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label for="romm.platforms">Selected Platforms</label>
              <select id="romm.platforms" multiple style="display:none"></select>
              <div class="multiselect" id="romm-ms-platforms">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="romm-ms-platforms-chips"></div>
                  <button class="ms-clear" id="romm-ms-platforms-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="romm-ms-platforms-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="romm-ms-platforms-search" type="text" placeholder="Search platforms…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="romm-ms-platforms-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="romm-ms-platforms-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="romm-ms-platforms-options"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TMDB Panel -->
  <section class="panel" id="panel-tmdb">
        <div class="actions-home" id="tmdb-actions-home" hidden>
          <span class="status-pill" id="tmdb-status-pill-header" title="TMDB configuration status">Not configured</span>
          <span class="status-pill" id="tmdb-count-pill" title="Items from TMDB in the current playlist">Items: —</span>
          <button class="btn btn-icon btn-sm" id="btn-tmdb-test" title="Test connection"><i class="fas fa-vial"></i></button>
          <label class="header-toggle" for="tmdb.enabled" title="Enable TMDB source">
            <input type="checkbox" id="tmdb.enabled" />
            <span class="ht-switch" aria-hidden="true"></span>
            <span class="ht-text">Enabled</span>
          </label>
          <button class="btn btn-primary btn-sm" id="btn-save-tmdb" title="Save TMDB settings"><i class="fas fa-save"></i><span>Save Settings</span></button>
        </div>
        <div class="panel-content">
          <div class="loading-overlay" aria-hidden="true">
            <div class="glass"></div>
            <div class="loader"><span class="spinner"></span></div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="tmdb.apikey">API Key</label>
              <input type="password" id="tmdb.apikey" placeholder="TMDB API Key" autocomplete="new-password">
            </div>
            <div class="form-group">
              <label for="tmdb.category">Category</label>
              <div class="select-wrap has-caret">
                <span class="select-icon" id="tmdb-category-icon"><i class="fas fa-fire"></i></span>
                <select id="tmdb.category">
                  <optgroup label="Movies">
                    <option value="popular">Popular Movies</option>
                    <option value="top_rated">Top Rated Movies</option>
                    <option value="now_playing">Now Playing</option>
                    <option value="upcoming">Upcoming Movies</option>
                    <option value="latest">Latest Movies</option>
                  </optgroup>
                  <optgroup label="TV Shows">
                    <option value="tv_popular">Popular TV Shows</option>
                    <option value="tv_top_rated">Top Rated TV Shows</option>
                    <option value="tv_on_the_air">Currently Airing</option>
                    <option value="tv_airing_today">Airing Today</option>
                    <option value="tv_latest">Latest TV Shows</option>
                  </optgroup>
                  <optgroup label="Trending">
                    <option value="trending_all_day">Trending Today (All)</option>
                    <option value="trending_movie_day">Trending Movies (Day)</option>
                    <option value="trending_tv_day">Trending TV (Day)</option>
                    <option value="trending_all_week">Trending Week (All)</option>
                    <option value="trending_movie_week">Trending Movies (Week)</option>
                    <option value="trending_tv_week">Trending TV (Week)</option>
                  </optgroup>
                  <optgroup label="Collections">
                    <option value="discover_movie">Discover Movies</option>
                    <option value="discover_tv">Discover TV Shows</option>
                  </optgroup>
                </select>
                <span class="select-caret" aria-hidden="true">▾</span>
              </div>
            </div>
            <div class="form-group">
              <label for="tmdb.minRating">Minimum Rating</label>
              <div class="number-input-wrapper niw-compact niw-sized-sm">
                <input type="number" id="tmdb.minRating" min="0" max="10" step="0.1" placeholder="0">
                <div class="number-controls">
                  <button type="button" class="number-btn number-inc" aria-label="Increase value"><i class="fas fa-chevron-up"></i></button>
                  <button type="button" class="number-btn number-dec" aria-label="Decrease value"><i class="fas fa-chevron-down"></i></button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="tmdb.yearFilter">Release Years</label>
              <input type="text" id="tmdb.yearFilter" inputmode="numeric" placeholder="e.g. 1995, 1998, 2015-2025">
              
            </div>
          </div>
            <div class="form-grid">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Genres</label>
                <input type="hidden" id="tmdb.genreFilter-hidden" value="">
                <div class="multiselect" id="tmdb-ms-genres">
                  <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                    <div class="ms-chips" id="tmdb-ms-genres-chips"></div>
                    <button class="ms-clear" id="tmdb-ms-genres-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                    <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                  </div>
                  <div class="ms-menu" id="tmdb-ms-genres-menu" role="listbox">
                    <div class="ms-search">
                      <i class="fas fa-search"></i>
                      <input id="tmdb-ms-genres-search" type="text" placeholder="Search genres…">
                    </div>
                    <div class="ms-actions">
                      <button class="btn btn-outline btn-sm" id="tmdb-ms-genres-select-all"><i class="fas fa-square-check"></i> Select all</button>
                      <button class="btn btn-outline btn-sm" id="tmdb-ms-genres-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                    </div>
                    <div class="ms-options" id="tmdb-ms-genres-options"></div>
                  </div>
                </div>
              </div>
            </div>

          <!-- Streaming Releases (TMDB-based) -->
          <div class="form-divider" aria-hidden="true"></div>
          <section class="subpanel" id="subpanel-streaming">
            <header class="subpanel-header">
              <h3>
                <i class="fas fa-stream" aria-hidden="true"></i>
                <span>Streaming Releases</span>
              </h3>
              <div class="panel-actions">
                <label class="header-toggle" for="streamingSources.enabled" title="Enable Streaming Releases">
                  <input type="checkbox" id="streamingSources.enabled" />
                  <span class="ht-switch" aria-hidden="true"></span>
                  <span class="ht-text">Enabled</span>
                </label>
                <button class="btn btn-icon btn-sm" id="test-streaming-button" title="Test Streaming"><i class="fas fa-vial"></i></button>
              </div>
            </header>
            <div class="subpanel-body">
              <div class="subtle">Add latest releases from popular streaming platforms using TMDB's provider data.</div>
              <small id="streaming-connection-status" class="form-help"></small>
          
          <div class="form-grid">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Streaming Providers</label>
              <select id="streaming.providers" multiple style="display:none"></select>
              <div class="multiselect" id="streaming-ms-providers">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="streaming-ms-providers-chips"></div>
                  <button class="ms-clear" id="streaming-ms-providers-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="streaming-ms-providers-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    <input type="text" id="streaming-ms-providers-search" placeholder="Search providers" aria-label="Search providers">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="streaming-ms-providers-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="streaming-ms-providers-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="streaming-ms-providers-options"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="checkbox"><input type="checkbox" id="streamingSources.newReleases"><span class="checkmark"></span><span>New Releases (Selected)</span></label>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="streamingSources.region">Region</label>
              <div class="select-wrap has-caret">
              <select id="streamingSources.region">
                <option value="US">🇺🇸 United States</option>
                <option value="NL">🇳🇱 Netherlands</option>
                <option value="GB">🇬🇧 United Kingdom</option>
                <option value="DE">🇩🇪 Germany</option>
                <option value="FR">🇫🇷 France</option>
                <option value="CA">🇨🇦 Canada</option>
                <option value="AU">🇦🇺 Australia</option>
                <option value="ES">🇪🇸 Spain</option>
                <option value="IT">🇮🇹 Italy</option>
                <option value="BR">🇧🇷 Brazil</option>
                <option value="MX">🇲🇽 Mexico</option>
                <option value="AR">🇦🇷 Argentina</option>
                <option value="JP">🇯🇵 Japan</option>
                <option value="KR">🇰🇷 South Korea</option>
                <option value="IN">🇮🇳 India</option>
                <option value="CN">🇨🇳 China</option>
                <option value="RU">🇷🇺 Russia</option>
                <option value="BE">🇧🇪 Belgium</option>
                <option value="AT">🇦🇹 Austria</option>
                <option value="CH">🇨🇭 Switzerland</option>
                <option value="SE">🇸🇪 Sweden</option>
                <option value="NO">🇳🇴 Norway</option>
                <option value="DK">🇩🇰 Denmark</option>
                <option value="FI">🇫🇮 Finland</option>
                <option value="PL">🇵🇱 Poland</option>
                <option value="CZ">🇨🇿 Czech Republic</option>
                <option value="HU">🇭🇺 Hungary</option>
                <option value="PT">🇵🇹 Portugal</option>
                <option value="GR">🇬🇷 Greece</option>
                <option value="TR">🇹🇷 Turkey</option>
                <option value="IL">🇮🇱 Israel</option>
                <option value="ZA">🇿🇦 South Africa</option>
                <option value="EG">🇪🇬 Egypt</option>
                <option value="SA">🇸🇦 Saudi Arabia</option>
                <option value="AE">🇦🇪 United Arab Emirates</option>
                <option value="TH">🇹🇭 Thailand</option>
                <option value="SG">🇸🇬 Singapore</option>
                <option value="MY">🇲🇾 Malaysia</option>
                <option value="ID">🇮🇩 Indonesia</option>
                <option value="PH">🇵🇭 Philippines</option>
                <option value="VN">🇻🇳 Vietnam</option>
                <option value="TW">🇹🇼 Taiwan</option>
                <option value="HK">🇭🇰 Hong Kong</option>
                <option value="NZ">🇳🇿 New Zealand</option>
                <option value="CL">🇨🇱 Chile</option>
                <option value="CO">🇨🇴 Colombia</option>
                <option value="PE">🇵🇪 Peru</option>
                <option value="VE">🇻🇪 Venezuela</option>
                <option value="UY">🇺🇾 Uruguay</option>
                <option value="EC">🇪🇨 Ecuador</option>
                <option value="BO">🇧🇴 Bolivia</option>
                <option value="PY">🇵🇾 Paraguay</option>
              </select>
              <span class="select-caret" aria-hidden="true">▾</span>
              </div>
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="streamingSources.minRating">Minimum Rating</label>
              <div class="number-input-wrapper niw-compact niw-sized-sm">
                <input type="number" id="streamingSources.minRating" min="0" max="10" step="0.1" placeholder="6.0">
                <div class="number-controls">
                  <button type="button" class="number-btn number-inc" aria-label="Increase value"><i class="fas fa-chevron-up"></i></button>
                  <button type="button" class="number-btn number-dec" aria-label="Decrease value"><i class="fas fa-chevron-down"></i></button>
                </div>
              </div>
            </div>
          </div>
            </div>
          </section>
        </div>
      </section>

      <!-- Local Directory Panel -->
      <section class="panel" id="panel-local">
        <div class="actions-home" id="local-actions-home" hidden>
          <span class="status-pill" id="local-status-pill-header" title="Local directory configuration status">Not configured</span>
          <span class="status-pill" id="local-count-pill" title="Items from local directory in the current playlist">Items: —</span>
          <button class="btn btn-icon btn-sm" id="btn-local-scan" title="Scan directory"><i class="fas fa-sync"></i></button>
          <label class="header-toggle" for="localDirectory.enabled" title="Enable local directory source">
            <input type="checkbox" id="localDirectory.enabled" />
            <span class="ht-switch" aria-hidden="true"></span>
            <span class="ht-text">Enabled</span>
          </label>
          <button class="btn btn-primary btn-sm" id="btn-save-local" title="Save local directory settings"><i class="fas fa-save"></i><span>Save Settings</span></button>
        </div>
        <div class="panel-content">
          <div class="loading-overlay" aria-hidden="true">
            <div class="glass"></div>
            <div class="loader"><span class="spinner"></span></div>
          </div>

          <!-- Directory configuration removed (fixed-path UX) -->

          <!-- File Operations removed by request; per-directory Upload is shown inline in the browser list -->

          <!-- Hidden per-target file inputs (kept for inline Upload buttons) -->
          <input type="file" id="file-input-posters" multiple accept="image/*" hidden>
          <input type="file" id="file-input-backgrounds" multiple accept="image/*" hidden>
          <input type="file" id="file-input-motion" multiple accept="video/*,.gif,.webm,.mp4,.avi,.mov,.mkv" hidden>
          <input type="file" id="file-input-packs" multiple accept=".zip" hidden>

          <!-- Directory Browser -->
          <div class="form-section">
            <div class="section-title">
              <i class="fas fa-list"></i> Directory Contents
              <div class="section-actions">
                <button class="btn btn-secondary btn-sm" id="btn-refresh-browser">
                  <span class="spinner"></span><i class="fas fa-rotate"></i><span>Refresh</span>
                </button>
                <button class="btn btn-secondary btn-sm" id="btn-download-dir" title="Download this folder as ZIP">
                  <span class="spinner"></span><i class="fas fa-file-zipper"></i><span>Download All</span>
                </button>
              </div>
            </div>
          </div>
          <div class="local-browser" id="local-browser">
            <div class="browser-toolbar">
              <div class="breadcrumb" id="local-breadcrumb">
                <button class="breadcrumb-item" data-path="/">
                  <i class="fas fa-home"></i>
                </button>
              </div>
              <div class="browser-search">
                <div class="search-input-wrapper">
                  <input type="text" id="local-browser-search" class="form-input" placeholder="Search files and folders..." />
                  <button type="button" class="search-clear-btn" id="local-search-clear" title="Clear search" style="display: none;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <div class="browser-actions"></div>
            </div>
            <div class="browser-content" id="local-browser-content">
              <div class="browser-empty">
                <i class="fas fa-folder-open"></i>
                <div>No directory contents to show</div>
                <small>Use the uploader to add files. Use per-item actions to open folders or delete files.</small>
              </div>
            </div>
          </div>

          <!-- Posterpack Generation -->
          <div class="form-section">
            <div class="section-title"><i class="fas fa-archive"></i> Posterpack Generation</div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="posterpack.source">Content Source</label>
              <div class="select-wrap has-caret" id="posterpack-source-wrap">
                <select id="posterpack.source">
                  <option value="plex">Plex</option>
                  <option value="jellyfin">Jellyfin</option>
                </select>
                <span class="select-caret" aria-hidden="true">▾</span>
              </div>
            </div>
            
            <!-- Posterpack Library Selection (per source) -->
            <div class="form-group" id="posterpack-lib-section" style="grid-column: 1 / -1;" hidden>
              <div class="form-subsection">
                <h4>Libraries</h4>
                <div class="form-grid pp-libs-grid" id="pp-plex-libs" hidden>
                  <!-- Plex Movie Libraries -->
                  <div class="form-group">
                    <label for="pp-plex.movies">Movie Libraries</label>
                    <select id="pp-plex.movies" multiple style="display:none"></select>
                    <div class="multiselect" id="pp-plex-ms-movies" tabindex="0">
                      <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox" tabindex="0">
                        <div class="ms-chips" id="pp-plex-ms-movies-chips"></div>
                        <button class="ms-clear" id="pp-plex-ms-movies-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                        <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                      </div>
                      <div class="ms-menu" id="pp-plex-ms-movies-menu" role="listbox">
                        <div class="ms-search">
                          <i class="fas fa-search"></i>
                          <input id="pp-plex-ms-movies-search" type="text" placeholder="Search libraries…">
                        </div>
                        <div class="ms-actions">
                          <button class="btn btn-outline btn-sm" id="pp-plex-ms-movies-select-all"><i class="fas fa-square-check"></i> Select all</button>
                          <button class="btn btn-outline btn-sm" id="pp-plex-ms-movies-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="ms-options" id="pp-plex-ms-movies-options"></div>
                      </div>
                    </div>
                  </div>
                  <!-- Plex Show Libraries -->
                  <div class="form-group">
                    <label for="pp-plex.shows">Show Libraries</label>
                    <select id="pp-plex.shows" multiple style="display:none"></select>
                    <div class="multiselect" id="pp-plex-ms-shows" tabindex="0">
                      <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox" tabindex="0">
                        <div class="ms-chips" id="pp-plex-ms-shows-chips"></div>
                        <button class="ms-clear" id="pp-plex-ms-shows-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                        <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                      </div>
                      <div class="ms-menu" id="pp-plex-ms-shows-menu" role="listbox">
                        <div class="ms-search">
                          <i class="fas fa-search"></i>
                          <input id="pp-plex-ms-shows-search" type="text" placeholder="Search libraries…">
                        </div>
                        <div class="ms-actions">
                          <button class="btn btn-outline btn-sm" id="pp-plex-ms-shows-select-all"><i class="fas fa-square-check"></i> Select all</button>
                          <button class="btn btn-outline btn-sm" id="pp-plex-ms-shows-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="ms-options" id="pp-plex-ms-shows-options"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Jellyfin libraries -->
                <div class="form-grid pp-libs-grid" id="pp-jf-libs" hidden>
                  <div class="form-group">
                    <label for="pp-jf.movies">Movie Libraries</label>
                    <select id="pp-jf.movies" multiple style="display:none"></select>
                    <div class="multiselect" id="pp-jf-ms-movies" tabindex="0">
                      <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox" tabindex="0">
                        <div class="ms-chips" id="pp-jf-ms-movies-chips"></div>
                        <button class="ms-clear" id="pp-jf-ms-movies-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                        <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                      </div>
                      <div class="ms-menu" id="pp-jf-ms-movies-menu" role="listbox">
                        <div class="ms-search">
                          <i class="fas fa-search"></i>
                          <input id="pp-jf-ms-movies-search" type="text" placeholder="Search libraries…">
                        </div>
                        <div class="ms-actions">
                          <button class="btn btn-outline btn-sm" id="pp-jf-ms-movies-select-all"><i class="fas fa-square-check"></i> Select all</button>
                          <button class="btn btn-outline btn-sm" id="pp-jf-ms-movies-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="ms-options" id="pp-jf-ms-movies-options"></div>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="pp-jf.shows">Show Libraries</label>
                    <select id="pp-jf.shows" multiple style="display:none"></select>
                    <div class="multiselect" id="pp-jf-ms-shows" tabindex="0">
                      <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox" tabindex="0">
                        <div class="ms-chips" id="pp-jf-ms-shows-chips"></div>
                        <button class="ms-clear" id="pp-jf-ms-shows-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                        <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                      </div>
                      <div class="ms-menu" id="pp-jf-ms-shows-menu" role="listbox">
                        <div class="ms-search">
                          <i class="fas fa-search"></i>
                          <input id="pp-jf-ms-shows-search" type="text" placeholder="Search libraries…">
                        </div>
                        <div class="ms-actions">
                          <button class="btn btn-outline btn-sm" id="pp-jf-ms-shows-select-all"><i class="fas fa-square-check"></i> Select all</button>
                          <button class="btn btn-outline btn-sm" id="pp-jf-ms-shows-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="ms-options" id="pp-jf-ms-shows-options"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <div class="form-subsection" id="posterpack-filters" hidden>
                <h4>Content Filters</h4>
                <!-- Common (all sources) -->
                <div id="posterpack-filters-common" class="form-grid">
                  <div class="form-group">
                    <label for="posterpack.yearFilter">Release Years</label>
                    <input type="text" id="posterpack.yearFilter" placeholder="e.g. 1995, 1998, 2015-2025" />
                  </div>
                </div>
                <!-- Server sources (Plex/Jellyfin) variant -->
                <div id="posterpack-filters-srv" class="form-grid">
                  <!-- Ratings multiselect -->
                  <div class="form-group">
                    <label for="pp-server.ratings">Ratings</label>
                    <select id="pp-server.ratings" multiple style="display:none"></select>
                    <div class="multiselect" id="pp-srv-ms-ratings">
                      <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <div class="ms-chips" id="pp-srv-ms-ratings-chips"></div>
                        <button class="ms-clear" id="pp-srv-ms-ratings-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                        <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                      </div>
                      <div class="ms-menu" id="pp-srv-ms-ratings-menu" role="listbox">
                        <div class="ms-search">
                          <i class="fas fa-search"></i>
                          <input id="pp-srv-ms-ratings-search" type="text" placeholder="Search ratings…">
                        </div>
                        <div class="ms-actions">
                          <button class="btn btn-outline btn-sm" id="pp-srv-ms-ratings-select-all"><i class="fas fa-square-check"></i> Select all</button>
                          <button class="btn btn-outline btn-sm" id="pp-srv-ms-ratings-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="ms-options" id="pp-srv-ms-ratings-options"></div>
                      </div>
                    </div>
                  </div>
                  <!-- Genres multiselect -->
                  <div class="form-group">
                    <label for="pp-server.genres">Genres</label>
                    <select id="pp-server.genres" multiple style="display:none"></select>
                    <div class="multiselect" id="pp-srv-ms-genres">
                      <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <div class="ms-chips" id="pp-srv-ms-genres-chips"></div>
                        <button class="ms-clear" id="pp-srv-ms-genres-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                        <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                      </div>
                      <div class="ms-menu" id="pp-srv-ms-genres-menu" role="listbox">
                        <div class="ms-search">
                          <i class="fas fa-search"></i>
                          <input id="pp-srv-ms-genres-search" type="text" placeholder="Search genres…">
                        </div>
                        <div class="ms-actions">
                          <button class="btn btn-outline btn-sm" id="pp-srv-ms-genres-select-all"><i class="fas fa-square-check"></i> Select all</button>
                          <button class="btn btn-outline btn-sm" id="pp-srv-ms-genres-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="ms-options" id="pp-srv-ms-genres-options"></div>
                      </div>
                    </div>
                  </div>
                  <!-- Qualities multiselect -->
                  <div class="form-group">
                    <label for="pp-server.qualities">Qualities</label>
                    <select id="pp-server.qualities" multiple style="display:none"></select>
                    <div class="multiselect" id="pp-srv-ms-qualities">
                      <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <div class="ms-chips" id="pp-srv-ms-qualities-chips"></div>
                        <button class="ms-clear" id="pp-srv-ms-qualities-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                        <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                      </div>
                      <div class="ms-menu" id="pp-srv-ms-qualities-menu" role="listbox">
                        <div class="ms-search">
                          <i class="fas fa-search"></i>
                          <input id="pp-srv-ms-qualities-search" type="text" placeholder="Search qualities…">
                        </div>
                        <div class="ms-actions">
                          <button class="btn btn-outline btn-sm" id="pp-srv-ms-qualities-select-all"><i class="fas fa-square-check"></i> Select all</button>
                          <button class="btn btn-outline btn-sm" id="pp-srv-ms-qualities-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="ms-options" id="pp-srv-ms-qualities-options"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Local source variant: no media type, no max items, no recently added; multiselects like Plex/JF -->
                <div id="posterpack-filters-local" class="form-grid" hidden>
                  <!-- Ratings -->
                  <div class="form-group">
                    <label for="pp-local.ratings">Ratings</label>
                    <select id="pp-local.ratings" multiple style="display:none"></select>
                    <div class="multiselect" id="pp-local-ms-ratings">
                      <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <div class="ms-chips" id="pp-local-ms-ratings-chips"></div>
                        <button class="ms-clear" id="pp-local-ms-ratings-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                        <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                      </div>
                      <div class="ms-menu" id="pp-local-ms-ratings-menu" role="listbox">
                        <div class="ms-search">
                          <i class="fas fa-search"></i>
                          <input id="pp-local-ms-ratings-search" type="text" placeholder="Search ratings…">
                        </div>
                        <div class="ms-actions">
                          <button class="btn btn-outline btn-sm" id="pp-local-ms-ratings-select-all"><i class="fas fa-square-check"></i> Select all</button>
                          <button class="btn btn-outline btn-sm" id="pp-local-ms-ratings-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="ms-options" id="pp-local-ms-ratings-options"></div>
                      </div>
                    </div>
                  </div>
                  <!-- Genres -->
                  <div class="form-group">
                    <label for="pp-local.genres">Genres</label>
                    <select id="pp-local.genres" multiple style="display:none"></select>
                    <div class="multiselect" id="pp-local-ms-genres">
                      <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <div class="ms-chips" id="pp-local-ms-genres-chips"></div>
                        <button class="ms-clear" id="pp-local-ms-genres-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                        <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                      </div>
                      <div class="ms-menu" id="pp-local-ms-genres-menu" role="listbox">
                        <div class="ms-search">
                          <i class="fas fa-search"></i>
                          <input id="pp-local-ms-genres-search" type="text" placeholder="Search genres…">
                        </div>
                        <div class="ms-actions">
                          <button class="btn btn-outline btn-sm" id="pp-local-ms-genres-select-all"><i class="fas fa-square-check"></i> Select all</button>
                          <button class="btn btn-outline btn-sm" id="pp-local-ms-genres-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="ms-options" id="pp-local-ms-genres-options"></div>
                      </div>
                    </div>
                  </div>
                  <!-- Qualities -->
                  <div class="form-group">
                    <label for="pp-local.qualities">Qualities</label>
                    <select id="pp-local.qualities" multiple style="display:none"></select>
                    <div class="multiselect" id="pp-local-ms-qualities">
                      <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <div class="ms-chips" id="pp-local-ms-qualities-chips"></div>
                        <button class="ms-clear" id="pp-local-ms-qualities-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                        <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                      </div>
                      <div class="ms-menu" id="pp-local-ms-qualities-menu" role="listbox">
                        <div class="ms-search">
                          <i class="fas fa-search"></i>
                          <input id="pp-local-ms-qualities-search" type="text" placeholder="Search qualities…">
                        </div>
                        <div class="ms-actions">
                          <button class="btn btn-outline btn-sm" id="pp-local-ms-qualities-select-all"><i class="fas fa-square-check"></i> Select all</button>
                          <button class="btn btn-outline btn-sm" id="pp-local-ms-qualities-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                        </div>
                        <div class="ms-options" id="pp-local-ms-qualities-options"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <div class="actions-inline">
                <button class="btn btn-secondary btn-sm" id="btn-preview-posterpack">
                  <span class="spinner"></span><i class="fas fa-eye"></i><span>Preview Selection</span>
                </button>
                <button class="btn btn-success btn-sm" id="btn-generate-posterpack">
                  <span class="spinner"></span><i class="fas fa-archive"></i><span>Generate Posterpack</span>
                </button>
              </div>
            </div>
            <!-- Generated Packs panel removed; directory-level downloads are available in the browser above -->
          </div>

          <!-- Job Status -->
          <div class="form-section" id="local-jobs-section" hidden>
            <div class="section-title">
              <i class="fas fa-tasks"></i> Background Jobs
              <div class="section-actions">
                <button class="btn btn-outline btn-sm" id="btn-clear-completed-jobs">
                  <i class="fas fa-broom"></i> Clear Completed
                </button>
              </div>
            </div>
          </div>
          <div class="job-list" id="local-job-list"></div>

        </div>
      </section>

      
        </div>
      </div>
    </section>

    <!-- Cinema Text Entry Modal (for add/rename header/footer text) -->
    <div class="modal-overlay" id="modal-cinema-text" hidden>
      <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-cinema-text-title">
        <div class="modal-header">
          <div class="modal-title" id="modal-cinema-text-title"><i class="fas fa-i-cursor"></i> Edit Text</div>
          <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="display:grid; gap:10px; padding:16px 20px;">
          <label for="cinema-text-input" id="cinema-text-input-label" style="color:var(--color-text-secondary)">Enter text</label>
          <input type="text" id="cinema-text-input" />
        </div>
        <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding: 12px 20px;">
          <button type="button" class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
          <button type="button" class="btn btn-secondary btn-sm btn-accent btn-cinema-accent" id="cinema-text-ok"><i class="fas fa-check" aria-hidden="true"></i><span>Save</span></button>
        </div>
      </div>
    </div>

    <!-- Cinema Save Preset Modal -->
    <div class="modal-overlay" id="modal-cinema-preset-save" hidden>
      <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-cinema-preset-save-title">
        <div class="modal-header">
          <div class="modal-title" id="modal-cinema-preset-save-title"><i class="fas fa-save"></i> Save Preset</div>
          <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="display:grid; gap:10px; padding:16px 20px;">
          <label for="cinema-preset-name-input" style="color:var(--color-text-secondary)">Preset name</label>
          <input type="text" id="cinema-preset-name-input" placeholder="My awesome preset" maxlength="50" />
        </div>
        <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding: 12px 20px;">
          <button type="button" class="btn btn-secondary btn-sm" data-close-modal><span>Cancel</span></button>
          <button type="button" class="btn btn-secondary btn-sm text-accent" id="cinema-preset-save-ok"><i class="fas fa-check" aria-hidden="true"></i><span>Save</span></button>
        </div>
      </div>
    </div>

    <!-- Cinema Delete Preset Modal -->
    <div class="modal-overlay" id="modal-cinema-preset-delete" hidden>
      <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-cinema-preset-delete-title">
        <div class="modal-header">
          <div class="modal-title" id="modal-cinema-preset-delete-title"><i class="fas fa-trash"></i> Delete Preset</div>
          <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="padding:16px 20px; display:grid; gap:12px;">
          <p style="color:var(--color-text-secondary); margin:0;">Select a preset to delete:</p>
          <div id="cinema-preset-delete-list" style="display:flex; flex-direction:column; gap:6px; max-height:200px; overflow-y:auto;"></div>
          <p id="cinema-preset-delete-empty" style="color:var(--color-text-muted); margin:0; font-style:italic; display:none;">No custom presets saved yet.</p>
        </div>
        <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding: 12px 20px;">
          <button type="button" class="btn btn-secondary btn-sm" data-close-modal><span>Cancel</span></button>
          <button type="button" class="btn btn-secondary btn-sm text-error" id="cinema-preset-delete-ok" disabled><i class="fas fa-trash" aria-hidden="true"></i><span>Delete</span></button>
        </div>
      </div>
    </div>

    <!-- Cinema Manage Texts Modal (add/rename/delete in one place) -->
    <div class="modal-overlay" id="modal-cinema-manage" hidden>
      <div class="modal modal-md" role="dialog" aria-modal="true" aria-labelledby="modal-cinema-manage-title">
        <div class="modal-header">
          <div class="modal-title" id="modal-cinema-manage-title"><i class="fas fa-list"></i> Manage Texts</div>
          <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="display:grid; grid-template-columns: 1fr; gap:12px; padding:16px 20px;">
          <div id="cinema-manage-help" style="color:var(--color-text-secondary); font-size:.9rem;">Create, rename, or remove preset texts. Select one to rename or delete.</div>
          <div id="cinema-manage-list" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
          <div>
            <label for="cinema-manage-input" id="cinema-manage-input-label" style="color:var(--color-text-secondary)">Preset text</label>
            <input type="text" id="cinema-manage-input" placeholder="Type preset text…" />
          </div>
        </div>
        <div class="modal-footer" style="display:flex; gap:10px; justify-content:space-between; padding: 12px 20px;">
          <div style="display:flex; gap:8px;">
            <button type="button" class="btn btn-secondary btn-sm" id="cinema-manage-add"><i class="fas fa-plus"></i> <span>Add</span></button>
            <button type="button" class="btn btn-secondary btn-sm" id="cinema-manage-rename"><i class="fas fa-pen"></i> <span>Rename</span></button>
            <button type="button" class="btn btn-outline btn-sm" id="cinema-manage-delete"><i class="fas fa-trash"></i> <span>Delete</span></button>
          </div>
          <div style="display:flex; gap:8px;">
            <button type="button" class="btn btn-outline" data-close-modal>Close</button>
            <button type="button" class="btn btn-primary" id="cinema-manage-done"><i class="fas fa-check"></i> <span>Done</span></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance Section -->
    <section id="section-performance" class="app-section" hidden>
      <div class="panel" style="border: none; background: transparent; box-shadow: none;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; display: flex; align-items: center;">
            <span style="display: inline-flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); color: var(--color-text-primary); padding: 6px 16px; border-radius: 20px; font-size: 0.95rem; font-weight: 500; letter-spacing: 0.3px;">
              <i class="fas fa-chart-line" style="opacity: 0.8;"></i>
              Performance Dashboard
            </span>
          </h2>
          <div class="section-header-actions" style="display: flex; gap: 12px; align-items: center;"></div>
        </div>
        <div class="panel-content" style="padding: 0;">
          <!-- KPI Cards -->
          <section class="card-grid" id="perf-kpi-cards" style="margin-bottom: 32px;">
            <div class="status-card status-info" title="Current request rate per minute">
              <div class="card-icon"><i class="fas fa-clock"></i></div>
              <div class="card-content">
                <h3>Requests/min</h3>
                <span class="metric" id="perf-rpm">—</span>
                <span class="trend" id="perf-rpm-trend"></span>
              </div>
            </div>
            <div class="status-card status-success" title="Average response time in milliseconds">
              <div class="card-icon"><i class="fas fa-gauge-high"></i></div>
              <div class="card-content">
                <h3>API Latency</h3>
                <span class="metric" id="perf-latency">—</span>
                <span class="trend" id="perf-latency-trend"></span>
              </div>
            </div>
            <div class="status-card status-warning" title="Percentage of API response cache hits vs misses">
              <div class="card-icon"><i class="fas fa-bolt"></i></div>
              <div class="card-content">
                <h3>API Cache Hit Rate</h3>
                <span class="metric" id="perf-cache-hit">—</span>
                <span class="trend" id="perf-cache-trend"></span>
              </div>
            </div>
            <div class="status-card status-success" title="Number of connected devices via WebSocket">
              <div class="card-icon"><i class="fas fa-plug"></i></div>
              <div class="card-content">
                <h3>Active Devices</h3>
                <span class="metric" id="perf-ws-devices">—</span>
                <span class="trend" id="perf-ws-trend"></span>
              </div>
            </div>
          </section>

          <!-- Charts Grid -->
          <div class="content-grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
            <!-- Request Latency Chart -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title" style="display: flex; flex-direction: row; align-items: center; gap: 10px;">
                  <i class="fas fa-clock"></i>
                  <h3>Request Latency</h3>
                </div>
              </div>
              <div class="panel-content">
                <canvas id="chart-latency" style="max-height: 250px;"></canvas>
              </div>
            </div>

            <!-- Request Rate Chart -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title" style="display: flex; flex-direction: row; align-items: center; gap: 10px;">
                  <i class="fas fa-chart-area"></i>
                  <h3>Request Rate</h3>
                </div>
              </div>
              <div class="panel-content">
                <canvas id="chart-requests" style="max-height: 250px;"></canvas>
              </div>
            </div>

            <!-- System Resources Chart -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title" style="display: flex; flex-direction: row; align-items: center; gap: 10px;">
                  <i class="fas fa-microchip"></i>
                  <h3>System Resources</h3>
                </div>
              </div>
              <div class="panel-content">
                <canvas id="chart-system" style="max-height: 250px;"></canvas>
              </div>
            </div>

            <!-- Endpoint Performance - Bubble Chart (Full Width) -->
            <div class="panel" style="grid-column: 1 / -1;">
              <div class="panel-header">
                <div class="panel-title" style="display: flex; flex-direction: row; align-items: center; gap: 10px;">
                  <i class="fas fa-bullseye"></i>
                  <h3>Endpoint Performance Analysis</h3>
                </div>
              </div>
              <div class="panel-content">
                <canvas id="chart-endpoints" style="max-height: 350px;"></canvas>
              </div>
            </div>
          </div>

          <!-- Top Endpoints Table -->
          <div class="panel" style="margin-top: 24px;">
            <div class="panel-header">
              <div class="panel-title" style="display: flex; flex-direction: row; align-items: center; gap: 10px;">
                <i class="fas fa-list"></i>
                <h3>Endpoint Performance Monitor</h3>
              </div>
            </div>
            <div class="panel-content">
              <div style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
                <table class="data-table" id="perf-endpoints-table">
                <thead>
                  <tr>
                    <th class="sortable" data-sort="path">
                      Endpoint
                      <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="count">
                      Requests
                      <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="avgLatency">
                      Latency
                      <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="errorRate">
                      Error Rate
                      <i class="fas fa-sort sort-icon"></i>
                    </th>
                  </tr>
                </thead>
                <tbody id="perf-endpoints-tbody">
                  <tr>
                    <td colspan="4" style="text-align: center; padding: 20px; color: var(--color-text-secondary);">
                      <i class="fas fa-spinner fa-spin"></i> Loading...
                    </td>
                  </tr>
                </tbody>
              </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Devices Section (top-level sibling) -->
    <section id="section-devices" class="app-section" hidden>
      <!-- Device Management Tabs header (mirrors Media Sources/Display) -->
      <div class="panel" id="panel-device-management" style="border: none; background: transparent; box-shadow: none;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; display: flex; align-items: center;">
            <span style="display: inline-flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); color: var(--color-text-primary); padding: 6px 16px; border-radius: 20px; font-size: 0.95rem; font-weight: 500; letter-spacing: 0.3px;">
              <i class="fas fa-laptop" style="opacity: 0.8;"></i>
              Device Management
              <span class="badge badge-beta" style="margin-left: 4px;">BETA</span>
            </span>
          </h2>
          <div class="section-header-actions" style="display: flex; gap: 12px; align-items: center;"></div>
        </div>
        <div class="panel-content" style="padding: 0;">
          <div class="form-section" id="device-tabs">
            <div class="section-title"><i class="fas fa-layer-group"></i> Manage</div>
            <div class="form-row">
              <div class="segmented" role="tablist" aria-label="Manage">
                <div class="seg-indicator"></div>
                <label class="seg" id="seg-devices" role="tab" aria-controls="device-ui" aria-checked="false">
                  <input type="radio" name="devices.active" value="devices" />
                  <i class="fas fa-desktop"></i> Devices
                </label>
                <label class="seg" id="seg-profiles" role="tab" aria-controls="profiles-ui" aria-checked="false">
                  <input type="radio" name="devices.active" value="profiles" />
                  <i class="fas fa-id-card"></i> Profiles
                </label>
                <label class="seg" id="seg-dev-settings" role="tab" aria-controls="device-settings-inline" aria-checked="false">
                  <input type="radio" name="devices.active" value="settings" />
                  <i class="fas fa-sliders-h"></i> Settings
                </label>
              </div>
              <div class="device-actions-right">
                <div class="device-toolbar">
                  <div class="dropdown">
                    <button class="btn btn-outline btn-sm dropdown-toggle" id="device-filter-toggle">
                      <i class="fas fa-filter"></i>
                      Filter
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="device-filter-menu"></div>
                  </div>
                  <div class="dropdown">
                    <button class="btn btn-outline btn-sm dropdown-toggle" id="device-actions-toggle">
                      <i class="fas fa-gear"></i>
                      Actions
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="device-actions-menu"></div>
                  </div>
                  <div class="search-box device-search-box input-shell">
                    <i class="fas fa-search"></i>
                    <input id="device-search" type="text" placeholder="Search devices…">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Devices content (grid + pagination) -->
          <div id="device-ui">
            <div class="device-grid" id="device-grid">
              <!-- Device cards will be rendered dynamically from /api/devices -->
            </div>
            <div class="table-footer device-pagination">
              <div class="table-info" id="device-page-info">Showing 0 of 0 devices</div>
              <div class="pagination">
                <button class="btn btn-icon btn-sm" id="device-page-prev" aria-label="Previous page"><i class="fas fa-chevron-left"></i></button>
                <span class="page-numbers" id="device-page-numbers"></span>
                <button class="btn btn-icon btn-sm" id="device-page-next" aria-label="Next page"><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
          <!-- Profiles content -->
          <div id="profiles-ui" hidden>
            <div class="profiles-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 4px;">
              <div class="profiles-info" style="color: var(--color-text-secondary); font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> Device Profiles contain all display settings. Assign a profile to a device to apply its settings.
              </div>
              <button type="button" class="btn btn-primary btn-sm" id="btn-create-profile">
                <i class="fas fa-plus"></i> New Profile
              </button>
            </div>
            <div class="profiles-grid" id="profiles-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
              <!-- Profile cards will be rendered dynamically -->
            </div>
            <div id="profiles-empty" style="display: none; text-align: center; padding: 48px 24px; color: var(--color-text-secondary);">
              <i class="fas fa-id-card" style="font-size: 3rem; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
              <p style="margin: 0 0 16px 0;">No profiles created yet.</p>
              <button type="button" class="btn btn-primary btn-sm" id="btn-create-profile-empty">
                <i class="fas fa-plus"></i> Create your first profile
              </button>
            </div>
          </div>
          <!-- Inline Settings content (previously separate panel) -->
          <div id="device-settings-inline" hidden>
              <!-- IP Whitelist Section (styled like Automatic Updates card) -->
              <section class="perf-card" aria-label="IP Whitelist" id="card-ip-whitelist">
                <h3><i class="fas fa-shield-halved"></i> IP Whitelist</h3>
                <div class="card-subtext">Clients matching these IPv4 addresses or CIDR ranges will skip device registration and use global Display Settings. Useful for trusted kiosk displays.</div>
                <div class="form-row" style="margin-top:18px;">
                  <div id="device-whitelist-empty" style="display:none; opacity:.6; font-size:.85rem; margin-bottom:12px; color:#9ca3af;">No whitelist entries yet.</div>
                  <div id="device-whitelist-list" class="chip-container" style="margin:0 0 18px 0; display:flex; flex-wrap:wrap; gap:8px; min-height:28px;"></div>
                </div>
                <div class="form-row">
                  <div class="input-group" style="display:flex; gap:12px; align-items:stretch; flex-wrap:wrap; margin-bottom:16px;">
                    <input
                      type="text"
                      id="input-whitelist-entry"
                      class="form-input"
                      placeholder="192.168.1.25 or 192.168.0.0/16"
                      style="flex:0 1 48%; max-width:420px; min-width:220px; background:var(--color-bg-card) !important; color:var(--color-text-primary) !important; border:1px solid var(--color-border) !important; padding:var(--space-md) !important; border-radius:var(--border-radius-md) !important;"
                      pattern="[0-9\.\/]*"
                      title="Only numbers, dots, and forward slashes allowed for IP addresses and CIDR ranges"
                      autocomplete="off"
                      autocapitalize="off"
                      spellcheck="false"
                    />
                  </div>
                </div>
                <div class="actions main-actions">
                  <button type="button" id="btn-add-whitelist" class="btn btn-op-surface btn-violet btn-sm" title="Add entry">
                    <i class="fas fa-plus"></i><span>Add</span>
                  </button>
                  <button type="button" id="btn-whitelist-save" class="btn btn-op-surface btn-primary btn-sm" disabled>
                    <i class="fas fa-save"></i><span>Save Changes</span>
                  </button>
                </div>
                <div class="form-help" style="margin-top:10px; font-size:11px; opacity:.8;">
                  <strong>Formats:</strong> IPv4 addresses or CIDR ranges (e.g. 10.0.0.0/8, 192.168.1.0/24). Changes take effect within 30s or after server restart.
                </div>
                <div id="whitelist-status" class="form-status" style="display:none; margin-top:10px;"></div>
              </section>
              </div>
              <!-- Placeholder for future device management settings -->
              <div class="form-section" style="margin-top:32px;" hidden id="device-future-settings">
                <div class="section-title"><i class="fas fa-gears"></i> Additional Settings</div>
                <div class="section-subtitle">Future options will appear here such as pairing policies, heartbeat intervals, offline grace periods, API throttling and more.</div>
              </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Operations Section (top-level sibling) -->
  <section id="section-operations" class="app-section" hidden>
    <section class="panel operations-panel" style="border: none; background: transparent; box-shadow: none;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; display: flex; align-items: center;">
            <span style="display: inline-flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); color: var(--color-text-primary); padding: 6px 16px; border-radius: 20px; font-size: 0.95rem; font-weight: 500; letter-spacing: 0.3px;">
              <i class="fas fa-screwdriver-wrench" style="opacity: 0.8;"></i>
              Operations
            </span>
          </h2>
          <div class="section-header-actions" style="display: flex; gap: 12px; align-items: center;">
            <button type="button" id="btn-restart-server" class="btn btn-secondary btn-sm" title="Restart server">
              <i class="fas fa-rotate"></i><span>Restart Server</span>
            </button>
            <button type="button" id="btn-save-operations" class="btn btn-primary btn-sm" title="Save all operation settings">
              <i class="fas fa-save"></i><span>Save Settings</span>
            </button>
          </div>
        </div>
        <div class="panel-content" style="padding: 0;">
  <div class="content-grid" style="gap:12px;">
        <div class="ops-col">
            <!-- Auto-Update Operations (moved to top-left) -->
            <section class="perf-card" aria-label="Automatic Updates">
              <h3><i class="fas fa-download"></i> Automatic Updates</h3>
              <div class="card-pill-spot">
                <span id="update-phase-text" class="status-pill status-info" style="display:none;">Checking…</span>
                <span id="update-progress-percent" class="status-pill" style="display:none;">0%</span>
                <span id="update-idle-pill" class="status-pill status-success">Ready</span>
              </div>
              <div id="ops-update-status" class="status-display">
                <div id="update-idle-state"></div>
                <div id="update-progress-state" style="display:none;" class="mt-8">
                  <div class="meter mt-6">
                    <div id="update-progress-bar" style="width:0%; background: linear-gradient(90deg,#60a5fa,#1e40af);"></div>
                  </div>
                  <div id="update-message" class="subtle mt-6">Preparing…</div>
                </div>
              </div>
              <div class="actions main-actions">
                <button type="button" id="btn-start-update" class="btn btn-success btn-sm"><i class="fas fa-download"></i><span>Start Auto-Update</span></button>
                <button type="button" id="btn-rollback-update" class="btn btn-secondary btn-sm"><i class="fas fa-undo"></i><span>Rollback</span></button>
                <button type="button" id="btn-list-backups" class="btn btn-secondary btn-sm"><i class="fas fa-archive"></i><span>View Backups</span></button>
              </div>
              <div class="actions sub-actions">
                <div class="input-row">
                  <div class="form-group" style="margin:0;">
                    <div class="number-input-wrapper niw-compact">
                      <input type="number" id="input-keep-backups" min="1" max="20" value="5" />
                      <div class="number-controls" role="group">
                        <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                        <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                      </div>
                    </div>
                  </div>
                  <button type="button" id="btn-cleanup-backups" class="btn btn-secondary btn-sm"><i class="fas fa-trash"></i><span>Cleanup Old</span></button>
                </div>
              </div>
              <div id="backups-display" class="status-display" style="display:none; margin-top:10px;">
                <div class="subtle" style="display:flex; align-items:center; gap:8px;"><i class="fas fa-archive"></i> Available Backups</div>
                <div id="backups-content" class="metric-row" style="margin-top:6px;">
                  <div class="subtle">Loading…</div>
                </div>
              </div>
      </section>

            <!-- Client Debug Viewer -->
            <section class="perf-card" aria-label="Client Debug Viewer">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h3 style="margin: 0;"><i class="fas fa-bug"></i> Client Debug Viewer</h3>
                <label class="header-toggle" for="clientDebugViewer.enabled">
                  <input type="checkbox" id="clientDebugViewer.enabled" />
                  <span class="ht-switch" aria-hidden="true"></span>
                </label>
              </div>
              <div class="card-subtext">Enable semi-transparent debug log overlay on display devices for troubleshooting.</div>
            </section>

            <!-- Pause Indicator -->
            <section class="perf-card" aria-label="Pause Indicator">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h3 style="margin: 0;"><i class="fas fa-pause-circle"></i> Pause Indicator</h3>
                <label class="header-toggle" for="pauseIndicator.enabled">
                  <input type="checkbox" id="pauseIndicator.enabled" checked />
                  <span class="ht-switch" aria-hidden="true"></span>
                </label>
              </div>
              <div class="card-subtext">Show pause indicator overlay on displays when playback is paused.</div>
            </section>

            <!-- Burn-in Prevention -->
            <section class="perf-card" aria-label="Burn-in Prevention">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h3 style="margin: 0;"><i class="fas fa-tv"></i> Burn-in Prevention</h3>
                <label class="header-toggle" for="burnInPrevention.enabled">
                  <input type="checkbox" id="burnInPrevention.enabled" />
                  <span class="ht-switch" aria-hidden="true"></span>
                </label>
              </div>
              <div class="card-subtext">Protect OLED and plasma displays from burn-in with subtle pixel shifting and element cycling.</div>
              
              <div id="burnInPrevention-settings" style="display: none; margin-top: 16px;">
                <!-- Protection Level -->
                <div style="margin-bottom: 16px;">
                  <label for="burnInPrevention.level" style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Protection Level</label>
                  <select id="burnInPrevention.level" class="entry-select" style="width: 100%;">
                    <option value="subtle">Subtle (1px shift every 5 min)</option>
                    <option value="moderate">Moderate (2px shift + element cycling)</option>
                    <option value="aggressive">Aggressive (3px shift + cycling + refresh)</option>
                  </select>
                </div>
                
                <!-- Feature Toggles -->
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <label class="checkbox" for="burnInPrevention.pixelShift.enabled">
                    <input type="checkbox" id="burnInPrevention.pixelShift.enabled" checked />
                    <span class="checkmark"></span>
                    <span>Pixel Shift <span style="color: var(--text-secondary); font-size: 0.85em;">— subtle movement of all content</span></span>
                  </label>
                  <label class="checkbox" for="burnInPrevention.elementCycling.enabled">
                    <input type="checkbox" id="burnInPrevention.elementCycling.enabled" />
                    <span class="checkmark"></span>
                    <span>Element Cycling <span style="color: var(--text-secondary); font-size: 0.85em;">— reposition clock, headers</span></span>
                  </label>
                  <label class="checkbox" for="burnInPrevention.screenRefresh.enabled">
                    <input type="checkbox" id="burnInPrevention.screenRefresh.enabled" />
                    <span class="checkmark"></span>
                    <span>Screen Refresh <span style="color: var(--text-secondary); font-size: 0.85em;">— periodic blanking</span></span>
                  </label>
                </div>
              </div>
            </section>

            <!-- Entry Route (moved here to left column) -->
            <section class="perf-card entry-route-card" aria-label="Entry Route">
              <h3><i class="fas fa-signs-post"></i> Entry Route</h3>
              
              <!-- Settings grid -->
              <div class="entry-route-settings">
                <div class="setting-row">
                  <span class="setting-label">Behavior</span>
                  <div class="setting-controls">
                    <select id="rootRoute_behavior" class="entry-select">
                      <option value="landing">Show landing</option>
                      <option value="redirect">Redirect to a mode</option>
                    </select>
                  </div>
                </div>
                <div class="setting-row" id="rootRoute_status_wrap">
                  <span class="setting-label">Redirect status</span>
                  <div class="setting-controls">
                    <select id="rootRoute_statusCode" class="entry-select">
                      <option value="302">302 Temporary</option>
                      <option value="307">307 Temporary (preserve method)</option>
                    </select>
                  </div>
                </div>
                <div class="setting-row">
                  <span class="setting-label">Bypass query flag</span>
                  <div class="setting-controls">
                    <input id="rootRoute_bypassParam" type="text" placeholder="landing" class="input-bypass" maxlength="32" pattern="[A-Za-z][A-Za-z0-9_\-]*" />
                    <a id="rootRoute_bypass_open" href="/?landing" target="_blank" rel="noopener" class="btn btn-secondary btn-sm">Open /?landing</a>
                  </div>
                </div>
              </div>
            </section>

            <!-- MQTT Operations -->
            <section class="perf-card mqtt-card" aria-label="MQTT Operations">
              <!-- Header with title and status pill -->
              <div class="mqtt-header">
                <h3><i class="fas fa-broadcast-tower"></i> MQTT Integration</h3>
                <span class="header-pill status-warning" id="mqtt-status-pill">Disabled</span>
              </div>
              
              <!-- Enable toggles -->
              <div class="mqtt-toggles">
                <label class="checkbox">
                  <input type="checkbox" id="mqtt.enabled" />
                  <span class="checkmark"></span>
                  <span>Enable MQTT Integration</span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" id="mqtt.discovery.enabled" />
                  <span class="checkmark"></span>
                  <span>Enable Home Assistant Discovery</span>
                </label>
              </div>

              <!-- Settings (shown when enabled) -->
              <div id="mqtt-settings-group" class="mqtt-settings" style="display:none;">
                <div class="mqtt-settings-grid">
                  <div class="setting-row">
                    <span class="setting-label">Connection</span>
                    <div class="setting-controls">
                      <div class="input-group">
                        <label for="mqtt.broker">Host</label>
                        <input type="text" id="mqtt.broker" placeholder="192.168.1.100" class="input-host" />
                      </div>
                      <div class="input-group">
                        <label for="mqtt.port">Port</label>
                        <div class="number-input-wrapper niw-compact">
                          <input type="number" id="mqtt.port" min="1" max="65535" value="1883" />
                          <div class="number-controls" role="group">
                            <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                            <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="setting-row">
                    <span class="setting-label">Authentication</span>
                    <div class="setting-controls">
                      <div class="input-group">
                        <label for="mqtt.username">Username</label>
                        <input type="text" id="mqtt.username" placeholder="mqtt-user" class="input-auth" />
                      </div>
                      <div class="input-group">
                        <label for="mqtt.password">Password</label>
                        <input type="password" id="mqtt.password" placeholder="••••••••" class="input-auth" />
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="mqtt-actions">
                  <button type="button" id="btn-republish-mqtt" class="btn btn-success btn-sm">
                    <i class="fas fa-paper-plane"></i><span>Republish All Devices</span>
                  </button>
                  <button type="button" id="btn-generate-ha-dashboard" class="btn btn-primary btn-sm">
                    <i class="fas fa-home"></i><span>Generate HA Section</span>
                  </button>
                </div>
              </div>
            </section>

            <!-- MQTT Status Panel -->
            <section class="perf-card" aria-label="MQTT Status" id="mqtt-status-panel" style="display:none;">
              <h3><i class="fas fa-chart-line"></i> MQTT Status & Monitoring</h3>
              <div class="card-pill-spot">
                <span class="status-pill status-warning" id="mqtt-conn-pill">Checking...</span>
              </div>

              <!-- Broker Info -->
              <div class="metric-row mt-6" id="mqtt-broker-info" style="display:none;">
                <div style="display:flex;gap:20px;flex-wrap:wrap;font-size:0.85rem;color:var(--color-text-secondary);">
                  <span><span style="color:var(--color-text-tertiary);">Broker:</span> <span id="mqtt-broker-host" style="color:var(--color-text-primary);">-</span></span>
                  <span><span style="color:var(--color-text-tertiary);">Prefix:</span> <span id="mqtt-topic-prefix" style="color:var(--color-text-primary);">-</span></span>
                  <span><span style="color:var(--color-text-tertiary);">Discovery:</span> <span id="mqtt-discovery-status" style="color:var(--color-text-primary);">-</span></span>
                  <span><span style="color:var(--color-text-tertiary);">Uptime:</span> <span id="mqtt-uptime" style="color:var(--color-text-primary);">-</span></span>
                </div>
              </div>

              <!-- Compact Stats & Devices Grid -->
              <div class="metric-row" id="mqtt-stats-cards" style="display:none;margin-top:16px;">
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
                  <div style="background:var(--color-bg-tertiary);border:1px solid var(--color-border);padding:16px 12px;border-radius:8px;text-align:center;">
                    <div style="font-size:1.6rem;font-weight:700;color:var(--color-secondary);" id="mqtt-stat-published">0</div>
                    <div style="font-size:0.8rem;color:var(--color-text-tertiary);margin-top:4px;">Published</div>
                  </div>
                  <div style="background:var(--color-bg-tertiary);border:1px solid var(--color-border);padding:16px 12px;border-radius:8px;text-align:center;">
                    <div style="font-size:1.6rem;font-weight:700;color:var(--color-secondary);" id="mqtt-stat-received">0</div>
                    <div style="font-size:0.8rem;color:var(--color-text-tertiary);margin-top:4px;">Received</div>
                  </div>
                  <div style="background:var(--color-bg-tertiary);border:1px solid var(--color-border);padding:16px 12px;border-radius:8px;text-align:center;">
                    <div style="font-size:1.6rem;font-weight:700;color:var(--color-secondary);" id="mqtt-stat-commands">0</div>
                    <div style="font-size:0.8rem;color:var(--color-text-tertiary);margin-top:4px;">Commands</div>
                  </div>
                  <div style="background:var(--color-bg-tertiary);border:1px solid var(--color-border);padding:16px 12px;border-radius:8px;text-align:center;">
                    <div style="font-size:1.6rem;font-weight:700;color:var(--color-secondary);" id="mqtt-stat-devices">0</div>
                    <div style="font-size:0.8rem;color:var(--color-text-tertiary);margin-top:4px;">Devices</div>
                  </div>
                </div>
              </div>

              <!-- Compact Device Summary -->
              <div class="metric-row" id="mqtt-device-summary" style="display:none;margin-top:12px;">
                <div style="display:flex;gap:8px;align-items:center;font-size:0.9rem;color:var(--color-text-secondary);">
                  <span style="font-weight:500;color:var(--color-text-primary);">Devices:</span>
                  <span id="mqtt-devices-total" style="color:var(--color-text-primary);">0</span> <span style="color:var(--color-text-tertiary);">total</span>
                  <span style="color:var(--color-success);font-weight:600;" id="mqtt-devices-online">0</span> <span style="color:var(--color-text-tertiary);">online</span>
                  <span style="color:var(--color-error);font-weight:600;" id="mqtt-devices-offline">0</span> <span style="color:var(--color-text-tertiary);">offline</span>
                </div>
              </div>
            </section>
        </div>
  <div class="ops-col">
            <!-- Server Settings (under Server) -->
            <section class="perf-card" aria-label="Server Settings">
              <h3><i class="fas fa-gear"></i> Server</h3>
              <div class="metric-row">
                <div class="form-group inline-field nowrap" style="display: block;">
                  <label for="SERVER_PORT" style="margin:0;display:inline-flex;align-items:center;padding-right:12px;">Port</label>
                  <div class="number-input-wrapper niw-compact" style="display:inline-flex;">
                    <input type="number" id="SERVER_PORT" min="1024" max="65535" step="1" />
                    <div class="number-controls" role="group">
                      <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                      <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="metric-row mt-6">
                <div class="form-group" style="display: block;">
                  <label for="baseUrl" style="margin:0 0 4px 0;display:flex;align-items:center;justify-content:space-between;">
                    <span><i class="fas fa-link" style="margin-right:6px;"></i>Server Base URL</span>
                    <button type="button" id="copy-current-url-base" class="btn btn-link btn-sm" title="Copy current URL" style="padding:2px 8px;font-size:0.85rem;">
                      <i class="fas fa-copy"></i><span id="current-url-base-text">Loading...</span>
                    </button>
                  </label>
                  <input type="url" id="baseUrl" style="width:100%;max-width:800px;" placeholder="http://localhost:4000" 
                         title="External URL where Posterrama is accessible" />
                </div>
              </div>
            </section>

            <!-- Config Backups (redesigned) -->
            <section class="perf-card config-backups-card" aria-label="Config Backups">
              <!-- Header row with title and status pill -->
              <div class="config-backups-header">
                <h3><i class="fas fa-archive"></i> Config Backups</h3>
                <span id="cfg-backup-schedule-pill" class="header-pill status-info">Disabled</span>
              </div>

              <!-- Action buttons -->
              <div class="config-backups-actions">
                <button type="button" id="btn-create-cfg-backup" class="btn btn-success btn-sm">
                  <i class="fas fa-plus-circle"></i><span>Backup now</span>
                </button>
                <button type="button" id="btn-cleanup-cfg-backups" class="btn btn-secondary btn-sm">
                  <i class="fas fa-broom"></i><span>Cleanup old backups</span>
                </button>
              </div>

              <!-- Settings grid -->
              <div class="config-backups-settings">
                <div class="setting-row">
                  <span class="setting-label">Daily schedule</span>
                  <div class="setting-controls">
                    <label class="checkbox">
                      <input type="checkbox" id="input-cfg-backup-enabled" />
                      <span class="checkmark"></span>
                      <span>Enabled</span>
                    </label>
                    <div class="time-input-compact">
                      <i class="fas fa-clock"></i>
                      <input type="time" id="input-cfg-backup-time" value="02:30" aria-label="Backup time" />
                    </div>
                  </div>
                </div>
                <div class="setting-row">
                  <span class="setting-label">Retention</span>
                  <div class="setting-controls">
                    <span class="setting-sublabel">Keep</span>
                    <div class="number-input-wrapper niw-compact">
                      <input type="number" id="input-cfg-backup-retention-count" min="1" max="60" value="5" />
                      <div class="number-controls">
                        <button type="button" class="number-btn number-inc"><i class="fas fa-chevron-up"></i></button>
                        <button type="button" class="number-btn number-dec"><i class="fas fa-chevron-down"></i></button>
                      </div>
                    </div>
                    <span class="setting-sublabel">Max age (days)</span>
                    <div class="number-input-wrapper niw-compact">
                      <input type="number" id="input-cfg-backup-retention-days" min="0" max="365" value="0" />
                      <div class="number-controls">
                        <button type="button" class="number-btn number-inc"><i class="fas fa-chevron-up"></i></button>
                        <button type="button" class="number-btn number-dec"><i class="fas fa-chevron-down"></i></button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Backup summary -->
              <div id="cfg-backup-summary" class="config-backups-summary"></div>

              <!-- Backup list (collapsible) -->
              <details class="backup-list-collapsible" id="cfg-backup-details">
                <summary class="backup-list-toggle">
                  <i class="fas fa-chevron-right toggle-icon"></i>
                  <span>View Backups</span>
                  <span class="backup-count-badge" id="cfg-backup-count-badge">0</span>
                </summary>
                <div id="cfg-backup-list" class="compact-backup-list"></div>
              </details>
            </section>

            <!-- Promobox Site -->
            <section class="perf-card promobox-card" aria-label="Promobox Site">
              <!-- Header with title and status pill -->
              <div class="promobox-header">
                <h3><i class="fas fa-bullhorn"></i> Promobox Site</h3>
                <span class="header-pill status-warning" id="siteServer-pill">Disabled</span>
              </div>
              
              <!-- Enable toggle -->
              <div class="promobox-toggle">
                <label class="checkbox">
                  <input type="checkbox" id="siteServer.enabled" />
                  <span class="checkmark"></span>
                  <span>Enable Promobox Site</span>
                </label>
              </div>

              <!-- Settings (shown when enabled) -->
              <div id="siteServerPortGroup" class="promobox-settings" style="display:none;">
                <div class="setting-row">
                  <span class="setting-label">Port</span>
                  <div class="setting-controls">
                    <div class="number-input-wrapper niw-compact">
                      <input type="number" id="siteServer.port" min="1024" max="65535" value="4001" />
                      <div class="number-controls" role="group">
                        <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                        <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="setting-row" id="siteServerStatus" style="display:none;"></div>
              </div>
            </section>

            <!-- API Access -->
            <section class="perf-card" aria-label="API Access Management">
              <h3><i class="fas fa-code"></i> API Access</h3>
              <div class="card-pill-spot">
                <span class="status-pill" id="api-key-status-pill">Key: <span id="api-key-status-text">Loading…</span></span>
              </div>
              <div id="api-key-display" class="is-hidden mt-6">
                <div class="input-row">
                  <input id="api-key-input" type="password" readonly />
                  <div class="actions">
                    <button id="toggle-api-key-visibility-button" type="button" class="btn btn-icon btn-sm" title="Show/Hide"><i class="fas fa-eye"></i></button>
                    <button id="copy-api-key-button" type="button" class="btn btn-icon btn-sm" title="Copy to clipboard"><i class="fas fa-copy"></i></button>
                  </div>
                </div>
              </div>
              <div class="actions" style="margin-top:6px;">
                <button id="generate-api-key-button" type="button" class="btn btn-success btn-sm">
                  <i class="fas fa-key"></i>
                  <span>Generate New Key</span>
                </button>
                <button id="revoke-api-key-button" type="button" class="btn btn-error btn-sm" disabled>
                  <i class="fas fa-trash-alt"></i>
                  <span>Revoke Key</span>
                </button>
              </div>
            </section>

            <!-- Device Sync -->
            <section class="perf-card" aria-label="Device Sync">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h3 style="margin: 0;"><i class="fas fa-link"></i> Device Sync</h3>
                <label class="header-toggle" for="syncEnabled">
                  <input type="checkbox" id="syncEnabled" />
                  <span class="ht-switch" aria-hidden="true"></span>
                </label>
              </div>
              <div class="card-subtext">Synchronize transitions across multiple devices so they show the same content at the same time.</div>
              <div class="sync-delay-row mt-6">
                <label for="syncAlignMaxDelayMs">Max align delay (ms)</label>
                <div class="number-input-wrapper niw-compact">
                  <input type="number" id="syncAlignMaxDelayMs" min="0" step="50" />
                  <div class="number-controls" role="group">
                    <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                    <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                  </div>
                </div>
              </div>
            </section>

            <!-- Media Operations -->
            <section class="perf-card" aria-label="Media Operations">
              <h3><i class="fas fa-sync-alt"></i> Media</h3>
              <div class="metric-row mt-6">
                <div class="form-group inline-field nowrap" style="display: block;">
                  <label for="ops.backgroundRefreshMinutes" style="margin:0;display:inline-flex;align-items:center;padding-right:12px; white-space:nowrap;">Background Refresh (minutes)</label>
                  <div class="number-input-wrapper niw-compact" style="display:inline-flex;">
                    <input type="number" id="ops.backgroundRefreshMinutes" min="5" max="1440" step="1" value="60" />
                    <div class="number-controls" role="group">
                      <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                      <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                    </div>
                  </div>
                </div>
              </div>
        <div class="actions main-actions">
                <button type="button" id="btn-refresh-media" class="btn btn-success btn-sm">
                  <i class="fas fa-sync-alt"></i><span>Refresh Media</span>
                </button>
              </div>
            </section>

            

      

      
    </div>
          </div>
        </div>
      </section>
    </section>

    <!-- Logs Viewer Section -->
    <section id="section-logs" class="app-section" hidden>
      <div id="logs-viewer-container"></div>
    </section>

  </main>

  <!-- Change Password Modal -->
  <div class="modal-overlay" id="modal-change-password">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-change-password-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-change-password-title"><i class="fas fa-key"></i> Change Password</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 24px;">
        
        <!-- Security icon and intro -->
        <div style="margin-bottom: 24px;">
          <div style="
            width: 64px; 
            height: 64px; 
            margin: 0 auto 16px auto; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
          ">
            <i class="fas fa-key" style="font-size: 24px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600;">Update Your Password</h3>
          <p style="margin: 0; font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.4;">
            Choose a strong password to keep your account secure
          </p>
        </div>

        <!-- Password form section -->
        <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.06);">
          
          <!-- Current password -->
          <div style="margin-bottom: 16px; text-align: left;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-unlock" style="color: var(--color-warning); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.85rem;">Current Password</span>
            </div>
            <input 
              type="password" 
              id="input-current-password" 
              autocomplete="current-password" 
              placeholder="Enter your current password"
              style="
                width: 100%;
                padding: 10px 12px;
                border-radius: 6px;
                border: 2px solid rgba(255,255,255,0.1);
                background: rgba(255,255,255,0.05);
                color: white;
                font-size: 0.9rem;
                transition: border-color 0.2s ease;
              "
            />
          </div>
          
          <!-- New password -->
          <div style="margin-bottom: 16px; text-align: left;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-lock" style="color: var(--color-success); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.85rem;">New Password</span>
            </div>
            <input 
              type="password" 
              id="input-new-password" 
              autocomplete="new-password" 
              placeholder="Enter a strong new password"
              style="
                width: 100%;
                padding: 10px 12px;
                border-radius: 6px;
                border: 2px solid rgba(255,255,255,0.1);
                background: rgba(255,255,255,0.05);
                color: white;
                font-size: 0.9rem;
                transition: border-color 0.2s ease;
              "
            />
          </div>
          
          <!-- Confirm password -->
          <div style="margin-bottom: 16px; text-align: left;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-check-circle" style="color: var(--color-accent); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.85rem;">Confirm Password</span>
            </div>
            <input 
              type="password" 
              id="input-confirm-password" 
              autocomplete="new-password" 
              placeholder="Confirm your new password"
              style="
                width: 100%;
                padding: 10px 12px;
                border-radius: 6px;
                border: 2px solid rgba(255,255,255,0.1);
                background: rgba(255,255,255,0.05);
                color: white;
                font-size: 0.9rem;
                transition: border-color 0.2s ease;
              "
            />
          </div>

          <!-- Password strength indicator -->
          <div id="password-strength" style="margin-bottom: 12px; text-align: left; display: none;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <i class="fas fa-shield-alt" style="font-size: 0.75rem; color: rgba(255,255,255,0.6);"></i>
              <span style="font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.8);">Password Strength</span>
            </div>
            <div style="display: flex; gap: 2px; margin-bottom: 6px;">
              <div class="strength-bar" style="height: 4px; flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px;"></div>
              <div class="strength-bar" style="height: 4px; flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px;"></div>
              <div class="strength-bar" style="height: 4px; flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px;"></div>
              <div class="strength-bar" style="height: 4px; flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px;"></div>
            </div>
            <div id="strength-text" style="font-size: 0.7rem; color: rgba(255,255,255,0.6);"></div>
          </div>

          <!-- Status message -->
          <div id="password-status" class="status-message" style="display: none; margin-top: 12px;"></div>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px;">
        <button type="button" class="btn btn-outline" data-close-modal style="min-width: 80px;">Cancel</button>
        <button type="button" id="btn-change-password" class="btn btn-primary" style="min-width: 140px;">
          <i class="fas fa-key"></i><span>Change Password</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div class="modal-overlay" id="modal-error">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-error-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-error-title"><i class="fas fa-exclamation-triangle"></i> Validation Error</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 24px;">
        
        <!-- Error icon and message -->
        <div style="margin-bottom: 24px;">
          <div style="
            width: 64px; 
            height: 64px; 
            margin: 0 auto 16px auto; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: linear-gradient(135deg, var(--color-warning), #ff6b35);
            box-shadow: 0 6px 20px rgba(255,107,53,0.3);
          ">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600;">Invalid Input</h3>
          <p id="modal-error-message" style="margin: 0; font-size: 0.9rem; color: rgba(255,255,255,0.8); line-height: 1.4;">
            <!-- Error message will be set by JavaScript -->
          </p>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: center; padding: 16px 24px;">
        <button type="button" class="btn btn-primary" data-close-modal style="min-width: 80px;">
          <i class="fas fa-check"></i><span>OK</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 2FA Enable Modal (theme-demo structure) -->
  <div class="modal-overlay" id="modal-2fa">
    <div class="modal modal-md" role="dialog" aria-modal="true" aria-labelledby="modal-2fa-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-2fa-title"><i class="fas fa-shield-alt"></i> Enable Two-Factor Authentication</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 24px;">
        
        <!-- Compact security icon and intro -->
        <div style="margin-bottom: 24px;">
          <div style="
            width: 60px; 
            height: 60px; 
            margin: 0 auto 16px auto; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: linear-gradient(135deg, var(--color-teal), var(--color-info));
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
          ">
            <i class="fas fa-shield-alt" style="font-size: 24px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600; color: var(--color-info);">Secure Your Account</h3>
          <p style="margin: 0; font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.4;">
            Add an extra layer of security with 2FA
          </p>
        </div>

        <!-- Compact steps in horizontal layout -->
        <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.06);">
          
          <!-- Two-column layout for steps -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
            
            <!-- Step 1: QR Code -->
            <div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; justify-content: center;">
                <div style="
                  width: 24px; 
                  height: 24px; 
                  border-radius: 50%; 
                  background: var(--color-info); 
                  display: flex; 
                  align-items: center; 
                  justify-content: center;
                  font-size: 0.75rem;
                  font-weight: 700;
                  color: white;
                ">1</div>
                <span style="font-weight: 600; font-size: 0.9rem;">Scan QR Code</span>
              </div>
              
              <div id="qr-code-container" style="
                background: white; 
                border-radius: 8px; 
                padding: 12px; 
                margin: 0 auto 8px auto; 
                display: inline-block;
                box-shadow: 0 3px 8px rgba(0,0,0,0.15);
              ">
                <div class="subtle" style="color: #666; font-size: 0.85rem;">Loading QR...</div>
              </div>
              
              <p style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin: 0; line-height: 1.3;">
                Use any TOTP app
              </p>
            </div>

            <!-- Step 2: Verification -->
            <div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; justify-content: center;">
                <div style="
                  width: 24px; 
                  height: 24px; 
                  border-radius: 50%; 
                  background: var(--color-teal); 
                  display: flex; 
                  align-items: center; 
                  justify-content: center;
                  font-size: 0.75rem;
                  font-weight: 700;
                  color: white;
                ">2</div>
                <span style="font-weight: 600; font-size: 0.9rem;">Enter Code</span>
              </div>
              
              <div style="margin-top: 8px;">
                <input 
                  id="input-2fa-token" 
                  inputmode="numeric" 
                  autocomplete="one-time-code" 
                  placeholder="000 000" 
                  maxlength="7"
                  style="
                    width: 140px;
                    font-size: 1rem;
                    font-weight: 600;
                    text-align: center;
                    letter-spacing: 0.4em;
                    padding: 10px 12px;
                    border-radius: 6px;
                    border: 2px solid rgba(255,255,255,0.1);
                    background: rgba(255,255,255,0.05);
                    color: white;
                  " 
                />
              </div>
              
              <p style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin: 8px 0 0 0; line-height: 1.3;">
                6-digit verification code
              </p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px;">
        <button type="button" class="btn btn-outline" data-close-modal style="min-width: 80px;">Cancel</button>
        <button type="button" id="btn-2fa-verify" class="btn btn-success" style="min-width: 140px;">
          <i class="fas fa-check-circle"></i><span>Verify & Enable</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 2FA Disable Modal (theme-demo structure) -->
  <div class="modal-overlay" id="modal-2fa-disable">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-2fa-disable-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-2fa-disable-title"><i class="fas fa-shield-alt"></i> Disable Two-Factor Authentication</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 20px;">
        
        <!-- Compact warning icon and message -->
        <div style="margin-bottom: 20px;">
          <div style="
            width: 60px; 
            height: 60px; 
            margin: 0 auto 12px auto; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: linear-gradient(135deg, var(--color-warning), var(--color-error));
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
          ">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600;">Disable Two-Factor Auth</h3>
          <p style="margin: 0; font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.4;">
            This will reduce your account security
          </p>
        </div>

        <!-- Compact password input section -->
        <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.06);">
          <div style="margin-bottom: 12px; text-align: left;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-key" style="color: var(--color-warning); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.85rem;">Confirm with password</span>
            </div>
            <input 
              type="password" 
              id="input-2fa-disable-password" 
              autocomplete="current-password" 
              placeholder="Current password"
              style="
                width: 100%;
                padding: 10px 12px;
                border-radius: 6px;
                border: 2px solid rgba(255,255,255,0.1);
                background: rgba(255,255,255,0.05);
                color: white;
                font-size: 0.95rem;
              "
            />
          </div>
          
          <!-- Compact security warning -->
          <div style="
            background: rgba(var(--color-warning-rgb, 251, 191, 36), 0.1); 
            border: 1px solid rgba(var(--color-warning-rgb, 251, 191, 36), 0.2);
            border-radius: 6px; 
            padding: 8px; 
            text-align: left;
          ">
            <div style="display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-info-circle" style="color: var(--color-warning); font-size: 0.75rem; flex-shrink: 0;"></i>
              <div style="font-size: 0.75rem; color: var(--color-warning); line-height: 1.3;">
                Your account will only be protected by password
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding:16px 20px;">
    <button type="button" class="btn btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
  <button type="button" id="btn-2fa-disable-confirm" class="btn btn-sm">
          <i class="fas fa-shield-alt" aria-hidden="true"></i><span>Disable 2FA</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Device Merge Modal -->
  <div class="modal-overlay" id="modal-merge">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-merge-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-merge-title"><i class="fas fa-object-group"></i> Merge Devices</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-grid" style="margin-top: var(--space-sm);">
          <div class="form-group">
            <label for="merge-source">Source Device</label>
            <div class="select-wrap has-caret">
              <select id="merge-source"></select>
              <span class="select-caret" aria-hidden="true">▾</span>
            </div>
          </div>
          <div class="form-group">
            <label for="merge-target">Target Device</label>
            <div class="select-wrap has-caret">
              <select id="merge-target"></select>
              <span class="select-caret" aria-hidden="true">▾</span>
            </div>
            <p class="form-hint" style="margin-top:8px; font-size:.7rem; opacity:.65; line-height:1.3;">The source device's data & settings will be merged into the target. Source will then be removed.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding:16px 20px;">
        <button class="btn btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
        <button class="btn btn-sm btn-merge-accent" id="btn-merge-confirm"><i class="fas fa-object-group" aria-hidden="true"></i><span>Merge</span></button>
      </div>
    </div>
  </div>

  <!-- Bulk Selection Bar (from theme-demo) -->
  <div class="bulk-bar" id="bulk-bar" aria-live="polite">
    <div class="bulk-inner">
      <div class="bulk-count"><strong id="bulk-count">0</strong> selected</div>
  <div class="bulk-actions">
        <button class="btn btn-warning btn-sm" id="bulk-poweroff" title="Power toggle"><i class="fas fa-power-off"></i></button>
        <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-reload" title="Reload devices"><i class="fas fa-rotate-right"></i></button>
        <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-clearcache" title="Clear caches"><i class="fas fa-broom"></i></button>
        <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-pair" title="Generate pairing code"><i class="fas fa-qrcode"></i></button>
        <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-override" title="Edit display settings override"><i class="fas fa-sliders"></i></button>
        <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-sendcmd" title="Send command"><i class="fas fa-terminal"></i></button>
  <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-clearoverrides" title="Clear overrides for selected devices"><i class="fas fa-eraser"></i></button>
  <button class="btn btn-secondary btn-sm" id="bulk-playpause" title="Play/Pause"><i class="fas fa-play"></i></button>
        <button class="btn btn-error btn-sm" id="bulk-delete" title="Delete selected"><i class="fas fa-trash"></i></button>
        <button class="btn btn-outline btn-sm" id="bulk-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
        <div class="dropdown">
          <button class="btn btn-icon btn-sm" id="bulk-more" title="More"><i class="fas fa-ellipsis"></i></button>
          <div class="dropdown-menu" id="bulk-more-menu"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Remote Control Modal -->
  
  <div class="modal-overlay" id="modal-remote">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="remote-title">
      <div class="modal-header">
        <div class="modal-title" id="remote-title"><i class="fas fa-gamepad"></i> Remote Control <span id="remote-target-name" style="opacity:.75"></span></div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <!-- Remote panel: Navigation + Play/Pause -->
        <div class="remote-panel">
          <div class="remote-nav remote-nav-compact">
            <button class="btn" data-remote="left" title="Previous" aria-label="Previous"><i class="fas fa-arrow-left"></i></button>
            <button class="btn" data-remote="select" id="remote-playpause-btn" title="Play/Pause" aria-label="Play or Pause"><i class="fas fa-play" id="remote-playpause-icon"></i></button>
            <button class="btn" data-remote="right" title="Next" aria-label="Next"><i class="fas fa-arrow-right"></i></button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close-modal>Close</button>
      </div>
    </div>
  </div>

  <!-- Display Settings Override Modal -->
  <div class="modal-overlay" id="modal-override">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="override-title">
      <div class="modal-header">
        <div class="modal-title" id="override-title"><i class="fas fa-sliders"></i> Display Settings Override</div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
  <p class="override-intro">Override display settings (JSON).</p>
        
        <!-- Plex Username Field (for Now Playing Cinema mode) -->
        <div class="form-group" style="margin-bottom: 16px;" id="override-plex-username-group">
          <label for="override-plex-username" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <i class="fas fa-user" style="color: var(--color-teal);"></i>
            <span>Plex Username</span>
            <span style="font-size: 0.85rem; color: var(--color-text-secondary); font-weight: normal;">(optional, for Cinema Now Playing)</span>
          </label>
          <input type="text" id="override-plex-username" placeholder="Enter Plex username for this device" style="width: 100%;" />
          <p style="font-size: 0.8rem; color: var(--color-text-secondary); margin: 6px 0 0 0; line-height: 1.4;">
            <i class="fas fa-info-circle"></i> When set, Cinema mode will show posters from this user's active Plex sessions
          </p>
        </div>
        
        <div class="override-helper override-layout">
          <div class="override-row">
            <div class="mode-segment" id="mode-segment" role="radiogroup" aria-label="Display mode">
              <span class="seg-indicator" aria-hidden="true"></span>
              <button type="button" role="radio" aria-checked="false" data-mode="general" class="seg-btn">Screensaver</button>
              <button type="button" role="radio" aria-checked="false" data-mode="wallart" class="seg-btn">Wallart</button>
              <button type="button" role="radio" aria-checked="false" data-mode="cinema" class="seg-btn">Cinema</button>
              <span class="mode-badge" id="mode-mixed-badge" hidden>Mixed</span>
            </div>
            <div class="menu-shell">
              <div class="menu-section"><i class="fas fa-key"></i><span class="menu-label">Keys</span></div>
              <div class="ov-filter-wrap input-shell search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="ov-keys-search" placeholder="Search keys…" aria-label="Search keys" />
              </div>
            </div>
          </div>
          <div class="override-snippets" id="override-snippets" aria-label="Quick JSON snippets" role="toolbar">
            <button type="button" class="ov-snippet" data-override-snippet='{"wallart":{"duration":45}}'>wallart.duration</button>
            <button type="button" class="ov-snippet" data-override-snippet='{"wallart":{"shuffle":true}}'>wallart.shuffle</button>
            <button type="button" class="ov-snippet" data-override-snippet='{"screensaver":{"interval":120}}'>screensaver.interval</button>
            <button type="button" class="ov-snippet" data-override-snippet='{"cinema":{"ambilight":{"strength":70}}}'>cinema.ambilight.strength</button>
            <button type="button" class="ov-snippet" data-override-snippet='{"display":{"orientation":"landscape"}}'>display.orientation</button>
            <button type="button" class="ov-snippet" data-override-snippet='{"display":{"theme":"dark"}}'>display.theme</button>
          </div>
          <div class="override-keys-panel" id="override-keys-panel">
            <div id="ov-keys-list" class="ov-keys-list" role="listbox" aria-label="Override keys list"></div>
            <div id="ov-keys-empty" class="ov-keys-empty">Start typing to see matching keys.</div>
          </div>
          <div class="override-conflicts" id="override-conflicts" hidden>
            <div class="conflicts-header">
              <button type="button" class="btn btn-outline btn-xs" id="conflicts-toggle"><i class="fas fa-code-branch"></i> Conflicts <span id="conflict-count">0</span></button>
              <button type="button" class="btn btn-outline btn-xs" id="conflicts-rescan" title="Rescan conflicts"><i class="fas fa-rotate"></i></button>
            </div>
            <div class="conflicts-body" id="conflicts-body" hidden>
              <div class="conflict-list-empty" id="conflicts-empty">No conflicts</div>
              <ul class="conflict-list" id="conflict-list" aria-label="Conflict keys"></ul>
              <div class="conflict-hint">Click a value to apply it; it will be removed from conflicts.</div>
            </div>
          </div>
        </div>
        <div class="override-json-shell">
          <div class="toolbar-row">
            <span class="label-spacer" aria-hidden="true"></span>
            <div class="override-actions" id="override-toolbar">
              <button type="button" class="btn btn-outline btn-sm" id="override-format" title="Format JSON"><i class="fas fa-magic"></i></button>
              <button type="button" class="btn btn-outline btn-sm" id="override-clear" title="Clear JSON"><i class="fas fa-eraser"></i></button>
              <button type="button" class="btn btn-outline btn-sm" id="override-clean" title="Reduce to current mode keys"><i class="fas fa-broom"></i></button>
            </div>
          </div>
          <textarea id="override-json" rows="12" class="override-json" placeholder='{"wallart": {"duration": 30}}'></textarea>
        </div>
        <div id="override-json-status" class="override-status" aria-live="polite"></div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end;">
        <button class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
  <button class="btn btn-secondary btn-sm btn-accent btn-override-accent" id="btn-override-apply"><i class="fas fa-check" aria-hidden="true"></i><span>Apply</span></button>
      </div>
    </div>
  </div>


  <!-- Send Command Modal -->
  <div class="modal-overlay" id="modal-sendcmd">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sendcmd-title" style="width:min(96vw, 560px)">
      <div class="modal-header">
        <div class="modal-title" id="sendcmd-title"><i class="fas fa-terminal"></i> Send Command</div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="padding:14px 16px;">
        
        <div class="form-group">
          <label for="sendcmd-select">Command</label>
          <div class="select-wrap has-caret" style="width:100%">
          <select id="sendcmd-select" style="width:100%">
            <option value="" selected>— Choose a command —</option>
            <optgroup label="Playback">
              <option value="playback.prev">playback.prev</option>
              <option value="playback.next">playback.next</option>
              <option value="playback.pause">playback.pause</option>
              <option value="playback.resume">playback.resume</option>
              <option value="playback.toggle">playback.toggle</option>
            </optgroup>
            <optgroup label="Power">
              <option value="power.on">power.on</option>
              <option value="power.off">power.off</option>
              <option value="power.toggle">power.toggle</option>
            </optgroup>
            <optgroup label="Management">
              <option value="core.mgmt.reload">core.mgmt.reload</option>
              <option value="core.mgmt.reset">core.mgmt.reset</option>
              <option value="core.mgmt.clearCache">core.mgmt.clearCache</option>
              <option value="core.mgmt.swUnregister">core.mgmt.swUnregister</option>
            </optgroup>
            <option value="__custom">Custom…</option>
          </select>
          <span class="select-caret" aria-hidden="true">▾</span>
          </div>
        </div>

        <div class="form-group" style="margin-top:10px;">
          <label for="sendcmd-type">Type</label>
          <input id="sendcmd-type" type="text" placeholder="e.g. playback.toggle" />
        </div>
        <div class="form-group" style="margin-top:10px;">
          <label for="sendcmd-payload">Payload (JSON, optional)</label>
          <textarea id="sendcmd-payload" rows="6" style="width:100%;" placeholder="{ }"></textarea>
        </div>
      </div>
  <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end;">
    <button class="btn btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
    <button class="btn btn-sm btn-sendcmd-accent" id="btn-sendcmd-apply"><i class="fas fa-paper-plane" aria-hidden="true"></i><span>Send</span></button>
      </div>
    </div>
  </div>

  <!-- Pairing Codes Modal -->
  <div class="modal-overlay" id="modal-pairing">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pairing-title">
      <div class="modal-header">
        <div class="modal-title" id="pairing-title"><i class="fas fa-qrcode"></i> Pairing Codes</div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
  <div class="modal-body" style="display:grid; gap:12px;">
        <div id="pairing-namebar" class="pairing-namebar" hidden>
          <i class="fas fa-desktop" aria-hidden="true"></i>
          <span id="pairing-namebar-text">—</span>
        </div>
        <div id="pairing-list" style="display:grid; gap:12px;"></div>
        <!-- dynamically filled: per device code + QR image -->
      </div>
      <div class="modal-footer pairing-footer">
        <div class="pairing-exp subtle" id="pairing-exp-footer"></div>
  <button class="btn btn-outline" data-close-modal>Close</button>
      </div>
    </div>
  </div>

  <!-- Create Device Modal -->
  <div class="modal-overlay" id="modal-create-device">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="create-device-title">
      <div class="modal-header">
        <div class="modal-title" id="create-device-title"><i class="fas fa-plus"></i> New Device</div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label for="create-device-name">Name</label>
            <input id="create-device-name" type="text" placeholder="Optional" />
          </div>
          <div class="form-group">
            <label for="create-device-location-select">Location</label>
            <div class="select-wrap has-caret">
              <select id="create-device-location-select"></select>
              <span class="select-caret" aria-hidden="true">▾</span>
            </div>
            <input id="create-device-location-new" type="text" placeholder="New location" style="display:none; margin-top:8px;" />
          </div>
          <div class="form-group">
            <label for="create-device-groups">Groups</label>
            <select id="create-device-groups" multiple size="4" style="min-height: 110px;"></select>
            <div class="hint" style="margin-top:6px; color: var(--color-text-muted); font-size:.85rem;">Optional. Select one or more groups.</div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end;">
        <button class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
  <button class="btn btn-secondary btn-sm btn-accent btn-create-accent" id="btn-create-device-confirm">
          <i class="fas fa-check" aria-hidden="true"></i><span>Create &amp; Pair</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Profile Builder Modal -->
  <div class="modal-overlay" id="modal-profile-builder">
    <div class="modal modal-xl" role="dialog" aria-modal="true" aria-labelledby="modal-profile-title" style="width: 90vw; max-width: 1600px;">
      <div class="modal-header">
        <div class="modal-title" id="modal-profile-title">
          <i class="fas fa-id-card"></i>
          <span id="profile-modal-title-text">Create Profile</span>
        </div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="max-height: 80vh; overflow-y: auto; padding: 0;">
        <!-- Header: Name, Description, Mode selector -->
        <div class="profile-builder-header">
          <div class="form-group">
            <label for="profile-name">Profile Name *</label>
            <input id="profile-name" type="text" placeholder="e.g. Living Room 4K" required />
          </div>
          <div class="form-group">
            <label for="profile-description">Description</label>
            <input id="profile-description" type="text" placeholder="Optional" />
          </div>
          <div class="form-group profile-mode-select">
            <label><i class="fas fa-layer-group"></i> Display Mode</label>
            <div class="segmented" role="tablist" aria-label="Profile Display Mode">
              <label class="seg" role="tab"><input type="radio" name="profile-mode" value="screensaver" checked /><i class="fas fa-image"></i> Screensaver</label>
              <label class="seg" role="tab"><input type="radio" name="profile-mode" value="wallart" /><i class="fas fa-images"></i> Wallart</label>
              <label class="seg" role="tab"><input type="radio" name="profile-mode" value="cinema" /><i class="fas fa-tv" style="transform: rotate(90deg);"></i> Cinema</label>
            </div>
          </div>
        </div>
        
        <!-- Settings Container -->
        <div id="profile-settings-container" class="profile-settings-container">
          <div class="profile-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <div>Loading settings...</div>
          </div>
        </div>
        
        <!-- JSON Section -->
        <div class="profile-json-section">
          <details>
            <summary><i class="fas fa-code"></i> Advanced (Raw JSON)</summary>
            <div class="json-editor-wrap">
              <p>Edit raw JSON settings. Changes here override form values.</p>
              <textarea id="profile-json-editor" rows="5" placeholder='{"cinemaMode": true, ...}'></textarea>
              <div id="profile-json-error"></div>
            </div>
          </details>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-sm btn-danger" id="btn-profile-delete" style="display: none;">
          <i class="fas fa-trash" aria-hidden="true"></i><span>Delete</span>
        </button>
        <div class="modal-footer-actions">
          <button class="btn btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
          <button class="btn btn-sm btn-assign-accent" id="btn-profile-save">
            <i class="fas fa-save" aria-hidden="true"></i><span>Save Profile</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Create Modal -->
  <div class="modal-overlay" id="modal-profile-create">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-profile-create-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-profile-create-title"><i class="fas fa-plus-circle"></i> Create New Profile</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="display:grid; gap:14px; padding:16px 20px;">
        <p style="color:var(--color-text-secondary); margin:0;">Create a profile to save custom display settings that can be assigned to devices.</p>
        <div class="form-group" style="margin:0;">
          <label for="profile-create-name" style="color:var(--color-text-secondary); margin-bottom:6px; display:block;">Profile Name *</label>
          <input type="text" id="profile-create-name" placeholder="e.g. Living Room 4K" maxlength="100" style="width:100%;" />
        </div>
        <div class="form-group" style="margin:0;">
          <label for="profile-create-description" style="color:var(--color-text-secondary); margin-bottom:6px; display:block;">Description (optional)</label>
          <input type="text" id="profile-create-description" placeholder="e.g. Dark mode with slow transitions" maxlength="200" style="width:100%;" />
        </div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding: 12px 20px;">
        <button type="button" class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
        <button type="button" class="btn btn-secondary btn-sm btn-profile-accent" id="btn-profile-create-confirm"><i class="fas fa-plus" aria-hidden="true"></i><span>Create Profile</span></button>
      </div>
    </div>
  </div>

  <!-- Profile Rename Modal -->
  <div class="modal-overlay" id="modal-profile-rename">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-profile-rename-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-profile-rename-title"><i class="fas fa-pen"></i> Rename Profile</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="display:grid; gap:14px; padding:16px 20px;">
        <div class="form-group" style="margin:0;">
          <label for="profile-rename-name" style="color:var(--color-text-secondary); margin-bottom:6px; display:block;">Profile Name *</label>
          <input type="text" id="profile-rename-name" placeholder="Enter profile name" maxlength="100" style="width:100%;" />
        </div>
        <div class="form-group" style="margin:0;">
          <label for="profile-rename-description" style="color:var(--color-text-secondary); margin-bottom:6px; display:block;">Description (optional)</label>
          <input type="text" id="profile-rename-description" placeholder="Enter description" maxlength="200" style="width:100%;" />
        </div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding: 12px 20px;">
        <button type="button" class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
        <button type="button" class="btn btn-secondary btn-sm btn-profile-accent" id="btn-profile-rename-confirm"><i class="fas fa-check" aria-hidden="true"></i><span>Save</span></button>
      </div>
    </div>
  </div>

  <!-- Profile Delete Modal -->
  <div class="modal-overlay" id="modal-profile-delete">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-profile-delete-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-profile-delete-title"><i class="fas fa-trash"></i> Delete Profile</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="display:grid; gap:14px; padding:16px 20px;">
        <p id="profile-delete-message" style="color:var(--color-text-secondary); margin:0;">Are you sure you want to delete this profile?</p>
        <div id="profile-delete-warning" style="display:none; padding:12px; background:rgba(var(--color-warning-rgb, 255, 171, 0), 0.1); border-radius:6px; border:1px solid rgba(var(--color-warning-rgb, 255, 171, 0), 0.3);">
          <p style="margin:0; color:var(--color-warning);"><i class="fas fa-exclamation-triangle"></i> <span id="profile-delete-device-warning"></span></p>
        </div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding: 12px 20px;">
        <button type="button" class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
        <button type="button" class="btn btn-secondary btn-sm btn-profile-delete" id="btn-profile-delete-confirm"><i class="fas fa-trash" aria-hidden="true"></i><span>Delete</span></button>
      </div>
    </div>
  </div>

  <!-- Assign Profile Modal -->
  <div class="modal-overlay" id="modal-assign-profile">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-assign-profile-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-assign-profile-title">
          <i class="fas fa-id-card"></i>
          Assign Profile
        </div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p>Select a profile to assign to the selected devices, or clear the current profile.</p>
        <div class="form-group" style="margin-top: var(--space-md);">
          <label for="assign-profile-select">Profile</label>
          <div class="select-wrap has-caret">
            <select id="assign-profile-select"></select>
            <span class="select-caret" aria-hidden="true">▾</span>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end;">
        <button class="btn btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
        <button class="btn btn-sm btn-remove-accent" id="btn-profile-clear"><i class="fas fa-ban" aria-hidden="true"></i><span>Clear</span></button>
        <button class="btn btn-sm btn-assign-accent" id="btn-profile-assign"><i class="fas fa-id-card" aria-hidden="true"></i><span>Assign</span></button>
      </div>
    </div>
  </div>

  <!-- Group Assign Modal (DEPRECATED - kept for migration) -->
  <div class="modal-overlay" id="modal-group-assign" style="display: none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-group-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-group-title">
          <i class="fas fa-layer-group"></i>
          Assign to Group
        </div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p>Select a group to assign or remove for the selected devices.</p>
        <div class="form-group" style="margin-top: var(--space-md);">
          <label for="group-select">Group</label>
          <div class="select-wrap has-caret">
            <select id="group-select"></select>
            <span class="select-caret" aria-hidden="true">▾</span>
          </div>
        </div>
        <div class="form-group" style="margin-top: var(--space-md);">
          <label for="new-group-name">Or create a new group</label>
          <div style="display:flex; gap:.5rem; align-items:center;">
            <input id="new-group-name" type="text" placeholder="New group name" />
            <button class="btn btn-secondary btn-sm btn-assign-accent" id="btn-group-create-assign">
              <i class="fas fa-plus" aria-hidden="true"></i><span>Create & assign</span>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end;">
        <button class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
        <button class="btn btn-secondary btn-sm btn-remove-accent" id="btn-group-remove">
          <i class="fas fa-minus-circle" aria-hidden="true"></i><span>Remove</span>
        </button>
        <button class="btn btn-secondary btn-sm btn-assign-accent" id="btn-group-assign">
          <i class="fas fa-layer-group" aria-hidden="true"></i><span>Assign</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Assign Preset Modal (DEPRECATED - kept for migration) -->
  <div class="modal-overlay" id="modal-assign-preset" style="display: none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-preset-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-preset-title">
          <i class="fas fa-star"></i>
          Presets
        </div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
  <p>Choose a preset to apply to the selected devices, or clear the current preset.</p>
        <div class="form-group" style="margin-top: var(--space-md);">
          <label for="preset-select">Preset</label>
          <div class="select-wrap has-caret">
            <select id="preset-select"></select>
            <span class="select-caret" aria-hidden="true">▾</span>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end;">
  <button class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
  <button class="btn btn-secondary btn-sm btn-remove-accent" id="btn-preset-clear"><i class="fas fa-ban" aria-hidden="true"></i><span>Clear</span></button>
  <button class="btn btn-secondary btn-sm btn-accent btn-preset-accent" id="btn-preset-apply"><i class="fas fa-star" aria-hidden="true"></i><span>Apply</span></button>
      </div>
    </div>
  </div>

  <!-- Assign Location Modal -->
  <div class="modal-overlay" id="modal-assign-location">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-location-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-location-title">
          <i class="fas fa-location-dot"></i>
          Assign Location
        </div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p>Set or clear the location for the selected devices.</p>
        <div class="form-group" style="margin-top: var(--space-md);">
          <label for="location-input">Location</label>
          <input id="location-input" type="text" list="location-list" placeholder="e.g. Living Room" />
          <datalist id="location-list"></datalist>
        </div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end;">
        <button class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
        <button class="btn btn-secondary btn-sm btn-remove-accent" id="btn-location-clear"><i class="fas fa-ban" aria-hidden="true"></i><span>Clear</span></button>
  <button class="btn btn-secondary btn-sm btn-accent btn-location-accent" id="btn-location-apply"><i class="fas fa-location-dot" aria-hidden="true"></i><span>Assign</span></button>
      </div>
    </div>
  </div>

  <!-- Revoke API Key Confirmation Modal (theme-demo structure) -->
  <div class="modal-overlay" id="modal-revoke-api-key">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-revoke-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-revoke-title"><i class="fas fa-trash-alt"></i> Revoke API Key</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to revoke the current API key? Any client using it will stop working immediately.</p>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end;">
        <button type="button" class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
  <button type="button" id="btn-revoke-api-key-confirm" class="btn btn-secondary btn-sm btn-accent btn-revoke-accent">
          <i class="fas fa-trash-alt" aria-hidden="true"></i><span>Revoke Key</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Update Confirmation Modal (theme-demo structure) -->
  <div class="modal-overlay" id="modal-update">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-update-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-update-title"><i class="fas fa-download"></i> Confirm Auto-Update</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="modal-update-content">
        <div class="subtle">Loading update information…</div>
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end;">
        <button type="button" class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
  <button type="button" id="btn-update-force" class="btn btn-secondary btn-sm btn-accent btn-update-accent" style="display:none;">
          <i class="fas fa-hammer" aria-hidden="true"></i><span>Force Update</span>
        </button>
  <button type="button" id="btn-update-confirm" class="btn btn-secondary btn-sm btn-accent btn-update-accent" disabled>
          <i class="fas fa-check" aria-hidden="true"></i><span>Start Update</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Devices Confirmation Modal (theme-demo structure) -->
  <div class="modal-overlay" id="modal-delete-devices">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-delete-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-delete-title"><i class="fas fa-trash"></i> Delete devices</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="modal-delete-content" style="padding: 20px;">
        <!-- Filled dynamically with selection summary -->
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding: 16px 20px;">
        <button type="button" class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
        <button type="button" class="btn btn-secondary btn-sm btn-delete-accent" id="btn-confirm-delete-devices"><i class="fas fa-trash"></i><span> Delete</span></button>
      </div>
    </div>
  </div>

  <!-- Cache Size Edit Modal -->
  <div class="modal-overlay" id="modal-cache-size">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-cache-size-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-cache-size-title"><i class="fas fa-database"></i> Edit Cache Size</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 24px;">
        
        <!-- Cache icon and intro -->
        <div style="margin-bottom: 24px;">
          <div style="
            width: 64px; 
            height: 64px; 
            margin: 0 auto 16px auto; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: linear-gradient(135deg, var(--color-warning), var(--color-warning-dark));
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
          ">
            <i class="fas fa-database" style="font-size: 24px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600;">Configure Cache Storage</h3>
          <p style="margin: 0; font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.4;">
            Set the maximum disk space for cached poster images
          </p>
        </div>

        <!-- Cache size form section -->
        <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.06);">
          
          <!-- Cache size input -->
          <div style="margin-bottom: 16px; text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-hdd" style="color: var(--color-warning); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.85rem;">Maximum Cache Size</span>
            </div>
            <div style="display: flex; gap: 6px; align-items: center; justify-content: center;">
              <div class="number-input-wrapper niw-compact">
                <input 
                  id="input-cache-size-gb" 
                  type="number" 
                  inputmode="decimal" 
                  step="0.1" 
                  min="0.1" 
                  placeholder="2.0"
                  style="text-align: center;"
                />
                <div class="number-controls" role="group">
                  <button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button>
                  <button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button>
                </div>
              </div>
              <div style="
                padding: 12px 16px;
                background: rgba(var(--color-warning-rgb), 0.15);
                border: 2px solid rgba(var(--color-warning-rgb), 0.3);
                border-radius: 8px;
                color: var(--color-warning);
                font-weight: 600;
                font-size: 0.9rem;
              ">
                GB
              </div>
            </div>
          </div>

          <!-- Storage info -->
          <div style="
            background: rgba(var(--color-info-rgb), 0.1); 
            border: 1px solid rgba(var(--color-info-rgb), 0.2); 
            border-radius: 8px; 
            padding: 12px 16px;
            text-align: center;
            margin-top: 16px;
          ">
            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 4px;">
              <i class="fas fa-info-circle" style="color: var(--color-info); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.8rem; color: var(--color-info);">Recommended Range</span>
            </div>
            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">
              1.0 - 5.0 GB • Must be greater than 0.1 GB
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer" style="padding: 20px 24px; border-top: 1px solid rgba(255,255,255,0.1);">
        <button type="button" class="btn btn-outline" data-close-modal style="margin-right: 12px;">
          <i class="fas fa-times"></i>
          <span>Cancel</span>
        </button>
        <button type="button" id="btn-cache-size-save" class="btn" style="
          background: linear-gradient(135deg, var(--color-warning), var(--color-warning-dark));
          border: none;
          color: white;
          font-weight: 600;
          box-shadow: 0 4px 12px rgba(var(--color-warning-rgb), 0.3);
          transition: all 0.2s ease;
        ">
          <i class="fas fa-save"></i>
          <span>Save Changes</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Profile Photo Modal -->
  <div class="modal-overlay" id="modal-avatar" hidden>
    <div class="modal modal-lg" role="dialog" aria-modal="true" aria-labelledby="modal-avatar-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-avatar-title"><i class="fas fa-image"></i> Profile Photo</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="padding: 20px; text-align: center;">
        
        <!-- Image cropping interface (initially hidden, shown when file selected) -->
        <div id="crop-interface" style="display: none; margin-bottom: 24px; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.08);">
          <div style="margin-bottom: 16px; text-align: center;">
            <h4 style="color: var(--color-primary); font-size: 1.1rem; margin: 0 0 8px 0; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <i class="fas fa-crop"></i>
              Crop Your Image
            </h4>
            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin: 0;">
              Drag to reposition, use mouse wheel to zoom, or resize the selection area.
            </p>
          </div>
          
          <!-- Crop canvas container -->
          <div id="crop-container" style="position: relative; margin-bottom: 16px; border-radius: 8px; overflow: hidden; background: #000; display: flex; justify-content: center; align-items: center; min-height: 300px; max-height: 400px;">
            <canvas id="crop-canvas" style="cursor: grab; display: block;"></canvas>
            
            <!-- Crop overlay with selection box -->
            <div id="crop-overlay" style="position: absolute; pointer-events: none;">
              <div id="crop-selection" style="
                position: absolute;
                border: 2px solid var(--color-primary);
                background: rgba(var(--color-primary-rgb), 0.1);
                cursor: move;
                pointer-events: all;
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
              ">
                <!-- Resize handles -->
                <div class="crop-handle" data-handle="nw" style="position: absolute; top: -4px; left: -4px; width: 8px; height: 8px; background: var(--color-primary); cursor: nw-resize;"></div>
                <div class="crop-handle" data-handle="ne" style="position: absolute; top: -4px; right: -4px; width: 8px; height: 8px; background: var(--color-primary); cursor: ne-resize;"></div>
                <div class="crop-handle" data-handle="sw" style="position: absolute; bottom: -4px; left: -4px; width: 8px; height: 8px; background: var(--color-primary); cursor: sw-resize;"></div>
                <div class="crop-handle" data-handle="se" style="position: absolute; bottom: -4px; right: -4px; width: 8px; height: 8px; background: var(--color-primary); cursor: se-resize;"></div>
              </div>
            </div>
          </div>
          
          <!-- Crop controls -->
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <label style="font-size: 0.85rem; color: rgba(255,255,255,0.8); display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-search-plus" style="font-size: 0.8rem;"></i>
                Zoom:
              </label>
              <input type="range" id="crop-zoom" min="0.5" max="3" step="0.1" value="1" style="width: 100px;">
              <span id="crop-zoom-value" style="font-size: 0.8rem; color: rgba(255,255,255,0.6); min-width: 30px;">100%</span>
            </div>
            
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn btn-outline btn-sm" id="crop-reset" title="Reset crop area">
                <i class="fas fa-undo"></i>
              </button>
            </div>
          </div>
          
          <!-- Cropped preview -->
          <div style="margin-top: 16px; text-align: center;">
            <div style="margin-bottom: 8px;">
              <span style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">Preview:</span>
            </div>
            <div style="display: inline-block; width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 2px solid rgba(255,255,255,0.2); background: #000;">
              <canvas id="crop-preview" width="80" height="80" style="width: 100%; height: 100%;"></canvas>
            </div>
          </div>
        </div>

        <!-- Large centered avatar preview -->
        <div style="margin-bottom: 24px; text-align: center;">
          <div class="avatar-preview" id="avatar-preview" aria-live="polite" style="
            width: 120px; 
            height: 120px; 
            margin: 0 auto 16px auto; 
            border-radius: 50%; 
            overflow: hidden; 
            border: 4px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            position: relative;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
          ">
            <div class="avatar-initials" id="avatar-initials-fallback" style="
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              font-size: 36px;
              font-weight: 700;
              color: white;
              text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            ">AD</div>
            <img id="avatar-image-preview" alt="Current profile photo" style="
              width: 100%;
              height: 100%;
              object-fit: cover;
              position: absolute;
              top: 0;
              left: 0;
            " />
          </div>
        </div>

        <!-- Upload section with modern design -->
        <div style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 24px; border: 1px solid rgba(255,255,255,0.06);">
          <div style="margin-bottom: 20px;">
            <div class="file-upload-area" style="
              border: 2px dashed rgba(255,255,255,0.2);
              border-radius: 12px;
              padding: 32px 16px;
              cursor: pointer;
              transition: all 0.2s ease;
              position: relative;
              background: rgba(255,255,255,0.01);
            " id="upload-drop-zone">
              <div style="margin-bottom: 16px;">
                <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--color-primary); opacity: 0.8;"></i>
              </div>
              <button type="button" class="btn btn-primary btn-sm" id="avatar-file-trigger" style="margin-bottom: 12px;">
                <i class="fas fa-file-upload"></i><span>Choose Image</span>
              </button>
              <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 8px;">
                or drag and drop your image here
              </div>
              <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                PNG, JPG, or WebP — up to 2 MB
              </div>
              <input type="file" id="avatar-file" accept="image/png,image/jpeg,image/webp" style="position:absolute;left:-9999px;opacity:0;pointer-events:none;" />
            </div>
            
            <!-- Selected file display -->
            <div id="selected-file-display" style="display: none; margin-top: 16px; padding: 12px; background: rgba(var(--color-success-rgb, 16, 185, 129), 0.1); border-radius: 8px; border: 1px solid rgba(var(--color-success-rgb, 16, 185, 129), 0.2);">
              <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-check-circle" style="color: var(--color-success);"></i>
                <span id="avatar-file-name" style="font-size: 0.9rem; color: var(--color-success);">No file selected</span>
              </div>
            </div>

          </div>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-top: 1px solid rgba(255,255,255,0.1);">
        <!-- Left side: Cancel -->
        <div>
          <button type="button" class="btn btn-outline" data-close-modal style="min-width: 80px;">Cancel</button>
        </div>
        
        <!-- Right side: Action buttons -->
        <div style="display: flex; gap: 12px;">
          <button type="button" class="btn btn-error" id="avatar-remove-btn" style="min-width: 90px;">
            <i class="fas fa-trash"></i><span>Remove</span>
          </button>
          <button type="button" class="btn btn-secondary" id="avatar-crop-btn" style="min-width: 90px; display: none;">
            <i class="fas fa-crop"></i><span>Crop</span>
          </button>
          <button type="button" class="btn btn-primary" id="avatar-upload-btn" style="min-width: 90px;">
            <i class="fas fa-upload"></i><span>Upload</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Cards Configuration Modal -->
  <div class="modal-overlay" id="modal-configure-cards">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-configure-cards-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-configure-cards-title">
          <i class="fas fa-sliders-h"></i> Configure Dashboard Cards
        </div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px; color: var(--color-text-secondary);">
          Select cards to display and drag to reorder. Cards automatically wrap to the next row.
        </p>
        <div id="cards-selection-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; max-height: 60vh; overflow-y: auto;">
          <!-- Cards will be dynamically added here -->
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px;">
        <button type="button" class="btn" data-close-modal style="min-width: 80px;">Cancel</button>
        <button type="button" id="btn-save-card-config" class="btn" style="min-width: 140px;">
          <i class="fas fa-check-circle"></i><span>Save Configuration</span>
        </button>
      </div>
    </div>
  </div>

  <script src="/notify.js?v=20250906-1"></script>
  
  <!-- Home Assistant Dashboard Generator Modal -->
  <div class="modal-overlay" id="modal-ha-dashboard" hidden>
    <div class="modal modal-lg" role="dialog" aria-modal="true" aria-labelledby="modal-ha-dashboard-title" style="max-width: 750px;">
      <div class="modal-header">
        <div class="modal-title" id="modal-ha-dashboard-title">
          <i class="fas fa-home"></i> Generate Home Assistant Section
        </div>
        <button class="modal-close" onclick="closeHADashboardModal()" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        
        <!-- Info section -->
        <div style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
          <div style="display: flex; align-items: start; gap: 10px;">
            <i class="fas fa-info-circle" style="color: #3b82f6; font-size: 16px; margin-top: 2px;"></i>
            <div style="flex: 1;">
              <strong style="display: block; margin-bottom: 4px; font-size: 0.95rem;">Section Generator</strong>
              <p style="margin: 0; font-size: 0.85rem; opacity: 0.85; line-height: 1.4;">
                Generate a Home Assistant section for your device. Add it via <strong>Add Section → Edit in YAML</strong>.
              </p>
            </div>
          </div>
        </div>

        <!-- Device selection -->
        <div style="margin-bottom: 20px;">
          <h3 style="margin: 0 0 10px 0; font-size: 0.95rem; font-weight: 600; opacity: 0.8;">
            <i class="fas fa-laptop"></i> Select Device
          </h3>
          <div id="ha-dashboard-device-list" style="
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 12px;
          ">
            <p style="text-align: center; opacity: 0.6;">Loading devices...</p>
          </div>
        </div>

        <!-- YAML Preview -->
        <div style="margin-bottom: 16px;">
          <h3 style="margin: 0 0 10px 0; font-size: 0.95rem; font-weight: 600; opacity: 0.8;">
            <i class="fas fa-code"></i> YAML Preview
          </h3>
          <div style="position: relative;">
            <pre id="ha-dashboard-yaml-preview" style="
              background: #1e1e1e;
              color: #d4d4d4;
              padding: 14px;
              border-radius: 6px;
              max-height: 300px;
              overflow: auto;
              font-family: 'Courier New', monospace;
              font-size: 0.8rem;
              line-height: 1.3;
              margin: 0;
            ">Loading...</pre>
          </div>
        </div>

        <!-- Installation Instructions -->
        <details style="margin-bottom: 16px;">
          <summary style="cursor: pointer; font-weight: 600; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.9rem;">
            <i class="fas fa-book"></i> Installation Instructions
          </summary>
          <div style="padding: 12px; background: rgba(255,255,255,0.02); border-radius: 0 0 6px 6px; border: 1px solid rgba(255,255,255,0.1); border-top: none;">
            <ol style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 0.85rem;">
              <li>Open your dashboard in Home Assistant</li>
              <li>Click <strong>"Edit Dashboard"</strong> (pencil icon)</li>
              <li>Click <strong>"+ Add Section"</strong> at the bottom</li>
              <li>Click the <strong>pencil icon</strong> on the new section</li>
              <li>Click <strong>three dots (⋮)</strong> → <strong>"Edit in YAML"</strong></li>
              <li>Replace content with copied YAML and click <strong>"Save"</strong></li>
            </ol>
          </div>
        </details>

      </div>
      
      <!-- Modal Footer with Actions -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" onclick="closeHADashboardModal()">
          <i class="fas fa-times"></i><span>Cancel</span>
        </button>
        <button type="button" class="btn btn-primary btn-sm" onclick="copyDashboardYAML()">
          <i class="fas fa-copy"></i><span>Copy YAML</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Notification Center (themed, matches theme-demo Device Management example) -->
  <div class="notify-center" id="notify-center" role="dialog" aria-modal="false" aria-live="polite" aria-label="Notifications panel" aria-hidden="true">
    <div class="notify-header">
      <strong>Notifications</strong>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn btn-outline btn-sm" id="notify-mark-all" title="Mark all as read">
          <i class="fas fa-check-double"></i>
          Mark all
        </button>
        <button class="btn btn-icon btn-sm" id="notify-close" title="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="notify-subheader">
      <div class="notify-filter" id="notify-min-level-icons" role="radiogroup" aria-label="Minimum level">
        <button class="nf-btn" data-level="info" role="radio" aria-checked="false" title="Info" aria-label="Info">
          <span class="ring"><i class="fas fa-circle-info" aria-hidden="true"></i></span>
        </button>
        <button class="nf-btn" data-level="warn" role="radio" aria-checked="false" title="Warn" aria-label="Warn">
          <span class="ring"><i class="fas fa-triangle-exclamation" aria-hidden="true"></i></span>
        </button>
        <button class="nf-btn" data-level="error" role="radio" aria-checked="true" title="Error" aria-label="Error">
          <span class="ring"><i class="fas fa-circle-exclamation" aria-hidden="true"></i></span>
        </button>
      </div>
      <!-- SR-only fallback select for accessibility and legacy binding -->
      <label for="notify-min-level" class="sr-only">Minimum level</label>
      <select id="notify-min-level" class="sr-only" tabindex="-1" aria-hidden="true">
        <option value="info">Info</option>
        <option value="warn">Warn</option>
        <option value="error" selected>Error</option>
      </select>
    </div>
    <div class="notify-list" id="notify-list"></div>
  </div>
    <!-- Generic Confirm Modal -->
    <div class="modal-overlay" id="modal-confirm" hidden>
      <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-confirm-title">
        <div class="modal-header">
          <div class="modal-title" id="modal-confirm-title"><i class="fas fa-question-circle"></i> Confirm</div>
          <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="modal-confirm-body" style="padding: 16px 20px;">
          Are you sure?
        </div>
        <div class="modal-footer" style="display:flex; gap:10px; justify-content:flex-end; padding: 14px 20px;">
          <button type="button" class="btn btn-secondary btn-sm btn-cancel" data-close-modal><span>Cancel</span></button>
          <button type="button" class="btn btn-secondary btn-sm btn-accent btn-confirm-accent" id="modal-confirm-ok"><i class="fas fa-check" aria-hidden="true"></i><span>Confirm</span></button>
        </div>
      </div>
    </div>
  <script>
    // Auto-redirect to latest version if cached old version is loaded
    (function() {
      try {
        const currentScript = document.currentScript?.src || '';
        const match = /admin\.js\?v=([^&\s]+)/.exec(document.querySelector('script[src*="admin.js"]')?.src || '');
        const expectedVersion = '{{ASSET_VERSION}}';
        const loadedVersion = match ? match[1] : null;
        
        if (loadedVersion && expectedVersion && loadedVersion !== expectedVersion) {
          console.warn('[Version Check] Old version detected:', loadedVersion, '→ Redirecting to latest:', expectedVersion);
          // Clear cache and reload with new version
          const newUrl = window.location.pathname + '?_bust=' + Date.now();
          window.location.replace(newUrl);
        }
      } catch(e) {
        console.error('[Version Check] Failed:', e);
      }
    })();
  </script>
  <script src="/vendor/luxon.min.js"></script>
  <script src="/vendor/chart.min.js"></script>
  <script src="/vendor/chartjs-adapter-luxon.min.js"></script>
  <script type="module" src="/admin.js?v={{ASSET_VERSION}}"></script>
  <script src="/performance.js?v={{ASSET_VERSION}}"></script>
  <script>
    // Fallback spinner wrapper bootstrap (runs after main admin.js). Safe + idempotent.
    (function(){
      const IDS = ['plex_port','plex.recentDays','jf.port','jf.recentDays','tmdb.minRating','streamingSources.minRating'];
      const MAX_WINDOW_MS = 10000; // give up after 10s
      const START = Date.now();
      const log = (...a)=>{ try { if (window.__MS_NUM_DEBUG || localStorage.getItem('MS_NUM_DEBUG')) console.debug('[MediaNumWrapFallback]',...a);}catch(_){} };
      function hasWrapper(el){ return !!el && !!el.closest('.number-input-wrapper'); }
      function manualWrap(el){
        if(!el || hasWrapper(el)) return;
        const parent=el.parentElement; if(!parent) return;
        const w=document.createElement('div'); w.className='number-input-wrapper niw-compact';
        parent.replaceChild(w,el); w.appendChild(el);
        const ctr=document.createElement('div'); ctr.className='number-controls';
        const mk=(cls,dir)=>{ const b=document.createElement('button'); b.type='button'; b.className='number-btn '+cls; b.setAttribute('aria-label', dir==='up'?'Increase value':'Decrease value'); b.innerHTML='<i class="fas fa-chevron-'+dir+'"></i>'; return b; };
        const up=mk('number-inc','up'); const dn=mk('number-dec','down'); ctr.append(up,dn); w.appendChild(ctr);
        const step=()=>Number(el.step||'1')||1; const dec=s=>{const str=String(s); const i=str.indexOf('.'); return i===-1?0:Math.min(6,str.length-i-1);} ;
        const snap=(v,s)=>Math.round(v/s)*s; const clamp=v=>{ let val=v; const min=el.min===''?null:Number(el.min); const max=el.max===''?null:Number(el.max); if(min!=null&&!Number.isNaN(min)) val=Math.max(val,min); if(max!=null&&!Number.isNaN(max)) val=Math.min(val,max); return val; };
        function apply(dir){ const cur=Number(el.value||'0')||0; const s=step(); const out=clamp(snap(cur+(dir==='up'?s:-s),s)); const d=dec(s); el.value=d>0?Number(out).toFixed(d):String(Math.round(out)); el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); }
        up.addEventListener('click',e=>{try{e.stopPropagation();}catch(_){} apply('up');});
        dn.addEventListener('click',e=>{try{e.stopPropagation();}catch(_){} apply('down');});
      }
      function attempt(reason){
        let remaining = [];
        IDS.forEach(id=>{
          const el=document.getElementById(id);
            if(!el){ remaining.push(id); return; }
            if(!hasWrapper(el)){
              if(window.enhanceNumberInput){ try { window.enhanceNumberInput(el); } catch(_){} }
              if(!hasWrapper(el)) manualWrap(el);
              if(!hasWrapper(el)) remaining.push(id);
            }
        });
        log('attempt', reason, 'remaining', remaining);
        if(remaining.length===0){ log('all wrapped'); return true; }
        if(Date.now()-START>MAX_WINDOW_MS){ log('giving up (timeout)', remaining); return true; }
        return false;
      }
      // Initial burst of rapid attempts
      let i=0; function burst(){ if(attempt('burst-'+i++)) return; if(i<20) setTimeout(burst,75); else scheduleSlow(); }
      function scheduleSlow(){
        let slowCount=0; const slow=()=>{ if(attempt('slow-'+slowCount++)) return; if(slowCount<40) setTimeout(slow,250); else attempt('final'); };
        slow();
      }
      // Mutation observer (document-level) as ultimate catch
      try { const mo = new MutationObserver(()=> attempt('mutation')); mo.observe(document.documentElement,{childList:true,subtree:true}); setTimeout(()=>mo.disconnect(), MAX_WINDOW_MS); } catch(_){}
      // Kick off
      if(!attempt('initial')) burst();
    })();
  </script>
  <link rel="stylesheet" href="/cinema/cinema.css?v={{ASSET_VERSION}}" />
  <script src="/cinema/cinema-ui.js?v={{ASSET_VERSION}}"></script>
  
  <!-- Logs Viewer -->
  <script src="/js/admin-logs-viewer.js?v=3.1.3"></script>
  <script>
    // Navigation handler for dropdown menu items with data-nav attribute
    document.addEventListener('DOMContentLoaded', function() {
      // Handle navigation items with data-nav attribute (excluding sidebar nav-items, handled in admin.js)
      document.querySelectorAll('[data-nav]:not(.sidebar-nav .nav-item)').forEach(function(navItem) {
        navItem.addEventListener('click', function(e) {
          e.preventDefault();
          const targetSection = this.getAttribute('data-nav');
          
          // Hide all app sections
          document.querySelectorAll('.app-section').forEach(function(section) {
            section.setAttribute('hidden', '');
          });
          
          // Show target section
          const target = document.getElementById('section-' + targetSection);
          if (target) {
            target.removeAttribute('hidden');
            
            // Hide/show dashboard controls based on section
            const configureBtn = document.getElementById('btn-configure-cards');
            const activityPill = document.getElementById('perf-activity');
            // Only show dashboard controls on the main dashboard page
            if (targetSection === 'dashboard') {
              if (configureBtn) configureBtn.style.display = 'block';
              if (activityPill) activityPill.style.display = 'flex';
            } else {
              if (configureBtn) configureBtn.style.display = 'none';
              if (activityPill) activityPill.style.display = 'none';
            }
            
            // Initialize logs viewer when logs section becomes visible
            if (targetSection === 'logs' && !window.logsViewer) {
              setTimeout(function() {
                window.logsViewer = new LogsViewer('logs-viewer-container');
              }, 100);
            }
          }
          
          // Update active state on sidebar nav items
          document.querySelectorAll('.nav-item').forEach(function(item) {
            item.classList.remove('active');
          });
          if (this.classList.contains('nav-item')) {
            this.classList.add('active');
          }
          
          // Close dropdown if this was a dropdown item
          const dropdown = this.closest('.dropdown');
          if (dropdown) {
            dropdown.classList.remove('show');
            const overlay = document.getElementById('dropdown-overlay');
            if (overlay) {
              overlay.hidden = true;
            }
          }
        });
      });

      // Handle version click to go to updates
      const versionEl = document.getElementById('app-version');
      if (versionEl) {
        versionEl.addEventListener('click', function() {
          const opsNav = document.querySelector('[data-nav="operations"]');
          if (opsNav) {
            opsNav.click();
            // Scroll to top of operations section to ensure updates are visible
            setTimeout(() => {
                 const opsSection = document.getElementById('section-operations');
                 if (opsSection) opsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);
          }
        });
      }

      // Handle logo click to go to dashboard
      const logoEl = document.getElementById('nav-logo-img');
      if (logoEl) {
        logoEl.addEventListener('click', function() {
          const dashNav = document.querySelector('[data-nav="dashboard"]');
          if (dashNav) {
            dashNav.click();
          }
        });
      }
    });
    
    // Handle hash navigation on page load (for direct links like /admin#performance)
    window.addEventListener('DOMContentLoaded', function() {
      const hash = window.location.hash.substring(1); // Remove # symbol
      if (hash) {
        const targetSection = hash;
        const navItem = document.querySelector(`[data-nav="${targetSection}"]`);
        if (navItem) {
          // Trigger click on the nav item to activate the section
          navItem.click();
        }
      }
    });
  </script>
  
  <!-- PWA Service Worker Registration (admin2) -->
  <script>
    // Register SW without forcing immediate reloads. We'll prompt the user instead.
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/sw.js')
          .then(reg => {
            // Disable SW update toasts in Admin: end-users don't receive admin-only updates.
            // Keep registration for caching/offline benefits, but don't surface update messages.
            const swToast = () => {};
            // If there's already a waiting worker, do NOT force-activate.
            // We'll surface an unobtrusive update hint and let the user refresh.
            // Intentionally no notification when a waiting worker exists

            // When a new SW is found, wait until it installs, then hint the user.
            reg.addEventListener('updatefound', () => {
              const sw = reg.installing;
              if (!sw) return;
              sw.addEventListener('statechange', () => {
                // Intentionally suppress 'Update installed' notifications
              });
            });

            // Avoid auto-refresh on controller changes; only refresh if explicitly requested elsewhere.
            navigator.serviceWorker.addEventListener('controllerchange', () => {
              // Intentionally no automatic reload here to prevent disruptive bounces.
              // Advanced: if a future flow sets window.__swAllowReload = true, we can honor it.
              if (window.__swAllowReload) {
                try { window.location.reload(); } catch (_) { /* ignore */ }
              }
            });
          })
          .catch(() => { /* silent */ });
      });
    }
  </script>
  
  <!-- Documentation Search Script -->
  <script src="/js/doc-search.js"></script>
</body>
</html>

