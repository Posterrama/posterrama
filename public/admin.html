<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Posterrama Admin — Dashboard</title>
  <!-- PWA: basic meta + manifest so admin2 independently registers the Service Worker -->
  <meta name="theme-color" content="#1a1d29" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link rel="stylesheet" href="/admin.css?v={{ASSET_VERSION}}" />
  
</head>
<body>
  <!-- Top navbar -->
  <nav class="navbar">
    <div class="nav-brand">
      <button class="btn btn-icon mobile-only" id="mobile-nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
        <i class="fas fa-bars"></i>
      </button>
      <span>Posterrama</span>
  <span class="version" id="app-version" title="Current version" style="margin-left:8px;">—</span>
  <span class="nav-badge" id="update-available-pill" hidden title="" style="margin-left:6px;">Update available</span>
    </div>
    <div class="nav-actions">
      <div class="dropdown" id="notif-dropdown">
        <button class="btn btn-icon dropdown-toggle" id="notif-btn" title="Notifications" aria-haspopup="true" aria-expanded="false" aria-controls="notif-menu">
          <i class="fas fa-bell"></i>
          <span class="badge" id="notif-count" hidden>0</span>
        </button>
        <div class="dropdown-menu" id="notif-menu" role="menu" aria-hidden="true"></div>
      </div>
  <div class="dropdown" id="settings-dropdown">
  <button type="button" class="btn btn-icon dropdown-toggle" id="settings-btn" title="Settings" aria-haspopup="true" aria-expanded="false" aria-controls="settings-menu">
          <i class="fas fa-cog"></i>
        </button>
        <div class="dropdown-menu" id="settings-menu" role="menu" aria-hidden="true">
          <div class="dropdown-heading">Quick links</div>
          <a class="dropdown-item" href="/" target="_blank" rel="noopener" title="Open Posterrama in a new tab">
            <i class="fas fa-external-link-alt"></i>
            <span>View Posterrama</span>
          </a>
          
          <a class="dropdown-item" href="/api-docs" target="_blank" rel="noopener">
            <i class="fas fa-book"></i>
            <span>API Docs</span>
          </a>
          <a class="dropdown-item" href="https://github.com/Posterrama/posterrama" target="_blank" rel="noopener">
            <i class="fab fa-github"></i>
            <span>GitHub Repository</span>
          </a>
          <a class="dropdown-item" href="https://github.com/Posterrama/posterrama/issues/new/choose" target="_blank" rel="noopener">
            <i class="fas fa-bug"></i>
            <span>Report an Issue</span>
          </a>
          <a class="dropdown-item" href="/logs.html" target="_blank" rel="noopener">
            <i class="fas fa-scroll"></i>
            <span>Open Logs</span>
          </a>
          <div class="dropdown-divider"></div>
          <div class="dropdown-heading">Server</div>
          <a class="dropdown-item" href="#" id="menu-restart">
            <i class="fas fa-rotate"></i>
            <span>Restart Posterrama</span>
          </a>
        </div>
      </div>
      <div class="dropdown nav-user" id="user-dropdown">
  <button type="button" class="btn btn-icon dropdown-toggle" id="user-btn" title="Account" aria-haspopup="true" aria-expanded="false" aria-controls="user-menu">
          <i class="fas fa-user-circle"></i>
          <span>Admin</span>
        </button>
        <div class="dropdown-menu dropdown-right" id="user-menu" role="menu" aria-hidden="true">
          <div class="dropdown-heading">Account</div>
          <a class="dropdown-item" href="#" id="user-change-password">
            <i class="fas fa-key"></i>
            <span>Change Password</span>
          </a>
          <a class="dropdown-item" href="#" id="user-two-fa">
            <i class="fas fa-user-lock"></i>
            <span>Two‑Factor</span>
          </a>
          <a class="dropdown-item" href="#" id="user-profile-photo">
            <i class="fas fa-image"></i>
            <span>Profile Photo</span>
          </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="/admin/logout" id="user-logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <aside class="sidebar">
    <nav class="sidebar-nav">
      <a href="#" class="nav-item active" data-nav="dashboard">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
      </a>
      <a href="#" class="nav-item" data-nav="display">
        <i class="fas fa-desktop"></i>
        <span>Display Settings</span>
      </a>
      <a href="#" class="nav-item" data-nav="media-sources">
        <i class="fas fa-server"></i>
        <span>Media Sources</span>
      </a>
      <a href="#" class="nav-item" data-nav="devices">
        <i class="fas fa-laptop"></i>
        <span class="nav-text-with-badge" style="white-space: nowrap;">
          Device Management
          <span class="nav-badge nav-badge-error">BETA</span>
        </span>
      </a>
      <a href="#" class="nav-item" data-nav="operations"><i class="fas fa-screwdriver-wrench"></i><span>Operations</span></a>
    </nav>
  <div class="sidebar-footer"></div>
  </aside>

  <div class="sidebar-overlay" id="sidebar-overlay" hidden></div>

  <!-- Main content -->
  <main class="main-content">
    <header class="page-header">
      <div class="page-title">
  
      </div>
      <div class="page-actions">
        <span class="header-pill" id="perf-activity" title="Overall system activity (CPU and memory)">
          <i class="fas fa-wave-square"></i>
          <span class="label">Activity</span>
          <span class="value">—</span>
        </span>
      </div>
    </header>

  <!-- Dashboard Section -->
  <section id="section-dashboard" class="app-section active">
  <!-- KPI cards -->
  <section class="card-grid" id="kpi-cards">
      <div class="status-card status-success" title="Devices that are Online or Live">
        <div class="card-icon"><i class="fas fa-check-circle"></i></div>
        <div class="card-content">
          <h3>Active Devices</h3>
          <span class="metric" id="metric-active-devices">—</span>
          <span class="trend" id="metric-active-trend"></span>
        </div>
      </div>
      <div class="status-card status-info" title="Total media items across connected sources">
        <div class="card-icon"><i class="fas fa-photo-film"></i></div>
        <div class="card-content">
          <h3>Media Items</h3>
          <span class="metric" id="metric-media-items">—</span>
          <span class="trend" id="metric-media-sub">from sources</span>
        </div>
      </div>
      <div class="status-card status-warning" id="mode-card" title="Current display mode and key settings">
        <div class="card-icon"><i id="metric-mode-icon" class="fas fa-image"></i></div>
        <div class="card-content">
          <h3>Active Mode</h3>
          <span class="metric" id="metric-mode">—</span>
          <span class="trend" id="metric-mode-sub"></span>
        </div>
      </div>
      <div class="status-card status-error" title="Devices currently Offline">
        <div class="card-icon"><i class="fas fa-times-circle"></i></div>
        <div class="card-content">
          <h3>Offline Devices</h3>
          <span class="metric" id="metric-offline-devices">—</span>
          <span class="trend negative" id="metric-offline-sub">needs attention</span>
        </div>
      </div>
    </section>

    
    

  <section class="content-grid" style="margin-top: 16px;">
      <!-- Unified System Performance Dashboard -->
      <section class="panel" id="panel-perf-dashboard" style="background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: 12px; box-shadow: var(--shadow-md);">
        <header class="panel-header" style="background: var(--color-bg-card); border-bottom: 1px solid var(--color-border); border-radius: 12px 12px 0 0; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="color: var(--color-text-primary); font-size: 1.25rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 12px;"><i class="fas fa-gauge-high" style="color: var(--color-accent);"></i> System Performance</h2>
          
          <!-- Status pills in header -->
          <div style="display: flex; gap: 16px; align-items: center;">
            <span class="header-pill status-success" id="perf-app-status" title="Application server status">
              <i class="fas fa-rocket"></i>
              <span class="label">Application</span>
              <span class="value">Running</span>
            </span>
            <span class="header-pill" id="perf-db-status" title="Storage status" style="background: rgba(59, 130, 246, 0.15); color: #93c5fd; border-color: rgba(59, 130, 246, 0.25);">
              <i class="fas fa-hdd"></i>
              <span class="label">Storage</span>
              <span class="value">Healthy</span>
            </span>
            <span class="header-pill status-warning" id="perf-cache-status" title="Cache system status">
              <i class="fas fa-bolt"></i>
              <span class="label">Cache</span>
              <span class="value">Active</span>
            </span>
            <!-- Uptime moved here as a pill only -->
            <span class="header-pill" id="perf-uptime-pill" title="Server uptime">
              <i class="fas fa-clock"></i>
              <span class="label">Uptime</span>
              <span class="value" id="perf-uptime">—</span>
            </span>
          </div>
        </header>
        <div class="panel-content" style="padding: 24px;">
          
          <!-- Resource usage cards -->
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            
            <!-- Resources card -->
            <div style="background: var(--color-bg-card); border-radius: 12px; padding: 24px; box-shadow: var(--shadow-md); border: 1px solid var(--color-border);">
              <h3 style="margin: 0 0 20px 0; font-size: 1.1rem; font-weight: 600; color: var(--color-text-primary); display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-microchip" style="color: var(--color-info);"></i>
                System Resources
              </h3>
              
              <div style="display: grid; gap: 20px;">
                <!-- CPU -->
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 0.9rem; color: var(--color-text-secondary); font-weight: 500;">CPU Usage</span>
                    <span style="font-size: 0.9rem; font-weight: 600; color: var(--color-text-primary);" id="perf-cpu">—</span>
                  </div>
                  <div style="width: 100%; height: 8px; background: var(--color-bg-secondary); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, var(--color-info), var(--color-info-dark)); border-radius: 4px; transition: width 0.6s ease; width: 0%;" id="meter-cpu"></div>
                  </div>
                </div>
                
                <!-- Memory -->
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 0.9rem; color: var(--color-text-secondary); font-weight: 500;">Memory Usage</span>
                    <span style="font-size: 0.9rem; font-weight: 600; color: var(--color-text-primary);" id="perf-mem">—</span>
                  </div>
                  <div style="width: 100%; height: 8px; background: var(--color-bg-secondary); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, var(--color-success), var(--color-success-dark)); border-radius: 4px; transition: width 0.6s ease; width: 0%;" id="meter-mem"></div>
                  </div>
                </div>

                <!-- Disk Usage: full-width bar like CPU/Memory -->
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 0.9rem; color: var(--color-text-secondary); font-weight: 500;">Disk Usage</span>
                    <span style="font-size: 0.9rem; font-weight: 600; color: var(--color-text-primary);" id="perf-disk">—</span>
                  </div>
                  <div style="width: 100%; height: 8px; background: var(--color-bg-secondary); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, var(--color-info), var(--color-info-dark)); border-radius: 4px; transition: width 0.6s ease; width: 0%;" id="meter-disk"></div>
                  </div>
                </div>

                <!-- Load Average under Disk Usage -->
                <div id="perf-loadavg-container" style="margin-top: 8px;">
                  <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 4px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--color-text-secondary);">
                      <i class="fas fa-chart-line" style="color: var(--color-info);"></i>
                      <span style="font-size: 0.9rem; font-weight: 500;">Load Average</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <span style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 4px 10px; border-radius: 9999px; font-size: 0.85rem; font-weight: 600; min-width: 48px; text-align: center; font-variant-numeric: tabular-nums;" id="perf-loadavg-1">—</span>
                      <span style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 4px 10px; border-radius: 9999px; font-size: 0.85rem; font-weight: 600; min-width: 48px; text-align: center; font-variant-numeric: tabular-nums;" id="perf-loadavg-5">—</span>
                      <span style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 4px 10px; border-radius: 9999px; font-size: 0.85rem; font-weight: 600; min-width: 48px; text-align: center; font-variant-numeric: tabular-nums;" id="perf-loadavg-15">—</span>
                    </div>
                  </div>
                  
                </div>
                
              </div>
            </div>

            <!-- Cache management card -->
            <div style="background: var(--color-bg-card); border-radius: 12px; padding: 24px; box-shadow: var(--shadow-md); border: 1px solid var(--color-border);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--color-text-primary); display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-database" style="color: var(--color-warning);"></i>
                  Cache
                </h3>
                <button type="button" class="btn btn-icon btn-sm cache-edit-btn" id="btn-edit-cache-size" style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-secondary); padding: 8px; border-radius: 6px; font-size: 0.8rem; transition: all 0.2s ease;">
                  <i class="fas fa-pen"></i>
                </button>
              </div>
              
              <!-- Storage usage -->
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="font-size: 0.85rem; color: var(--color-text-secondary);">Storage</span>
                  <span style="font-size: 0.85rem; font-weight: 600; color: var(--color-text-primary);" id="cache-disk-usage">Loading…</span>
                </div>
                <div style="width: 100%; height: 6px; background: var(--color-bg-secondary); border-radius: 3px; overflow: hidden;">
                  <div style="height: 100%; background: linear-gradient(90deg, var(--color-warning), var(--color-warning-dark)); border-radius: 3px; transition: width 0.6s ease; width: 0%;" id="meter-image-cache"></div>
                </div>
              </div>
              
              <!-- Memory items -->
              <div style="margin-bottom: 24px;">
                <div style="font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 4px;">Memory Items</div>
                <div style="font-size: 1.2rem; font-weight: 600; color: var(--color-text-primary);" id="cache-item-count">Loading…</div>
              </div>
              
              <!-- Actions -->
              <div style="display: flex !important; flex-direction: row !important; gap: 8px !important;">
                <button type="button" id="cleanup-cache-button" style="flex: 1; padding: 10px 16px; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 8px; font-size: 0.85rem; font-weight: 500; color: var(--color-text-primary); display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <i class="fas fa-compress-alt"></i>
                  <span>Run Cleanup</span>
                </button>
                <button type="button" id="clear-cache-button" style="flex: 1; padding: 10px 16px; background: var(--color-error); border: 1px solid var(--color-error); border-radius: 8px; font-size: 0.85rem; font-weight: 500; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <i class="fas fa-broom"></i>
                  <span>Clear Cache</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>
    </section> <!-- /section-dashboard -->


    <!-- Display Settings -->
    <section id="section-display" class="app-section" hidden>
      
      <div class="panel" id="panel-display">
        <div class="panel-header">
          <div class="panel-title" style="flex-direction:column; align-items:flex-start; gap:4px;">
            <div style="display:flex; align-items:center; gap:10px;">
              <i class="fas fa-desktop" aria-hidden="true"></i>
              <h2 style="margin:0;">Display Settings</h2>
            </div>
            <div class="panel-subtitle">Customize posters for Screensaver, Wallart, Cinema: effects, timing, sync.</div>
          </div>
          <div class="panel-actions">
            <span class="status-pill status-info" id="display-mode-pill" title="Current display mode">Mode: —</span>
            <button class="btn btn-primary btn-sm" id="btn-save-display"><span class="spinner" style="display:none"></span><i class="fas fa-save"></i><span>Save Settings</span></button>
          </div>
        </div>
        <div class="panel-content">
          <!-- Floating Live Preview (reuses /preview page) -->
          <div id="display-preview-container" class="pip-mode screensaver-mode">
            <div class="preview-shell">
              <div class="preview-drag-handle" title="Drag preview"></div>
              <div class="preview-tools">
                <button type="button" id="toggle-preview-zoom" class="pip-button" title="Zoom 1.4x">
                  <i class="fas fa-search-plus"></i>
                </button>
                <button type="button" id="toggle-preview-orientation" class="pip-button" title="Toggle Orientation">
                  <i class="fas fa-mobile-alt"></i>
                </button>
              </div>
              <iframe id="display-preview-frame" class="preview-frame" title="Display Settings Live Preview" src="/preview"></iframe>
            </div>
          </div>
          <!-- Active mode selector -->
          <div class="form-section" id="card-active-mode">
            <div class="section-title"><i class="fas fa-layer-group"></i> Active Mode</div>
            <div class="form-row">
              <div class="segmented" role="tablist" aria-label="Display Mode">
                <label class="seg" id="seg-saver" role="tab" aria-controls="card-screensaver" aria-checked="false">
                  <input type="radio" name="display.mode" id="mode-screensaver" value="screensaver" />
                  <i class="fas fa-image"></i> Screensaver
                </label>
                <label class="seg" id="seg-wallart" role="tab" aria-controls="card-wallart" aria-checked="false">
                  <input type="radio" name="display.mode" id="mode-wallart" value="wallart" />
                  <i class="fas fa-images"></i> Wallart
                </label>
                <label class="seg" id="seg-cinema" role="tab" aria-controls="card-cinema" aria-checked="false">
                  <input type="radio" name="display.mode" id="mode-cinema" value="cinema" />
                  <i class="fas fa-tv" style="transform: rotate(90deg);"></i> Cinema
                </label>
              </div>

            </div>
          </div>
          <!-- Mode-specific settings placed directly under Active Mode for better hierarchy -->
          <div id="mode-cards-top">
            <!-- Screensaver settings (active when mode = screensaver) -->
            <div class="mode-card" id="card-screensaver" hidden>
              <div class="card-header">
                <div class="card-title"><i class="fas fa-image"></i> Screensaver</div>
              </div>
              <fieldset id="fs-screensaver">
                <div class="card-subtext" style="margin-bottom:10px; color: var(--color-text-secondary);">
                  A calm, full-screen slideshow of your posters. Use presets or fine‑tune Effects & Playback.
                </div>
                <div class="form-grid masonry" id="saver-cards" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
                  <!-- Presets + Summary card (first by default) -->
                  <div class="mode-card" id="saver-presets-card" data-card-key="presets" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-sliders-h"></i> Presets</div>
                    <div class="scaling-presets" style="display:flex; flex-wrap:wrap; gap:8px;">
                      <button type="button" class="btn btn-secondary btn-sm" id="saver-preset-chill" title="Ken Burns, slower cadence"><i class="fas fa-wind"></i> <span>Chill</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="saver-preset-standard" title="Fade, balanced cadence"><i class="fas fa-balance-scale"></i> <span>Standard</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="saver-preset-lively" title="Slide, faster cadence"><i class="fas fa-bolt"></i> <span>Lively</span></button>
                      <button type="button" class="btn btn-outline btn-sm" id="saver-preset-reset" title="Reset to sensible defaults"><i class="fas fa-undo"></i> <span>Reset</span></button>
                    </div>
                    <div class="card-title" style="font-size:.95rem; margin:10px 0 6px;"><i class="fas fa-info-circle"></i> Current Experience</div>
                    <div id="saver-summary" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                      <span class="status-pill" id="saver-summary-interval" title="Poster change interval">Every — s</span>
                      <span class="status-pill" id="saver-summary-effect" title="Visual transition">Effect: —</span>
                      <span class="status-pill" id="saver-summary-pause" title="Pause after transition">Pause: —</span>
                      <span class="status-pill" id="saver-summary-clock" title="Clock widget status">Clock: —</span>
                    </div>
                  </div>
                  
                  <!-- MOVED: Shared sections now live inside Screensaver -->
                  <!-- Visual Elements -->
                  <div class="form-section" id="sec-visual" data-card-key="visual">
                    <div class="section-title"><i class="fas fa-eye"></i> Visual Elements</div>
                    <div class="form-grid">
                      <div class="form-row"><label>Show:</label></div>
                      <div class="form-row">
                        <label class="checkbox" for="showPoster">
                          <input type="checkbox" id="showPoster" />
                          <span class="checkmark"></span>
                          <span>Poster</span>
                        </label>
                      </div>
                      <div class="form-row">
                        <label class="checkbox" for="showMetadata">
                          <input type="checkbox" id="showMetadata" />
                          <span class="checkmark"></span>
                          <span>Metadata</span>
                        </label>
                      </div>
                      <div class="form-row">
                        <label class="checkbox" for="showClearLogo">
                          <input type="checkbox" id="showClearLogo" />
                          <span class="checkmark"></span>
                          <span>Clearlogo</span>
                        </label>
                      </div>
                      <div class="form-row">
                        <label class="checkbox" for="showRottenTomatoes">
                          <input type="checkbox" id="showRottenTomatoes" />
                          <span class="checkmark"></span>
                          <span>Rotten Tomatoes</span>
                        </label>
                      </div>
                      <div class="form-row full-span"><label for="rottenTomatoesMinimumScore">Minimum Rotten Tomatoes (0–10)</label><div class="number-input-wrapper"><input type="number" min="0" max="10" step="0.5" id="rottenTomatoesMinimumScore" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div></div>
                    </div>
                  </div>

                  <!-- Clock Widget -->
                  <div class="form-section" id="sec-clock" data-card-key="clock">
                    <div class="section-title"><i class="fas fa-clock"></i> Clock Widget
                      <label class="header-toggle" for="clockWidget">
                        <input type="checkbox" id="clockWidget" />
                        <span class="ht-switch" aria-hidden="true"></span>
                        <span class="ht-text">Show clock</span>
                      </label>
                    </div>
                    <div class="form-grid">
                      
                      <div class="form-row"><label for="clockTimezone">Clock timezone</label><div class="select-wrap has-caret"><select id="clockTimezone"><option value="auto">Auto (System Timezone)</option><optgroup label="Common Timezones"><option value="Europe/Amsterdam">Europe/Amsterdam (CET/CEST)</option><option value="Europe/London">Europe/London (GMT/BST)</option><option value="Europe/Berlin">Europe/Berlin (CET/CEST)</option><option value="Europe/Paris">Europe/Paris (CET/CEST)</option><option value="America/New_York">America/New_York (EST/EDT)</option><option value="America/Chicago">America/Chicago (CST/CDT)</option><option value="America/Denver">America/Denver (MST/MDT)</option><option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option><option value="Asia/Tokyo">Asia/Tokyo (JST)</option><option value="Asia/Shanghai">Asia/Shanghai (CST)</option><option value="Australia/Sydney">Australia/Sydney (AEST/AEDT)</option></optgroup><optgroup label="Additional Timezones"><option value="UTC">UTC (Coordinated Universal Time)</option><option value="Africa/Cairo">Africa/Cairo (EET)</option><option value="Africa/Johannesburg">Africa/Johannesburg (SAST)</option><option value="America/Argentina/Buenos_Aires">America/Argentina/Buenos_Aires (ART)</option><option value="America/Mexico_City">America/Mexico_City (CST/CDT)</option><option value="America/Sao_Paulo">America/Sao_Paulo (BRT/BRST)</option><option value="America/Toronto">America/Toronto (EST/EDT)</option><option value="America/Vancouver">America/Vancouver (PST/PDT)</option><option value="Asia/Bangkok">Asia/Bangkok (ICT)</option><option value="Asia/Dubai">Asia/Dubai (GST)</option><option value="Asia/Hong_Kong">Asia/Hong_Kong (HKT)</option><option value="Asia/Jakarta">Asia/Jakarta (WIB)</option><option value="Asia/Kolkata">Asia/Kolkata (IST)</option><option value="Asia/Seoul">Asia/Seoul (KST)</option><option value="Asia/Singapore">Asia/Singapore (SGT)</option><option value="Asia/Taipei">Asia/Taipei (CST)</option><option value="Australia/Brisbane">Australia/Brisbane (AEST)</option><option value="Australia/Melbourne">Australia/Melbourne (AEST/AEDT)</option><option value="Australia/Perth">Australia/Perth (AWST)</option><option value="Europe/Athens">Europe/Athens (EET/EEST)</option><option value="Europe/Istanbul">Europe/Istanbul (TRT)</option><option value="Europe/Moscow">Europe/Moscow (MSK)</option><option value="Europe/Rome">Europe/Rome (CET/CEST)</option><option value="Europe/Stockholm">Europe/Stockholm (CET/CEST)</option><option value="Europe/Zurich">Europe/Zurich (CET/CEST)</option><option value="Pacific/Auckland">Pacific/Auckland (NZST/NZDT)</option><option value="Pacific/Honolulu">Pacific/Honolulu (HST)</option></optgroup></select><span class="select-caret" aria-hidden="true">▾</span></div></div>
                      <div class="form-row"><label for="clockFormat">Clock format</label><div class="select-wrap has-caret"><select id="clockFormat"><option value="24h">24-hour</option><option value="12h">12-hour</option></select><span class="select-caret" aria-hidden="true">▾</span></div></div>
                    </div>
                  </div>

                  <!-- UI Element Scaling -->
                  <div class="form-section" id="sec-scaling" data-card-key="scaling">
                    <div class="section-title"><i class="fas fa-expand-arrows-alt"></i> UI Element Scaling</div>
                    <div class="form-grid">
                      <div class="form-row"><label for="uiScaling_content">Content</label><div class="modern-slider"><input type="range" id="uiScaling_content" min="50" max="200" step="5" value="100" /><div class="slider-percentage" data-target="uiScaling.content">100%</div></div></div>
                      <div class="form-row"><label for="uiScaling_clearlogo">Clearlogo</label><div class="modern-slider"><input type="range" id="uiScaling_clearlogo" min="50" max="200" step="5" value="100" /><div class="slider-percentage" data-target="uiScaling.clearlogo">100%</div></div></div>
                      <div class="form-row"><label for="uiScaling_clock">Clock</label><div class="modern-slider"><input type="range" id="uiScaling_clock" min="50" max="200" step="5" value="100" /><div class="slider-percentage" data-target="uiScaling.clock">100%</div></div></div>
                      <div class="form-row"><label for="uiScaling_global">Global</label><div class="modern-slider"><input type="range" id="uiScaling_global" min="50" max="200" step="5" value="100" /><div class="slider-percentage" data-target="uiScaling.global">100%</div></div></div>
                    </div>
                    <!-- Presets -->
                    <div class="form-row" style="margin-top:8px;">
                      <div class="scaling-presets" style="display:flex; flex-wrap:wrap; gap:8px;">
                        <button type="button" class="btn btn-secondary btn-sm" id="preset-4k-tv"><i class="fas fa-tv"></i> <span>4K TV</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" id="preset-full-hd"><i class="fas fa-desktop"></i> <span>Full HD</span></button>
                        <button type="button" class="btn btn-secondary btn-sm" id="preset-ultrawide"><i class="fas fa-expand-arrows-alt"></i> <span>Ultrawide</span></button>
                        <button type="button" class="btn btn-outline btn-sm" id="reset-ui-scaling"><i class="fas fa-undo"></i> <span>Reset</span></button>
                      </div>
                    </div>
                  </div>

                  <!-- Sync -->
                  <div class="form-section" id="sec-sync" data-card-key="sync">
                    <div class="section-title"><i class="fas fa-link"></i> Sync
                      <label class="header-toggle" for="syncEnabled">
                        <input type="checkbox" id="syncEnabled" />
                        <span class="ht-switch" aria-hidden="true"></span>
                        <span class="ht-text">Enable device sync</span>
                      </label>
                    </div>
                    <div class="form-grid">
                      
                      <div class="form-row"><label for="syncAlignMaxDelayMs">Max align delay (ms)</label><div class="number-input-wrapper"><input type="number" id="syncAlignMaxDelayMs" min="0" step="50" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div></div>
                    </div>
                  </div>

                  <!-- Effects & Transitions -->
                  <div class="form-section" id="sec-effects" data-card-key="effects">
                    <div class="section-title"><i class="fas fa-magic"></i> Effects & Transitions</div>
                    <div class="form-grid">
                      <div class="form-row"><label for="transitionEffect">Transition effect</label><div class="select-wrap has-caret"><select id="transitionEffect"><option value="kenburns">Ken Burns</option><option value="fade">Fade In/Out</option><option value="slide">Slide Transition</option></select><span class="select-caret" aria-hidden="true">▾</span></div></div>
                      <div class="form-row"><label for="effectPauseTime">Effect pause (seconds)</label><div class="number-input-wrapper"><input type="number" min="0" max="10" step="0.5" id="effectPauseTime" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div></div>
                    </div>
                  </div>

                  <!-- Playback Timing -->
                  <div class="form-section" id="sec-playback" data-card-key="playback">
                    <div class="section-title"><i class="fas fa-cogs"></i> Playback Timing</div>
                    <div class="form-grid">
                      <div class="form-row"><label for="transitionIntervalSeconds">Transition interval (seconds)</label><div class="number-input-wrapper"><input type="number" min="1" max="300" step="1" id="transitionIntervalSeconds" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div><div class="form-help">Time in seconds between poster transitions (1-300).</div></div>
                    </div>
                  </div>

              </fieldset>
            </div>

            <!-- Wallart settings -->
            <div class="mode-card" id="card-wallart" style="margin-top:12px;" hidden>
              <div class="card-header">
                <div class="card-title"><i class="fas fa-th-large"></i> Wallart</div>
              </div>
              <fieldset id="fs-wallart">
                <div class="card-subtext" style="margin-bottom:10px; color: var(--color-text-secondary);">
                  A dynamic, tiled poster wall. Fine‑tune density, animation, layout, ambience, and hero.
                </div>
                <div class="form-grid masonry" id="wallart-cards" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
                  <!-- Presets + Summary card (mirrors Screensaver) -->
                  <div class="mode-card" id="wallart-presets-card" data-card-key="presets" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-sliders-h"></i> Presets</div>
                    <div class="scaling-presets" style="display:flex; flex-wrap:wrap; gap:8px;">
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-gallery" title="Dense grid, smooth fade"><i class="fas fa-th"></i> <span>Gallery</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-hero" title="Hero left, medium grid cadence"><i class="fas fa-user-astronaut"></i> <span>Hero Focus</span></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="wallart-preset-vibe" title="Ambient gradient, slow"> <i class="fas fa-water"></i> <span>Ambient Vibe</span></button>
                      <button type="button" class="btn btn-outline btn-sm" id="wallart-preset-reset" title="Reset to sensible defaults"><i class="fas fa-undo"></i> <span>Reset</span></button>
                    </div>
                    <div class="card-title" style="font-size:.95rem; margin:10px 0 6px;"><i class="fas fa-info-circle"></i> Current Experience</div>
                    <div id="wallart-summary" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                      <span class="status-pill" id="wallart-summary-density" title="Poster density">Density: —</span>
                      <span class="status-pill" id="wallart-summary-layout" title="Layout variant">Layout: —</span>
                      <span class="status-pill" id="wallart-summary-anim" title="Animation type">Anim: —</span>
                      <span class="status-pill" id="wallart-summary-tempo" title="Refresh/Randomness">Tempo: —</span>
                    </div>
                  </div>
                  <!-- Tempo card -->
                  <div class="mode-card" data-card-key="tempo" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-tachometer-alt"></i> Tempo</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="wallartMode_refreshRate">Poster Refresh Rate</label>
                        <div class="modern-slider">
                          <input type="range" min="1" max="10" step="1" id="wallartMode_refreshRate" value="5" />
                          <div class="slider-percentage" data-target="wallartMode.refreshRate">Medium</div>
                        </div>
                      </div>
                      <div class="form-row">
                        <label for="wallartMode_randomness">Timing Randomness</label>
                        <div class="modern-slider">
                          <input type="range" min="0" max="10" step="1" id="wallartMode_randomness" value="3" />
                          <div class="slider-percentage" data-target="wallartMode.randomness">Low</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Animation card -->
                  <div class="mode-card" data-card-key="animation" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-magic"></i> Animation</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="wallartMode_animationType">Animation</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_animationType">
                            <option value="random">Random — Uses all animations</option>
                            <option value="fade">Fade — Smooth opacity</option>
                            <option value="slideLeft">Slide Left — From right</option>
                            <option value="slideUp">Slide Up — From bottom</option>
                            <option value="zoom">Zoom — Scale in</option>
                            <option value="flip">Flip — 3D flip</option>
                            <option value="staggered">Staggered — Rows/columns</option>
                            <option value="ripple">Ripple — Wave from center</option>
                            <option value="scanline">Scanline — Horizontal sweep</option>
                            <option value="parallax">Parallax — Subtle depth</option>
                            <option value="neonPulse">Neon Pulse — Soft glow</option>
                            <option value="chromaticShift">Chromatic Shift — RGB split</option>
                            <option value="mosaicShatter">Mosaic Shatter — Tiles assemble</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Layout card -->
                  <div class="mode-card" data-card-key="layout" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-th-large"></i> Layout</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="wallartMode_density">Density</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_density">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="ludicrous">Ludicrous</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                      <div class="form-row">
                        <label for="wallartMode_layoutVariant">Layout</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_layoutVariant">
                            <option value="heroGrid">Hero Grid</option>
                            <option value="classic">Classic</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                      
                    </div>
                  </div>

                  <!-- Ambience card -->
                  <div class="mode-card" data-card-key="ambience" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-lightbulb"></i> Ambience
                      <label class="header-toggle" for="wallartMode_ambientGradient" style="margin-left:auto;">
                        <input type="checkbox" id="wallartMode_ambientGradient" />
                        <span class="ht-switch" aria-hidden="true"></span>
                        <span class="ht-text">Ambient gradient</span>
                      </label>
                    </div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label class="checkbox" for="wallartMode_biasAmbientToHero">
                          <input type="checkbox" id="wallartMode_biasAmbientToHero" />
                          <span class="checkmark"></span>
                          <span>Bias ambient to hero</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Hero settings card (shown for Hero Grid) -->
                  <div class="mode-card" id="wallart-hero-card" data-card-key="hero" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-user-astronaut"></i> Hero Settings</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="wallartMode_heroSide">Hero side</label>
                        <div class="select-wrap has-caret">
                          <select id="wallartMode_heroSide">
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                      <div class="form-row">
                        <label for="wallartMode_heroRotationMinutes">Hero rotation (min)</label>
                        <div class="number-input-wrapper"><input type="number" min="1" max="60" id="wallartMode_heroRotationMinutes" /><div class="number-controls" role="group"><button type="button" class="number-btn number-inc" title="Increase"><i class="fas fa-chevron-up"></i></button><button type="button" class="number-btn number-dec" title="Decrease"><i class="fas fa-chevron-down"></i></button></div></div>
                      </div>
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>

            <!-- Cinema settings -->
            <div class="mode-card" id="card-cinema" style="margin-top:12px;" hidden>
              <div class="card-header">
                <div class="card-title"><i class="fas fa-film"></i> Cinema</div>
              </div>
              <fieldset id="fs-cinema">
                <div class="card-subtext" style="margin-bottom:10px; color: var(--color-text-secondary);">
                  A large, single‑poster view for displays. Choose your screen orientation.
                </div>
                <div class="form-grid masonry" id="cinema-cards">
                  <!-- Presets: first card (top-left) like Screensaver -->
                  <div class="mode-card" id="cinema-presets-card" data-card-key="cinema-presets" style="padding:12px;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-sliders-h"></i> Presets</div>
                    <div id="cinema-presets-mount"></div>
                  </div>
                  <!-- Left: Ambilight -->
                  <div class="mode-card" data-card-key="cinema-ambilight" id="cinema-ambilight-card" style="padding:12px; grid-column: 1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-lightbulb"></i> Ambilight</div>
                    <div id="cinema-ambilight-mount"></div>
                  </div>
                  <!-- Right: Orientation -->
                  <div class="mode-card" data-card-key="orientation" style="padding:12px; grid-column: 1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-mobile-alt"></i> Orientation</div>
                    <div class="form-grid">
                      <div class="form-row">
                        <label for="cinemaOrientation">Orientation</label>
                        <div class="select-wrap has-caret">
                          <select id="cinemaOrientation">
                            <option value="auto">Auto</option>
                            <option value="portrait">Portrait</option>
                            <option value="portrait-flipped">Portrait (flipped)</option>
                          </select>
                          <span class="select-caret" aria-hidden="true">▾</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Next row: Header (left) and Footer (right) -->
                  <div class="mode-card" data-card-key="cinema-header" id="cinema-header-card" style="padding:12px; grid-column: 1;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-heading"></i> Header</div>
                    <div id="cinema-header-mount"></div>
                  </div>
                  <div class="mode-card" data-card-key="cinema-footer" id="cinema-footer-card" style="padding:12px; break-before: column; -webkit-column-break-before: always;">
                    <div class="card-title" style="font-size:.95rem; margin-bottom:6px;"><i class="fas fa-window-maximize"></i> Footer</div>
                    <div id="cinema-footer-mount"></div>
                  </div>
                  
                </div>
              </fieldset>
            </div>
          </div>

        </div>
      </div>

    </section>

    <!-- Media Sources Section (top-level sibling, not nested under dashboard) -->
    <section id="section-media-sources" class="app-section" hidden>
      <div class="panel" id="panel-media-sources">
        <div class="panel-header">
          <div class="panel-title" style="flex-direction:column; align-items:flex-start; gap:4px;">
            <div style="display:flex; align-items:center; gap:10px;">
              <i class="fas fa-server" aria-hidden="true"></i>
              <h2 style="margin:0;">Media Sources</h2>
            </div>
            <div class="panel-subtitle">Connect and configure sources across Plex, Jellyfin and TMDB</div>
          </div>
          <div class="panel-actions"></div>
        </div>
        <div class="panel-content">
      <!-- Sources tabs (mirror Display segmented control) -->
      <div class="form-section" id="sources-tabs">
        <div class="section-title"><i class="fas fa-layer-group"></i> Source</div>
        <div class="form-row">
          <div class="segmented" role="tablist" aria-label="Source">
            <label class="seg" id="seg-plex" role="tab" aria-controls="panel-plex" aria-checked="false">
              <input type="radio" name="sources.active" id="src-plex" value="plex" />
              <i class="fas fa-film"></i> Plex
            </label>
            <label class="seg" id="seg-jellyfin" role="tab" aria-controls="panel-jellyfin" aria-checked="false">
              <input type="radio" name="sources.active" id="src-jellyfin" value="jellyfin" />
              <i class="fas fa-play"></i> Jellyfin
            </label>
            <label class="seg" id="seg-tmdb" role="tab" aria-controls="panel-tmdb" aria-checked="false">
              <input type="radio" name="sources.active" id="src-tmdb" value="tmdb" />
              <i class="fas fa-database"></i> TMDB
            </label>
            
          </div>
          <div class="source-actions-right"></div>
        </div>
      </div>
      <section class="panel" id="panel-sources-overview" hidden></section>

      <!-- Plex Panel -->
      <section class="panel" id="panel-plex">
        <div class="actions-home" id="plex-actions-home" hidden>
          <span class="status-pill" id="plex-status-pill-header" title="Plex configuration status">Not configured</span>
          <span class="status-pill" id="plex-count-pill" title="Change ratings/genres/quality chips or year fields → the “Items: N” pill updates immediately using the cached playlist">Items: —</span>
          <button class="btn btn-icon btn-sm" id="btn-plex-test" title="Test connection"><i class="fas fa-vial"></i></button>
          <button class="btn btn-icon btn-sm" id="btn-plex-libraries" title="Fetch libraries"><i class="fas fa-list"></i></button>
          <label class="header-toggle" for="plex.enabled" title="Enable Plex source">
            <input type="checkbox" id="plex.enabled" />
            <span class="ht-switch" aria-hidden="true"></span>
            <span class="ht-text">Enabled</span>
          </label>
          <button class="btn btn-primary btn-sm" id="btn-save-plex" title="Save Plex settings"><i class="fas fa-save"></i><span>Save Settings</span></button>
        </div>
        <div class="panel-content">
          <div class="loading-overlay" aria-hidden="true">
            <div class="glass"></div>
            <div class="loader"><span class="spinner"></span></div>
          </div>
          <!-- Connection -->
          <div class="form-section">
            <div class="section-title"><i class="fas fa-server"></i> Server
            </div>
          </div>
          <div class="form-grid plex-dense" id="plex-server-grid">
            <div class="form-group">
              <label for="plex_hostname">Hostname</label>
              <input type="text" id="plex_hostname" placeholder="e.g. 192.168.1.10" autocomplete="off" autocapitalize="off" spellcheck="false">
            </div>
            <div class="form-group">
              <label for="plex_port">Port</label>
              <input type="number" id="plex_port" min="1" max="65535" placeholder="32400" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
            </div>
            <div class="form-group">
              <label for="plex_token">API Token</label>
              <input type="password" id="plex_token" placeholder="X-Plex-Token" autocomplete="new-password">
              
            </div>
          </div>

          <!-- Libraries -->
          <div class="form-section">
            <div class="section-title"><i class="fas fa-list"></i> Libraries</div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="plex.movies">Movie Libraries</label>
              <select id="plex.movies" multiple style="display:none"></select>
              <div class="multiselect" id="plex-ms-movies">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-movies-chips"></div>
                  <button class="ms-clear" id="plex-ms-movies-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-movies-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-movies-search" type="text" placeholder="Search libraries…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-movies-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-movies-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-movies-options"></div>
                </div>
              </div>
              <small class="form-help">Select one or more libraries. Populated from Plex.</small>
            </div>
            <div class="form-group">
              <label for="plex.shows">Show Libraries</label>
              <select id="plex.shows" multiple style="display:none"></select>
              <div class="multiselect" id="plex-ms-shows">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-shows-chips"></div>
                  <button class="ms-clear" id="plex-ms-shows-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-shows-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-shows-search" type="text" placeholder="Search libraries…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-shows-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-shows-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-shows-options"></div>
                </div>
              </div>
              <small class="form-help">Select one or more libraries. Populated from Plex.</small>
            </div>
          </div>

          <!-- Years -->
          <div class="form-section">
            <div class="section-title"><i class="fas fa-filter"></i> Filters</div>
          </div>
          <!-- Compact filters grid: place all filters in one dense grid -->
          <div class="form-grid plex-dense" id="plex-filters-grid">
            <div class="form-group">
              <label for="plex.yearFilter">Release Years</label>
              <input type="text" id="plex.yearFilter" inputmode="numeric" placeholder="e.g. 1995, 1998, 2015-2025">
            </div>
            <div class="form-group">
              <label for="plex.ratingFilter">Ratings</label>
              <input type="hidden" id="plex.ratingFilter-hidden" value="">
              <div class="multiselect" id="plex-ms-ratings">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-ratings-chips"></div>
                  <button class="ms-clear" id="plex-ms-ratings-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-ratings-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-ratings-search" type="text" placeholder="Search ratings…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-ratings-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-ratings-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-ratings-options"></div>
                </div>
              </div>
              <small class="form-help">Select one or more ratings. Populated from Plex libraries.</small>
              
            </div>
            <div class="form-group">
              <label for="plex.genreFilter">Genres</label>
              <input type="hidden" id="plex.genreFilter-hidden" value="">
              <div class="multiselect" id="plex-ms-genres">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-genres-chips"></div>
                  <button class="ms-clear" id="plex-ms-genres-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-genres-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-genres-search" type="text" placeholder="Search genres…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-genres-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-genres-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-genres-options"></div>
                </div>
              </div>
              <small class="form-help">Select one or more genres. Populated from Plex libraries.</small>
              
            </div>
            <div class="form-group">
              <label for="plex.qualityFilter">Qualities</label>
              <input type="hidden" id="plex.qualityFilter-hidden" value="">
              <div class="multiselect" id="plex-ms-qualities">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="plex-ms-qualities-chips"></div>
                  <button class="ms-clear" id="plex-ms-qualities-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="plex-ms-qualities-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="plex-ms-qualities-search" type="text" placeholder="Search qualities…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="plex-ms-qualities-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="plex-ms-qualities-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="plex-ms-qualities-options"></div>
                </div>
              </div>
              <small class="form-help">Select one or more qualities. Populated from Plex libraries.</small>
              
            </div>
          </div>

          <!-- Recently added -->
          <div class="form-section">
            <div class="section-title"><i class="fas fa-clock"></i> Recently added
              <label class="header-toggle" for="plex.recentOnlyHeader" title="Show only recently added items" style="margin-left:auto;">
                <input type="checkbox" id="plex.recentOnlyHeader" />
                <span class="ht-switch" aria-hidden="true"></span>
              </label>
            </div>
          </div>
          <div class="form-grid plex-dense" id="plex-recent-grid">
            <!-- hidden form checkbox kept for saving is removed per request; header toggle will be the single source -->
            <div class="form-group">
              <label for="plex.recentDays">Recently added days</label>
              <input type="number" id="plex.recentDays" min="1" max="365" placeholder="30">
            </div>
          </div>
        </div>
      </section>

      <!-- Jellyfin Panel -->
      <section class="panel" id="panel-jellyfin" hidden>
        <div class="actions-home" id="jellyfin-actions-home" hidden>
          <span class="status-pill" id="jf-status-pill-header" title="Jellyfin configuration status">Not configured</span>
          <span class="status-pill" id="jf-count-pill" title="Change ratings/genres/quality chips or year fields → the “Items: N” pill updates immediately using the cached playlist">Items: —</span>
          <button class="btn btn-icon btn-sm" id="btn-jf-test" title="Test connection"><i class="fas fa-vial"></i></button>
          <button class="btn btn-icon btn-sm" id="btn-jf-libraries" title="Fetch libraries"><i class="fas fa-list"></i></button>
          <label class="header-toggle" for="jf.enabled" title="Enable Jellyfin source">
            <input type="checkbox" id="jf.enabled" />
            <span class="ht-switch" aria-hidden="true"></span>
            <span class="ht-text">Enabled</span>
          </label>
          <button class="btn btn-primary btn-sm" id="btn-save-jellyfin" title="Save Jellyfin settings"><i class="fas fa-save"></i><span>Save Settings</span></button>
        </div>
        <div class="panel-content">
          <div class="loading-overlay" aria-hidden="true">
            <div class="glass"></div>
            <div class="loader"><span class="spinner"></span></div>
          </div>
          <div class="form-section">
            <div class="section-title"><i class="fas fa-server"></i> Server
              <div class="section-actions">
                <span class="ht-text" id="jf-insecure-note">Allow self‑signed certificates</span>
                <label class="header-toggle" for="jf.insecureHttpsHeader" title="Allow self‑signed/invalid HTTPS (Jellyfin)">
                  <input type="checkbox" id="jf.insecureHttpsHeader" />
                  <span class="ht-switch" aria-hidden="true"></span>
                </label>
              </div>
            </div>
          </div>
          <div class="form-grid plex-dense" id="jf-server-grid">
            <div class="form-group">
              <label for="jf.hostname">Hostname</label>
              <input type="text" id="jf.hostname" placeholder="e.g. 192.168.1.20" autocomplete="off" autocapitalize="off" spellcheck="false">
            </div>
            <div class="form-group">
              <label for="jf.port">Port</label>
              <div class="number-input-wrapper niw-compact niw-sized-sm">
                <input type="number" id="jf.port" min="1" max="65535" placeholder="8096" autocomplete="off">
                <div class="number-controls" role="group">
                  <button type="button" class="number-btn number-inc" title="Increase" aria-label="Increase"><i class="fas fa-chevron-up"></i></button>
                  <button type="button" class="number-btn number-dec" title="Decrease" aria-label="Decrease"><i class="fas fa-chevron-down"></i></button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="jf.apikey">API Key</label>
              <input type="password" id="jf.apikey" placeholder="Jellyfin API Key" autocomplete="new-password">
              
            </div>
            <div class="form-group" hidden>
              <input type="checkbox" id="jf.insecureHttps" />
            </div>
          </div>
          <div class="form-section">
            <div class="section-title"><i class="fas fa-list"></i> Libraries</div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="jf.movies">Movie Libraries</label>
              <select id="jf.movies" multiple style="display:none"></select>
              <div class="multiselect" id="jf-ms-movies">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="jf-ms-movies-chips"></div>
                  <button class="ms-clear" id="jf-ms-movies-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="jf-ms-movies-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="jf-ms-movies-search" type="text" placeholder="Search libraries…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="jf-ms-movies-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="jf-ms-movies-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="jf-ms-movies-options"></div>
                </div>
              </div>
              <small class="form-help">Select one or more libraries. Populated from Jellyfin.</small>
            </div>
            <div class="form-group">
              <label for="jf.shows">Show Libraries</label>
              <select id="jf.shows" multiple style="display:none"></select>
              <div class="multiselect" id="jf-ms-shows">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="jf-ms-shows-chips"></div>
                  <button class="ms-clear" id="jf-ms-shows-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="jf-ms-shows-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="jf-ms-shows-search" type="text" placeholder="Search libraries…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="jf-ms-shows-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="jf-ms-shows-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="jf-ms-shows-options"></div>
                </div>
              </div>
              <small class="form-help">Select one or more libraries. Populated from Jellyfin.</small>
            </div>
          </div>
          
          <div class="form-section">
            <div class="section-title"><i class="fas fa-filter"></i> Filters</div>
          </div>
          <!-- Dense filters grid for Jellyfin (no qualities) -->
          <div class="form-grid plex-dense" id="jf-filters-grid">
            <div class="form-group">
              <label for="jf.yearFilter">Release Years</label>
              <input type="text" id="jf.yearFilter" inputmode="numeric" placeholder="e.g. 1995, 1998, 2015-2025">
            </div>
            <div class="form-group">
              <label for="jf.ratingFilter">Ratings</label>
              <input type="hidden" id="jf.ratingFilter-hidden" value="">
              <div class="multiselect" id="jf-ms-ratings">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="jf-ms-ratings-chips"></div>
                  <button class="ms-clear" id="jf-ms-ratings-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="jf-ms-ratings-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="jf-ms-ratings-search" type="text" placeholder="Search ratings…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="jf-ms-ratings-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="jf-ms-ratings-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="jf-ms-ratings-options"></div>
                </div>
              </div>
              <small class="form-help">Select one or more ratings. Populated from Jellyfin libraries.</small>
              
            </div>
            <div class="form-group">
              <label for="jf.genreFilter">Genres</label>
              <input type="hidden" id="jf.genreFilter-hidden" value="">
              <div class="multiselect" id="jf-ms-genres">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="jf-ms-genres-chips"></div>
                  <button class="ms-clear" id="jf-ms-genres-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="jf-ms-genres-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search"></i>
                    <input id="jf-ms-genres-search" type="text" placeholder="Search genres…">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="jf-ms-genres-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="jf-ms-genres-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="jf-ms-genres-options"></div>
                </div>
              </div>
              <small class="form-help">Select one or more genres. Populated from Jellyfin libraries.</small>
              
            </div>
          </div>
          <!-- Jellyfin Qualities hidden (disabled feature) -->
          <div class="form-grid" style="display:none">
            <div class="form-group">
              <label for="jf.qualityFilter">Qualities</label>
              <input type="hidden" id="jf.qualityFilter-hidden" value="">
              <div class="multiselect" id="jf-ms-qualities"></div>
              <small class="form-help">Qualities disabled for Jellyfin</small>
            </div>
          </div>
          <!-- Recently added -->
          <div class="form-section">
            <div class="section-title"><i class="fas fa-clock"></i> Recently added
              <label class="header-toggle" for="jf.recentOnlyHeader" title="Show only recently added items" style="margin-left:auto;">
                <input type="checkbox" id="jf.recentOnlyHeader" />
                <span class="ht-switch" aria-hidden="true"></span>
              </label>
            </div>
          </div>
          <div class="form-grid plex-dense" id="jf-recent-grid">
            <!-- removed hidden checkbox; header toggle is the only control now -->
            <div class="form-group">
              <label for="jf.recentDays">Recently added days</label>
              <input type="number" id="jf.recentDays" min="1" max="365" placeholder="30">
            </div>
          </div>
        </div>
      </section>

      <!-- TMDB Panel -->
  <section class="panel" id="panel-tmdb">
        <div class="actions-home" id="tmdb-actions-home" hidden>
          <span class="status-pill" id="tmdb-status-pill-header" title="TMDB configuration status">Not configured</span>
          <span class="status-pill" id="tmdb-count-pill" title="Items from TMDB in the current playlist">Items: —</span>
          <button class="btn btn-icon btn-sm" id="btn-tmdb-test" title="Test connection"><i class="fas fa-vial"></i></button>
          <label class="header-toggle" for="tmdb.enabled" title="Enable TMDB source">
            <input type="checkbox" id="tmdb.enabled" />
            <span class="ht-switch" aria-hidden="true"></span>
            <span class="ht-text">Enabled</span>
          </label>
          <button class="btn btn-primary btn-sm" id="btn-save-tmdb" title="Save TMDB settings"><i class="fas fa-save"></i><span>Save Settings</span></button>
        </div>
        <div class="panel-content">
          <div class="loading-overlay" aria-hidden="true">
            <div class="glass"></div>
            <div class="loader"><span class="spinner"></span></div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="tmdb.apikey">API Key</label>
              <input type="password" id="tmdb.apikey" placeholder="TMDB API Key" autocomplete="new-password">
            </div>
            <div class="form-group">
              <label for="tmdb.category">Category</label>
              <div class="select-wrap has-caret">
                <span class="select-icon" id="tmdb-category-icon"><i class="fas fa-fire"></i></span>
                <select id="tmdb.category">
                  <optgroup label="Movies">
                    <option value="popular">Popular Movies</option>
                    <option value="top_rated">Top Rated Movies</option>
                    <option value="now_playing">Now Playing</option>
                    <option value="upcoming">Upcoming Movies</option>
                    <option value="latest">Latest Movies</option>
                  </optgroup>
                  <optgroup label="TV Shows">
                    <option value="tv_popular">Popular TV Shows</option>
                    <option value="tv_top_rated">Top Rated TV Shows</option>
                    <option value="tv_on_the_air">Currently Airing</option>
                    <option value="tv_airing_today">Airing Today</option>
                    <option value="tv_latest">Latest TV Shows</option>
                  </optgroup>
                  <optgroup label="Trending">
                    <option value="trending_all_day">Trending Today (All)</option>
                    <option value="trending_movie_day">Trending Movies (Day)</option>
                    <option value="trending_tv_day">Trending TV (Day)</option>
                    <option value="trending_all_week">Trending Week (All)</option>
                    <option value="trending_movie_week">Trending Movies (Week)</option>
                    <option value="trending_tv_week">Trending TV (Week)</option>
                  </optgroup>
                  <optgroup label="Collections">
                    <option value="discover_movie">Discover Movies</option>
                    <option value="discover_tv">Discover TV Shows</option>
                  </optgroup>
                </select>
                <span class="select-caret" aria-hidden="true">▾</span>
              </div>
            </div>
            <div class="form-group">
              <label for="tmdb.minRating">Minimum Rating</label>
              <div class="number-input-wrapper niw-compact niw-sized-sm">
                <input type="number" id="tmdb.minRating" min="0" max="10" step="0.1" placeholder="0">
                <div class="number-controls">
                  <button type="button" class="number-btn number-inc" aria-label="Increase value"><i class="fas fa-chevron-up"></i></button>
                  <button type="button" class="number-btn number-dec" aria-label="Decrease value"><i class="fas fa-chevron-down"></i></button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="tmdb.yearFilter">Release Years</label>
              <input type="text" id="tmdb.yearFilter" inputmode="numeric" placeholder="e.g. 1995, 1998, 2015-2025">
              
            </div>
          </div>
            <div class="form-grid">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Genres</label>
                <input type="hidden" id="tmdb.genreFilter-hidden" value="">
                <div class="multiselect" id="tmdb-ms-genres">
                  <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                    <div class="ms-chips" id="tmdb-ms-genres-chips"></div>
                    <button class="ms-clear" id="tmdb-ms-genres-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                    <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                  </div>
                  <div class="ms-menu" id="tmdb-ms-genres-menu" role="listbox">
                    <div class="ms-search">
                      <i class="fas fa-search"></i>
                      <input id="tmdb-ms-genres-search" type="text" placeholder="Search genres…">
                    </div>
                    <div class="ms-actions">
                      <button class="btn btn-outline btn-sm" id="tmdb-ms-genres-select-all"><i class="fas fa-square-check"></i> Select all</button>
                      <button class="btn btn-outline btn-sm" id="tmdb-ms-genres-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                    </div>
                    <div class="ms-options" id="tmdb-ms-genres-options"></div>
                  </div>
                </div>
                <small id="tmdb-genre-help" class="form-help">Select one or more genres. Populated from TMDB.</small>
              </div>
            </div>

          <!-- Streaming Releases (TMDB-based) -->
          <div class="form-divider" aria-hidden="true"></div>
          <section class="subpanel" id="subpanel-streaming">
            <header class="subpanel-header">
              <h3>
                <i class="fas fa-stream" aria-hidden="true"></i>
                <span>Streaming Releases</span>
              </h3>
              <div class="panel-actions">
                <label class="header-toggle" for="streamingSources.enabled" title="Enable Streaming Releases">
                  <input type="checkbox" id="streamingSources.enabled" />
                  <span class="ht-switch" aria-hidden="true"></span>
                  <span class="ht-text">Enabled</span>
                </label>
                <button class="btn btn-icon btn-sm" id="test-streaming-button" title="Test Streaming"><i class="fas fa-vial"></i></button>
              </div>
            </header>
            <div class="subpanel-body">
              <div class="subtle">Add latest releases from popular streaming platforms using TMDB's provider data.</div>
              <small id="streaming-connection-status" class="form-help"></small>
          
          <div class="form-grid">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Streaming Providers</label>
              <select id="streaming.providers" multiple style="display:none"></select>
              <div class="multiselect" id="streaming-ms-providers">
                <div class="ms-control" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                  <div class="ms-chips" id="streaming-ms-providers-chips"></div>
                  <button class="ms-clear" id="streaming-ms-providers-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
                  <i class="fas fa-chevron-down ms-caret" aria-hidden="true"></i>
                </div>
                <div class="ms-menu" id="streaming-ms-providers-menu" role="listbox">
                  <div class="ms-search">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    <input type="text" id="streaming-ms-providers-search" placeholder="Search providers" aria-label="Search providers">
                  </div>
                  <div class="ms-actions">
                    <button class="btn btn-outline btn-sm" id="streaming-ms-providers-select-all"><i class="fas fa-square-check"></i> Select all</button>
                    <button class="btn btn-outline btn-sm" id="streaming-ms-providers-clear-all"><i class="fas fa-eraser"></i> Clear</button>
                  </div>
                  <div class="ms-options" id="streaming-ms-providers-options"></div>
                </div>
              </div>
              <small class="form-help">Select one or more providers. Populated from TMDB.</small>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="checkbox"><input type="checkbox" id="streamingSources.newReleases"><span class="checkmark"></span><span>New Releases (Selected)</span></label>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="streamingSources.region">Region</label>
              <div class="select-wrap has-caret">
              <select id="streamingSources.region">
                <option value="US">🇺🇸 United States</option>
                <option value="NL">🇳🇱 Netherlands</option>
                <option value="GB">🇬🇧 United Kingdom</option>
                <option value="DE">🇩🇪 Germany</option>
                <option value="FR">🇫🇷 France</option>
                <option value="CA">🇨🇦 Canada</option>
                <option value="AU">🇦🇺 Australia</option>
                <option value="ES">🇪🇸 Spain</option>
                <option value="IT">🇮🇹 Italy</option>
                <option value="BR">🇧🇷 Brazil</option>
                <option value="MX">🇲🇽 Mexico</option>
                <option value="AR">🇦🇷 Argentina</option>
                <option value="JP">🇯🇵 Japan</option>
                <option value="KR">🇰🇷 South Korea</option>
                <option value="IN">🇮🇳 India</option>
                <option value="CN">🇨🇳 China</option>
                <option value="RU">🇷🇺 Russia</option>
                <option value="BE">🇧🇪 Belgium</option>
                <option value="AT">🇦🇹 Austria</option>
                <option value="CH">🇨🇭 Switzerland</option>
                <option value="SE">🇸🇪 Sweden</option>
                <option value="NO">🇳🇴 Norway</option>
                <option value="DK">🇩🇰 Denmark</option>
                <option value="FI">🇫🇮 Finland</option>
                <option value="PL">🇵🇱 Poland</option>
                <option value="CZ">🇨🇿 Czech Republic</option>
                <option value="HU">🇭🇺 Hungary</option>
                <option value="PT">🇵🇹 Portugal</option>
                <option value="GR">🇬🇷 Greece</option>
                <option value="TR">🇹🇷 Turkey</option>
                <option value="IL">🇮🇱 Israel</option>
                <option value="ZA">🇿🇦 South Africa</option>
                <option value="EG">🇪🇬 Egypt</option>
                <option value="SA">🇸🇦 Saudi Arabia</option>
                <option value="AE">🇦🇪 United Arab Emirates</option>
                <option value="TH">🇹🇭 Thailand</option>
                <option value="SG">🇸🇬 Singapore</option>
                <option value="MY">🇲🇾 Malaysia</option>
                <option value="ID">🇮🇩 Indonesia</option>
                <option value="PH">🇵🇭 Philippines</option>
                <option value="VN">🇻🇳 Vietnam</option>
                <option value="TW">🇹🇼 Taiwan</option>
                <option value="HK">🇭🇰 Hong Kong</option>
                <option value="NZ">🇳🇿 New Zealand</option>
                <option value="CL">🇨🇱 Chile</option>
                <option value="CO">🇨🇴 Colombia</option>
                <option value="PE">🇵🇪 Peru</option>
                <option value="VE">🇻🇪 Venezuela</option>
                <option value="UY">🇺🇾 Uruguay</option>
                <option value="EC">🇪🇨 Ecuador</option>
                <option value="BO">🇧🇴 Bolivia</option>
                <option value="PY">🇵🇾 Paraguay</option>
              </select>
              <span class="select-caret" aria-hidden="true">▾</span>
              </div>
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="streamingSources.minRating">Minimum Rating</label>
              <div class="number-input-wrapper niw-compact niw-sized-sm">
                <input type="number" id="streamingSources.minRating" min="0" max="10" step="0.1" placeholder="6.0">
                <div class="number-controls">
                  <button type="button" class="number-btn number-inc" aria-label="Increase value"><i class="fas fa-chevron-up"></i></button>
                  <button type="button" class="number-btn number-dec" aria-label="Decrease value"><i class="fas fa-chevron-down"></i></button>
                </div>
              </div>
            </div>
          </div>
            </div>
          </section>
        </div>
      </section>

      
        </div>
      </div>
    </section>

    <!-- Cinema Text Entry Modal (for add/rename header/footer text) -->
    <div class="modal-overlay" id="modal-cinema-text" hidden>
      <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-cinema-text-title">
        <div class="modal-header">
          <div class="modal-title" id="modal-cinema-text-title"><i class="fas fa-i-cursor"></i> Edit Text</div>
          <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="display:grid; gap:10px; padding:16px 20px;">
          <label for="cinema-text-input" id="cinema-text-input-label" style="color:var(--color-text-secondary)">Enter text</label>
          <input type="text" id="cinema-text-input" />
        </div>
        <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding: 12px 20px;">
          <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
          <button type="button" class="btn btn-primary" id="cinema-text-ok"><i class="fas fa-check"></i><span>Save</span></button>
        </div>
      </div>
    </div>

    <!-- Cinema Manage Texts Modal (add/rename/delete in one place) -->
    <div class="modal-overlay" id="modal-cinema-manage" hidden>
      <div class="modal modal-md" role="dialog" aria-modal="true" aria-labelledby="modal-cinema-manage-title">
        <div class="modal-header">
          <div class="modal-title" id="modal-cinema-manage-title"><i class="fas fa-list"></i> Manage Texts</div>
          <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="display:grid; grid-template-columns: 1fr; gap:12px; padding:16px 20px;">
          <div id="cinema-manage-help" style="color:var(--color-text-secondary); font-size:.9rem;">Create, rename, or remove preset texts. Select one to rename or delete.</div>
          <div id="cinema-manage-list" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
          <div>
            <label for="cinema-manage-input" id="cinema-manage-input-label" style="color:var(--color-text-secondary)">Preset text</label>
            <input type="text" id="cinema-manage-input" placeholder="Type preset text…" />
          </div>
        </div>
        <div class="modal-footer" style="display:flex; gap:10px; justify-content:space-between; padding: 12px 20px;">
          <div style="display:flex; gap:8px;">
            <button type="button" class="btn btn-secondary btn-sm" id="cinema-manage-add"><i class="fas fa-plus"></i> <span>Add</span></button>
            <button type="button" class="btn btn-secondary btn-sm" id="cinema-manage-rename"><i class="fas fa-pen"></i> <span>Rename</span></button>
            <button type="button" class="btn btn-outline btn-sm" id="cinema-manage-delete"><i class="fas fa-trash"></i> <span>Delete</span></button>
          </div>
          <div style="display:flex; gap:8px;">
            <button type="button" class="btn btn-outline" data-close-modal>Close</button>
            <button type="button" class="btn btn-primary" id="cinema-manage-done"><i class="fas fa-check"></i> <span>Done</span></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Devices Section (top-level sibling) -->
    <section id="section-devices" class="app-section" hidden>
      <!-- Device Management Tabs header (mirrors Media Sources/Display) -->
      <div class="panel" id="panel-device-management">
        <div class="panel-header">
          <div class="panel-title" style="flex-direction:column; align-items:flex-start; gap:4px;">
            <div style="display:flex; align-items:center; gap:10px;">
              <i class="fas fa-laptop" aria-hidden="true"></i>
              <h2 style="margin:0;">Device Management</h2>
            </div>
            <div class="panel-subtitle">Manage devices, groups, and configuration presets</div>
          </div>
          <div class="panel-actions"></div>
        </div>
        <div class="panel-content">
          <div class="form-section" id="device-tabs">
            <div class="section-title"><i class="fas fa-layer-group"></i> Manage</div>
            <div class="segmented" role="tablist" aria-label="Manage">
              <label class="seg" id="seg-devices" role="tab" aria-controls="device-ui" aria-checked="false">
                <i class="fas fa-desktop"></i> Devices
              </label>
              <label class="seg" id="seg-dev-settings" role="tab" aria-controls="panel-device-settings" aria-checked="false">
                <i class="fas fa-sliders-h"></i> Settings
              </label>
            </div>
          </div>
        </div>
      </div>
      <!-- Devices subpanel -->
      <section class="panel" id="device-ui">
        <header class="panel-header">
          <div class="panel-title">
            <h2><i class="fas fa-desktop"></i> Devices <span class="badge badge-error">BETA</span></h2>
            <div class="panel-subtitle">Manage devices, groups, and configuration presets</div>
          </div>
          <div class="panel-actions device-toolbar">
            <div class="dropdown">
              <button class="btn btn-outline btn-sm dropdown-toggle" id="device-filter-toggle">
                <i class="fas fa-filter"></i>
                Filter
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="dropdown-menu" id="device-filter-menu"></div>
            </div>
            <div class="dropdown">
              <button class="btn btn-outline btn-sm dropdown-toggle" id="device-actions-toggle">
                <i class="fas fa-gear"></i>
                Actions
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="dropdown-menu" id="device-actions-menu"></div>
            </div>
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input id="device-search" type="text" placeholder="Search devices…">
            </div>
          </div>
        </header>
        <div class="panel-content">
          <div class="device-grid" id="device-grid">
            <!-- Device cards will be rendered dynamically from /api/devices -->
          </div>

          <div class="table-footer device-pagination">
            <div class="table-info" id="device-page-info">Showing 0 of 0 devices</div>
            <div class="pagination">
              <button class="btn btn-icon btn-sm" id="device-page-prev" aria-label="Previous page"><i class="fas fa-chevron-left"></i></button>
              <span class="page-numbers" id="device-page-numbers"></span>
              <button class="btn btn-icon btn-sm" id="device-page-next" aria-label="Next page"><i class="fas fa-chevron-right"></i></button>
              <div class="per-page">
                <label for="device-per-page" class="sr-only">Per page</label>
                <div class="select-wrap has-caret">
                  <select id="device-per-page">
                    <option value="6">6 / page</option>
                    <option value="9" selected>9 / page</option>
                    <option value="12">12 / page</option>
                    <option value="24">24 / page</option>
                  </select>
                  <span class="select-caret" aria-hidden="true">▾</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- Settings subpanel (moved under Devices section) -->
      <section class="panel" id="panel-device-settings" hidden>
        <header class="panel-header">
          <div class="panel-title">
            <h2><i class="fas fa-sliders-h"></i> Settings</h2>
            <div class="panel-subtitle">Configure IP whitelists and general device policies</div>
          </div>
          <div class="panel-actions"></div>
        </header>
        <div class="panel-content">
          <!-- IP Whitelist Section -->
          <div class="form-section" id="card-ip-whitelist">
            <div class="section-title"><i class="fas fa-shield-halved"></i> IP Whitelist</div>
            <div class="section-subtitle">Clients matching these IPv4 addresses or CIDR ranges will skip device registration and use global Display Settings. Useful for trusted kiosk displays.</div>
            
            <div class="form-row" style="margin-top: 16px;">
              <div id="device-whitelist-empty" style="display:none; opacity:.6; font-size:.9rem; margin-bottom:12px; color: #9ca3af;">No whitelist entries yet.</div>
              <div id="device-whitelist-list" class="chip-container" style="margin:0 0 16px 0; display:flex; flex-wrap:wrap; gap:8px; min-height:24px;"></div>
            </div>
            
            <div class="form-row">
              <div class="input-group" style="display:flex; gap:12px; align-items:stretch;">
                <input 
                  type="text" 
                  id="input-whitelist-entry" 
                  class="form-input"
                  placeholder="192.168.1.25 or 192.168.0.0/16" 
                  style="
                    flex:1; 
                    min-width:280px;
                    background: var(--color-bg-card) !important;
                    color: var(--color-text-primary) !important;
                    border: 1px solid var(--color-border) !important;
                    padding: var(--space-md) !important;
                    border-radius: var(--border-radius-md) !important;
                  "
                  pattern="[0-9\.\/]*"
                  title="Only numbers, dots, and forward slashes allowed for IP addresses and CIDR ranges"
                  autocomplete="off" 
                  autocapitalize="off" 
                  spellcheck="false"
                />
                <button type="button" id="btn-add-whitelist" class="btn btn-outline" style="padding:10px 16px; border-radius:6px; font-weight:500; font-size:14px; display:flex; align-items:center; gap:6px; white-space:nowrap; transition:all 0.15s ease;">
                  <i class="fas fa-plus" style="font-size:12px;"></i>
                  <span>Add</span>
                </button>
                <button type="button" id="btn-whitelist-save" class="btn btn-primary" disabled style="padding:10px 20px; border-radius:6px; font-weight:500; font-size:14px; display:flex; align-items:center; gap:8px; white-space:nowrap; transition:all 0.15s ease;">
                  <i class="fas fa-save" style="font-size:12px;"></i>
                  <span>Save Changes</span>
                </button>
              </div>
            </div>
            
            <div class="form-help" style="margin-top:8px;">
              <strong>Formats:</strong> IPv4 addresses or CIDR ranges (e.g. 10.0.0.0/8, 192.168.1.0/24). Changes take effect within 30s or after server restart.
            </div>
            <div id="whitelist-status" class="form-status" style="display:none; margin-top:8px;"></div>
          </div>

          <!-- Placeholder for future device management settings -->
          <div class="form-section" style="margin-top:32px;" hidden id="device-future-settings">
            <div class="section-title"><i class="fas fa-gears"></i> Additional Settings</div>
            <div class="section-subtitle">Future options will appear here such as pairing policies, heartbeat intervals, offline grace periods, API throttling and more.</div>
          </div>
        </div>
      </section>
    </section>

    <!-- Operations Section (top-level sibling) -->
  <section id="section-operations" class="app-section" hidden>
    <section class="panel operations-panel">
        <header class="panel-header">
          <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; width:100%;">
            <div class="panel-title">
              <h2><i class="fas fa-screwdriver-wrench"></i> Operations</h2>
              <div class="panel-subtitle">Run media refresh and manage auto-updates</div>
            </div>
            <div class="panel-actions">
              <button type="button" id="btn-save-operations" class="btn btn-primary btn-sm" title="Save all operation settings">
                <i class="fas fa-save"></i><span>Save Settings</span>
              </button>
            </div>
          </div>
        </header>
        <div class="panel-content">
  <div class="content-grid" style="gap:12px;">
        <div class="ops-col">
          <div class="ops-group">
            <div class="ops-group-title"><i class="fas fa-download"></i> Updates</div>
          </div>
            <!-- Auto-Update Operations (moved to top-left) -->
            <section class="perf-card" aria-label="Automatic Updates">
              <h3><i class="fas fa-download"></i> Automatic Updates</h3>
              <div class="card-pill-spot">
                <span id="update-phase-text" class="status-pill status-info" style="display:none;">Checking…</span>
                <span id="update-progress-percent" class="status-pill" style="display:none;">0%</span>
                <span id="update-idle-pill" class="status-pill status-success">Ready</span>
              </div>
              <div class="card-subtext">Manage updates and view progress.</div>
              <div id="ops-update-status" class="status-display">
                <div id="update-idle-state"></div>
                <div id="update-progress-state" style="display:none;" class="mt-8">
                  <div class="meter mt-6">
                    <div id="update-progress-bar" style="width:0%; background: linear-gradient(90deg,#60a5fa,#1e40af);"></div>
                  </div>
                  <div id="update-message" class="subtle mt-6">Preparing…</div>
                </div>
              </div>
              <div class="actions main-actions">
                <button type="button" id="btn-start-update" class="btn btn-success btn-sm"><i class="fas fa-download"></i><span>Start Auto-Update</span></button>
                <button type="button" id="btn-rollback-update" class="btn btn-secondary btn-sm"><i class="fas fa-undo"></i><span>Rollback</span></button>
                <button type="button" id="btn-list-backups" class="btn btn-secondary btn-sm"><i class="fas fa-archive"></i><span>View Backups</span></button>
              </div>
              <div class="actions sub-actions">
                <div class="input-row">
                  <div class="form-group" style="margin:0;">
                    <input type="number" id="input-keep-backups" min="1" max="20" value="5" class="w-90" />
                  </div>
                  <button type="button" id="btn-cleanup-backups" class="btn btn-secondary btn-sm"><i class="fas fa-trash"></i><span>Cleanup Old</span></button>
                </div>
              </div>
              <div id="backups-display" class="status-display" style="display:none; margin-top:10px;">
                <div class="subtle" style="display:flex; align-items:center; gap:8px;"><i class="fas fa-archive"></i> Available Backups</div>
                <div id="backups-content" class="metric-row" style="margin-top:6px;">
                  <div class="subtle">Loading…</div>
                </div>
              </div>
      </section>
            <!-- Backups Group Title -->
            <div class="ops-group">
              <div class="ops-group-title"><i class="fas fa-folder-open"></i> Backups</div>
            </div>
            <!-- Config Backups (compact list) -->
            <section class="perf-card" aria-label="Config Backups">
              <h3><i class="fas fa-archive"></i> Config Backups</h3>
              <div class="card-pill-spot">
                <span id="cfg-backup-schedule-pill" class="status-pill status-warning">Disabled</span>
              </div>
              <div class="card-subtext">Create daily configuration backups and restore per file.</div>

              <div class="actions main-actions">
                <button type="button" id="btn-create-cfg-backup" class="btn btn-success btn-sm"><i class="fas fa-plus-circle"></i><span>Backup now</span></button>
                <div class="input-row">
                  <div class="form-group" style="margin:0;">
                    <input type="number" id="input-keep-cfg-backups" min="1" max="60" value="5" class="w-90" title="Number of backups to keep" />
                  </div>
                  <button type="button" id="btn-cleanup-cfg-backups" class="btn btn-secondary btn-sm"><i class="fas fa-broom"></i><span>Cleanup</span></button>
                </div>
              </div>

              <div class="actions sub-actions">
                <div class="inline-field">
                  <label for="input-cfg-backup-enabled" style="margin:0;display:inline-flex;align-items:center;padding-right:12px;">Daily schedule</label>
                  <label class="checkbox" style="margin-right:8px;">
                    <input type="checkbox" id="input-cfg-backup-enabled" />
                    <span class="checkmark"></span>
                    <span>Enabled</span>
                  </label>
                  <div class="time-input" title="Run time">
                    <i class="fas fa-clock" aria-hidden="true"></i>
                    <input type="time" id="input-cfg-backup-time" value="02:30" class="w-110" aria-label="Backup time" />
                  </div>
                  
                </div>
              </div>

              <div id="cfg-backup-list" class="compact-backup-list"></div>
            </section>
        </div>
  <div class="ops-col">
      <div class="ops-group">
        <div class="ops-group-title"><i class="fas fa-server"></i> Server</div>
      </div>
            <!-- Server Settings (under Server) -->
            <section class="perf-card" aria-label="Server Settings">
              <h3><i class="fas fa-gear"></i> Server</h3>
              <div class="card-subtext">Core server configuration.</div>
              <div class="metric-row">
                <div class="form-group inline-field nowrap" style="display: block;">
                  <label for="SERVER_PORT" style="margin:0;display:inline-flex;align-items:center;padding-right:12px;">Port</label>
                  <input type="number" id="SERVER_PORT" min="1024" max="65535" step="1" class="w-110" />
                </div>
              </div>
            </section>
  <!-- Promobox Site -->
            <section class="perf-card" aria-label="Promobox Site">
              <h3><i class="fas fa-bullhorn"></i> Promobox Site</h3>
              <div class="card-pill-spot">
                <span class="status-pill status-warning" id="siteServer-pill">Disabled</span>
              </div>
              <div class="card-subtext">Optional static poster showcase.</div>
              <div class="metric-row mt-6">
                <div class="form-group checkbox-group">
                  <label class="checkbox" for="siteServer.enabled">
                    <input type="checkbox" id="siteServer.enabled" />
                    <span class="checkmark"></span>
                    <span>Enable Promobox Site</span>
                  </label>
                </div>
                <div class="form-group inline-field nowrap" id="siteServerPortGroup" style="display:none;">
                  <label for="siteServer.port" style="margin:0;display:inline-flex;align-items:center;padding-right:12px;">Port</label>
                  <input type="number" id="siteServer.port" min="1024" max="65535" value="4001" class="w-110" />
                </div>
                <div id="siteServerStatus" class="subtle" style="display:none;"></div>
              </div>
            </section>

            <!-- API Group Title -->
            <div class="ops-group">
              <div class="ops-group-title"><i class="fas fa-plug"></i> API</div>
            </div>
            <!-- API Access -->
            <section class="perf-card" aria-label="API Access Management">
              <h3><i class="fas fa-code"></i> API Access</h3>
              <div class="card-pill-spot">
                <span class="status-pill" id="api-key-status-pill">Key: <span id="api-key-status-text">Loading…</span></span>
              </div>
              <div class="card-subtext">Programmatic access to admin endpoints.</div>
              <div id="api-key-display" class="is-hidden mt-6">
                <div class="input-row">
                  <input id="api-key-input" type="password" readonly />
                  <div class="actions">
                    <button id="toggle-api-key-visibility-button" type="button" class="btn btn-icon btn-sm" title="Show/Hide"><i class="fas fa-eye"></i></button>
                    <button id="copy-api-key-button" type="button" class="btn btn-icon btn-sm" title="Copy to clipboard"><i class="fas fa-copy"></i></button>
                  </div>
                </div>
              </div>
              <div class="actions" style="margin-top:6px;">
                <button id="generate-api-key-button" type="button" class="btn btn-success btn-sm">
                  <i class="fas fa-key"></i>
                  <span>Generate New Key</span>
                </button>
                <button id="revoke-api-key-button" type="button" class="btn btn-error btn-sm" disabled>
                  <i class="fas fa-trash-alt"></i>
                  <span>Revoke Key</span>
                </button>
              </div>
            </section>

            <!-- Media Group Title -->
            <div class="ops-group">
              <div class="ops-group-title"><i class="fas fa-photo-video"></i> Media</div>
            </div>
            <!-- Media Operations -->
            <section class="perf-card" aria-label="Media Operations">
              <h3><i class="fas fa-sync-alt"></i> Media</h3>
              <div class="card-subtext">Refresh media from configured sources.</div>
              <div class="metric-row mt-6">
                <div class="form-group inline-field nowrap" style="display: block;">
                  <label for="ops.backgroundRefreshMinutes" style="margin:0;display:inline-flex;align-items:center;padding-right:12px; white-space:nowrap;">Background Refresh (minutes)</label>
                  <input type="number" id="ops.backgroundRefreshMinutes" min="5" max="1440" step="1" class="w-110" value="60" />
                </div>
              </div>
        <div class="actions main-actions">
                <button type="button" id="btn-refresh-media" class="btn btn-success btn-sm">
                  <i class="fas fa-sync-alt"></i><span>Refresh Media</span>
                </button>
              </div>
            </section>

      

      
    </div>
          </div>
        </div>
      </section>
    </section>

  </main>

  <!-- Change Password Modal -->
  <div class="modal-overlay" id="modal-change-password">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-change-password-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-change-password-title"><i class="fas fa-key"></i> Change Password</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 24px;">
        
        <!-- Security icon and intro -->
        <div style="margin-bottom: 24px;">
          <div style="
            width: 64px; 
            height: 64px; 
            margin: 0 auto 16px auto; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
          ">
            <i class="fas fa-key" style="font-size: 24px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600;">Update Your Password</h3>
          <p style="margin: 0; font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.4;">
            Choose a strong password to keep your account secure
          </p>
        </div>

        <!-- Password form section -->
        <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.06);">
          
          <!-- Current password -->
          <div style="margin-bottom: 16px; text-align: left;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-unlock" style="color: var(--color-warning); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.85rem;">Current Password</span>
            </div>
            <input 
              type="password" 
              id="input-current-password" 
              autocomplete="current-password" 
              placeholder="Enter your current password"
              style="
                width: 100%;
                padding: 10px 12px;
                border-radius: 6px;
                border: 2px solid rgba(255,255,255,0.1);
                background: rgba(255,255,255,0.05);
                color: white;
                font-size: 0.9rem;
                transition: border-color 0.2s ease;
              "
            />
          </div>
          
          <!-- New password -->
          <div style="margin-bottom: 16px; text-align: left;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-lock" style="color: var(--color-success); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.85rem;">New Password</span>
            </div>
            <input 
              type="password" 
              id="input-new-password" 
              autocomplete="new-password" 
              placeholder="Enter a strong new password"
              style="
                width: 100%;
                padding: 10px 12px;
                border-radius: 6px;
                border: 2px solid rgba(255,255,255,0.1);
                background: rgba(255,255,255,0.05);
                color: white;
                font-size: 0.9rem;
                transition: border-color 0.2s ease;
              "
            />
          </div>
          
          <!-- Confirm password -->
          <div style="margin-bottom: 16px; text-align: left;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-check-circle" style="color: var(--color-accent); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.85rem;">Confirm Password</span>
            </div>
            <input 
              type="password" 
              id="input-confirm-password" 
              autocomplete="new-password" 
              placeholder="Confirm your new password"
              style="
                width: 100%;
                padding: 10px 12px;
                border-radius: 6px;
                border: 2px solid rgba(255,255,255,0.1);
                background: rgba(255,255,255,0.05);
                color: white;
                font-size: 0.9rem;
                transition: border-color 0.2s ease;
              "
            />
          </div>

          <!-- Password strength indicator -->
          <div id="password-strength" style="margin-bottom: 12px; text-align: left; display: none;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <i class="fas fa-shield-alt" style="font-size: 0.75rem; color: rgba(255,255,255,0.6);"></i>
              <span style="font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.8);">Password Strength</span>
            </div>
            <div style="display: flex; gap: 2px; margin-bottom: 6px;">
              <div class="strength-bar" style="height: 4px; flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px;"></div>
              <div class="strength-bar" style="height: 4px; flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px;"></div>
              <div class="strength-bar" style="height: 4px; flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px;"></div>
              <div class="strength-bar" style="height: 4px; flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px;"></div>
            </div>
            <div id="strength-text" style="font-size: 0.7rem; color: rgba(255,255,255,0.6);"></div>
          </div>

          <!-- Status message -->
          <div id="password-status" class="status-message" style="display: none; margin-top: 12px;"></div>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px;">
        <button type="button" class="btn btn-outline" data-close-modal style="min-width: 80px;">Cancel</button>
        <button type="button" id="btn-change-password" class="btn btn-primary" style="min-width: 140px;">
          <i class="fas fa-key"></i><span>Change Password</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div class="modal-overlay" id="modal-error">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-error-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-error-title"><i class="fas fa-exclamation-triangle"></i> Validation Error</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 24px;">
        
        <!-- Error icon and message -->
        <div style="margin-bottom: 24px;">
          <div style="
            width: 64px; 
            height: 64px; 
            margin: 0 auto 16px auto; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: linear-gradient(135deg, var(--color-warning), #ff6b35);
            box-shadow: 0 6px 20px rgba(255,107,53,0.3);
          ">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600;">Invalid Input</h3>
          <p id="modal-error-message" style="margin: 0; font-size: 0.9rem; color: rgba(255,255,255,0.8); line-height: 1.4;">
            <!-- Error message will be set by JavaScript -->
          </p>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: center; padding: 16px 24px;">
        <button type="button" class="btn btn-primary" data-close-modal style="min-width: 80px;">
          <i class="fas fa-check"></i><span>OK</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 2FA Enable Modal (theme-demo structure) -->
  <div class="modal-overlay" id="modal-2fa">
    <div class="modal modal-md" role="dialog" aria-modal="true" aria-labelledby="modal-2fa-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-2fa-title"><i class="fas fa-shield-alt"></i> Enable Two-Factor Authentication</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 24px;">
        
        <!-- Compact security icon and intro -->
        <div style="margin-bottom: 24px;">
          <div style="
            width: 60px; 
            height: 60px; 
            margin: 0 auto 16px auto; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: linear-gradient(135deg, var(--color-success), var(--color-primary));
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
          ">
            <i class="fas fa-shield-alt" style="font-size: 24px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600;">Secure Your Account</h3>
          <p style="margin: 0; font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.4;">
            Add an extra layer of security with 2FA
          </p>
        </div>

        <!-- Compact steps in horizontal layout -->
        <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.06);">
          
          <!-- Two-column layout for steps -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
            
            <!-- Step 1: QR Code -->
            <div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; justify-content: center;">
                <div style="
                  width: 24px; 
                  height: 24px; 
                  border-radius: 50%; 
                  background: var(--color-primary); 
                  display: flex; 
                  align-items: center; 
                  justify-content: center;
                  font-size: 0.75rem;
                  font-weight: 700;
                  color: white;
                ">1</div>
                <span style="font-weight: 600; font-size: 0.9rem;">Scan QR Code</span>
              </div>
              
              <div id="qr-code-container" style="
                background: white; 
                border-radius: 8px; 
                padding: 12px; 
                margin: 0 auto 8px auto; 
                display: inline-block;
                box-shadow: 0 3px 8px rgba(0,0,0,0.15);
              ">
                <div class="subtle" style="color: #666; font-size: 0.85rem;">Loading QR...</div>
              </div>
              
              <p style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin: 0; line-height: 1.3;">
                Use any TOTP app
              </p>
            </div>

            <!-- Step 2: Verification -->
            <div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; justify-content: center;">
                <div style="
                  width: 24px; 
                  height: 24px; 
                  border-radius: 50%; 
                  background: var(--color-accent); 
                  display: flex; 
                  align-items: center; 
                  justify-content: center;
                  font-size: 0.75rem;
                  font-weight: 700;
                  color: white;
                ">2</div>
                <span style="font-weight: 600; font-size: 0.9rem;">Enter Code</span>
              </div>
              
              <div style="margin-top: 8px;">
                <input 
                  id="input-2fa-token" 
                  inputmode="numeric" 
                  autocomplete="one-time-code" 
                  placeholder="000 000" 
                  maxlength="7"
                  style="
                    width: 140px;
                    font-size: 1rem;
                    font-weight: 600;
                    text-align: center;
                    letter-spacing: 0.4em;
                    padding: 10px 12px;
                    border-radius: 6px;
                    border: 2px solid rgba(255,255,255,0.1);
                    background: rgba(255,255,255,0.05);
                    color: white;
                  " 
                />
              </div>
              
              <p style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin: 8px 0 0 0; line-height: 1.3;">
                6-digit verification code
              </p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px;">
        <button type="button" class="btn btn-outline" data-close-modal style="min-width: 80px;">Cancel</button>
        <button type="button" id="btn-2fa-verify" class="btn btn-success" style="min-width: 140px;">
          <i class="fas fa-check-circle"></i><span>Verify & Enable</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 2FA Disable Modal (theme-demo structure) -->
  <div class="modal-overlay" id="modal-2fa-disable">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-2fa-disable-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-2fa-disable-title"><i class="fas fa-shield-alt"></i> Disable Two-Factor Authentication</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 20px;">
        
        <!-- Compact warning icon and message -->
        <div style="margin-bottom: 20px;">
          <div style="
            width: 60px; 
            height: 60px; 
            margin: 0 auto 12px auto; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: linear-gradient(135deg, var(--color-warning), var(--color-error));
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
          ">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600;">Disable Two-Factor Auth</h3>
          <p style="margin: 0; font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.4;">
            This will reduce your account security
          </p>
        </div>

        <!-- Compact password input section -->
        <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.06);">
          <div style="margin-bottom: 12px; text-align: left;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-key" style="color: var(--color-warning); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.85rem;">Confirm with password</span>
            </div>
            <input 
              type="password" 
              id="input-2fa-disable-password" 
              autocomplete="current-password" 
              placeholder="Current password"
              style="
                width: 100%;
                padding: 10px 12px;
                border-radius: 6px;
                border: 2px solid rgba(255,255,255,0.1);
                background: rgba(255,255,255,0.05);
                color: white;
                font-size: 0.95rem;
              "
            />
          </div>
          
          <!-- Compact security warning -->
          <div style="
            background: rgba(var(--color-warning-rgb, 251, 191, 36), 0.1); 
            border: 1px solid rgba(var(--color-warning-rgb, 251, 191, 36), 0.2);
            border-radius: 6px; 
            padding: 8px; 
            text-align: left;
          ">
            <div style="display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-info-circle" style="color: var(--color-warning); font-size: 0.75rem; flex-shrink: 0;"></i>
              <div style="font-size: 0.75rem; color: var(--color-warning); line-height: 1.3;">
                Your account will only be protected by password
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 20px;">
        <button type="button" class="btn btn-outline" data-close-modal style="min-width: 80px;">Cancel</button>
        <button type="button" id="btn-2fa-disable-confirm" class="btn btn-error" style="min-width: 120px;">
          <i class="fas fa-shield-alt"></i><span>Disable 2FA</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Device Merge Modal (from theme-demo) -->
  <div class="modal-overlay" id="modal-merge">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-merge-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-merge-title">
          <i class="fas fa-object-group"></i>
          Merge Devices
        </div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p>Select the source and target devices to merge histories and preferences. This cannot be undone.</p>
        <div class="form-grid" style="margin-top: var(--space-lg);">
          <div class="form-group">
            <label>Source Device</label>
            <div class="select-wrap has-caret">
              <select id="merge-source"></select>
              <span class="select-caret" aria-hidden="true">▾</span>
            </div>
          </div>
          <div class="form-group">
            <label>Target Device</label>
            <div class="select-wrap has-caret">
              <select id="merge-target"></select>
              <span class="select-caret" aria-hidden="true">▾</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close-modal>Cancel</button>
        <button class="btn btn-error" id="btn-merge-confirm">Merge</button>
      </div>
    </div>
  </div>

  <!-- Bulk Selection Bar (from theme-demo) -->
  <div class="bulk-bar" id="bulk-bar" aria-live="polite">
    <div class="bulk-inner">
      <div class="bulk-count"><strong id="bulk-count">0</strong> selected</div>
  <div class="bulk-actions">
        <button class="btn btn-warning btn-sm" id="bulk-poweroff" title="Power toggle"><i class="fas fa-power-off"></i></button>
        <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-reload" title="Reload devices"><i class="fas fa-rotate-right"></i></button>
        <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-clearcache" title="Clear caches"><i class="fas fa-broom"></i></button>
        <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-pair" title="Generate pairing code"><i class="fas fa-qrcode"></i></button>
        <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-override" title="Edit display settings override"><i class="fas fa-sliders"></i></button>
        <button class="btn btn-secondary btn-sm bulk-secondary" id="bulk-sendcmd" title="Send command"><i class="fas fa-terminal"></i></button>
  <button class="btn btn-secondary btn-sm" id="bulk-playpause" title="Play/Pause"><i class="fas fa-play"></i></button>
        <button class="btn btn-error btn-sm" id="bulk-delete" title="Delete selected"><i class="fas fa-trash"></i></button>
        <button class="btn btn-outline btn-sm" id="bulk-clear" title="Clear selection"><i class="fas fa-xmark"></i></button>
        <div class="dropdown">
          <button class="btn btn-icon btn-sm" id="bulk-more" title="More"><i class="fas fa-ellipsis"></i></button>
          <div class="dropdown-menu" id="bulk-more-menu"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Remote Control Modal -->
  
  <div class="modal-overlay" id="modal-remote">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="remote-title">
      <div class="modal-header">
        <div class="modal-title" id="remote-title"><i class="fas fa-gamepad"></i> Remote Control <span id="remote-target-name" style="opacity:.75"></span></div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <!-- Remote panel: only implemented controls (D‑pad + Select + Back/Home + Play/Pause) -->
        <div class="remote-panel">
          <div class="remote-nav">
            <div></div>
            <button class="btn" data-remote="up" title="Up" aria-label="Up"><i class="fas fa-arrow-up"></i></button>
            <div></div>
            <button class="btn" data-remote="left" title="Left" aria-label="Left"><i class="fas fa-arrow-left"></i></button>
            <button class="btn" data-remote="select" title="Select" aria-label="Select"><i class="fas fa-dot-circle"></i></button>
            <button class="btn" data-remote="right" title="Right" aria-label="Right"><i class="fas fa-arrow-right"></i></button>
            <div></div>
            <button class="btn" data-remote="down" title="Down" aria-label="Down"><i class="fas fa-arrow-down"></i></button>
            <div></div>
          </div>
          <div class="remote-actions">
            <button class="btn" data-remote="back" title="Back" aria-label="Back"><i class="fas fa-arrow-rotate-left"></i></button>
            <button class="btn" data-remote="playpause" title="Play/Pause" aria-label="Play or Pause"><i class="fas fa-play"></i></button>
            <button class="btn" data-remote="home" title="Home" aria-label="Home"><i class="fas fa-house"></i></button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close-modal>Close</button>
      </div>
    </div>
  </div>

  <!-- Display Settings Override Modal -->
  <div class="modal-overlay" id="modal-override">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="override-title">
      <div class="modal-header">
        <div class="modal-title" id="override-title"><i class="fas fa-sliders"></i> Display Settings Override</div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p>Provide a JSON object to override display settings for the selected device(s).</p>
        <textarea id="override-json" rows="10" style="width:100%;" placeholder="{\n  \"wallart\": { \"duration\": 30 }\n}"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close-modal>Cancel</button>
        <button class="btn btn-primary" id="btn-override-apply"><i class="fas fa-check"></i> Apply</button>
      </div>
    </div>
  </div>

  <!-- Send Command Modal -->
  <div class="modal-overlay" id="modal-sendcmd">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sendcmd-title" style="width:min(96vw, 560px)">
      <div class="modal-header">
        <div class="modal-title" id="sendcmd-title"><i class="fas fa-terminal"></i> Send Command</div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="padding:14px 16px;">
        
        <div class="form-group">
          <label for="sendcmd-select">Command</label>
          <div class="select-wrap has-caret" style="width:100%">
          <select id="sendcmd-select" style="width:100%">
            <option value="" selected>— Choose a command —</option>
            <optgroup label="Playback">
              <option value="playback.prev">playback.prev</option>
              <option value="playback.next">playback.next</option>
              <option value="playback.pause">playback.pause</option>
              <option value="playback.resume">playback.resume</option>
              <option value="playback.toggle">playback.toggle</option>
              <option value="playback.pinPoster">playback.pinPoster</option>
            </optgroup>
            <optgroup label="Remote">
              <option value="remote.key">remote.key</option>
            </optgroup>
            <optgroup label="Power">
              <option value="power.on">power.on</option>
              <option value="power.off">power.off</option>
              <option value="power.toggle">power.toggle</option>
            </optgroup>
            <optgroup label="Source">
              <option value="source.switch">source.switch (plex|jellyfin|tmdb|all)</option>
            </optgroup>
            <optgroup label="Management">
              <option value="core.mgmt.reload">core.mgmt.reload</option>
              <option value="core.mgmt.reset">core.mgmt.reset</option>
              <option value="core.mgmt.clearCache">core.mgmt.clearCache</option>
              <option value="core.mgmt.swUnregister">core.mgmt.swUnregister</option>
            </optgroup>
            <option value="__custom">Custom…</option>
          </select>
          <span class="select-caret" aria-hidden="true">▾</span>
          </div>
        </div>
        <div class="form-group" id="sendcmd-param-source" style="margin-top:10px; display:none;">
          <label for="sendcmd-source">Source key</label>
          <div class="select-wrap has-caret">
          <select id="sendcmd-source">
            <option value="plex" selected>plex</option>
            <option value="jellyfin">jellyfin</option>
            <option value="tmdb">tmdb</option>
            <option value="all">all</option>
          </select>
          <span class="select-caret" aria-hidden="true">▾</span>
          </div>
        </div>
        <div class="form-group" style="margin-top:10px;">
          <label for="sendcmd-type">Type</label>
          <input id="sendcmd-type" type="text" placeholder="e.g. playback.toggle" />
        </div>
        <div class="form-group" style="margin-top:10px;">
          <label for="sendcmd-payload">Payload (JSON, optional)</label>
          <textarea id="sendcmd-payload" rows="6" style="width:100%;" placeholder="{ }"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close-modal>Cancel</button>
        <button class="btn btn-primary" id="btn-sendcmd-apply"><i class="fas fa-paper-plane"></i> Send</button>
      </div>
    </div>
  </div>

  <!-- Pairing Codes Modal -->
  <div class="modal-overlay" id="modal-pairing">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pairing-title">
      <div class="modal-header">
        <div class="modal-title" id="pairing-title"><i class="fas fa-qrcode"></i> Pairing Codes</div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
  <div class="modal-body" style="display:grid; gap:12px;">
        <div id="pairing-namebar" class="pairing-namebar" hidden>
          <i class="fas fa-desktop" aria-hidden="true"></i>
          <span id="pairing-namebar-text">—</span>
        </div>
        <div id="pairing-list" style="display:grid; gap:12px;"></div>
        <!-- dynamically filled: per device code + QR image -->
      </div>
      <div class="modal-footer pairing-footer">
        <div class="pairing-exp subtle" id="pairing-exp-footer"></div>
  <button class="btn btn-outline" data-close-modal>Close</button>
      </div>
    </div>
  </div>

  <!-- Create Device Modal -->
  <div class="modal-overlay" id="modal-create-device">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="create-device-title">
      <div class="modal-header">
        <div class="modal-title" id="create-device-title"><i class="fas fa-plus"></i> New Device</div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label for="create-device-name">Name</label>
            <input id="create-device-name" type="text" placeholder="Optional" />
          </div>
          <div class="form-group">
            <label for="create-device-location-select">Location</label>
            <div class="select-wrap has-caret">
              <select id="create-device-location-select"></select>
              <span class="select-caret" aria-hidden="true">▾</span>
            </div>
            <input id="create-device-location-new" type="text" placeholder="New location" style="display:none; margin-top:8px;" />
          </div>
          <div class="form-group">
            <label for="create-device-groups">Groups</label>
            <select id="create-device-groups" multiple size="4" style="min-height: 110px;"></select>
            <div class="hint" style="margin-top:6px; color: var(--color-text-muted); font-size:.85rem;">Optional. Select one or more groups.</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close-modal>Cancel</button>
        <button class="btn btn-primary" id="btn-create-device-confirm"><i class="fas fa-check"></i> Create &amp; Show Pairing code</button>
      </div>
    </div>
  </div>

  <!-- Group Assign Modal -->
  <div class="modal-overlay" id="modal-group-assign">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-group-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-group-title">
          <i class="fas fa-layer-group"></i>
          Assign to Group
        </div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p>Select a group to assign or remove for the selected devices.</p>
        <div class="form-group" style="margin-top: var(--space-md);">
          <label for="group-select">Group</label>
          <div class="select-wrap has-caret">
            <select id="group-select"></select>
            <span class="select-caret" aria-hidden="true">▾</span>
          </div>
        </div>
        <div class="form-group" style="margin-top: var(--space-md);">
          <label for="new-group-name">Or create a new group</label>
          <div style="display:flex; gap:.5rem; align-items:center;">
            <input id="new-group-name" type="text" placeholder="New group name" />
            <button class="btn btn-outline" id="btn-group-create-assign"><i class="fas fa-plus"></i> Create & assign</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close-modal>Cancel</button>
        <button class="btn btn-secondary" id="btn-group-remove">Remove from group</button>
        <button class="btn btn-primary" id="btn-group-assign">Assign to group</button>
      </div>
    </div>
  </div>

  <!-- Assign Preset Modal -->
  <div class="modal-overlay" id="modal-assign-preset">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-preset-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-preset-title">
          <i class="fas fa-star"></i>
          Presets
        </div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
  <p>Choose a preset to apply to the selected devices, or clear the current preset.</p>
        <div class="form-group" style="margin-top: var(--space-md);">
          <label for="preset-select">Preset</label>
          <div class="select-wrap has-caret">
            <select id="preset-select"></select>
            <span class="select-caret" aria-hidden="true">▾</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
  <button class="btn btn-outline" data-close-modal>Cancel</button>
  <button class="btn btn-secondary" id="btn-preset-clear">Clear preset</button>
  <button class="btn btn-primary" id="btn-preset-apply">Apply preset</button>
      </div>
    </div>
  </div>

  <!-- Assign Location Modal -->
  <div class="modal-overlay" id="modal-assign-location">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-location-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-location-title">
          <i class="fas fa-location-dot"></i>
          Assign Location
        </div>
        <button class="modal-close" data-close-modal><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p>Set or clear the location for the selected devices.</p>
        <div class="form-group" style="margin-top: var(--space-md);">
          <label for="location-input">Location</label>
          <input id="location-input" type="text" list="location-list" placeholder="e.g. Living Room" />
          <datalist id="location-list"></datalist>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close-modal>Cancel</button>
        <button class="btn btn-secondary" id="btn-location-clear">Clear location</button>
        <button class="btn btn-primary" id="btn-location-apply">Assign location</button>
      </div>
    </div>
  </div>

  <!-- Revoke API Key Confirmation Modal (theme-demo structure) -->
  <div class="modal-overlay" id="modal-revoke-api-key">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-revoke-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-revoke-title"><i class="fas fa-trash-alt"></i> Revoke API Key</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to revoke the current API key? Any client using it will stop working immediately.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
        <button type="button" id="btn-revoke-api-key-confirm" class="btn btn-error"><i class="fas fa-trash-alt"></i><span>Revoke Key</span></button>
      </div>
    </div>
  </div>

  <!-- Update Confirmation Modal (theme-demo structure) -->
  <div class="modal-overlay" id="modal-update">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-update-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-update-title"><i class="fas fa-download"></i> Confirm Auto-Update</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="modal-update-content">
        <div class="subtle">Loading update information…</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
        <button type="button" id="btn-update-force" class="btn btn-warning" style="display:none;"><i class="fas fa-hammer"></i><span>Force Update</span></button>
        <button type="button" id="btn-update-confirm" class="btn btn-primary" disabled><i class="fas fa-check"></i><span>Start Update</span></button>
      </div>
    </div>
  </div>

  <!-- Delete Devices Confirmation Modal (theme-demo structure) -->
  <div class="modal-overlay" id="modal-delete-devices">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-delete-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-delete-title"><i class="fas fa-trash"></i> Delete devices</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="modal-delete-content" style="padding: 20px;">
        <!-- Filled dynamically with selection summary -->
      </div>
      <div class="modal-footer" style="display:flex; gap:12px; justify-content:flex-end; padding: 16px 20px;">
        <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
        <button type="button" class="btn btn-error" id="btn-confirm-delete-devices"><i class="fas fa-trash"></i><span> Delete</span></button>
      </div>
    </div>
  </div>

  <!-- Cache Size Edit Modal -->
  <div class="modal-overlay" id="modal-cache-size">
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-cache-size-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-cache-size-title"><i class="fas fa-database"></i> Edit Cache Size</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 24px;">
        
        <!-- Cache icon and intro -->
        <div style="margin-bottom: 24px;">
          <div style="
            width: 64px; 
            height: 64px; 
            margin: 0 auto 16px auto; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: linear-gradient(135deg, var(--color-warning), var(--color-warning-dark));
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
          ">
            <i class="fas fa-database" style="font-size: 24px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600;">Configure Cache Storage</h3>
          <p style="margin: 0; font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.4;">
            Set the maximum disk space for cached poster images
          </p>
        </div>

        <!-- Cache size form section -->
        <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.06);">
          
          <!-- Cache size input -->
          <div style="margin-bottom: 16px; text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-hdd" style="color: var(--color-warning); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.85rem;">Maximum Cache Size</span>
            </div>
            <div style="display: flex; gap: 6px; align-items: center; justify-content: center;">
              <input 
                id="input-cache-size-gb" 
                type="number" 
                inputmode="decimal" 
                step="0.1" 
                min="0.1" 
                placeholder="2.0"
                style="
                  flex: 0 0 auto;
                  text-align: center;
                "
              />
              <div style="
                padding: 12px 16px;
                background: rgba(var(--color-warning-rgb), 0.15);
                border: 2px solid rgba(var(--color-warning-rgb), 0.3);
                border-radius: 8px;
                color: var(--color-warning);
                font-weight: 600;
                font-size: 0.9rem;
              ">
                GB
              </div>
            </div>
          </div>

          <!-- Storage info -->
          <div style="
            background: rgba(var(--color-info-rgb), 0.1); 
            border: 1px solid rgba(var(--color-info-rgb), 0.2); 
            border-radius: 8px; 
            padding: 12px 16px;
            text-align: center;
            margin-top: 16px;
          ">
            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 4px;">
              <i class="fas fa-info-circle" style="color: var(--color-info); font-size: 0.8rem;"></i>
              <span style="font-weight: 600; font-size: 0.8rem; color: var(--color-info);">Recommended Range</span>
            </div>
            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">
              1.0 - 5.0 GB • Must be greater than 0.1 GB
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer" style="padding: 20px 24px; border-top: 1px solid rgba(255,255,255,0.1);">
        <button type="button" class="btn btn-outline" data-close-modal style="margin-right: 12px;">
          <i class="fas fa-times"></i>
          <span>Cancel</span>
        </button>
        <button type="button" id="btn-cache-size-save" class="btn" style="
          background: linear-gradient(135deg, var(--color-warning), var(--color-warning-dark));
          border: none;
          color: white;
          font-weight: 600;
          box-shadow: 0 4px 12px rgba(var(--color-warning-rgb), 0.3);
          transition: all 0.2s ease;
        ">
          <i class="fas fa-save"></i>
          <span>Save Changes</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Profile Photo Modal -->
  <div class="modal-overlay" id="modal-avatar" hidden>
    <div class="modal modal-lg" role="dialog" aria-modal="true" aria-labelledby="modal-avatar-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-avatar-title"><i class="fas fa-image"></i> Profile Photo</div>
        <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="padding: 20px; text-align: center;">
        
        <!-- Image cropping interface (initially hidden, shown when file selected) -->
        <div id="crop-interface" style="display: none; margin-bottom: 24px; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.08);">
          <div style="margin-bottom: 16px; text-align: center;">
            <h4 style="color: var(--color-primary); font-size: 1.1rem; margin: 0 0 8px 0; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <i class="fas fa-crop"></i>
              Crop Your Image
            </h4>
            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin: 0;">
              Drag to reposition, use mouse wheel to zoom, or resize the selection area.
            </p>
          </div>
          
          <!-- Crop canvas container -->
          <div id="crop-container" style="position: relative; margin-bottom: 16px; border-radius: 8px; overflow: hidden; background: #000; display: flex; justify-content: center; align-items: center; min-height: 300px; max-height: 400px;">
            <canvas id="crop-canvas" style="cursor: grab; display: block;"></canvas>
            
            <!-- Crop overlay with selection box -->
            <div id="crop-overlay" style="position: absolute; pointer-events: none;">
              <div id="crop-selection" style="
                position: absolute;
                border: 2px solid var(--color-primary);
                background: rgba(var(--color-primary-rgb), 0.1);
                cursor: move;
                pointer-events: all;
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
              ">
                <!-- Resize handles -->
                <div class="crop-handle" data-handle="nw" style="position: absolute; top: -4px; left: -4px; width: 8px; height: 8px; background: var(--color-primary); cursor: nw-resize;"></div>
                <div class="crop-handle" data-handle="ne" style="position: absolute; top: -4px; right: -4px; width: 8px; height: 8px; background: var(--color-primary); cursor: ne-resize;"></div>
                <div class="crop-handle" data-handle="sw" style="position: absolute; bottom: -4px; left: -4px; width: 8px; height: 8px; background: var(--color-primary); cursor: sw-resize;"></div>
                <div class="crop-handle" data-handle="se" style="position: absolute; bottom: -4px; right: -4px; width: 8px; height: 8px; background: var(--color-primary); cursor: se-resize;"></div>
              </div>
            </div>
          </div>
          
          <!-- Crop controls -->
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <label style="font-size: 0.85rem; color: rgba(255,255,255,0.8); display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-search-plus" style="font-size: 0.8rem;"></i>
                Zoom:
              </label>
              <input type="range" id="crop-zoom" min="0.5" max="3" step="0.1" value="1" style="width: 100px;">
              <span id="crop-zoom-value" style="font-size: 0.8rem; color: rgba(255,255,255,0.6); min-width: 30px;">100%</span>
            </div>
            
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn btn-outline btn-sm" id="crop-reset" title="Reset crop area">
                <i class="fas fa-undo"></i>
              </button>
            </div>
          </div>
          
          <!-- Cropped preview -->
          <div style="margin-top: 16px; text-align: center;">
            <div style="margin-bottom: 8px;">
              <span style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">Preview:</span>
            </div>
            <div style="display: inline-block; width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 2px solid rgba(255,255,255,0.2); background: #000;">
              <canvas id="crop-preview" width="80" height="80" style="width: 100%; height: 100%;"></canvas>
            </div>
          </div>
        </div>

        <!-- Large centered avatar preview -->
        <div style="margin-bottom: 24px; text-align: center;">
          <div class="avatar-preview" id="avatar-preview" aria-live="polite" style="
            width: 120px; 
            height: 120px; 
            margin: 0 auto 16px auto; 
            border-radius: 50%; 
            overflow: hidden; 
            border: 4px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            position: relative;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
          ">
            <div class="avatar-initials" id="avatar-initials-fallback" style="
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              font-size: 36px;
              font-weight: 700;
              color: white;
              text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            ">AD</div>
            <img id="avatar-image-preview" alt="Current profile photo" style="
              width: 100%;
              height: 100%;
              object-fit: cover;
              position: absolute;
              top: 0;
              left: 0;
            " />
          </div>
        </div>

        <!-- Upload section with modern design -->
        <div style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 24px; border: 1px solid rgba(255,255,255,0.06);">
          <div style="margin-bottom: 20px;">
            <div class="file-upload-area" style="
              border: 2px dashed rgba(255,255,255,0.2);
              border-radius: 12px;
              padding: 32px 16px;
              cursor: pointer;
              transition: all 0.2s ease;
              position: relative;
              background: rgba(255,255,255,0.01);
            " id="upload-drop-zone">
              <div style="margin-bottom: 16px;">
                <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--color-primary); opacity: 0.8;"></i>
              </div>
              <button type="button" class="btn btn-primary btn-sm" id="avatar-file-trigger" style="margin-bottom: 12px;">
                <i class="fas fa-file-upload"></i><span>Choose Image</span>
              </button>
              <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 8px;">
                or drag and drop your image here
              </div>
              <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                PNG, JPG, or WebP — up to 2 MB
              </div>
              <input type="file" id="avatar-file" accept="image/png,image/jpeg,image/webp" style="position:absolute;left:-9999px;opacity:0;pointer-events:none;" />
            </div>
            
            <!-- Selected file display -->
            <div id="selected-file-display" style="display: none; margin-top: 16px; padding: 12px; background: rgba(var(--color-success-rgb, 16, 185, 129), 0.1); border-radius: 8px; border: 1px solid rgba(var(--color-success-rgb, 16, 185, 129), 0.2);">
              <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-check-circle" style="color: var(--color-success);"></i>
                <span id="avatar-file-name" style="font-size: 0.9rem; color: var(--color-success);">No file selected</span>
              </div>
            </div>

          </div>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-top: 1px solid rgba(255,255,255,0.1);">
        <!-- Left side: Cancel -->
        <div>
          <button type="button" class="btn btn-outline" data-close-modal style="min-width: 80px;">Cancel</button>
        </div>
        
        <!-- Right side: Action buttons -->
        <div style="display: flex; gap: 12px;">
          <button type="button" class="btn btn-error" id="avatar-remove-btn" style="min-width: 90px;">
            <i class="fas fa-trash"></i><span>Remove</span>
          </button>
          <button type="button" class="btn btn-secondary" id="avatar-crop-btn" style="min-width: 90px; display: none;">
            <i class="fas fa-crop"></i><span>Crop</span>
          </button>
          <button type="button" class="btn btn-primary" id="avatar-upload-btn" style="min-width: 90px;">
            <i class="fas fa-upload"></i><span>Upload</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="/notify.js?v=20250906-1"></script>
  
  <!-- Notification Center (themed, matches theme-demo Device Management example) -->
  <div class="notify-center" id="notify-center" aria-live="polite" aria-label="Notifications panel">
    <div class="notify-header">
      <strong>Notifications</strong>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn btn-outline btn-sm" id="notify-mark-all" title="Mark all as read">
          <i class="fas fa-check-double"></i>
          Mark all
        </button>
        <button class="btn btn-icon btn-sm" id="notify-close" title="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="notify-subheader">
      <div class="notify-filter" id="notify-min-level-icons" role="radiogroup" aria-label="Minimum level">
        <button class="nf-btn" data-level="info" role="radio" aria-checked="false" title="Info" aria-label="Info">
          <span class="ring"><i class="fas fa-circle-info" aria-hidden="true"></i></span>
        </button>
        <button class="nf-btn" data-level="warn" role="radio" aria-checked="false" title="Warn" aria-label="Warn">
          <span class="ring"><i class="fas fa-triangle-exclamation" aria-hidden="true"></i></span>
        </button>
        <button class="nf-btn" data-level="error" role="radio" aria-checked="true" title="Error" aria-label="Error">
          <span class="ring"><i class="fas fa-circle-exclamation" aria-hidden="true"></i></span>
        </button>
      </div>
      <!-- SR-only fallback select for accessibility and legacy binding -->
      <label for="notify-min-level" class="sr-only">Minimum level</label>
      <select id="notify-min-level" class="sr-only" tabindex="-1" aria-hidden="true">
        <option value="info">Info</option>
        <option value="warn">Warn</option>
        <option value="error" selected>Error</option>
      </select>
    </div>
    <div class="notify-list" id="notify-list"></div>
  </div>
    <!-- Generic Confirm Modal -->
    <div class="modal-overlay" id="modal-confirm" hidden>
      <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="modal-confirm-title">
        <div class="modal-header">
          <div class="modal-title" id="modal-confirm-title"><i class="fas fa-question-circle"></i> Confirm</div>
          <button class="modal-close" data-close-modal aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="modal-confirm-body" style="padding: 16px 20px;">
          Are you sure?
        </div>
        <div class="modal-footer" style="display:flex; gap:10px; justify-content:flex-end; padding: 14px 20px;">
          <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
          <button type="button" class="btn btn-primary" id="modal-confirm-ok"><i class="fas fa-check"></i><span>Confirm</span></button>
        </div>
      </div>
    </div>
  <script src="/admin.js?v={{ASSET_VERSION}}"></script>
  <link rel="stylesheet" href="/cinema/cinema.css?v={{ASSET_VERSION}}" />
  <script src="/cinema/cinema-ui.js?v={{ASSET_VERSION}}"></script>
  <!-- PWA Service Worker Registration (admin2) -->
  <script>
    // Register SW without forcing immediate reloads. We'll prompt the user instead.
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/sw.js')
          .then(reg => {
            // Disable SW update toasts in Admin: end-users don't receive admin-only updates.
            // Keep registration for caching/offline benefits, but don't surface update messages.
            const swToast = () => {};
            // If there's already a waiting worker, do NOT force-activate.
            // We'll surface an unobtrusive update hint and let the user refresh.
            // Intentionally no notification when a waiting worker exists

            // When a new SW is found, wait until it installs, then hint the user.
            reg.addEventListener('updatefound', () => {
              const sw = reg.installing;
              if (!sw) return;
              sw.addEventListener('statechange', () => {
                // Intentionally suppress 'Update installed' notifications
              });
            });

            // Avoid auto-refresh on controller changes; only refresh if explicitly requested elsewhere.
            navigator.serviceWorker.addEventListener('controllerchange', () => {
              // Intentionally no automatic reload here to prevent disruptive bounces.
              // Advanced: if a future flow sets window.__swAllowReload = true, we can honor it.
              if (window.__swAllowReload) {
                try { window.location.reload(); } catch (_) { /* ignore */ }
              }
            });
          })
          .catch(() => { /* silent */ });
      });
    }
  </script>
</body>
</html>

