<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
        <title>Posterrama Cinema</title>

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Kalam:wght@400;700&display=swap"
            rel="stylesheet"
        />

        <!-- Cinema styles (ONLY) -->
        <link rel="stylesheet" href="cinema/cinema-display.css?v=20251012c" />

        <!-- Client-side Logger -->
        <script src="/client-logger.js"></script>
    </head>
    <body data-mode="cinema">
        <script>
            // Early guard: if cinema mode is not enabled anymore, immediately go back to root
            // Skip this check in preview mode (iframe or ?preview=1)
            (async function () {
                try {
                    // Check if in preview mode
                    const params = new URLSearchParams(window.location.search);
                    const isPreview = params.get('preview') === '1' || window.self !== window.top;
                    if (isPreview) return; // Skip guard in preview mode
                    
                    const resp = await fetch('/get-config?_t=' + Date.now(), { cache: 'no-cache' });
                    if (!resp.ok) return; // fail open
                    const cfg = await resp.json();
                    if (!cfg || cfg.cinemaMode !== true) {
                        // Use absolute origin to avoid proxy/base tag quirks
                        window.location.replace(window.location.origin + '/');
                    }
                } catch (e) {
                    // silent; normal runtime will handle later
                }
            })();
        </script>
        <!-- Loader -->
        <div id="loader">
            <div class="poster-loader"></div>
        </div>

        <!-- Error message -->
        <div id="error-message" class="is-hidden"></div>

        <!-- Cinema poster and metadata container -->
        <div id="info-container">
            <div id="poster-wrapper">
                <div id="poster"></div>
            </div>
        </div>

        <!-- No on-screen controls in cinema mode -->

        <!-- Scripts -->
    <script src="device-mgmt.js?v=20250901a"></script>
    <script src="/core.js?v={{ASSET_VERSION}}"></script>
        <script>
            // Load promo overlay if enabled (typically port 4001 promo site)
            (async function() {
                try {
                    const cfg = await window.PosterramaCore.fetchConfig();
                    if (cfg && cfg.promoBoxEnabled === true) {
                        window.PosterramaCore.loadPromoOverlay(cfg);
                    }
                } catch (e) {
                    /* ignore */
                }
            })();
        </script>
        <script src="cinema/cinema-display.js?v=20251012c"></script>
        <script src="/cinema/cinema-bootstrap.js?v={{ASSET_VERSION}}"></script>
        <script>
            // Server-independent hint for mode-specific behaviors
            window.MODE_HINT = 'cinema';
        </script>
        <script>
            // Start device management initialization (non-blocking)
            // Device identity will be available from localStorage immediately if registered
            (async function() {
                try {
                    if (window.PosterramaDevice && window.PosterramaDevice.init) {
                        const cfg = await window.PosterramaCore.fetchConfig();
                        window.PosterramaDevice.init(cfg || {}); // Don't await - let it run in background
                    }
                } catch (e) {
                    console.warn('[Cinema] Device init failed:', e);
                }
            })();
        </script>
        <script>
            // Start auto-exit poll immediately (device ID from localStorage if available)
            try { window.PosterramaCore && window.PosterramaCore.startAutoExitPoll({ currentMode: 'cinema', intervalMs: 15000 }); } catch (e) {}
        </script>
    </body>
</html>
