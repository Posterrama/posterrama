<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
        <title>Posterrama Cinema</title>

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Kalam:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <!-- Preconnect to media server for faster poster loading -->
        <link rel="dns-prefetch" href="/image" />
        <link rel="preconnect" href="/image" crossorigin />

        <!-- Cinema styles (ONLY) -->
        <link rel="stylesheet" href="cinema/cinema-display.css?v=20251012c" />

        <!-- Client-side Logger -->
        <script src="/client-logger.js"></script>
        
        <!-- Global Error Handler -->
        <script type="module" src="/error-handler.js"></script>
    </head>
    <body data-mode="cinema">
        <script>
            // Early guard: if cinema mode is not enabled anymore, immediately go back to root
            // Skip this check in preview mode (iframe or ?preview=1)
            (async function () {
                try {
                    // Check if in preview mode
                    const params = new URLSearchParams(window.location.search);
                    const isPreview = params.get('preview') === '1' || window.self !== window.top;
                    if (isPreview) return; // Skip guard in preview mode
                    
                    const resp = await fetch('/get-config?_t=' + Date.now(), { cache: 'no-cache' });
                    if (!resp.ok) return; // fail open
                    const cfg = await resp.json();
                    if (!cfg || cfg.cinemaMode !== true) {
                        // Use absolute origin to avoid proxy/base tag quirks
                        window.location.replace(window.location.origin + '/');
                    }
                } catch (e) {
                    // silent; normal runtime will handle later
                }
            })();
        </script>
        <!-- Loader -->
        <div id="loader">
            <div class="poster-loader"></div>
        </div>

        <!-- Error message -->
        <div id="error-message" class="is-hidden"></div>

        <!-- Cinema poster and metadata container -->
        <div id="info-container">
            <div id="poster-wrapper">
                <div id="poster"></div>
            </div>
        </div>

        <!-- No on-screen controls in cinema mode -->

        <!-- Scripts -->
    <script defer src="device-mgmt.js?v=20250901a"></script>
    <script defer src="/core.js?v={{ASSET_VERSION}}"></script>
        <script defer src="cinema/cinema-display.js?v=20251012c"></script>
        <script defer src="/cinema/cinema-bootstrap.js?v={{ASSET_VERSION}}"></script>
        
        <!-- Mode initialization -->
        <script type="module">
            import { initDevice, startAutoExitPoll } from './display-mode-init.js';
            import { loadPromoOverlayIfEnabled } from './mode-redirect.js';
            
            // Set mode hint for mode-specific behaviors
            window.MODE_HINT = 'cinema';
            
            // Initialize device management (non-blocking)
            initDevice();
            
            // Start auto-exit polling
            startAutoExitPoll('cinema', 15000);
            
            // Load promo overlay if enabled
            await loadPromoOverlayIfEnabled();
        </script>
    </body>
</html>
