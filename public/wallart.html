<!doctype html>
<!-- posterrama.app | Author: Posterrama Team | License: GPL-3.0-or-later -->
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Posterrama - Self-Hosted Digital Movie Poster App & Cinema Display</title>
        <meta
            name="description"
            content="Transform your movie collection into stunning digital posters, elegant screensavers, and immersive cinema displays. Self-hosted, open-source, and perfect for home theaters and media rooms."
        />
        <meta
            name="keywords"
            content="movie poster app, digital movie posters, cinema display, screensaver, self-hosted media, home theater, plex companion, media collection, movie library, tv show posters, digital signage, media server, personal cinema, movie collection display, film poster screensaver, home cinema automation, media room display, raspberry pi media, kodi alternative, emby companion, jellyfin integration, movie artwork display, poster slideshow, cinema mode app, home theater software, media center display, digital photo frame movies, auto movie posters"
        />
        <meta name="author" content="Posterrama Team" />
        <meta name="robots" content="index, follow" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

        <!-- PWA Meta Tags -->
        <meta name="theme-color" content="#1a1a1a" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-title" content="Posterrama" />
        <meta name="mobile-web-app-capable" content="yes" />
        
        <!-- App Manifest -->
        <link rel="manifest" href="/manifest.json" />
        
        <!-- Favicons and Icons -->
        <link rel="icon" type="image/svg+xml" href="/icons/posterrama-icon.svg?v=3" />
        <link rel="icon" type="image/x-icon" href="/favicon.ico?v=3" />
        <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png?v=2" />
        <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png?v=2" />
        <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png" />
        <link rel="apple-touch-icon" sizes="128x128" href="/icons/icon-128x128.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png" />
        <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png" />
        <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://posterrama.app/" />
        <meta property="og:title" content="Posterrama - Self-Hosted Digital Movie Poster App" />
        <meta
            property="og:description"
            content="Transform your movie collection into stunning digital posters, elegant screensavers, and immersive cinema displays. Self-hosted and open-source."
        />
        <meta property="og:site_name" content="Posterrama" />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content="https://posterrama.app/" />
        <meta
            property="twitter:title"
            content="Posterrama - Self-Hosted Digital Movie Poster App"
        />
        <meta
            property="twitter:description"
            content="Transform your movie collection into stunning digital posters, elegant screensavers, and immersive cinema displays."
        />

        <!-- Canonical URL -->
        <link rel="canonical" href="https://posterrama.app/" />

        <!-- Preconnects for performance -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Kalam:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <!-- Preconnect to media server for faster poster loading -->
        <link rel="dns-prefetch" href="/image" />
        <link rel="preconnect" href="/image" crossorigin />

        <!-- Font Awesome for icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
            integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />

        <!-- Client-side Logger for controlled debugging -->
        <script src="/client-logger.js"></script>
        
        <!-- Persistent Debug Logger (survives reloads) -->
        <script src="/debug-logger.js"></script>

        <!-- Critical CSS inline for instant FCP (~1KB) -->
        <style>*{box-sizing:border-box}body,html{background:linear-gradient(135deg,#1a1a1a 0,#2a2a2a 100%)}*,body,html{margin:0;padding:0}body,html{width:100vw;height:100vh;overflow:hidden;font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;color:#e2e8f0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.is-hidden{display:none!important}#poster{width:100%;height:100%;background-size:cover;background-position:center;background-repeat:no-repeat;position:relative}#error-message{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(239,68,68,.95);color:#fff;padding:1rem 1.5rem;border-radius:8px;z-index:10000;max-width:90%;text-align:center}body.wallart-mode #branding-container,body.wallart-mode #promo-box{display:none!important}</style>

        <!-- Preload non-critical CSS (deferred) -->
        <link rel="preload" href="style.css?v=20250828a" as="style" onload="this.onload=null;this.rel='stylesheet'" />
        <link rel="preload" href="/wallart/wallart.css?v={{ASSET_VERSION}}" as="style" onload="this.onload=null;this.rel='stylesheet'" />
        
        <!-- Fallback for no-JS -->
        <noscript>
            <link rel="stylesheet" href="style.css?v=20250828a" />
            <link rel="stylesheet" href="/wallart/wallart.css?v={{ASSET_VERSION}}" />
        </noscript>

        
        <!-- Structured Data / JSON-LD -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "SoftwareApplication",
                "name": "Posterrama",
                "description": "Self-hosted digital movie poster app that transforms your screens into personal cinemas and elegant screensavers",
                "url": "https://posterrama.app",
                "downloadUrl": "https://github.com/Posterrama/posterrama",
                "operatingSystem": "Linux, Windows, macOS",
                "applicationCategory": "MultimediaApplication",
                "offers": {
                    "@type": "Offer",
                    "price": "0",
                    "priceCurrency": "USD"
                },
                "creator": {
                    "@type": "Organization",
                    "name": "Posterrama Team",
                    "url": "https://github.com/Posterrama"
                },
                "license": "https://www.gnu.org/licenses/gpl-3.0.html",
                "softwareVersion": "1.3.0",
                "requirements": "Docker, Node.js, Media Server (Plex)",
                "featureList": [
                    "Digital Movie Poster Display",
                    "Cinema Mode for Portrait Screens",
                    "Elegant Screensavers",
                    "Self-Hosted Media Management",
                    "Plex Integration",
                    "Multiple Display Support",
                    "Responsive Design"
                ]
            }
        </script>
        
        <!-- Global Error Handler -->
        <script type="module" src="/error-handler.js"></script>
    </head>
    <body data-mode="wallart" class="wallart-mode">
        <div id="loader">
            <div class="poster-loader"></div>
        </div>
        <div id="error-message" class="is-hidden"></div>

        <div id="layer-a" class="screensaver-layer"></div>
        <div id="layer-b" class="screensaver-layer"></div>

        <div id="clock-widget-container">
            <div id="time-widget">
                <span id="time-hours">00</span>
                <span id="time-separator">:</span>
                <span id="time-minutes">00</span>
            </div>
        </div>

        <div id="clearlogo-container">
            <img id="clearlogo" src="" alt="ClearLogo" />
        </div>

        <div id="info-container">
            <div id="poster-wrapper">
                <a id="poster-link" href="#" target="_blank" rel="noopener noreferrer">
                    <div id="poster-a" class="poster-layer"></div>
                    <div id="poster-b" class="poster-layer"></div>
                    <!-- Keep original poster for backward compatibility -->
                    <div id="poster"></div>
                </a>
            </div>
            <div id="text-wrapper">
                <h1 id="title"></h1>
                <p id="tagline"></p>
                <div id="meta-info">
                    <span id="year"></span>
                    <span id="rating"></span>
                </div>
            </div>
        </div>

        <div id="controls-container">
            <button id="prev-button" aria-label="Previous">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                </svg>
            </button>
            <button id="pause-button" aria-label="Pause/Resume">
                <svg
                    class="icon-pause"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                </svg>
                <svg
                    class="icon-play"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path d="M8 5v14l11-7z" />
                </svg>
            </button>
            <button id="next-button" aria-label="Next">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z" />
                </svg>
            </button>
        </div>

        <div id="branding-container">
            <a
                href="https://posterrama.app"
                target="_blank"
                rel="noopener noreferrer"
                title="posterrama.app"
            >
                <svg
                    role="img"
                    aria-label="posterrama.app Logo"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path d="M6 2H16L14 22H4L6 2Z" />
                    <path d="M10 2H20L18 22H8L10 2Z" style="mix-blend-mode: screen; opacity: 0.6" />
                </svg>
            </a>
        </div>

    <!-- Mode-based redirect: automatically redirect to mode-specific page -->
    <script type="module">
        import { checkModeRedirect, loadPromoOverlayIfEnabled, startPeriodicModeCheck } from './mode-redirect.js?v=1765570858';
        
        // Check if we should redirect to another mode
        await checkModeRedirect('wallart', '__wallartModeVerified');
        
        // Mode verified - set hint to prevent further checks
        window.MODE_HINT = 'wallart';
        
        // Start periodic mode checking (auto-navigate on config changes)
        startPeriodicModeCheck('wallart');
        
        // Load promo overlay if enabled
        await loadPromoOverlayIfEnabled();
    </script>

    <script defer src="lazy-loading.js?v=20250825a"></script>
    <script defer src="device-mgmt.js?v=20250825a"></script>
    <script defer src="/core.js?v={{ASSET_VERSION}}"></script>
    <script defer src="/wallart/artist-cards.js?v={{ASSET_VERSION}}"></script>
    <script defer src="/wallart/film-cards.js?v={{ASSET_VERSION}}"></script>
    <script defer src="/wallart/parallax-scrolling.js?v={{ASSET_VERSION}}"></script>
    <script defer src="/wallart/wallart-display.js?v={{ASSET_VERSION}}"></script>
    <script>
        (function () {
            // Minimal, page-local bootstrap to populate media and start wallart without legacy script.js
            // Force service worker update if available
            async function forceServiceWorkerUpdate() {
                try {
                    if ('serviceWorker' in navigator) {
                        const registration = await navigator.serviceWorker.getRegistration();
                        if (registration) {
                            await registration.update();
                            window.debugLog && window.debugLog('SW_UPDATE_REQUESTED', { scope: registration.scope });
                            
                            // If there's a new SW waiting, activate it immediately
                            if (registration.waiting) {
                                registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                                window.debugLog && window.debugLog('SW_SKIP_WAITING_SENT', {});
                            }
                        }
                    }
                } catch (e) {
                    window.debugLog && window.debugLog('SW_UPDATE_ERROR', { error: e.message });
                }
            }
            
            async function ensureConfig() {
                window.debugLog && window.debugLog('WALLART_ENSURE_CONFIG_START', {});
                try {
                    if (window.appConfig && window.wallartConfig) {
                        window.debugLog && window.debugLog('WALLART_CONFIG_ALREADY_EXISTS', {});
                        return true;
                    }
                    const useCore = !!(window.PosterramaCore && window.PosterramaCore.fetchConfig);
                    window.debugLog && window.debugLog('WALLART_FETCH_CONFIG', { useCore });
                    const cfg = useCore
                        ? await window.PosterramaCore.fetchConfig()
                        : await (await fetch('/get-config', { cache: 'no-cache', headers: { 'Cache-Control': 'no-cache' } })).json();
                    window.debugLog && window.debugLog('WALLART_CONFIG_FETCHED', { hasConfig: !!cfg });
                    try {
                        if (!Object.getOwnPropertyDescriptor(window, 'appConfig')) {
                            Object.defineProperty(window, 'appConfig', { value: cfg, writable: true });
                        } else {
                            window.appConfig = cfg;
                        }
                        const wcfg = (cfg && cfg.wallartMode) || {};
                        if (!Object.getOwnPropertyDescriptor(window, 'wallartConfig')) {
                            Object.defineProperty(window, 'wallartConfig', { value: wcfg, writable: true });
                        } else {
                            window.wallartConfig = wcfg;
                        }
                        // Also expose as __serverConfig for consistency with admin.js
                        window.__serverConfig = cfg;
                    } catch (e) {
                        window.debugLog && window.debugLog('WALLART_CONFIG_DEFINE_ERROR', { error: e.message });
                        window.appConfig = cfg;
                        window.wallartConfig = (cfg && cfg.wallartMode) || {};
                        window.__serverConfig = cfg;
                    }
                    window.debugLog && window.debugLog('WALLART_ENSURE_CONFIG_SUCCESS', {});
                    return true;
                } catch (e) {
                    window.debugLog && window.debugLog('WALLART_ENSURE_CONFIG_FAIL', { error: e.message });
                    return false;
                }
            }
            async function ensureMediaQueue(force = false) {
                window.debugLog && window.debugLog('WALLART_ENSURE_MEDIA_START', {});
                try {
                    if (!force && Array.isArray(window.mediaQueue) && window.mediaQueue.length > 0) {
                        window.debugLog && window.debugLog('WALLART_MEDIA_ALREADY_EXISTS', { count: window.mediaQueue.length });
                        return true;
                    }

                    if (force) {
                        try {
                            window.mediaQueue = [];
                        } catch (_) {
                            /* best-effort */
                        }
                    }
                    // Check if games-only mode is enabled
                    const gamesOnly = window.appConfig?.wallartMode?.gamesOnly === true;
                    
                    // Check if music mode is enabled
                    const musicMode = window.appConfig?.wallartMode?.musicMode?.enabled === true;

                    // Music display style (affects which endpoint we should use)
                    let musicDisplayStyle = window.appConfig?.wallartMode?.musicMode?.displayStyle;
                    // Backward-compat: normalize removed/invalid values
                    if (musicDisplayStyle === 'album-info' || musicDisplayStyle === 'grid') {
                        musicDisplayStyle = 'covers-only';
                    }
                    
                    // Build absolute URL for better Safari/iOS compatibility
                    const baseUrl = window.location.origin;
                    let url;
                    
                    // In admin preview mode, use an authenticated endpoint that can respect UNSAVED settings.
                    // This is required because /get-media musicMode is gated by saved server config.
                    const isPreview =
                        (window.PosterramaCore &&
                            typeof window.PosterramaCore.isPreviewMode === 'function' &&
                            window.PosterramaCore.isPreviewMode()) ||
                        window.IS_PREVIEW === true;

                    if (isPreview && (musicMode || gamesOnly || window.appConfig?.wallartMode?.layoutVariant === 'filmCards')) {
                        // Artist Cards needs per-artist discographies + artist photos.
                        // The public /get-music-artists endpoint already returns that shape and does not depend
                        // on saved wallartMode.musicMode.enabled, so it's safe for preview too.
                        if (musicMode && musicDisplayStyle === 'artist-cards') {
                            const artistCount = 50;
                            url = `${baseUrl}/get-music-artists?count=${artistCount}`;

                            const res = await fetch(url, {
                                method: 'GET',
                                cache: force ? 'no-store' : 'default',
                                headers: { Accept: 'application/json' },
                                credentials: 'same-origin',
                                mode: 'cors',
                            });

                            if (!res.ok) return false;
                            const data = await res.json();
                            const items =
                                Array.isArray(data)
                                    ? data
                                    : Array.isArray(data?.results)
                                      ? data.results
                                      : [];
                            if (!items.length) return false;
                            window.mediaQueue = items;
                            return true;
                        }

                        // Use POST so we can send preview config without encoding into the URL.
                        const layoutVariant = window.appConfig?.wallartMode?.layoutVariant;
                        let previewCount = 200;
                        if (musicMode) previewCount = 200;
                        else if (layoutVariant === 'filmCards') previewCount = 1000;
                        else if (gamesOnly) previewCount = 500;

                        const type = (window.appConfig && window.appConfig.type) || 'movie';
                        const resp = await fetch(`${baseUrl}/api/admin/media/preview`, {
                            method: 'POST',
                            credentials: 'include',
                            cache: 'no-store',
                            headers: {
                                'Content-Type': 'application/json',
                                Accept: 'application/json',
                            },
                            body: JSON.stringify({
                                type,
                                count: previewCount,
                                musicMode: musicMode ? '1' : '0',
                                filmCards: layoutVariant === 'filmCards' ? '1' : '0',
                                gamesOnly: gamesOnly ? '1' : '0',
                                wallartMode: window.appConfig?.wallartMode || {},
                            }),
                        });

                        if (!resp.ok) {
                            window.debugLog &&
                                window.debugLog('WALLART_PREVIEW_MEDIA_FETCH_FAIL', {
                                    status: resp.status,
                                });
                            // Fall back to public endpoint below
                            throw new Error('preview_media_fetch_failed');
                        }

                        const data = await resp.json();
                        const items =
                            Array.isArray(data) ? data : Array.isArray(data?.results) ? data.results : [];
                        if (!items.length) return false;
                        window.mediaQueue = items;
                        return true;
                    }

                    // Non-preview (or no special mode): fall back to public endpoints.
                    // Games-only mode: fetch games from RomM
                    if (gamesOnly) {
                        // Games-only mode: fetch games from RomM
                        const gameCount = 100; // Default game count
                        url = `${baseUrl}/get-media?count=${gameCount}&gamesOnly=1`;
                    } else {
                        // Regular media fetching (movies/TV)
                        let count;
                        if (musicMode) {
                            // Artist Cards requires special endpoint with artist photos + discographies.
                            if (musicDisplayStyle === 'artist-cards') {
                                const artistCount = 50;
                                url = `${baseUrl}/get-music-artists?count=${artistCount}`;
                                window.debugLog &&
                                    window.debugLog('WALLART_FETCH_MUSIC_ARTISTS', {
                                        url,
                                        artistCount,
                                    });

                                const res = await fetch(url, {
                                    method: 'GET',
                                    cache: force ? 'no-store' : 'default',
                                    headers: { Accept: 'application/json' },
                                    credentials: 'same-origin',
                                    mode: 'cors',
                                });
                                if (!res.ok) return false;
                                const data = await res.json();
                                const items =
                                    Array.isArray(data)
                                        ? data
                                        : Array.isArray(data?.results)
                                          ? data.results
                                          : [];
                                if (!items.length) return false;
                                window.mediaQueue = items;
                                return true;
                            }

                            count = 500; // Balanced count for reasonable loading time and variety
                        } else {
                            // Check if filmCards layout is active - needs more films for grouping
                            const layoutVariant = window.appConfig?.wallartMode?.layoutVariant;
                            if (layoutVariant === 'filmCards') {
                                // Fetch significantly more films to ensure complete director/genre/actor collections
                                count = 1000;
                            } else {
                                count = Math.max(60, Math.min(400, Math.floor((window.innerWidth * window.innerHeight) / 8000)));
                            }
                        }
                        
                        // Determine media type
                        const type = (window.appConfig && window.appConfig.type) || 'movie';
                        
                        url = `${baseUrl}/get-media?count=${count}&type=${encodeURIComponent(type)}`;
                        
                        // If music mode, add musicMode parameter
                        if (musicMode) {
                            url += '&musicMode=1';
                        }
                        
                        // If film cards layout, add filmCards parameter to bypass cache limits
                        const layoutVariant = window.appConfig?.wallartMode?.layoutVariant;
                        if (layoutVariant === 'filmCards') {
                            url += '&filmCards=1';
                        }
                    }
                    
                    window.debugLog && window.debugLog('WALLART_FETCH_MEDIA', { url, gamesOnly, userAgent: navigator.userAgent });
                    
                    // Safari-compatible fetch - use short-term cache for faster reloads
                    const res = await fetch(url, { 
                        method: 'GET',
                        cache: force ? 'no-store' : 'default', // Avoid stale previews after toggles
                        headers: { 
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        mode: 'cors'
                    });
                    
                    window.debugLog && window.debugLog('WALLART_MEDIA_FETCH_SUCCESS', { 
                        status: res.status, 
                        ok: res.ok,
                        contentType: res.headers.get('content-type'),
                        bodyUsed: res.bodyUsed
                    });
                    
                    if (!res.ok) {
                        window.debugLog && window.debugLog('WALLART_MEDIA_FETCH_FAIL', { status: res.status, statusText: res.statusText });
                        return false;
                    }
                    
                    // Clone response before reading to avoid Safari bodyUsed issues
                    const resClone = res.clone();
                    let data;
                    try {
                        const text = await resClone.text();
                        window.debugLog && window.debugLog('WALLART_MEDIA_TEXT_LENGTH', { length: text.length, preview: text.substring(0, 100) });
                        data = JSON.parse(text);
                        window.debugLog && window.debugLog('WALLART_MEDIA_JSON_PARSED', { isArray: Array.isArray(data), length: data?.length || 0 });
                    } catch (jsonErr) {
                        window.debugLog && window.debugLog('WALLART_MEDIA_JSON_PARSE_ERROR', { error: jsonErr.message, errorName: jsonErr.name });
                        throw jsonErr;
                    }
                    
                    const items = Array.isArray(data) ? data : Array.isArray(data?.results) ? data.results : [];
                    if (!items.length) {
                        window.debugLog && window.debugLog('WALLART_MEDIA_EMPTY', {});
                        return false;
                    }
                    
                    // OPTIMIZATION: Preload first 10 posters immediately for instant display
                    const preloadCount = Math.min(10, items.length);
                    for (let i = 0; i < preloadCount; i++) {
                        const posterUrl = items[i]?.posterUrl || items[i]?.poster_path;
                        if (posterUrl) {
                            const img = new Image();
                            img.fetchPriority = i < 3 ? 'high' : 'low';
                            img.src = posterUrl;
                        }
                    }
                    
                    try {
                        if (!Object.getOwnPropertyDescriptor(window, 'mediaQueue')) {
                            Object.defineProperty(window, 'mediaQueue', { value: items, writable: true });
                        } else {
                            window.mediaQueue = items;
                        }
                    } catch (e) {
                        window.debugLog && window.debugLog('WALLART_MEDIA_DEFINE_ERROR', { error: e.message });
                        window.mediaQueue = items;
                    }
                    window.debugLog && window.debugLog('WALLART_ENSURE_MEDIA_SUCCESS', { count: items.length, preloaded: preloadCount });
                    return true;
                } catch (e) {
                    window.debugLog && window.debugLog('WALLART_ENSURE_MEDIA_FAIL', { 
                        error: e.message, 
                        errorName: e.name,
                        errorStack: e.stack?.substring(0, 200),
                        isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent)
                    });
                    return false;
                }
            }

            // Expose a refetch helper for live preview updates (admin iframe -> wallart preview)
            // Signature: window.fetchMedia(force = false) -> Promise<boolean>
            try {
                if (typeof window.fetchMedia !== 'function') {
                    window.fetchMedia = async function fetchMedia(force = false) {
                        return ensureMediaQueue(!!force);
                    };
                }
            } catch (_) {
                /* best-effort */
            }
            async function startWallartOnceReady() {
                window.debugLog && window.debugLog('WALLART_START_ONCE_READY', {});
                try {
                    // Force SW update first to ensure latest version
                    await forceServiceWorkerUpdate();
                    
                    await ensureConfig();
                    try { window.logger && window.logger.debug && window.logger.debug('[WALLART] bootstrap: config loaded', { hasWallartConfig: !!window.wallartConfig }); } catch(_) {}
                    // Initialize device management to enable heartbeats and live WS logs
                    // IMPORTANT: await init() so setup overlay completes before media check
                    window.debugLog && window.debugLog('WALLART_INIT_DEVICE_MGMT', {});
                    try {
                        if (window.PosterramaDevice && typeof window.PosterramaDevice.init === 'function') {
                            await window.PosterramaDevice.init(window.appConfig || {});
                        }
                    } catch (e) { 
                        window.debugLog && window.debugLog('WALLART_DEVICE_MGMT_ERROR', { error: e.message });
                    }
                    const hasMedia = await ensureMediaQueue(false);
                    if (!hasMedia) {
                        console.log('[Wallart] No media available, redirecting to no-media page');
                        window.location.replace('/no-media.html');
                        return;
                    }
                    try { window.logger && window.logger.debug && window.logger.debug('[WALLART] bootstrap: media ready', { count: (Array.isArray(window.mediaQueue) && window.mediaQueue.length) || 0 }); } catch(_) {}
                    window.debugLog && window.debugLog('WALLART_START_MODULE', { hasModule: !!(window.PosterramaWallart && typeof window.PosterramaWallart.start === 'function') });
                    if (window.PosterramaWallart && typeof window.PosterramaWallart.start === 'function') {
                        window.PosterramaWallart.start(window.wallartConfig || {});
                        try { window.logger && window.logger.debug && window.logger.debug('[WALLART] module start invoked'); } catch(_) {}
                    }
                    window.debugLog && window.debugLog('WALLART_BOOTSTRAP_COMPLETE', {});
                } catch (e) {
                    window.debugLog && window.debugLog('WALLART_START_ERROR', { error: e.message, stack: e.stack });
                }
            }
            // Kick on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startWallartOnceReady);
            } else {
                startWallartOnceReady();
            }
        })();
    </script>
    <script>
        // If server indicated a mode, apply it immediately to avoid race conditions
        document.addEventListener('DOMContentLoaded', () => {
            window.debugLog && window.debugLog('DOM_READY', { verified: window.__wallartModeVerified });
            
            if (window.MODE_HINT === 'wallart') {
                document.body.classList.add('wallart-mode');
            } else if (window.MODE_HINT === 'screensaver') {
                document.body.classList.remove('wallart-mode');
            }
            // Wait for inline redirect script to verify wallart mode before starting auto-exit poll
            // This prevents reload loops on initial page load
            const startPoll = () => {
                window.debugLog && window.debugLog('AUTO_EXIT_POLL_START', {});
                try { 
                    window.PosterramaCore && window.PosterramaCore.startAutoExitPoll({ currentMode: 'wallart', intervalMs: 15000 }); 
                } catch (e) {
                    window.debugLog && window.debugLog('AUTO_EXIT_POLL_ERROR', { error: e.message });
                }
            };
            if (window.__wallartModeVerified) {
                // Already verified, safe to start poll after a delay
                window.debugLog && window.debugLog('POLL_DELAY_VERIFIED', { delayMs: 3000 });
                setTimeout(startPoll, 3000);
            } else {
                // Wait for verification flag
                window.debugLog && window.debugLog('POLL_WAIT_VERIFY', {});
                const checkInterval = setInterval(() => {
                    if (window.__wallartModeVerified) {
                        window.debugLog && window.debugLog('POLL_VERIFIED_VIA_INTERVAL', {});
                        clearInterval(checkInterval);
                        setTimeout(startPoll, 3000);
                    }
                }, 100);
                // Failsafe: start anyway after 5 seconds
                setTimeout(() => {
                    clearInterval(checkInterval);
                    if (!window.__wallartModeVerified) {
                        window.debugLog && window.debugLog('POLL_FAILSAFE_TRIGGER', {});
                        window.__wallartModeVerified = true;
                        startPoll();
                    }
                }, 5000);
            }
        });
    </script>
    
    <!-- Listen for config changes and refresh on games/music mode toggle -->
    <script>
        (function() {
            try {
                // Store initial config state
                let currentGamesOnly = window.appConfig?.wallartMode?.gamesOnly;
                let currentMusicMode = window.appConfig?.wallartMode?.musicMode?.enabled;
                
                // Listen for config updates via BroadcastChannel
                const configChannel = new BroadcastChannel('posterrama-config');
                configChannel.onmessage = (event) => {
                    if (event.data && event.data.type === 'config-updated') {
                        const settings = event.data.settings || {};
                        
                        // Check if games mode or music mode changed
                        const newGamesOnly = settings.wallartMode?.gamesOnly;
                        const newMusicMode = settings.wallartMode?.musicMode?.enabled;
                        
                        // Reload if games mode toggled
                        if (newGamesOnly !== undefined && newGamesOnly !== currentGamesOnly) {
                            console.log('[Wallart] Games mode changed, reloading...', { old: currentGamesOnly, new: newGamesOnly });
                            window.location.reload();
                            return;
                        }
                        
                        // Reload if music mode toggled
                        if (newMusicMode !== undefined && newMusicMode !== currentMusicMode) {
                            console.log('[Wallart] Music mode changed, reloading...', { old: currentMusicMode, new: newMusicMode });
                            window.location.reload();
                            return;
                        }
                    }
                };
                
                console.log('[Wallart] Config change listener initialized');
            } catch (e) {
                console.warn('[Wallart] BroadcastChannel not supported:', e);
            }
        })();
    </script>
        
        <!-- PWA Service Worker Registration -->
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker
                        .register('/sw.js')
                        .catch(() => {
                            /* silent */
                        });
                });
            }
        </script>
    </body>
</html>
