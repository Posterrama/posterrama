<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control Center - posterrama</title>
        
    <!-- Theme styles (new theme) -->
    <link rel="stylesheet" href="/admin.css?v=0" />
        <!-- Font Awesome (icons consistent with admin2) -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <style>
            /* Keep login-specific layout tweaks; visuals come from admin.css */
            body { background-color: var(--color-bg-secondary); color: var(--color-text-primary); }
            .auth-container {
                min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; gap: 2rem;
            }
            .auth-box { width: 100%; max-width: 420px; }
            .panel-content { padding: var(--space-lg); }
            .auth-title { text-align: center; margin: 0 0 1.25rem 0; letter-spacing: -0.02em; font-weight: var(--font-weight-semibold); }
            .admin-text { font-weight: var(--font-weight-bold); text-transform: uppercase; letter-spacing: .08em; }
            .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
            .form-group { margin-bottom: var(--space-md); }
            .form-compact { max-width: 360px; margin: 0 auto; }
            /* Ensure equal widths for username/password like admin2 fields */
            .form-compact .form-group input,
            .form-compact .form-group select {
                width: 100%;
            }
            /* Minimal helpers for icons inside inputs */
            .input-wrap { position: relative; }
            .input-icon-btn { position: absolute; right: .5rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: var(--color-text-secondary); padding: .25rem; cursor: pointer; opacity: .85; }
            .input-icon-btn:hover { opacity: 1; color: var(--color-info); }
            /* Ensure input with icon stays full width */
            .input-wrap input { width: 100%; display: block; }
            /* Override autofill to match theme (avoid bright background) */
            input:-webkit-autofill,
            input:-webkit-autofill:hover,
            input:-webkit-autofill:focus {
                -webkit-text-fill-color: var(--color-text-primary);
                box-shadow: 0 0 0px 1000px var(--color-bg-card) inset;
                border: 1px solid var(--color-border);
                transition: background-color 9999s ease-in-out 0s;
            }
            /* Heading overrides: plain white, no forced uppercase */
            .auth-title .admin-text { text-transform: none; letter-spacing: 0; }
            /* Error message styled with theme vars */
            .error-message { 
                display: none; 
                background: rgba(232,67,147,0.08); 
                border: 1px solid rgba(232,67,147,0.35); 
                color: #e8439b; 
                padding: .75rem 1rem; 
                border-radius: 8px; 
                text-align: center; 
                font-size: 14px; 
                margin-top: 1rem;
            }
            .error-message.show { display: block !important; }
            /* Smaller centered submit */
            .auth-actions { display:flex; justify-content:center; margin-top: 1rem; }
            .auth-footer { display:flex; gap:12px; align-items:center; justify-content:center; margin-top:1rem; }
            /* Spinner + loading state styles centralized in admin.css */
        </style>
    </head>
    <body>
        <div class="auth-container">
            <div class="auth-box panel">
                <div class="panel-content">
                <h1 class="auth-title">
                    <i class="fas fa-user-lock" aria-hidden="true" style="opacity:.9; margin-right: 0.5rem;"></i>
                    <span class="admin-text" style="color: var(--color-text-primary); font-weight: var(--font-weight-semibold);">Admin login</span>
                    <span style="display:block; margin-top:.125rem; color: var(--color-text-secondary); font-size: var(--font-size-sm); font-weight: 100;">posterrama</span>
                </h1>

                <form id="loginForm" class="form-compact" method="POST" action="/admin/login">
                    <div class="form-group">
                        <input
                            type="text"
                            id="username"
                            name="username"
                            required
                            placeholder="Enter your username"
                            autocomplete="username"
                            autocapitalize="off"
                            spellcheck="false"
                        />
                    </div>

                    <div class="form-group">
                        <div class="input-wrap">
                            <input
                                type="password"
                                id="password"
                                name="password"
                                required
                                placeholder="Enter your password"
                                autocomplete="current-password"
                                style="padding-right:2.2rem"
                            />
                            <button type="button" id="togglePwd" class="input-icon-btn" aria-label="Show/Hide password"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>

                    <div class="auth-actions">
                        <button type="submit" class="btn auth-btn-primary btn-sm" id="submitBtn">
                            <span class="spinner" aria-hidden="true"></span>
                            <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                            <span>Sign In</span>
                        </button>
                    </div>

                    <div id="errorMessage" class="error-message" role="alert" aria-live="assertive"></div>
                </form>
                </div>
            </div>
            <div class="auth-footer">
                <a href="/" class="btn auth-btn-secondary btn-sm"><i class="fas fa-arrow-left" aria-hidden="true"></i><span>Back to Home</span></a>
            </div>
        </div>

        <script>
            // Toggle password visibility
            const togglePwd = document.getElementById('togglePwd');
            togglePwd?.addEventListener('click', () => {
                const pwd = document.getElementById('password');
                const icon = togglePwd.querySelector('i');
                if (!pwd) return;
                const isPwd = pwd.type === 'password';
                pwd.type = isPwd ? 'text' : 'password';
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });

            document.getElementById('loginForm').addEventListener('submit', async e => {
                e.preventDefault();

                const submitBtn = document.getElementById('submitBtn');
                const errorDiv = document.getElementById('errorMessage');

                submitBtn.disabled = true;
                submitBtn.classList.add('btn-loading');
                const originalHtml = submitBtn.innerHTML;
                submitBtn.setAttribute('data-original-html', originalHtml);
                submitBtn.querySelector('span:last-child').textContent = 'Signing in...';
                errorDiv.style.display = 'none';
                errorDiv.classList.remove('show');

                try {
                    const formData = new FormData(e.target);
                    const response = await fetch('/admin/login', {
                        method: 'POST',
                        body: new URLSearchParams(formData),
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                    });

                    if (response.ok) {
                        try {
                            // First check if response is actually JSON
                            const responseText = await response.text();
                            
                            // Check if it's HTML (redirect page)
                            if (responseText.trim().startsWith('<!DOCTYPE') || responseText.trim().startsWith('<html')) {
                                window.location.href = '/admin';
                                return;
                            }
                            
                            const result = JSON.parse(responseText);
                            
                            if (result.success) {
                                // Login successful, redirect as instructed
                                window.location.href = result.redirectTo;
                            } else {
                                // This shouldn't happen if response.ok is true, but handle it
                                errorDiv.textContent = result.error || 'Login failed for unknown reasons.';
                                errorDiv.classList.add('show');
                            }
                        } catch (jsonError) {
                            console.error('JSON parse error on success response:', jsonError);
                            errorDiv.textContent = 'Unexpected response format. Redirecting to admin panel...';
                            errorDiv.classList.add('show');
                            // Try redirecting anyway since we got a 200 response
                            setTimeout(() => {
                                window.location.href = '/admin';
                            }, 2000);
                        }
                    } else {
                        // Handle error responses
                        let errorMessage = 'Login failed. Please check your credentials.';

                        try {
                            const errorData = await response.json();
                            if (errorData.error) {
                                errorMessage = errorData.error;
                            }
                        } catch (e) {
                            try {
                                const errorText = await response.text();
                                if (errorText.trim()) {
                                    // If it looks like HTML, show a generic message
                                    if (
                                        errorText.includes('<!DOCTYPE') ||
                                        errorText.includes('<html')
                                    ) {
                                        errorMessage =
                                            'Server error occurred. Please try again or contact support.';
                                    } else {
                                        errorMessage = errorText;
                                    }
                                }
                            } catch (textError) {
                                console.error('Failed to parse error response:', textError);
                            }
                        }

                        errorDiv.textContent = errorMessage;
                        errorDiv.classList.add('show');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    errorDiv.textContent = 'Network error. Please try again.';
                    errorDiv.classList.add('show');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('btn-loading');
                    const restore = submitBtn.getAttribute('data-original-html');
                    if (restore) submitBtn.innerHTML = restore;
                }
            });

            // Focus on username field when page loads
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('username').focus();
            });
        </script>
    </body>
</html>
