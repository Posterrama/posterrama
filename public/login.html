<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Posterrama Admin</title>
        <meta name="description" content="Login to the Posterrama admin control center to manage media sources, display presets, devices and system operations." />
        <link rel="stylesheet" href="/admin.css?v={{ASSET_VERSION}}" />
        <link rel="icon" type="image/svg+xml" href="/icons/posterrama-icon.svg?v=3" />
        <link rel="icon" type="image/x-icon" href="/favicon.ico?v=3" />
        <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png?v=2" />
        <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png?v=2" />
        <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=2" />
        <style>
            .login-version-badge {
                position: fixed;
                right: 14px;
                bottom: 14px;
                z-index: 50;
                font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
                    'Courier New', monospace;
                font-size: 10px;
                letter-spacing: 0.15px;
                color: rgba(229, 231, 235, 0.7);
                padding: 4px 8px;
                border-radius: 999px;
                background: rgba(0, 0, 0, 0.18);
                border: 1px solid rgba(255, 255, 255, 0.08);
                opacity: 0;
                transform: translateY(2px);
                transition:
                    opacity 140ms ease,
                    transform 140ms ease;
                user-select: none;
                pointer-events: none;
            }

            .login-version-badge.is-visible {
                opacity: 1;
                transform: translateY(0);
            }
        </style>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
    </head>
    <body>
        <div class="auth-container">
            <div class="auth-box panel">
                <div class="panel-content">
                    <img src="/logo.png" alt="Posterrama Logo" class="auth-corner-logo" />
                    <h1 class="auth-title">
                        <div class="auth-title-row">
                            <span class="auth-title-text">Admin login</span>
                        </div>
                        <span class="auth-title-brand">posterrama</span>
                    </h1>

                    <form id="loginForm" class="form-compact" method="POST" action="/admin/login">
                        <div class="form-group">
                            <input
                                type="text"
                                id="username"
                                name="username"
                                required
                                placeholder="Enter your username"
                                autocomplete="username"
                                autocapitalize="off"
                                spellcheck="false"
                            />
                        </div>

                        <div class="form-group">
                            <div class="input-wrap">
                                <input
                                    type="password"
                                    id="password"
                                    name="password"
                                    required
                                    placeholder="Enter your password"
                                    autocomplete="current-password"
                                    style="padding-right:2.2rem"
                                />
                                <button type="button" id="togglePwd" class="input-icon-btn" aria-label="Show/Hide password"><i class="fas fa-eye"></i></button>
                            </div>
                        </div>

                        <div class="auth-actions">
                            <button type="submit" class="btn auth-btn-primary btn-sm" id="submitBtn">
                                <span class="spinner" aria-hidden="true"></span>
                                <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                                <span>Sign In</span>
                            </button>
                        </div>

                        <div id="errorMessage" class="error-message" role="alert" aria-live="assertive"></div>
                    </form>
                </div>
            </div>
        </div>

        <div class="login-version-badge" id="loginVersionBadge" aria-label="Posterrama version"></div>

        <script>
            // Toggle password visibility
            const togglePwd = document.getElementById('togglePwd');
            togglePwd?.addEventListener('click', () => {
                const pwd = document.getElementById('password');
                const icon = togglePwd.querySelector('i');
                if (!pwd) return;
                const isPwd = pwd.type === 'password';
                pwd.type = isPwd ? 'text' : 'password';
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });

            document.getElementById('loginForm').addEventListener('submit', async e => {
                e.preventDefault();

                const submitBtn = document.getElementById('submitBtn');
                const errorDiv = document.getElementById('errorMessage');

                submitBtn.disabled = true;
                submitBtn.classList.add('btn-loading');
                const originalHtml = submitBtn.innerHTML;
                submitBtn.setAttribute('data-original-html', originalHtml);
                submitBtn.querySelector('span:last-child').textContent = 'Signing in...';
                errorDiv.style.display = 'none';
                errorDiv.classList.remove('show');

                try {
                    const formData = new FormData(e.target);
                    const response = await fetch('/admin/login', {
                        method: 'POST',
                        body: new URLSearchParams(formData),
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                    });

                    if (response.ok) {
                        try {
                            // First check if response is actually JSON
                            const responseText = await response.text();
                            
                            // Check if it's HTML (redirect page)
                            if (responseText.trim().startsWith('<!DOCTYPE') || responseText.trim().startsWith('<html')) {
                                window.location.href = '/admin';
                                return;
                            }
                            
                            const result = JSON.parse(responseText);
                            
                            if (result.success) {
                                // Login successful, redirect as instructed
                                window.location.href = result.redirectTo;
                            } else {
                                // This shouldn't happen if response.ok is true, but handle it
                                errorDiv.textContent = result.error || 'Login failed for unknown reasons.';
                                errorDiv.classList.add('show');
                            }
                        } catch (jsonError) {
                            console.error('JSON parse error on success response:', jsonError);
                            errorDiv.textContent = 'Unexpected response format. Redirecting to admin panel...';
                            errorDiv.classList.add('show');
                            // Try redirecting anyway since we got a 200 response
                            setTimeout(() => {
                                window.location.href = '/admin';
                            }, 2000);
                        }
                    } else {
                        // Handle error responses
                        let errorMessage = 'Login failed. Please check your credentials.';

                        try {
                            const errorData = await response.json();
                            if (errorData.error) {
                                errorMessage = errorData.error;
                            }
                        } catch (e) {
                            try {
                                const errorText = await response.text();
                                if (errorText.trim()) {
                                    // If it looks like HTML, show a generic message
                                    if (
                                        errorText.includes('<!DOCTYPE') ||
                                        errorText.includes('<html')
                                    ) {
                                        errorMessage =
                                            'Server error occurred. Please try again or contact support.';
                                    } else {
                                        errorMessage = errorText;
                                    }
                                }
                            } catch (textError) {
                                console.error('Failed to parse error response:', textError);
                            }
                        }

                        errorDiv.textContent = errorMessage;
                        errorDiv.classList.add('show');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    errorDiv.textContent = 'Network error. Please try again.';
                    errorDiv.classList.add('show');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('btn-loading');
                    const restore = submitBtn.getAttribute('data-original-html');
                    if (restore) submitBtn.innerHTML = restore;
                }
            });

            // Focus on username field when page loads
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('username').focus();
            });

            // Populate version badge without relying on server-side HTML stamping.
            // X-API-Version is always set by the /api middleware.
            document.addEventListener('DOMContentLoaded', async () => {
                const badge = document.getElementById('loginVersionBadge');
                if (!badge) return;

                try {
                    const response = await fetch('/api/v1/config', { cache: 'no-store' });
                    const apiVersion = response.headers.get('x-api-version');

                    if (apiVersion) {
                        badge.textContent = `v${apiVersion}`;
                        badge.classList.add('is-visible');
                    }
                } catch {
                    // Hide badge on any error
                }
            });
        </script>
    </body>
</html>
