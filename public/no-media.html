<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <title>No Media Available - Posterrama</title>
        <link rel="icon" type="image/svg+xml" href="/icons/posterrama-icon.svg?v=3" />
        <link rel="icon" type="image/x-icon" href="/favicon.ico?v=3" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <!-- Device management for setup overlay -->
        <script src="/device-mgmt.js" defer></script>
        <style>
            :root {
                /* Admin theme colors - exact match */
                --color-accent: #00d4aa;
                --color-accent-dim: rgba(0, 212, 170, 0.15);
                --color-secondary: #667eea;
                --color-bg-primary: #1f2028;
                --color-bg-secondary: #2a2b38;
                --color-bg-tertiary: #303240;
                --color-bg-dark: #16161e;
                --color-bg-card: #242530;
                --color-text-primary: #c0caf5;
                --color-text-secondary: #a9b1d6;
                --color-text-muted: #565f89;
                --color-border: rgba(255, 255, 255, 0.06);
                --color-border-light: rgba(255, 255, 255, 0.1);
                --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                    'Helvetica Neue', Arial, sans-serif;
            }

            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            html,
            body {
                height: 100%;
            }

            body {
                font-family: var(--font-family);
                background: var(--color-bg-primary);
                color: var(--color-text-primary);
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }

            /* Subtle gradient background */
            .bg-gradient {
                position: fixed;
                inset: 0;
                background: radial-gradient(
                        ellipse 80% 50% at 50% -20%,
                        rgba(0, 212, 170, 0.05) 0%,
                        transparent 50%
                    ),
                    radial-gradient(
                        ellipse 60% 40% at 100% 100%,
                        rgba(102, 126, 234, 0.04) 0%,
                        transparent 40%
                    );
                pointer-events: none;
            }

            /* Clock - top right */
            .clock {
                position: fixed;
                top: 2rem;
                right: 2.5rem;
                font-size: 2.5rem;
                font-weight: 200;
                letter-spacing: 0.08em;
                color: var(--color-text-muted);
                font-variant-numeric: tabular-nums;
            }

            /* Main container */
            .container {
                position: relative;
                z-index: 1;
                width: 100%;
                max-width: 480px;
                padding: 2rem;
            }

            /* Logo section */
            .logo-section {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 1rem;
                margin-bottom: 3rem;
            }

            .logo-icon {
                width: 56px;
                height: 56px;
                object-fit: contain;
                opacity: 0.9;
            }

            .logo-text {
                font-size: 1.75rem;
                font-weight: 600;
                letter-spacing: -0.02em;
                background: linear-gradient(135deg, var(--color-accent), var(--color-secondary));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            /* Status card */
            .status-card {
                background: var(--color-bg-card);
                border: 1px solid var(--color-border-light);
                border-radius: 12px;
                padding: 2rem;
                text-align: center;
            }

            .status-icon {
                width: 64px;
                height: 64px;
                margin: 0 auto 1.5rem;
                border-radius: 50%;
                background: var(--color-accent-dim);
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .status-icon i {
                font-size: 1.5rem;
                color: var(--color-accent);
            }

            .status-title {
                font-size: 1.25rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                color: var(--color-text-primary);
            }

            .status-subtitle {
                font-size: 0.875rem;
                color: var(--color-text-secondary);
                margin-bottom: 2rem;
            }

            /* Checklist */
            .checklist {
                text-align: left;
                margin-bottom: 2rem;
            }

            .checklist-item {
                display: flex;
                align-items: flex-start;
                gap: 0.75rem;
                padding: 0.75rem 0;
                border-bottom: 1px solid var(--color-border);
            }

            .checklist-item:last-child {
                border-bottom: none;
            }

            .checklist-icon {
                flex-shrink: 0;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: var(--color-bg-tertiary);
                border: 1px solid var(--color-border-light);
                display: flex;
                align-items: center;
                justify-content: center;
                margin-top: 2px;
            }

            .checklist-icon i {
                font-size: 0.55rem;
                color: var(--color-text-muted);
            }

            .checklist-text {
                font-size: 0.875rem;
                color: var(--color-text-secondary);
                line-height: 1.5;
            }

            /* Status indicator */
            .status-bar {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.625rem;
                padding: 0.875rem 1.25rem;
                background: var(--color-bg-tertiary);
                border-radius: 8px;
                font-size: 0.8125rem;
                color: var(--color-text-secondary);
            }

            .pulse-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--color-accent);
                animation: pulse 2s ease-in-out infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.4;
                    transform: scale(0.9);
                }
            }

            /* Responsive */
            @media (max-width: 600px) {
                .container {
                    padding: 1.5rem;
                }

                .clock {
                    font-size: 1.75rem;
                    top: 1.25rem;
                    right: 1.5rem;
                }

                .logo-section {
                    margin-bottom: 2rem;
                }

                .logo-icon {
                    width: 44px;
                    height: 44px;
                }

                .logo-text {
                    font-size: 1.5rem;
                }

                .status-card {
                    padding: 1.5rem;
                }

                .status-icon {
                    width: 52px;
                    height: 52px;
                }

                .status-icon i {
                    font-size: 1.25rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="bg-gradient"></div>

        <div class="clock" id="clock">00:00</div>

        <div class="container">
            <div class="logo-section">
                <img src="/logo.png" alt="Posterrama" class="logo-icon" />
                <span class="logo-text">Posterrama</span>
            </div>

            <div class="status-card">
                <div class="status-icon">
                    <i class="fas fa-photo-film"></i>
                </div>

                <h1 class="status-title">No Media Available</h1>
                <p class="status-subtitle">Configure a media source to get started</p>

                <div class="checklist">
                    <div class="checklist-item">
                        <div class="checklist-icon"><i class="fas fa-check"></i></div>
                        <span class="checklist-text"
                            >Open the admin panel and go to Media Sources</span
                        >
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-icon"><i class="fas fa-check"></i></div>
                        <span class="checklist-text"
                            >Connect Plex, Jellyfin / Emby, TMDB, or another source</span
                        >
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-icon"><i class="fas fa-check"></i></div>
                        <span class="checklist-text"
                            >Enable libraries and verify the connection</span
                        >
                    </div>
                </div>

                <div class="status-bar">
                    <span class="pulse-dot"></span>
                    <span id="status-text">Checking for media...</span>
                </div>
            </div>
        </div>

        <script>
            let checkInterval = null;
            let nextCheckTime = null;
            let deviceInitialized = false;

            async function loadConfig() {
                try {
                    if (window.__serverConfig) return;
                    const response = await fetch('/get-config', {
                        cache: 'no-cache',
                        headers: { 'Cache-Control': 'no-cache' },
                    });
                    if (response.ok) {
                        window.__serverConfig = await response.json();
                    }
                } catch (e) {
                    // Ignore config load errors
                }
            }

            // Initialize device management (shows setup overlay if needed)
            async function initDeviceManagement() {
                if (deviceInitialized) return;
                deviceInitialized = true;
                
                try {
                    await loadConfig();
                    if (window.PosterramaDevice && typeof window.PosterramaDevice.init === 'function') {
                        await window.PosterramaDevice.init(window.__serverConfig || {});
                    }
                } catch (e) {
                    // Ignore device init errors
                }
            }

            function updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('clock').textContent = hours + ':' + minutes;
            }

            async function checkMediaAvailability() {
                try {
                    await loadConfig();

                    const wallartMode = window.__serverConfig?.wallartMode || {};
                    const isGamesOnly = wallartMode.gamesOnly === true;
                    const isMusicMode = wallartMode.musicMode && wallartMode.musicMode.enabled === true;
                    const musicDisplayStyle = wallartMode.musicMode && wallartMode.musicMode.displayStyle;

                    let url;
                    if (isMusicMode && musicDisplayStyle === 'artist-cards') {
                        url = '/get-music-artists?count=1';
                    } else {
                        url = '/get-media?count=1';
                        if (isGamesOnly) {
                            url += '&gamesOnly=true';
                        } else {
                            url += '&excludeGames=1';
                        }
                        if (isMusicMode) {
                            url += '&musicMode=true';
                        }
                    }

                    const response = await fetch(url, {
                        cache: 'no-cache',
                        headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate' },
                    });

                    if (!response.ok) throw new Error('Failed to fetch media');

                    const data = await response.json();

                    if (data && typeof data === 'object' && data.status === 'building') {
                        document.getElementById('status-text').textContent =
                            'Building playlist...';
                        return 'building';
                    }

                    if (Array.isArray(data) && data.length > 0) {
                        document.getElementById('status-text').textContent =
                            'Media found! Redirecting...';
                        setTimeout(function() {
                            window.location.href = '/';
                        }, 500);
                        return true;
                    }

                    return false;
                } catch (error) {
                    return false;
                }
            }

            function updateStatusText() {
                if (!nextCheckTime) return;

                const now = Date.now();
                const remaining = Math.ceil((nextCheckTime - now) / 1000);

                if (remaining > 0) {
                    document.getElementById('status-text').textContent =
                        'Next check in ' + remaining + 's';
                } else {
                    document.getElementById('status-text').textContent = 'Checking...';
                }
            }

            function startAutoCheck() {
                checkMediaAvailability().then(function(result) {
                    if (result === 'building') {
                        nextCheckTime = Date.now() + 5000;
                    } else if (!result) {
                        nextCheckTime = Date.now() + 15000;
                    }
                });

                if (checkInterval) clearInterval(checkInterval);
                checkInterval = setInterval(async function() {
                    nextCheckTime = null;
                    document.getElementById('status-text').textContent = 'Checking...';
                    const result = await checkMediaAvailability();

                    if (result === true) {
                        clearInterval(checkInterval);
                    } else if (result === 'building') {
                        nextCheckTime = Date.now() + 5000;
                    } else {
                        nextCheckTime = Date.now() + 15000;
                    }
                }, 5000);

                setInterval(updateStatusText, 1000);
                nextCheckTime = Date.now() + 5000;
            }

            updateClock();
            setInterval(updateClock, 1000);
            
            // Initialize device management first, then start media checks
            initDeviceManagement().then(() => {
                startAutoCheck();
            });
        </script>
    </body>
</html>
