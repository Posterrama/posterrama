# Posterrama Development Context

## üöÄ Server Configuration

### Port Information

- **Main Server Port**: `4000` (default)
    - Configurable via `process.env.SERVER_PORT` or `config.serverPort` in config.json
    - Server accessible at: `http://localhost:4000`
    - API endpoints: `http://localhost:4000/get-media`, `http://localhost:4000/health`, etc.

### Environment Variables

- `SERVER_PORT`: Override default port (default: 4000)
- `DEBUG`: Enable debug logging (`true`/`false`)
- `NODE_ENV`: Environment mode (`production`, `development`, `test`)

## üîß Quick Commands for Development

### Testing the Application

```bash
# Test main endpoints
curl http://localhost:4000/health
curl http://localhost:4000/get-media
curl http://localhost:4000/get-config

# Test admin endpoints (requires authentication)
curl http://localhost:4000/admin
```

### PM2 Process Management

```bash
pm2 list                    # Show running processes
pm2 restart posterrama     # Restart the application
pm2 logs posterrama        # View logs
pm2 stop posterrama        # Stop the application
pm2 start posterrama       # Start the application
```

### Development Workflow

```bash
# Run tests
npm test
npm run test:coverage

# Check code quality
npm run lint
npm run quality:all

# Development server (if not using PM2)
npm start
```

## üêõ Common Issues & Solutions

### Empty Media Queue After Restart

**Symptom**: `No media found. Check the library configuration.` immediately after restart
**Cause**: Race condition - frontend requests media before initial cache is populated
**Solution**: Server now pre-populates cache before accepting requests (fixed in startup logic)

### Empty Boxes in Wallart Grid

**Symptom**: Lege vakjes in hero + grid layout, lazy loading failures
**Causes & Solutions**:

1. **Missing ImageTags in Jellyfin API** - Added 'ImageTags' and 'BackdropImageTags' to fields array
2. **Invalid Image URLs** - Added checks for item.ImageTags before generating poster/backdrop URLs
3. **Lazy Loading Timeouts** - Added 10-second timeout to prevent hanging image loads
4. **Missing Fallback Images** - Added SVG placeholder for failed images
5. **Improved Error Handling** - Better logging and retry logic in lazy loader

### Jellyfin Source Debugging

**Test Connection**: `curl http://localhost:4000/api/test-connection`
**Check Logs**: Focus on `[JellyfinSource:ServerName]` entries
**Cache Status**: Check `/health?detailed=true` for cache information

## üìÅ Key Files & Locations

### Configuration

- `config.json` - Main configuration file
- `.env` - Environment variables
- `config.schema.json` - Configuration validation schema

### Sources

- `sources/jellyfin.js` - Jellyfin media source implementation
- `sources/plex.js` - Plex media source implementation
- `sources/tmdb.js` - TMDB source implementation
- `sources/tvdb.js` - TVDB source implementation

### Main Application

- `server.js` - Main Express server (8000+ lines)
- `public/` - Frontend static files
- `middleware/` - Express middleware
- `utils/` - Shared utilities

### Important Endpoints

- `/get-media` - Main media endpoint
- `/health` - Health check (use `?detailed=true` for full status)
- `/admin` - Admin panel
- `/api/sources/:sourceType/ratings` - Dynamic rating filters

## üîç Debugging Tips

### Server Startup Issues

1. Check PM2 status: `pm2 list`
2. View logs: `pm2 logs posterrama`
3. Test health: `curl http://localhost:4000/health?detailed=true`

### Empty Media Issues

1. Check if sources are enabled in config.json
2. Test individual source connections
3. Check cache status in detailed health endpoint
4. Look for source-specific errors in logs

### Performance Issues

1. Monitor memory usage in logs
2. Check cache cleanup intervals
3. Review source response times in metrics
4. Use detailed health endpoint for diagnostics

---

**Remember**: Server runs on port **4000** by default!
